<!DOCTYPE HTML>
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
        <title>Exploring the Amiga - Part 2 - The Digital Cat</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<meta name="description" content="The jump table of libraries in the Amiga system, types and structures of Kickstart 1.3">
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@thedigicat" />
<meta name="twitter:title" content="Exploring the Amiga - Part 2" />
<meta name="twitter:description" content="The jump table of libraries in the Amiga system, types and structures of Kickstart 1.3" />
<meta name="twitter:image" content="https://www.thedigitalcatonline.com/images/exploring-the-amiga-2.jpg" />
		<script src="https://kit.fontawesome.com/15214b60ba.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,400italic,600italic|Roboto+Slab:400,700">

        <link rel="stylesheet" href="/theme/css/main.min.css?0fd2251d">

<link rel="stylesheet" href="/theme/css/retro.min.css?d93687f1">
        
        <link href="/images/global/favicon.jpg" rel="icon">

        <!-- Google Analytics Universal -->
        <script type="text/javascript">
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-74364524-1', 'auto');
            ga('send', 'pageview');
        </script>
        <!-- End Google Analytics Universal Code -->

<script type="application/ld+json">
  {
      "@context" : "https://schema.org",
      "@type" : "Article",
      "name" : "Exploring the Amiga - Part 2",
      "author" : {
	  "@type" : "Person",
	  "name" : "Leonardo Giordani"
      },
      "publisher" : {
	  "@type" : "Organization",
	  "name" : "The Digital Cat",
	  "logo" : {
	      "@type" : "ImageObject",
	      "url" : "https://www.thedigitalcatonline.com/images/global/logo_200.jpg",
	      "height" : 200,
	      "width" : 200
	  }
      },
      "mainEntityOfPage": {
	  "@type": "WebPage",
	  "@id": "https://www.thedigitalcatonline.com/blog/2018/05/28/exploring-the-amiga-2/"
      },
      "datePublished" : "28/05/2018",
      "dateModified" : "12/02/2019",
      "image" : "https://www.thedigitalcatonline.com/images/exploring-the-amiga-2.jpg",
      "description" : "The jump table of libraries in the Amiga system, types and structures of Kickstart 1.3",
      "headline" : "The jump table of libraries in the Amiga system, types and structures of Kickstart 1.3",
      "url" : "https://www.thedigitalcatonline.com/blog/2018/05/28/exploring-the-amiga-2/"
  }
</script>
	</head>
	<body class="is-preload">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Main -->
					<div id="main">
						<div class="inner">

<header id="header">
  <a class="logo" href="/category/retro/" title="Retro">All posts in category Retro <i class="fas fa-link"></i></a>
  <div class="align-right">

    <a href="/blog/2018/05/28/exploring-the-amiga-1/"><i class="fas fa-caret-square-left"></i></a>
    
    Exploring the Amiga #2

    <a href="/blog/2018/06/08/exploring-the-amiga-3/"><i class="fas fa-caret-square-right"></i></a>

  </div>
</header>

<!-- <article class="post"> -->

  <section id="header">
    <header class="main">
      <h1>Exploring the Amiga - Part 2</h1>
    </header>
  </section>

  <section id="post-info">
    <p class="article-info">
    By Leonardo Giordani

    <span class="fas fa-calendar-alt"></span> <time datetime="2018-05-28T15:00:00+01:00"> 28/05/2018</time>

    <span class="fas fa-edit"></span> <time datetime="2019-02-12T20:00:00+00:00"> 12/02/2019</time>

    <span class="fas fa-tags"></span>
    <a class="tag" href="/categories/assembly/">assembly</a>    <a class="tag" href="/categories/amiga/">amiga</a>    <a class="tag" href="/categories/retroprogramming/">retroprogramming</a>    <br>
    Share on: <span><a class="" href="https://twitter.com/intent/tweet?text=Exploring%20the%20Amiga%20-%20Part%202&url=https%3A//www.thedigitalcatonline.com/blog/2018/05/28/exploring-the-amiga-2/&via=thedigicat&hashtags=assembly,amiga,retroprogramming" target="_blank" title="Share on Twitter"><i class="fab fa-twitter"></i> Twitter</a></span>
<span><a class="" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A//www.thedigitalcatonline.com/blog/2018/05/28/exploring-the-amiga-2/&title=Exploring%20the%20Amiga%20-%20Part%202&summary=The%20jump%20table%20of%20libraries%20in%20the%20Amiga%20system%2C%20types%20and%20structures%20of%20Kickstart%201.3&source=https%3A//www.thedigitalcatonline.com/blog/2018/05/28/exploring-the-amiga-2/" target="_blank" title="Share on LinkedIn"><i class="fab fa-linkedin"></i> LinkedIn</a></span>
<span><a class="" href="https://news.ycombinator.com/submitlink?t=Exploring%20the%20Amiga%20-%20Part%202&u=https%3A//www.thedigitalcatonline.com/blog/2018/05/28/exploring-the-amiga-2/" target="_blank" title="Share on HackerNews"><i class="fab fa-hacker-news"></i> HackerNews</a></span>
<span><a class="" href="mailto:?subject=Exploring%20the%20Amiga%20-%20Part%202&amp;body=https%3A//www.thedigitalcatonline.com/blog/2018/05/28/exploring-the-amiga-2/" target="_blank" title="Share via Email"><i class="fas fa-envelope"></i> Email</a></span>
<span><a class="" href="https://www.reddit.com/submit?url=https%3A//www.thedigitalcatonline.com/blog/2018/05/28/exploring-the-amiga-2/&title=Exploring%20the%20Amiga%20-%20Part%202" target="_blank" title="Share via Reddit"><i class="fab fa-reddit"></i> Reddit</a></span>    </p>
  </section>

  <section id="content">
    <h1 id="the-library-jump-table">The library jump table<a class="headerlink" href="#the-library-jump-table" title="Permanent link">&para;</a></h1>
<p>As already mentioned when a library is loaded in memory a jump table is created just before the library base address. This table contains the addresses of the functions exposed by the library, and Exec itself has one.</p>
<p>The jump table functions order for the Exec library is specified in one of the include files provided by the NDK, namely <code>include_i/exec/exec_lib.i</code>.</p>
<div class="highlight"><pre><span></span><code>    FUNCDEF Supervisor
    FUNCDEF execPrivate1
    FUNCDEF execPrivate2
    FUNCDEF execPrivate3
    ...
    FUNCDEF OpenLibrary
    ...
</code></pre></div>

<p>As you can see this file makes use of the <code>FUNCDEF</code> macro, which is not provided and has to be implemented by the coder. The idea of the macro is very simple: as the order of the jump table does not change we can just replace the first <code>FUNCDEF</code> with the offset of the first function in the library and then increment this offset with the default size of the jump address. The expected output of the macro is</p>
<div class="highlight"><pre><span></span><code>    _LVOSupervisor     EQU     -30
    _LVOexecPrivate1   EQU     -36
    _LVOexecPrivate2   EQU     -42
    _LVOexecPrivate3   EQU     -48
    ...
    _LVOOpenLibrary    EQU     -552
    ...
</code></pre></div>

<p>Please note that the name of the function has been replaced by another string prepending <code>_LVO</code> to avoid clashes with the actual function definition (LVO stands for Library Vector Offset).</p>
<p>The above figures come from the "Special Constants" section contained in the <code>include_i/exec/libraries.i</code> file</p>
<div class="highlight"><pre><span></span><code><span class="err">*------ Special Constants ---------------------------------------</span>
<span class="err">LIB_VECTSIZE    EQU 6       ;Each library entry takes 6 bytes</span>
<span class="err">LIB_RESERVED    EQU 4       ;Exec reserves the first 4 vectors</span>
<span class="err">LIB_BASE        EQU -LIB_VECTSIZE</span>
<span class="err">LIB_USERDEF     EQU LIB_BASE-(LIB_RESERVED*LIB_VECTSIZE) ;First user func</span>
<span class="err">LIB_NONSTD      EQU LIB_USERDEF</span>
</code></pre></div>

<p>AS you can see from the comments, Exec reserves the first 4 vectors, so the first function's address is <code>LIB_USERDEF</code>. To understand why the addresses are negative and how the offset is computed let's get a snapshot of the library once it has been loaded in memory</p>
<div class="highlight"><pre><span></span><code>                               <span class="n">HIGHER</span> <span class="n">MEMORY</span> <span class="n">ADDRESSES</span>
                             <span class="o">+-------------------------+</span>
<span class="n">Last</span> <span class="n">byte</span> <span class="n">of</span> <span class="n">the</span>             <span class="o">|</span> <span class="n">End</span> <span class="n">of</span> <span class="n">the</span> <span class="n">library</span>      <span class="o">|</span>
<span class="n">library</span> <span class="n">loaded</span> <span class="n">in</span> <span class="o">---------&gt;</span> <span class="o">+-------------------------+</span>
<span class="n">memory</span>                       <span class="o">|</span> <span class="p">[...]</span>                   <span class="o">|</span>
                             <span class="o">+-------------------------+</span>
                             <span class="o">|</span> <span class="n">Content</span> <span class="n">of</span> <span class="n">the</span> <span class="n">library</span>  <span class="o">|</span>
                             <span class="o">+-------------------------+</span>
                             <span class="o">|</span> <span class="n">Library</span> <span class="n">structure</span>       <span class="o">|</span>
<span class="n">Library</span> <span class="n">base</span> <span class="n">address</span> <span class="o">------&gt;</span> <span class="o">+-------------------------+</span>
                             <span class="o">|</span> <span class="mi">1</span><span class="n">st</span> <span class="n">reserved</span> <span class="n">vector</span>     <span class="o">|</span> 
                             <span class="o">+-------------------------+</span> <span class="o">&lt;---</span> <span class="n">LIB_BASE</span>
                             <span class="o">|</span> <span class="mi">2</span><span class="n">nd</span> <span class="n">reserved</span> <span class="n">vector</span>     <span class="o">|</span> 
                             <span class="o">+-------------------------+</span> <span class="o">&lt;--+</span>
                             <span class="o">|</span> <span class="mi">3</span><span class="n">rd</span> <span class="n">reserved</span> <span class="n">vector</span>     <span class="o">|</span>    <span class="o">|</span> <span class="n">LIB_VECTSIZE</span>
                             <span class="o">+-------------------------+</span> <span class="o">&lt;--+</span>
                             <span class="o">|</span> <span class="mi">4</span><span class="n">th</span> <span class="n">reserved</span> <span class="n">vector</span>     <span class="o">|</span> 
                             <span class="o">+-------------------------+</span> 
                             <span class="o">|</span> <span class="mi">1</span><span class="n">st</span> <span class="n">defined</span> <span class="n">function</span>    <span class="o">|</span> 
                             <span class="o">+-------------------------+</span> <span class="o">&lt;---</span> <span class="n">LIB_USERDEF</span>
                             <span class="o">|</span> <span class="mi">2</span><span class="n">nd</span> <span class="n">defined</span> <span class="n">function</span>    <span class="o">|</span>
                             <span class="o">+-------------------------+</span>
                             <span class="o">|</span> <span class="p">[...]</span>                   <span class="o">|</span>
                             <span class="o">+-------------------------+</span>
<span class="n">First</span> <span class="n">byte</span> <span class="n">of</span> <span class="n">the</span>            <span class="o">|</span> <span class="n">End</span> <span class="n">of</span> <span class="n">the</span> <span class="n">jump</span> <span class="n">table</span>   <span class="o">|</span>
<span class="n">library</span> <span class="n">loaded</span> <span class="n">in</span> <span class="o">---------&gt;</span> <span class="o">+-------------------------+</span>
<span class="n">memory</span>                         <span class="n">LOWER</span> <span class="n">MEMORY</span> <span class="n">ADDRESSES</span>
</code></pre></div>

<p>You can find an official version of this in the <a href="http://amigadev.elowar.com/read/ADCD_2.1/AmigaMail_Vol2_guide/node0189.html">documentation</a>. Pay attention that the picture in the documentation represents memory upside down, with lower memory addresses towards the top of the page.</p>
<p>As you can see the library is loaded as expected from the base address towards the higher memory addresses, but at the same time the jump table is prefixed <em>in reverse order</em>. This is done to allow you to find the address of a function with a simple (negative) indexing instead of a more complex algorithm. Function number 1 is at address <code>-1 * address_size</code>, function number 2 at address <code>-2 * address_size</code>, etc.</p>
<p>This is why we use negative offsets to call library functions but positive ones to access the library data and structures.</p>
<p>You can also see from the figure where the Special Constants <code>LIB_BASE</code> and <code>LIB_USERDEF</code> are located. The actual values are</p>
<div class="highlight"><pre><span></span><code><span class="err">LIB_BASE    EQU -6</span>
<span class="err">LIB_USERDEF EQU -30</span>
</code></pre></div>

<p>A good definition of the <code>FUNCDEF</code> macro, thus, is the following</p>
<div class="highlight"><pre><span></span><code>    <span class="n">INCLUDE</span> <span class="ss">&quot;exec/libraries.i&quot;</span>

    <span class="n">MACRO</span>   <span class="n">FUNCDEF</span>
<span class="n">_LVO</span><span class="err">\</span><span class="mi">1</span>      <span class="n">EQU</span>      <span class="n">FUNC_CNT</span>
<span class="n">FUNC_CNT</span>    <span class="k">SET</span>      <span class="n">FUNC_CNT</span><span class="o">-</span><span class="n">LIB_VECTSIZE</span>
    <span class="n">ENDM</span>

<span class="n">FUNC_CNT</span>    <span class="k">SET</span>      <span class="n">LIB_USERDEF</span>
</code></pre></div>

<p>The last line initializes the <code>FUNC_CNT</code> symbol with the <code>LIB_USERDEF</code> value. Then each call of the <code>FUNCDEF &lt;arg&gt;</code> macro does two things:</p>
<ol>
<li>Creates the <code>_LVO&lt;arg&gt;</code> symbol with value <code>FUNC_CNT</code> (e.g. <code>_LVOSupervisor EQU -30</code>)</li>
<li>Decrements the <code>FUNC_CNT</code> symbol by <code>LIB_VECTSIZE</code></li>
</ol>
<p>Please note that the example <code>FUNCDEF</code> that you can find (commented) in <code>libraries.i</code> won't work out of the box as <code>FUNC_CNT</code> is defined inside the macro itself, while it has to be already defined before the first use of the macro.</p>
<div class="highlight"><pre><span></span><code><span class="err">*------ FUNCDEF is used to parse library offset tables.  Many applications</span>
<span class="err">*------ need a special version of FUNCDEF - you provide your own macro</span>
<span class="err">*------ to match your needs.  Here is an example:</span>
<span class="err">*</span>
<span class="err">*    FUNCDEF     MACRO</span>
<span class="err">*    _LVO\1      EQU    FUNC_CNT</span>
<span class="err">*    FUNC_CNT    SET    FUNC_CNT-6  * Standard offset-6 bytes each</span>
<span class="err">*    FUNC_CNT    EQU    LIB_USERDEF * Skip 4 standard vectors</span>
<span class="err">*                ENDM</span>
</code></pre></div>

<p>You can put the <code>FUNCDEF</code> macro code in a local include file like <code>funcdef.i</code>. Including it your code allows you to use <code>_LVO</code> prefixed labels for the functions that you want to load</p>
<div class="highlight"><pre><span></span><code>    <span class="n">INCLUDE</span> <span class="ss">&quot;funcdef.i&quot;</span>
    <span class="n">INCLUDE</span> <span class="ss">&quot;exec/exec_lib.i&quot;</span>

    <span class="k">move</span><span class="p">.</span><span class="n">l</span>  <span class="mi">4</span><span class="p">.</span><span class="n">w</span><span class="p">,</span><span class="n">a6</span>
    <span class="n">clr</span><span class="p">.</span><span class="n">l</span>   <span class="n">d0</span>
    <span class="k">move</span><span class="p">.</span><span class="n">l</span>  <span class="o">#</span><span class="n">libname</span><span class="p">,</span><span class="n">a1</span>
    <span class="n">jsr</span>     <span class="n">_LVOOpenLibrary</span><span class="p">(</span><span class="n">a6</span><span class="p">)</span>

<span class="n">libname</span><span class="p">:</span>
    <span class="n">dc</span><span class="p">.</span><span class="n">b</span> <span class="ss">&quot;somename.library&quot;</span><span class="p">,</span><span class="mi">0</span>
</code></pre></div>

<p>Finally, if you want to be even more explicit you can use the <code>CALLLIB</code> macro defined in <code>libraries.i</code> and write</p>
<div class="highlight"><pre><span></span><code>    <span class="n">INCLUDE</span> <span class="ss">&quot;funcdef.i&quot;</span>
    <span class="n">INCLUDE</span> <span class="ss">&quot;exec/exec_lib.i&quot;</span>
    <span class="n">INCLUDE</span> <span class="ss">&quot;exec/libraries.i&quot;</span>

    <span class="k">move</span><span class="p">.</span><span class="n">l</span>  <span class="mi">4</span><span class="p">.</span><span class="n">w</span><span class="p">,</span><span class="n">a6</span>
    <span class="n">clr</span><span class="p">.</span><span class="n">l</span>   <span class="n">d0</span>
    <span class="k">move</span><span class="p">.</span><span class="n">l</span>  <span class="o">#</span><span class="n">libname</span><span class="p">,</span><span class="n">a1</span>
    <span class="n">CALLLIB</span> <span class="n">_LVOOpenLibrary</span>

<span class="n">libname</span><span class="p">:</span>
    <span class="n">dc</span><span class="p">.</span><span class="n">b</span> <span class="ss">&quot;somename.library&quot;</span><span class="p">,</span><span class="mi">0</span>
</code></pre></div>

<h1 id="the-four-reserved-vectors">The four reserved vectors<a class="headerlink" href="#the-four-reserved-vectors" title="Permanent link">&para;</a></h1>
<p>As we saw, the Amiga system reserves 4 vectors at the beginning of the jump table of a library. These 4 spaces host 3 standard functions that shall be provided by any library, <code>Open()</code>, <code>Close()</code>, and <code>Expunge()</code>. The fourth slot is kept for possible future expansions and must contain a function that returns 0.</p>
<p>The offsets of these functions are contained in the <code>include_i/exec/libraries.i</code> file</p>
<div class="highlight"><pre><span></span><code><span class="o">*</span><span class="c1">----------------------------------------------------------------</span>
<span class="o">*</span>
<span class="o">*</span>   <span class="n">Standard</span> <span class="n">Library</span> <span class="n">Functions</span>
<span class="o">*</span>
<span class="o">*</span><span class="c1">----------------------------------------------------------------</span>

    <span class="n">LIBINIT</span> <span class="n">LIB_BASE</span>

    <span class="n">LIBDEF</span>  <span class="n">LIB_OPEN</span>
    <span class="n">LIBDEF</span>  <span class="n">LIB_CLOSE</span>
    <span class="n">LIBDEF</span>  <span class="n">LIB_EXPUNGE</span> <span class="p">;</span> <span class="n">must</span> <span class="n">exist</span> <span class="k">in</span> <span class="k">all</span> <span class="n">libraries</span>
    <span class="n">LIBDEF</span>  <span class="n">LIB_EXTFUNC</span> <span class="p">;</span> <span class="k">for</span> <span class="n">future</span> <span class="n">expansion</span> <span class="o">-</span> <span class="n">must</span> <span class="k">return</span> <span class="n">zero</span><span class="p">.</span>
</code></pre></div>

<p>the effect of the above macros with the previous constants is</p>
<div class="highlight"><pre><span></span><code><span class="err">LIB_OPEN        EQU     -6</span>
<span class="err">LIB_CLOSE       EQU     -12</span>
<span class="err">LIB_EXPUNGE     EQU     -18</span>
<span class="err">LIB_EXTFUNC     EQU     -24</span>
</code></pre></div>

<p>You can try to follow the definitions of the <code>LIBINIT</code> and <code>LIBDEF</code> macros to obtain the same result.</p>
<h1 id="types-and-structures">Types and structures<a class="headerlink" href="#types-and-structures" title="Permanent link">&para;</a></h1>
<p>Let's see how the Exec library defines its types, which are the base components of the Amiga system. The main entry point for this investigation is the <code>include_i/exec/types.i</code> file.</p>
<p>When working with data structures in Assembly, everything is expressed in terms of offsets. The main idea behind structures is to create something like this</p>
<div class="highlight"><pre><span></span><code><span class="err">STRUCT1         EQU     0</span>
<span class="err">OFFS            SET     0</span>
<span class="err">FIELD1          EQU     OFFS</span>
<span class="err">OFFS            EQU     OFFS+SIZE_OF_FIELD1</span>
<span class="err">FIELD2          EQU     OFFS</span>
<span class="err">OFFS            EQU     OFFS+SIZE_OF_FIELD2</span>
<span class="err">; ...</span>
<span class="err">STRUCT1_SIZE    EQU     OFFS</span>
</code></pre></div>

<p>which, once run through the macro expansion, creates the following code</p>
<div class="highlight"><pre><span></span><code><span class="err">STRUCT1         EQU     0</span>
<span class="err">FIELD1          EQU     0</span>
<span class="err">FIELD2          EQU     SIZE_OF_FIELD1</span>
<span class="err">FIIELD3         EQU     SIZE_OF_FIELD1+SIZE_OF_FIELD2</span>
<span class="err">; ...</span>
<span class="err">STRUCT1_SIZE    EQU     SIZE_OF_FIELD1+...+SIZE_OF_FIELDn</span>
</code></pre></div>

<p>So, the type macros are all defined with code like this</p>
<div class="highlight"><pre><span></span><code><span class="err">TYPENAME    MACRO</span>
<span class="err">\1          EQU     SOFFSET</span>
<span class="err">SOFFSET     SET     SOFFSET+SIZE_OF_TYPE</span>
<span class="err">            ENDM</span>
</code></pre></div>

<p>For example the <code>BYTE</code> macro is</p>
<div class="highlight"><pre><span></span><code><span class="err">BYTE        MACRO       ; byte (8 bits)</span>
<span class="err">\1          EQU     SOFFSET</span>
<span class="err">SOFFSET     SET     SOFFSET+1</span>
<span class="err">            ENDM</span>
</code></pre></div>

<p>Note that the field is defined with <code>EQU</code> to avoid unwanted overwrites, while <code>SOFFSET</code> uses <code>SET</code> that allows to redefine the symbol.</p>
<p>Let's see now how a real structure is defined. A good example is <code>LN</code> defined in <code>include_i/exec/nodes.i</code> which represents a node of a linked list.</p>
<div class="highlight"><pre><span></span><code><span class="err">   STRUCTURE    LN,0    ; List Node</span>
<span class="err">    APTR    LN_SUCC ; Pointer to next (successor)</span>
<span class="err">    APTR    LN_PRED ; Pointer to previous (predecessor)</span>
<span class="err">    UBYTE   LN_TYPE</span>
<span class="err">    BYTE    LN_PRI  ; Priority, for sorting</span>
<span class="err">    APTR    LN_NAME ; ID string, null terminated</span>
<span class="err">    LABEL   LN_SIZE ; Note: word aligned</span>
</code></pre></div>

<p>The <code>STRUCTURE</code> macro is defined in <code>types.i</code> as</p>
<div class="highlight"><pre><span></span><code><span class="err">STRUCTURE   MACRO       ; structure name, initial offset</span>
<span class="err">\1          EQU     0</span>
<span class="err">SOFFSET     SET     \2</span>
<span class="err">            ENDM</span>
</code></pre></div>

<p>And the resulting declarations, once the macros have been expanded, are the following</p>
<div class="highlight"><pre><span></span><code><span class="err">LN          EQU     0</span>
<span class="err">LN_SUCC     EQU     0</span>
<span class="err">LN_PRED     EQU     4</span>
<span class="err">LN_TYPE     EQU     8</span>
<span class="err">LN_PRI      EQU     9</span>
<span class="err">LN_NAME     EQU     10</span>
<span class="err">LN_SIZE     EQU     14</span>
</code></pre></div>

<p>As you can see the field names are just offsets inside the structure, and there is no specific padding at the end to align the structure. In this case there is no need, as the structure size is already a multiple of a word (14 bytes).</p>
<h2 id="how-to-align-structures">How to align structures<a class="headerlink" href="#how-to-align-structures" title="Permanent link">&para;</a></h2>
<p>If we need to align the bytes however we can use a little binary trick. If you ignore the least significant bit of a binary number you convert it to the nearest even number (downwards). An example in Python is</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">bin</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s1">&#39;0b1101&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">bin</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s1">&#39;0b1100&#39;</span>
</code></pre></div>

<p>You can ignore the least significant bits with a simple bitwise AND</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">bin</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
<span class="s1">&#39;0b1110&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mi">14</span><span class="o">&amp;</span><span class="mb">0b1100</span>
<span class="mi">12</span>
</code></pre></div>

<p>So if we get the current offset, we increase it by one and round down to the nearest integer we are aligning the offset to multiples of a word (2 bytes). The <code>ALIGNWORD</code> macro in the <code>include_i/exec/types.i</code> file implements exactly this algorithm</p>
<div class="highlight"><pre><span></span><code><span class="err">ALIGNWORD   MACRO       ; Align structure offset to nearest word</span>
<span class="err">SOFFSET     SET     (SOFFSET+1)&amp;$fffffffe</span>
<span class="err">            ENDM</span>
</code></pre></div>

<p>This can be seen in action in the <code>CardHandle</code> structure defined in <code>include_i/resources/card.i</code>. The same algorithm is implemented in other parts of the Kickstart code, for example in the <code>AddMemList</code> function that adds memory space to the free memory pool.</p>
<h1 id="whats-next">What's next<a class="headerlink" href="#whats-next" title="Permanent link">&para;</a></h1>
<p>The next article will describe in depth how the jump table of the Exec library is created through the <code>MakeFunctions</code> routine. This will be shown step by step discussing the reverse engineering method followed to discover the mechanism and the relevant code.</p>
<h1 id="resources">Resources<a class="headerlink" href="#resources" title="Permanent link">&para;</a></h1>
<ul>
<li>Amiga System Programmers Guide, Abacus (<a href="https://archive.org/details/Amiga_System_Programmers_Guide_1988_Abacus">pdf here</a>)</li>
<li><a href="http://amigadev.elowar.com">AmigaOS Developer Docs</a></li>
</ul>
<h1 id="feedback">Feedback<a class="headerlink" href="#feedback" title="Permanent link">&para;</a></h1>
<p>Feel free to reach me on <a href="https://twitter.com/thedigicat">Twitter</a> if you have questions. The <a href="https://github.com/TheDigitalCatOnline/thedigitalcatonline.github.com/issues">GitHub issues</a> page is the best place to submit corrections.</p>
  </section>

  <section class="footer">
    <h1>Part 2 of the Exploring the Amiga series</h1>
    <div class="box">
      <h5>Previous articles</h5>
      <ul>
        <li><a href="/blog/2018/05/28/exploring-the-amiga-1/">Exploring the Amiga - Part 1</a></li>
      </ul>
      
      <h5>Next articles</h5>
      <ul>
        <li><a href="/blog/2018/06/08/exploring-the-amiga-3/">Exploring the Amiga - Part 3</a></li>
        <li><a href="/blog/2018/06/14/exploring-the-amiga-4/">Exploring the Amiga - Part 4</a></li>
        <li><a href="/blog/2018/06/25/exploring-the-amiga-5/">Exploring the Amiga - Part 5</a></li>
        <li><a href="/blog/2018/06/25/exploring-the-amiga-6/">Exploring the Amiga - Part 6</a></li>
        <li><a href="/blog/2019/02/19/exploring-the-amiga-7/">Exploring the Amiga - Part 7</a></li>
        <li><a href="/blog/2019/02/19/exploring-the-amiga-8/">Exploring the Amiga - Part 8</a></li>
      </ul>
    </div>
  </section>

  <section class="footer">
    <h1>Related Posts</h1>
    <div class="posts mini">
      <article class="card">
        <a href="/blog/2019/02/19/exploring-the-amiga-8/" class="image">
          <img src="/images/exploring-the-amiga-8.jpg" alt="exploring-the-amiga-8" />
        </a>
        <div class="card-body">
          <a href="/blog/2019/02/19/exploring-the-amiga-8/"><h2 class="card-title">Exploring the Amiga - Part 8</h2></a>
	  <p class="article-info">
            <time datetime="2019-02-19T14:00:00+01:00">Feb 19, 2019</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/assembly/" class="tag">assembly</a>            <a href="/categories/amiga/" class="tag">amiga</a>            <a href="/categories/retroprogramming/" class="tag">retroprogramming</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2019/02/19/exploring-the-amiga-7/" class="image">
          <img src="/images/exploring-the-amiga-7.jpg" alt="exploring-the-amiga-7" />
        </a>
        <div class="card-body">
          <a href="/blog/2019/02/19/exploring-the-amiga-7/"><h2 class="card-title">Exploring the Amiga - Part 7</h2></a>
	  <p class="article-info">
            <time datetime="2019-02-19T13:00:00+01:00">Feb 19, 2019</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/assembly/" class="tag">assembly</a>            <a href="/categories/amiga/" class="tag">amiga</a>            <a href="/categories/retroprogramming/" class="tag">retroprogramming</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2018/06/25/exploring-the-amiga-6/" class="image">
          <img src="/images/exploring-the-amiga-6.jpg" alt="exploring-the-amiga-6" />
        </a>
        <div class="card-body">
          <a href="/blog/2018/06/25/exploring-the-amiga-6/"><h2 class="card-title">Exploring the Amiga - Part 6</h2></a>
	  <p class="article-info">
            <time datetime="2018-06-25T13:00:00+01:00">Jun 25, 2018</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/assembly/" class="tag">assembly</a>            <a href="/categories/amiga/" class="tag">amiga</a>            <a href="/categories/retroprogramming/" class="tag">retroprogramming</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2018/06/25/exploring-the-amiga-5/" class="image">
          <img src="/images/exploring-the-amiga-5.jpg" alt="exploring-the-amiga-5" />
        </a>
        <div class="card-body">
          <a href="/blog/2018/06/25/exploring-the-amiga-5/"><h2 class="card-title">Exploring the Amiga - Part 5</h2></a>
	  <p class="article-info">
            <time datetime="2018-06-25T12:00:00+01:00">Jun 25, 2018</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/assembly/" class="tag">assembly</a>            <a href="/categories/amiga/" class="tag">amiga</a>            <a href="/categories/retroprogramming/" class="tag">retroprogramming</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2018/06/14/exploring-the-amiga-4/" class="image">
          <img src="/images/exploring-the-amiga-4.jpg" alt="exploring-the-amiga-4" />
        </a>
        <div class="card-body">
          <a href="/blog/2018/06/14/exploring-the-amiga-4/"><h2 class="card-title">Exploring the Amiga - Part 4</h2></a>
	  <p class="article-info">
            <time datetime="2018-06-14T14:30:00+01:00">Jun 14, 2018</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/assembly/" class="tag">assembly</a>            <a href="/categories/amiga/" class="tag">amiga</a>            <a href="/categories/retroprogramming/" class="tag">retroprogramming</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2018/06/08/exploring-the-amiga-3/" class="image">
          <img src="/images/exploring-the-amiga-3.jpg" alt="exploring-the-amiga-3" />
        </a>
        <div class="card-body">
          <a href="/blog/2018/06/08/exploring-the-amiga-3/"><h2 class="card-title">Exploring the Amiga - Part 3</h2></a>
	  <p class="article-info">
            <time datetime="2018-06-08T12:30:00+01:00">Jun 8, 2018</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/assembly/" class="tag">assembly</a>            <a href="/categories/amiga/" class="tag">amiga</a>            <a href="/categories/retroprogramming/" class="tag">retroprogramming</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2018/05/28/exploring-the-amiga-1/" class="image">
          <img src="/images/exploring-the-amiga-1.jpg" alt="exploring-the-amiga-1" />
        </a>
        <div class="card-body">
          <a href="/blog/2018/05/28/exploring-the-amiga-1/"><h2 class="card-title">Exploring the Amiga - Part 1</h2></a>
	  <p class="article-info">
            <time datetime="2018-05-28T14:00:00+01:00">May 28, 2018</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/assembly/" class="tag">assembly</a>            <a href="/categories/amiga/" class="tag">amiga</a>            <a href="/categories/retroprogramming/" class="tag">retroprogramming</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2019/03/04/motorola-68000-addressing-modes/" class="image">
          <img src="/images/mc68000.jpg" alt="mc68000" />
        </a>
        <div class="card-body">
          <a href="/blog/2019/03/04/motorola-68000-addressing-modes/"><h2 class="card-title">Motorola 68000: addressing modes</h2></a>
	  <p class="article-info">
            <time datetime="2019-03-04T22:30:00+01:00">Mar 4, 2019</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/assembly/" class="tag">assembly</a>            <a href="/categories/m68000/" class="tag">M68000</a>          </p>
        </div>
      </article>
    </div>
  </section>



  <!-- </article> -->

						</div>
					</div>

				<!-- Sidebar -->
					<div id="sidebar">
<div class="inner">
    <!-- Menu -->
        <nav id="menu">
            <header class="major">
                <h2>Menu</h2>
            </header>
<ul>
    <li><a href="/index.html">Homepage</a></li>
    <li><a href="/pages/about.html">About</a></li>
    <li><a href="/archives/index.html">Archives</a></li>
</ul>        </nav>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Recent posts</h2>
            </header>
<div class="mini-posts">
    <article>
        <a href="/blog/2021/02/22/mau-a-lightweight-markup-language/" class="image"><img src="/images/mau-a-lightweight-markup-language.jpg" alt="mau-a-lightweight-markup-language" /></a>
        <p><strong>Mau: a lightweight markup language</strong> <a href="/blog/2021/02/22/mau-a-lightweight-markup-language/">Read</a></p> 
    </article>
    <article>
        <a href="/blog/2020/11/04/public-key-cryptography-ssl-certificates/" class="image"><img src="/images/public-key-cryptography-ssl-certificates.jpg" alt="public-key-cryptography-ssl-certificates" /></a>
        <p><strong>Public key cryptography: SSL certificates</strong> <a href="/blog/2020/11/04/public-key-cryptography-ssl-certificates/">Read</a></p> 
    </article>
    <article>
        <a href="/blog/2020/09/21/tdd-in-python-with-pytest-part-5/" class="image"><img src="/images/tdd-in-python-with-pytest-part-5.jpg" alt="tdd-in-python-with-pytest-part-5" /></a>
        <p><strong>TDD in Python with pytest - Part 5</strong> <a href="/blog/2020/09/21/tdd-in-python-with-pytest-part-5/">Read</a></p> 
    </article>
</div>        </section>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Categories</h2>
            </header>
<ul class="list-clean">
    <li><a href="/category/programming/">Programming</a></li>
    <li><a href="/category/projects/">Projects</a></li>
    <li><a href="/category/retro/">Retro</a></li>
</ul>
        </section>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Feeds</h2>
            </header>
<ul class="list-clean">
    <li><a href="/atom.xml"><i class="fas fa-rss"></i> All posts</a></li>


    <li><a href="/category/retro/atom.xml"><i class="fas fa-rss"></i> All posts in category: Retro</a></li>
</ul>        </section>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Tags</h2>
            </header>
<ul class="list-inline list-clean" id="tags-side">
    <li class="tag font-size-2">
        <a title="Posts about algorithms" href="/categories/algorithms/">algorithms</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about amiga" href="/categories/amiga/">amiga</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about AMQP" href="/categories/amqp/">AMQP</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about architectures" href="/categories/architectures/">architectures</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about assembly" href="/categories/assembly/">assembly</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about AWS" href="/categories/aws/">AWS</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about blogging" href="/categories/blogging/">blogging</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about C" href="/categories/c/">C</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about Clojure" href="/categories/clojure/">Clojure</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about compilers" href="/categories/compilers/">compilers</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about concurrent programming" href="/categories/concurrent-programming/">concurrent programming</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about cryptography" href="/categories/cryptography/">cryptography</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about decorators" href="/categories/decorators/">decorators</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about Django" href="/categories/django/">Django</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about Docker" href="/categories/docker/">Docker</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about editor" href="/categories/editor/">editor</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about Emacs" href="/categories/emacs/">Emacs</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about Erlang" href="/categories/erlang/">Erlang</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about Flask" href="/categories/flask/">Flask</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about functional programming" href="/categories/functional-programming/">functional programming</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about generators" href="/categories/generators/">generators</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about Git" href="/categories/git/">Git</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about HTTP" href="/categories/http/">HTTP</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about infrastructure" href="/categories/infrastructure/">infrastructure</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about JavaScript" href="/categories/javascript/">JavaScript</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about M68000" href="/categories/m68000/">M68000</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about Markdown" href="/categories/markdown/">Markdown</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about Mau" href="/categories/mau/">Mau</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about metaclasses" href="/categories/metaclasses/">metaclasses</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about metaprogramming" href="/categories/metaprogramming/">metaprogramming</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about Notebook" href="/categories/notebook/">Notebook</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about OOP" href="/categories/oop/">OOP</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about operating systems" href="/categories/operating-systems/">operating systems</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about pelican" href="/categories/pelican/">pelican</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about Pika" href="/categories/pika/">Pika</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about Postage" href="/categories/postage/">Postage</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about Postgres" href="/categories/postgres/">Postgres</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about pytest" href="/categories/pytest/">pytest</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about Python" href="/categories/python/">Python</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about Python2" href="/categories/python2/">Python2</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about Python3" href="/categories/python3/">Python3</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about RabbitMQ" href="/categories/rabbitmq/">RabbitMQ</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about refactoring" href="/categories/refactoring/">refactoring</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about retroprogramming" href="/categories/retroprogramming/">retroprogramming</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about RSA" href="/categories/rsa/">RSA</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about Scala" href="/categories/scala/">Scala</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about SSH" href="/categories/ssh/">SSH</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about SSL" href="/categories/ssl/">SSL</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about TDD" href="/categories/tdd/">TDD</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about Terraform" href="/categories/terraform/">Terraform</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about testing" href="/categories/testing/">testing</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about tools" href="/categories/tools/">tools</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about versioning" href="/categories/versioning/">versioning</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about video" href="/categories/video/">video</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about WWW" href="/categories/www/">WWW</a>
    </li>
</ul>        </section>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Get in touch</h2>
            </header>
<ul class="contact">
    
    
    
    <li class="fa-twitter"><a href="https://twitter.com/thedigicat">Twitter</a></li>
    
    
    
    
    <li class="fa-github"><a href="https://github.com/TheDigitalCatOnline">GitHub</a></li>
    
</ul>        </section>

    <!-- Footer -->
        <footer id="footer">
            <p class="copyright">Editorial theme by: <a href="https://html5up.net">HTML5 UP</a>.</p>
            <p class="copyright">Cover picture by: <a href="https://pxhere.com/en/photo/1428515">An Min @ pxhere.com</a></p>
        </footer>

</div>					</div>

			</div>

		<!-- Scripts -->
			<script src="/theme/js/jquery.min.js"></script>
			<script src="/theme/js/browser.min.js"></script>
			<script src="/theme/js/breakpoints.min.js"></script>
            <script src="/theme/js/packed.js?fa89ff81"></script>

	</body>
</html>