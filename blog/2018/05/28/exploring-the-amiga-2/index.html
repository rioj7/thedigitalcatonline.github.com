<!DOCTYPE HTML>
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
        <title>Exploring the Amiga - Part 2 - The Digital Cat</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
        <link rel="stylesheet" href="https://www.thedigitalcatonline.com/theme/css/main.css" />
        <link rel="stylesheet" href="https://www.thedigitalcatonline.com/theme/css/custom.css" />
<link rel="stylesheet" href="https://www.thedigitalcatonline.com/theme/css/retro.css" />
        
        <!-- Pygments CSS START -->
        <link rel="stylesheet" href="https://www.thedigitalcatonline.com/theme/css/pygments/default.css">
        <!-- Pygments CSS END -->

        <link href="https://www.thedigitalcatonline.com/images/TheDigitalCat_favicon_32.png" rel="icon">

        <!-- Google Analytics Universal -->
        <script type="text/javascript">
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-74364524-1', 'auto');
            ga('send', 'pageview');
        </script>
        <!-- End Google Analytics Universal Code -->

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Article",
  "name" : "Exploring the Amiga - Part 2",
  "author" : {
    "@type" : "Person",
    "name" : "Leonardo Giordani"
  },
  "publisher" : {
    "@type" : "Organization",
    "name" : "The Digital Cat",
    "logo" : {
      "@type" : "ImageObject",
      "url" : "https://www.thedigitalcatonline.com/images/TheDigitalCat_logo_200.jpg",
      "height" : 200,
      "width" : 200
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.thedigitalcatonline.com/blog/2018/05/28/exploring-the-amiga-2/"
  },
  "datePublished" : "28/05/2018",
  "dateModified" : "12/02/2019",
  "image" : "https://www.thedigitalcatonline.com/images/exploring-the-amiga-2.jpg",
  "url" : "https://www.thedigitalcatonline.com/blog/2018/05/28/exploring-the-amiga-2/"
}
</script>
	</head>
	<body class="is-preload">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Main -->
					<div id="main">
						<div class="inner">

    <header id="header">
        <a class="logo" href="https://www.thedigitalcatonline.com/category/retro/" title="Retro">All posts in category Retro <i class="fa fa-link"></i></a>
        <div class="align-right">
            
            <a href="https://www.thedigitalcatonline.com/blog/2018/05/28/exploring-the-amiga-1/"><i class="fa fa-caret-square-left"></i></a>
            
            Exploring the Amiga #2

            <a href="https://www.thedigitalcatonline.com/blog/2018/06/08/exploring-the-amiga-3/"><i class="fa fa-caret-square-right"></i></a>

        </div>
    </header>

    <!-- <article class="post"> -->

    <section id="header">
        <header class="main">
            <h1>Exploring the Amiga - Part 2</h1>
        </header>
    </section>

    <section id="post-info">
        <div class="align-center">
            <a class="button special small" href="https://www.thedigitalcatonline.com/categories/assembly/">assembly</a>            <a class="button special small" href="https://www.thedigitalcatonline.com/categories/amiga/">amiga</a>            <a class="button special small" href="https://www.thedigitalcatonline.com/categories/retroprogramming/">retroprogramming</a>        </div>

        <div class="align-center">
            By Leonardo Giordani
            <span class="separator">•</span>

            Published on <time datetime="2018-05-28T15:00:00+01:00"> 28/05/2018</time>

            <span class="separator">•</span>
            Last update on
            <time datetime="2019-02-12T20:00:00+00:00"> 12/02/2019</time>
        </div>
    </section>

    <section id="content">
        <h1 id="the-library-jump-table">The library jump table<a class="headerlink" href="#the-library-jump-table" title="Permanent link">&para;</a></h1>
<p>As already mentioned when a library is loaded in memory a jump table is created just before the library base address. This table contains the addresses of the functions exposed by the library, and Exec itself has one.</p>
<p>The jump table functions order for the Exec library is specified in one of the include files provided by the NDK, namely <code>include_i/exec/exec_lib.i</code>.</p>
<div class="highlight"><pre><span></span>    FUNCDEF Supervisor
    FUNCDEF execPrivate1
    FUNCDEF execPrivate2
    FUNCDEF execPrivate3
    ...
    FUNCDEF OpenLibrary
    ...
</pre></div>


<p>As you can see this file makes use of the <code>FUNCDEF</code> macro, which is not provided and has to be implemented by the coder. The idea of the macro is very simple: as the order of the jump table does not change we can just replace the first <code>FUNCDEF</code> with the offset of the first function in the library and then increment this offset with the default size of the jump address. The expected output of the macro is</p>
<div class="highlight"><pre><span></span>    _LVOSupervisor     EQU     -30
    _LVOexecPrivate1   EQU     -36
    _LVOexecPrivate2   EQU     -42
    _LVOexecPrivate3   EQU     -48
    ...
    _LVOOpenLibrary    EQU     -552
    ...
</pre></div>


<p>Please note that the name of the function has been replaced by another string prepending <code>_LVO</code> to avoid clashes with the actual function definition (LVO stands for Library Vector Offset).</p>
<p>The above figures come from the "Special Constants" section contained in the <code>include_i/exec/libraries.i</code> file</p>
<div class="highlight"><pre><span></span><span class="c">*------ Special Constants ---------------------------------------</span>
<span class="nv">LIB_VECTSIZE</span>    <span class="k">EQU</span> <span class="mi">6</span><span class="s">       </span><span class="c">;Each library entry takes 6 bytes</span>
<span class="nv">LIB_RESERVED</span>    <span class="k">EQU</span> <span class="mi">4</span><span class="s">       </span><span class="c">;Exec reserves the first 4 vectors</span>
<span class="nv">LIB_BASE</span>        <span class="k">EQU</span> <span class="s">-LIB_VECTSIZE</span>
<span class="nv">LIB_USERDEF</span>     <span class="k">EQU</span> <span class="s">LIB_BASE-(LIB_RESERVED*LIB_VECTSIZE) </span><span class="c">;First user func</span>
<span class="nv">LIB_NONSTD</span>      <span class="k">EQU</span> <span class="s">LIB_USERDEF</span>
</pre></div>


<p>AS you can see from the comments, Exec reserves the first 4 vectors, so the first function's address is <code>LIB_USERDEF</code>. To understand why the addresses are negative and how the offset is computed let's get a snapshot of the library once it has been loaded in memory</p>
<div class="highlight"><pre><span></span>                               <span class="n">HIGHER</span> <span class="n">MEMORY</span> <span class="n">ADDRESSES</span>
                             <span class="o">+-------------------------+</span>
<span class="n">Last</span> <span class="n">byte</span> <span class="n">of</span> <span class="n">the</span>             <span class="o">|</span> <span class="n">End</span> <span class="n">of</span> <span class="n">the</span> <span class="n">library</span>      <span class="o">|</span>
<span class="n">library</span> <span class="n">loaded</span> <span class="n">in</span> <span class="o">---------&gt;</span> <span class="o">+-------------------------+</span>
<span class="n">memory</span>                       <span class="o">|</span> <span class="p">[...]</span>                   <span class="o">|</span>
                             <span class="o">+-------------------------+</span>
                             <span class="o">|</span> <span class="n">Content</span> <span class="n">of</span> <span class="n">the</span> <span class="n">library</span>  <span class="o">|</span>
                             <span class="o">+-------------------------+</span>
                             <span class="o">|</span> <span class="n">Library</span> <span class="n">structure</span>       <span class="o">|</span>
<span class="n">Library</span> <span class="n">base</span> <span class="n">address</span> <span class="o">------&gt;</span> <span class="o">+-------------------------+</span>
                             <span class="o">|</span> <span class="mi">1</span><span class="n">st</span> <span class="n">reserved</span> <span class="n">vector</span>     <span class="o">|</span> 
                             <span class="o">+-------------------------+</span> <span class="o">&lt;---</span> <span class="n">LIB_BASE</span>
                             <span class="o">|</span> <span class="mi">2</span><span class="n">nd</span> <span class="n">reserved</span> <span class="n">vector</span>     <span class="o">|</span> 
                             <span class="o">+-------------------------+</span> <span class="o">&lt;--+</span>
                             <span class="o">|</span> <span class="mi">3</span><span class="n">rd</span> <span class="n">reserved</span> <span class="n">vector</span>     <span class="o">|</span>    <span class="o">|</span> <span class="n">LIB_VECTSIZE</span>
                             <span class="o">+-------------------------+</span> <span class="o">&lt;--+</span>
                             <span class="o">|</span> <span class="mi">4</span><span class="n">th</span> <span class="n">reserved</span> <span class="n">vector</span>     <span class="o">|</span> 
                             <span class="o">+-------------------------+</span> 
                             <span class="o">|</span> <span class="mi">1</span><span class="n">st</span> <span class="n">defined</span> <span class="n">function</span>    <span class="o">|</span> 
                             <span class="o">+-------------------------+</span> <span class="o">&lt;---</span> <span class="n">LIB_USERDEF</span>
                             <span class="o">|</span> <span class="mi">2</span><span class="n">nd</span> <span class="n">defined</span> <span class="n">function</span>    <span class="o">|</span>
                             <span class="o">+-------------------------+</span>
                             <span class="o">|</span> <span class="p">[...]</span>                   <span class="o">|</span>
                             <span class="o">+-------------------------+</span>
<span class="n">First</span> <span class="n">byte</span> <span class="n">of</span> <span class="n">the</span>            <span class="o">|</span> <span class="n">End</span> <span class="n">of</span> <span class="n">the</span> <span class="n">jump</span> <span class="n">table</span>   <span class="o">|</span>
<span class="n">library</span> <span class="n">loaded</span> <span class="n">in</span> <span class="o">---------&gt;</span> <span class="o">+-------------------------+</span>
<span class="n">memory</span>                         <span class="n">LOWER</span> <span class="n">MEMORY</span> <span class="n">ADDRESSES</span>
</pre></div>


<p>You can find an official version of this in the <a href="http://amigadev.elowar.com/read/ADCD_2.1/AmigaMail_Vol2_guide/node0189.html">documentation</a>. Pay attention that the picture in the documentation represents memory upside down, with lower memory addresses towards the top of the page.</p>
<p>As you can see the library is loaded as expected from the base address towards the higher memory addresses, but at the same time the jump table is prefixed <em>in reverse order</em>. This is done to allow you to find the address of a function with a simple (negative) indexing instead of a more complex algorithm. Function number 1 is at address <code>-1 * address_size</code>, function number 2 at address <code>-2 * address_size</code>, etc.</p>
<p>This is why we use negative offsets to call library functions but positive ones to access the library data and structures.</p>
<p>You can also see from the figure where the Special Constants <code>LIB_BASE</code> and <code>LIB_USERDEF</code> are located. The actual values are</p>
<div class="highlight"><pre><span></span><span class="nv">LIB_BASE</span>    <span class="k">EQU</span> <span class="mi">-6</span>
<span class="nv">LIB_USERDEF</span> <span class="k">EQU</span> <span class="mi">-30</span>
</pre></div>


<p>A good definition of the <code>FUNCDEF</code> macro, thus, is the following</p>
<div class="highlight"><pre><span></span>    <span class="k">INCLUDE</span> <span class="s">&quot;exec/libraries.i&quot;</span>

    <span class="k">MACRO</span>   <span class="nv">FUNCDEF</span>
<span class="nv">_LVO\1</span>      <span class="k">EQU</span>      <span class="s">FUNC_CNT</span>
<span class="nv">FUNC_CNT</span>    <span class="k">SET</span>      <span class="s">FUNC_CNT-LIB_VECTSIZE</span>
    <span class="k">ENDM</span>

<span class="nv">FUNC_CNT</span>    <span class="k">SET</span>      <span class="s">LIB_USERDEF</span>
</pre></div>


<p>The last line initializes the <code>FUNC_CNT</code> symbol with the <code>LIB_USERDEF</code> value. Then each call of the <code>FUNCDEF &lt;arg&gt;</code> macro does two things:</p>
<ol>
<li>Creates the <code>_LVO&lt;arg&gt;</code> symbol with value <code>FUNC_CNT</code> (e.g. <code>_LVOSupervisor EQU -30</code>)</li>
<li>Decrements the <code>FUNC_CNT</code> symbol by <code>LIB_VECTSIZE</code></li>
</ol>
<p>Please note that the example <code>FUNCDEF</code> that you can find (commented) in <code>libraries.i</code> won't work out of the box as <code>FUNC_CNT</code> is defined inside the macro itself, while it has to be already defined before the first use of the macro.</p>
<div class="highlight"><pre><span></span><span class="c">*------ FUNCDEF is used to parse library offset tables.  Many applications</span>
<span class="c">*------ need a special version of FUNCDEF - you provide your own macro</span>
<span class="c">*------ to match your needs.  Here is an example:</span>
<span class="c">*</span>
<span class="c">*    FUNCDEF     MACRO</span>
<span class="c">*    _LVO\1      EQU    FUNC_CNT</span>
<span class="c">*    FUNC_CNT    SET    FUNC_CNT-6  * Standard offset-6 bytes each</span>
<span class="c">*    FUNC_CNT    EQU    LIB_USERDEF * Skip 4 standard vectors</span>
<span class="c">*                ENDM</span>
</pre></div>


<p>You can put the <code>FUNCDEF</code> macro code in a local include file like <code>funcdef.i</code>. Including it your code allows you to use <code>_LVO</code> prefixed labels for the functions that you want to load</p>
<div class="highlight"><pre><span></span>    <span class="k">INCLUDE</span> <span class="s">&quot;funcdef.i&quot;</span>
    <span class="k">INCLUDE</span> <span class="s">&quot;exec/exec_lib.i&quot;</span>

    <span class="k">move.l</span>  <span class="mi">4</span><span class="p">.</span><span class="nl">w</span><span class="p">,</span><span class="nv">a6</span>
    <span class="k">clr.l</span>   <span class="nv">d0</span>
    <span class="k">move.l</span>  <span class="p">#</span><span class="nl">libname</span><span class="p">,</span><span class="nv">a1</span>
    <span class="k">jsr</span>     <span class="nl">_LVOOpenLibrary</span><span class="p">(</span><span class="nv">a6</span><span class="p">)</span>

<span class="nl">libname:</span>
    <span class="k">dc.b</span> <span class="s">&quot;somename.library&quot;,0</span>
</pre></div>


<p>Finally, if you want to be even more explicit you can use the <code>CALLLIB</code> macro defined in <code>libraries.i</code> and write</p>
<div class="highlight"><pre><span></span>    <span class="k">INCLUDE</span> <span class="s">&quot;funcdef.i&quot;</span>
    <span class="k">INCLUDE</span> <span class="s">&quot;exec/exec_lib.i&quot;</span>
    <span class="k">INCLUDE</span> <span class="s">&quot;exec/libraries.i&quot;</span>

    <span class="k">move.l</span>  <span class="mi">4</span><span class="p">.</span><span class="nl">w</span><span class="p">,</span><span class="nv">a6</span>
    <span class="k">clr.l</span>   <span class="nv">d0</span>
    <span class="k">move.l</span>  <span class="p">#</span><span class="nl">libname</span><span class="p">,</span><span class="nv">a1</span>
    <span class="nv">CALLLIB</span> <span class="s">_LVOOpenLibrary</span>

<span class="nl">libname:</span>
    <span class="k">dc.b</span> <span class="s">&quot;somename.library&quot;,0</span>
</pre></div>


<h1 id="the-four-reserved-vectors">The four reserved vectors<a class="headerlink" href="#the-four-reserved-vectors" title="Permanent link">&para;</a></h1>
<p>As we saw, the Amiga system reserves 4 vectors at the beginning of the jump table of a library. These 4 spaces host 3 standard functions that shall be provided by any library, <code>Open()</code>, <code>Close()</code>, and <code>Expunge()</code>. The fourth slot is kept for possible future expansions and must contain a function that returns 0.</p>
<p>The offsets of these functions are contained in the <code>include_i/exec/libraries.i</code> file</p>
<div class="highlight"><pre><span></span><span class="c">*----------------------------------------------------------------</span>
<span class="c">*</span>
<span class="c">*   Standard Library Functions</span>
<span class="c">*</span>
<span class="c">*----------------------------------------------------------------</span>

    <span class="nv">LIBINIT</span> <span class="s">LIB_BASE</span>

    <span class="nv">LIBDEF</span>  <span class="s">LIB_OPEN</span>
    <span class="nv">LIBDEF</span>  <span class="s">LIB_CLOSE</span>
    <span class="nv">LIBDEF</span>  <span class="s">LIB_EXPUNGE </span><span class="c">; must exist in all libraries</span>
    <span class="nv">LIBDEF</span>  <span class="s">LIB_EXTFUNC </span><span class="c">; for future expansion - must return zero.</span>
</pre></div>


<p>the effect of the above macros with the previous constants is</p>
<div class="highlight"><pre><span></span><span class="nv">LIB_OPEN</span>        <span class="k">EQU</span>     <span class="mi">-6</span>
<span class="nv">LIB_CLOSE</span>       <span class="k">EQU</span>     <span class="mi">-12</span>
<span class="nv">LIB_EXPUNGE</span>     <span class="k">EQU</span>     <span class="mi">-18</span>
<span class="nv">LIB_EXTFUNC</span>     <span class="k">EQU</span>     <span class="mi">-24</span>
</pre></div>


<p>You can try to follow the definitions of the <code>LIBINIT</code> and <code>LIBDEF</code> macros to obtain the same result.</p>
<h1 id="types-and-structures">Types and structures<a class="headerlink" href="#types-and-structures" title="Permanent link">&para;</a></h1>
<p>Let's see how the Exec library defines its types, which are the base components of the Amiga system. The main entry point for this investigation is the <code>include_i/exec/types.i</code> file.</p>
<p>When working with data structures in Assembly, everything is expressed in terms of offsets. The main idea behind structures is to create something like this</p>
<div class="highlight"><pre><span></span><span class="nv">STRUCT1</span>         <span class="k">EQU</span>     <span class="mi">0</span>
<span class="nv">OFFS</span>            <span class="k">SET</span>     <span class="mi">0</span>
<span class="nv">FIELD1</span>          <span class="k">EQU</span>     <span class="s">OFFS</span>
<span class="nv">OFFS</span>            <span class="k">EQU</span>     <span class="s">OFFS+SIZE_OF_FIELD1</span>
<span class="nv">FIELD2</span>          <span class="k">EQU</span>     <span class="s">OFFS</span>
<span class="nv">OFFS</span>            <span class="k">EQU</span>     <span class="s">OFFS+SIZE_OF_FIELD2</span><span class="c"></span>
<span class="c">; ...</span>
<span class="nv">STRUCT1_SIZE</span>    <span class="k">EQU</span>     <span class="s">OFFS</span>
</pre></div>


<p>which, once run through the macro expansion, creates the following code</p>
<div class="highlight"><pre><span></span><span class="nv">STRUCT1</span>         <span class="k">EQU</span>     <span class="mi">0</span>
<span class="nv">FIELD1</span>          <span class="k">EQU</span>     <span class="mi">0</span>
<span class="nv">FIELD2</span>          <span class="k">EQU</span>     <span class="s">SIZE_OF_FIELD1</span>
<span class="nv">FIIELD3</span>         <span class="k">EQU</span>     <span class="s">SIZE_OF_FIELD1+SIZE_OF_FIELD2</span><span class="c"></span>
<span class="c">; ...</span>
<span class="nv">STRUCT1_SIZE</span>    <span class="k">EQU</span>     <span class="s">SIZE_OF_FIELD1+</span><span class="p">...</span><span class="s">+SIZE_OF_FIELDn</span>
</pre></div>


<p>So, the type macros are all defined with code like this</p>
<div class="highlight"><pre><span></span><span class="nv">TYPENAME</span>    <span class="k">MACRO</span>
<span class="nv">\1</span>          <span class="k">EQU</span>     <span class="s">SOFFSET</span>
<span class="nv">SOFFSET</span>     <span class="k">SET</span>     <span class="s">SOFFSET+SIZE_OF_TYPE</span>
            <span class="k">ENDM</span>
</pre></div>


<p>For example the <code>BYTE</code> macro is</p>
<div class="highlight"><pre><span></span><span class="nv">BYTE</span>        <span class="k">MACRO</span>       <span class="c">; byte (8 bits)</span>
<span class="nv">\1</span>          <span class="k">EQU</span>     <span class="s">SOFFSET</span>
<span class="nv">SOFFSET</span>     <span class="k">SET</span>     <span class="s">SOFFSET+1</span>
            <span class="k">ENDM</span>
</pre></div>


<p>Note that the field is defined with <code>EQU</code> to avoid unwanted overwrites, while <code>SOFFSET</code> uses <code>SET</code> that allows to redefine the symbol.</p>
<p>Let's see now how a real structure is defined. A good example is <code>LN</code> defined in <code>include_i/exec/nodes.i</code> which represents a node of a linked list.</p>
<div class="highlight"><pre><span></span>   <span class="nv">STRUCTURE</span>    <span class="s">LN</span><span class="p">,</span><span class="mi">0</span><span class="s">    </span><span class="c">; List Node</span>
    <span class="nv">APTR</span>    <span class="s">LN_SUCC </span><span class="c">; Pointer to next (successor)</span>
    <span class="nv">APTR</span>    <span class="s">LN_PRED </span><span class="c">; Pointer to previous (predecessor)</span>
    <span class="nv">UBYTE</span>   <span class="s">LN_TYPE</span>
    <span class="nv">BYTE</span>    <span class="s">LN_PRI  </span><span class="c">; Priority, for sorting</span>
    <span class="nv">APTR</span>    <span class="s">LN_NAME </span><span class="c">; ID string, null terminated</span>
    <span class="nv">LABEL</span>   <span class="s">LN_SIZE </span><span class="c">; Note: word aligned</span>
</pre></div>


<p>The <code>STRUCTURE</code> macro is defined in <code>types.i</code> as</p>
<div class="highlight"><pre><span></span><span class="nv">STRUCTURE</span>   <span class="k">MACRO</span>       <span class="c">; structure name, initial offset</span>
<span class="nv">\1</span>          <span class="k">EQU</span>     <span class="mi">0</span>
<span class="nv">SOFFSET</span>     <span class="k">SET</span>     <span class="nv">\2</span>
            <span class="k">ENDM</span>
</pre></div>


<p>And the resulting declarations, once the macros have been expanded, are the following</p>
<div class="highlight"><pre><span></span><span class="nv">LN</span>          <span class="k">EQU</span>     <span class="mi">0</span>
<span class="nv">LN_SUCC</span>     <span class="k">EQU</span>     <span class="mi">0</span>
<span class="nv">LN_PRED</span>     <span class="k">EQU</span>     <span class="mi">4</span>
<span class="nv">LN_TYPE</span>     <span class="k">EQU</span>     <span class="mi">8</span>
<span class="nv">LN_PRI</span>      <span class="k">EQU</span>     <span class="mi">9</span>
<span class="nv">LN_NAME</span>     <span class="k">EQU</span>     <span class="mi">10</span>
<span class="nv">LN_SIZE</span>     <span class="k">EQU</span>     <span class="mi">14</span>
</pre></div>


<p>As you can see the field names are just offsets inside the structure, and there is no specific padding at the end to align the structure. In this case there is no need, as the structure size is already a multiple of a word (14 bytes).</p>
<h2 id="how-to-align-structures">How to align structures<a class="headerlink" href="#how-to-align-structures" title="Permanent link">&para;</a></h2>
<p>If we need to align the bytes however we can use a little binary trick. If you ignore the least significant bit of a binary number you convert it to the nearest even number (downwards). An example in Python is</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="nb">bin</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s1">&#39;0b1101&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">bin</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s1">&#39;0b1100&#39;</span>
</pre></div>


<p>You can ignore the least significant bits with a simple bitwise AND</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="nb">bin</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
<span class="s1">&#39;0b1110&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="mi">14</span><span class="o">&amp;</span><span class="mb">0b1100</span>
<span class="mi">12</span>
</pre></div>


<p>So if we get the current offset, we increase it by one and round down to the nearest integer we are aligning the offset to multiples of a word (2 bytes). The <code>ALIGNWORD</code> macro in the <code>include_i/exec/types.i</code> file implements exactly this algorithm</p>
<div class="highlight"><pre><span></span><span class="nv">ALIGNWORD</span>   <span class="k">MACRO</span>       <span class="c">; Align structure offset to nearest word</span>
<span class="nv">SOFFSET</span>     <span class="k">SET</span>     <span class="s">(SOFFSET+1)&amp;</span><span class="mi">$fffffffe</span>
            <span class="k">ENDM</span>
</pre></div>


<p>This can be seen in action in the <code>CardHandle</code> structure defined in <code>include_i/resources/card.i</code>. The same algorithm is implemented in other parts of the Kickstart code, for example in the <code>AddMemList</code> function that adds memory space to the free memory pool.</p>
<h1 id="whats-next">What's next<a class="headerlink" href="#whats-next" title="Permanent link">&para;</a></h1>
<p>The next article will describe in depth how the jump table of the Exec library is created through the <code>MakeFunctions</code> routine. This will be shown step by step discussing the reverse engineering method followed to discover the mechanism and the relevant code.</p>
<h1 id="resources">Resources<a class="headerlink" href="#resources" title="Permanent link">&para;</a></h1>
<ul>
<li>Amiga System Programmers Guide, Abacus (<a href="https://archive.org/details/Amiga_System_Programmers_Guide_1988_Abacus">pdf here</a>)</li>
<li><a href="http://amigadev.elowar.com">AmigaOS Developer Docs</a></li>
</ul>
<h1 id="feedback">Feedback<a class="headerlink" href="#feedback" title="Permanent link">&para;</a></h1>
<p>Feel free to reach me on <a href="https://twitter.com/thedigicat">Twitter</a> if you have questions. The <a href="https://github.com/TheDigitalCatOnline/thedigitalcatonline.github.com/issues">GitHub issues</a> page is the best place to submit corrections.</p>
    </section>

    <section id="related">

        <h1>Part 2 of the Exploring the Amiga series</h1>
        <div class="box">
            <h5>Previous articles</h5>
            <ul>
                <li><a href="https://www.thedigitalcatonline.com/blog/2018/05/28/exploring-the-amiga-1/">Exploring the Amiga - Part 1</a></li>
            </ul>
        
            <h5>Next articles</h5>
            <ul>
                <li><a href="https://www.thedigitalcatonline.com/blog/2018/06/08/exploring-the-amiga-3/">Exploring the Amiga - Part 3</a></li>
                <li><a href="https://www.thedigitalcatonline.com/blog/2018/06/14/exploring-the-amiga-4/">Exploring the Amiga - Part 4</a></li>
                <li><a href="https://www.thedigitalcatonline.com/blog/2018/06/25/exploring-the-amiga-5/">Exploring the Amiga - Part 5</a></li>
                <li><a href="https://www.thedigitalcatonline.com/blog/2018/06/25/exploring-the-amiga-6/">Exploring the Amiga - Part 6</a></li>
                <li><a href="https://www.thedigitalcatonline.com/blog/2019/02/19/exploring-the-amiga-7/">Exploring the Amiga - Part 7</a></li>
                <li><a href="https://www.thedigitalcatonline.com/blog/2019/02/19/exploring-the-amiga-8/">Exploring the Amiga - Part 8</a></li>
            </ul>
        </div>
    </section>



    <!-- </article> -->

						</div>
					</div>

				<!-- Sidebar -->
					<div id="sidebar">
<div class="inner">
    <!-- Menu -->
        <nav id="menu">
            <header class="major">
                <h2>Menu</h2>
            </header>
<ul>
    <li><a href="https://www.thedigitalcatonline.com/index.html">Homepage</a></li>
    <li><a href="https://www.thedigitalcatonline.com/pages/about.html">About</a></li>
    <li><a href="https://www.thedigitalcatonline.com/archives/">Archives</a></li>
    <li>
        <span class="opener">Categories</span>
        <ul>
            <li><a href="https://www.thedigitalcatonline.com/category/programming/">Programming</a></li>
            <li><a href="https://www.thedigitalcatonline.com/category/projects/">Projects</a></li>
            <li><a href="https://www.thedigitalcatonline.com/category/retro/">Retro</a></li>
        </ul>
    </li>
</ul>        </nav>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Feeds</h2>
            </header>
<ul class="list-clean">
    <li><a href="https://www.thedigitalcatonline.com/atom.xml"><i class="fa fa-rss"></i> All posts</a></li>


    <li><a href="https://www.thedigitalcatonline.com/category/retro/atom.xml"><i class="fa fa-rss"></i> All posts in category: Retro</a></li>
</ul>        </section>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Tags</h2>
            </header>
<ul class="list-inline list-clean" id="tags-side">
    <li class="tag font-size-3">
        <a href="https://www.thedigitalcatonline.com/categories/algorithms/">algorithms</a>
    </li>
    <li class="tag font-size-2">
        <a href="https://www.thedigitalcatonline.com/categories/amiga/">amiga</a>
    </li>
    <li class="tag font-size-4">
        <a href="https://www.thedigitalcatonline.com/categories/amqp/">AMQP</a>
    </li>
    <li class="tag font-size-3">
        <a href="https://www.thedigitalcatonline.com/categories/architectures/">architectures</a>
    </li>
    <li class="tag font-size-2">
        <a href="https://www.thedigitalcatonline.com/categories/assembly/">assembly</a>
    </li>
    <li class="tag font-size-2">
        <a href="https://www.thedigitalcatonline.com/categories/c/">C</a>
    </li>
    <li class="tag font-size-4">
        <a href="https://www.thedigitalcatonline.com/categories/clojure/">Clojure</a>
    </li>
    <li class="tag font-size-2">
        <a href="https://www.thedigitalcatonline.com/categories/compilers/">compilers</a>
    </li>
    <li class="tag font-size-2">
        <a href="https://www.thedigitalcatonline.com/categories/concurrent-programming/">concurrent programming</a>
    </li>
    <li class="tag font-size-4">
        <a href="https://www.thedigitalcatonline.com/categories/cryptography/">cryptography</a>
    </li>
    <li class="tag font-size-2">
        <a href="https://www.thedigitalcatonline.com/categories/decorators/">decorators</a>
    </li>
    <li class="tag font-size-3">
        <a href="https://www.thedigitalcatonline.com/categories/django/">Django</a>
    </li>
    <li class="tag font-size-3">
        <a href="https://www.thedigitalcatonline.com/categories/erlang/">Erlang</a>
    </li>
    <li class="tag font-size-1">
        <a href="https://www.thedigitalcatonline.com/categories/functional-programming/">functional programming</a>
    </li>
    <li class="tag font-size-3">
        <a href="https://www.thedigitalcatonline.com/categories/generators/">generators</a>
    </li>
    <li class="tag font-size-3">
        <a href="https://www.thedigitalcatonline.com/categories/git/">Git</a>
    </li>
    <li class="tag font-size-4">
        <a href="https://www.thedigitalcatonline.com/categories/m68000/">M68000</a>
    </li>
    <li class="tag font-size-2">
        <a href="https://www.thedigitalcatonline.com/categories/metaclasses/">metaclasses</a>
    </li>
    <li class="tag font-size-2">
        <a href="https://www.thedigitalcatonline.com/categories/metaprogramming/">metaprogramming</a>
    </li>
    <li class="tag font-size-3">
        <a href="https://www.thedigitalcatonline.com/categories/notebook/">Notebook</a>
    </li>
    <li class="tag font-size-1">
        <a href="https://www.thedigitalcatonline.com/categories/oop/">OOP</a>
    </li>
    <li class="tag font-size-2">
        <a href="https://www.thedigitalcatonline.com/categories/operating-systems/">operating systems</a>
    </li>
    <li class="tag font-size-4">
        <a href="https://www.thedigitalcatonline.com/categories/pika/">Pika</a>
    </li>
    <li class="tag font-size-4">
        <a href="https://www.thedigitalcatonline.com/categories/postage/">Postage</a>
    </li>
    <li class="tag font-size-1">
        <a href="https://www.thedigitalcatonline.com/categories/python/">Python</a>
    </li>
    <li class="tag font-size-2">
        <a href="https://www.thedigitalcatonline.com/categories/python2/">Python2</a>
    </li>
    <li class="tag font-size-1">
        <a href="https://www.thedigitalcatonline.com/categories/python3/">Python3</a>
    </li>
    <li class="tag font-size-3">
        <a href="https://www.thedigitalcatonline.com/categories/rabbitmq/">RabbitMQ</a>
    </li>
    <li class="tag font-size-4">
        <a href="https://www.thedigitalcatonline.com/categories/refactoring/">refactoring</a>
    </li>
    <li class="tag font-size-2">
        <a href="https://www.thedigitalcatonline.com/categories/retroprogramming/">retroprogramming</a>
    </li>
    <li class="tag font-size-4">
        <a href="https://www.thedigitalcatonline.com/categories/rsa/">RSA</a>
    </li>
    <li class="tag font-size-1">
        <a href="https://www.thedigitalcatonline.com/categories/scala/">Scala</a>
    </li>
    <li class="tag font-size-4">
        <a href="https://www.thedigitalcatonline.com/categories/ssh/">SSH</a>
    </li>
    <li class="tag font-size-4">
        <a href="https://www.thedigitalcatonline.com/categories/ssl/">SSL</a>
    </li>
    <li class="tag font-size-1">
        <a href="https://www.thedigitalcatonline.com/categories/tdd/">TDD</a>
    </li>
    <li class="tag font-size-1">
        <a href="https://www.thedigitalcatonline.com/categories/testing/">testing</a>
    </li>
    <li class="tag font-size-3">
        <a href="https://www.thedigitalcatonline.com/categories/versioning/">versioning</a>
    </li>
</ul>        </section>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Other posts</h2>
            </header>
<div class="mini-posts">
    <article>
        <a href="https://www.thedigitalcatonline.com/blog/2019/02/19/exploring-the-amiga-8/" class="image"><img src="/images/exploring-the-amiga-8.jpg" alt="exploring-the-amiga-8" /></a>
        <p><strong>Exploring the Amiga - Part 8</strong> <a href="https://www.thedigitalcatonline.com/blog/2019/02/19/exploring-the-amiga-8/">Read</a></p> 
    </article>
    <article>
        <a href="https://www.thedigitalcatonline.com/blog/2019/02/19/exploring-the-amiga-7/" class="image"><img src="/images/exploring-the-amiga-7.jpg" alt="exploring-the-amiga-7" /></a>
        <p><strong>Exploring the Amiga - Part 7</strong> <a href="https://www.thedigitalcatonline.com/blog/2019/02/19/exploring-the-amiga-7/">Read</a></p> 
    </article>
    <article>
        <a href="https://www.thedigitalcatonline.com/blog/2018/06/25/exploring-the-amiga-6/" class="image"><img src="/images/exploring-the-amiga-6.jpg" alt="exploring-the-amiga-6" /></a>
        <p><strong>Exploring the Amiga - Part 6</strong> <a href="https://www.thedigitalcatonline.com/blog/2018/06/25/exploring-the-amiga-6/">Read</a></p> 
    </article>
</div>        </section>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Get in touch</h2>
            </header>
<ul class="contact">
    
    
    
    <li class="fa-twitter"><a href="https://twitter.com/thedigicat">Twitter</a></li>
    
    
    
    
    <li class="fa-github"><a href="https://github.com/TheDigitalCatOnline">GitHub</a></li>
    
</ul>        </section>

    <!-- Footer -->
        <footer id="footer">
            <p class="copyright">Editorial theme by: <a href="https://html5up.net">HTML5 UP</a>.</p>
            <p class="copyright">Cover picture by: <a href="https://pxhere.com/en/photo/1428515">An Min @ pxhere.com</a></p>
        </footer>

</div>					</div>

			</div>

		<!-- Scripts -->
			<script src="https://www.thedigitalcatonline.com/theme/js/jquery.min.js"></script>
			<script src="https://www.thedigitalcatonline.com/theme/js/browser.min.js"></script>
			<script src="https://www.thedigitalcatonline.com/theme/js/breakpoints.min.js"></script>
			<script src="https://www.thedigitalcatonline.com/theme/js/util.js"></script>
			<script src="https://www.thedigitalcatonline.com/theme/js/main.js"></script>

	</body>
</html>