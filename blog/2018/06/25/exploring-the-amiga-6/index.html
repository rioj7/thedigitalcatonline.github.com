<!DOCTYPE HTML>
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
        <title>Exploring the Amiga - Part 6 - The Digital Cat</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<meta name="description" content="A review of the functions that perform memory management in Kickstart 1.3">
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@thedigicat" />
<meta name="twitter:title" content="Exploring the Amiga - Part 6" />
<meta name="twitter:description" content="A review of the functions that perform memory management in Kickstart 1.3" />
<meta name="twitter:image" content="https://www.thedigitalcatonline.com/images/exploring-the-amiga-6.jpg" />
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,400italic,600italic|Roboto+Slab:400,700">

        <link rel="stylesheet" href="/theme/css/main.min.css?8201b720">

<link rel="stylesheet" href="/theme/css/retro.min.css?d93687f1">
        
        <link href="/images/global/favicon.jpg" rel="icon">

        <!-- Google Analytics Universal -->
        <script type="text/javascript">
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-74364524-1', 'auto');
            ga('send', 'pageview');
        </script>
        <!-- End Google Analytics Universal Code -->

<script type="application/ld+json">
{
  "@context" : "https://schema.org",
  "@type" : "Article",
  "name" : "Exploring the Amiga - Part 6",
  "author" : {
    "@type" : "Person",
    "name" : "Leonardo Giordani"
  },
  "publisher" : {
    "@type" : "Organization",
    "name" : "The Digital Cat",
    "logo" : {
      "@type" : "ImageObject",
      "url" : "https://www.thedigitalcatonline.com/images/global/logo_200.jpg",
      "height" : 200,
      "width" : 200
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.thedigitalcatonline.com/blog/2018/06/25/exploring-the-amiga-6/"
  },
  "datePublished" : "25/06/2018",
  "dateModified" : "12/02/2019",
  "image" : "https://www.thedigitalcatonline.com/images/exploring-the-amiga-6.jpg",
  "description" : "A review of the functions that perform memory management in Kickstart 1.3",
  "headline" : "A review of the functions that perform memory management in Kickstart 1.3",
  "url" : "https://www.thedigitalcatonline.com/blog/2018/06/25/exploring-the-amiga-6/"
}
</script>
	</head>
	<body class="is-preload">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Main -->
					<div id="main">
						<div class="inner">

    <header id="header">
        <a class="logo" href="/category/retro/" title="Retro">All posts in category Retro <i class="fa fa-link"></i></a>
        <div class="align-right">
            
            <a href="/blog/2018/06/25/exploring-the-amiga-5/"><i class="fa fa-caret-square-left"></i></a>
            
            Exploring the Amiga #6

            <a href="/blog/2019/02/19/exploring-the-amiga-7/"><i class="fa fa-caret-square-right"></i></a>

        </div>
    </header>

    <!-- <article class="post"> -->

    <section id="header">
        <header class="main">
            <h1>Exploring the Amiga - Part 6</h1>
        </header>
    </section>

    <section id="post-info">
        <div class="align-center">
            <a class="button small" href="/categories/assembly/">assembly</a>            <a class="button small" href="/categories/amiga/">amiga</a>            <a class="button small" href="/categories/retroprogramming/">retroprogramming</a>        </div>

        <div class="align-center">
            By Leonardo Giordani
            <span class="separator">•</span>

            Published on <time datetime="2018-06-25T13:00:00+01:00"> 25/06/2018</time>

            <span class="separator">•</span>
            Last update on
            <time datetime="2019-02-12T20:00:00+00:00"> 12/02/2019</time>
        </div>
    </section>

    <section id="content">
        <h1 id="memory-initialisation">Memory initialisation<a class="headerlink" href="#memory-initialisation" title="Permanent link">&para;</a></h1>
<p>The Amiga has two types of memory. The first one is found on-board and it is traditionally referred to as "Chip Memory". This name comes from the fact that both the CPU and the custom chips have access to it, which also means that all this components have to share the access. This slows down the CPU when the custom chips are using the memory. While they can use DMA to access it without blocking the CPU, the memory cannot be accessed by multiple components at the same time.</p>
<p>The second type of memory is called "Fast Memory" because the CPU has exclusive access to it, thus providing better performances. It is also referred to as "expansion memory" since it comes with expansion boards.</p>
<p>At a certain point during boot time Kickstart figures out the types of memory installed in the Amiga machine and puts the expansion memory size in <code>a4</code>. If this register contains a non-zero value, Kickstart knows that an expansion board has been installed and configures the memory accordingly.</p>
<p>The memory initialisation code is the following</p>
<div class="highlight"><pre><span></span><span class="mi">00000380</span><span class="o">:</span> <span class="mi">200</span><span class="n">c</span>                      <span class="n">move</span><span class="o">.</span><span class="na">l</span>  <span class="n">a4</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">00000382</span><span class="o">:</span> <span class="mi">6724</span>                      <span class="n">beq</span><span class="o">.</span><span class="na">b</span>   <span class="mh">0x3a8</span>
<span class="mi">00000384</span><span class="o">:</span> <span class="mi">41</span><span class="n">ee</span> <span class="mi">024</span><span class="n">c</span>                 <span class="n">lea</span>     <span class="mh">0x24c</span><span class="o">(</span><span class="n">a6</span><span class="o">),</span><span class="n">a0</span>
<span class="mi">00000388</span><span class="o">:</span> <span class="mi">43</span><span class="n">fa</span> <span class="n">ffa8</span>                 <span class="n">lea</span>     <span class="mh">0x332</span><span class="o">(</span><span class="n">pc</span><span class="o">),</span><span class="n">a1</span>
<span class="mi">0000038</span><span class="n">c</span><span class="o">:</span> <span class="mi">7400</span>                      <span class="n">moveq</span>   <span class="err">#</span><span class="mi">0</span><span class="o">,</span><span class="n">d2</span>
<span class="mi">0000038</span><span class="n">e</span><span class="o">:</span> <span class="mi">323</span><span class="n">c</span> <span class="mi">0005</span>                 <span class="n">move</span><span class="o">.</span><span class="na">w</span>  <span class="err">#</span><span class="mh">0x5</span><span class="o">,</span><span class="n">d1</span>
<span class="mi">00000392</span><span class="o">:</span> <span class="mi">200</span><span class="n">c</span>                      <span class="n">move</span><span class="o">.</span><span class="na">l</span>  <span class="n">a4</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">00000394</span><span class="o">:</span> <span class="mi">9088</span>                      <span class="n">sub</span><span class="o">.</span><span class="na">l</span>   <span class="n">a0</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">00000396</span><span class="o">:</span> <span class="mi">0480</span> <span class="mi">0000</span> <span class="mi">1800</span>            <span class="n">subi</span><span class="o">.</span><span class="na">l</span>  <span class="err">#</span><span class="mh">0x1800</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">0000039</span><span class="n">c</span><span class="o">:</span> <span class="mi">6100</span> <span class="mi">1688</span>                 <span class="n">bsr</span><span class="o">.</span><span class="na">w</span>   <span class="mh">0x1a26</span>
<span class="mi">000003</span><span class="n">a0</span><span class="o">:</span> <span class="mi">41</span><span class="n">f8</span> <span class="mi">0400</span>                 <span class="n">lea</span>     <span class="mh">0x400</span><span class="o">.</span><span class="na">w</span><span class="o">,</span><span class="n">a0</span>
<span class="mi">000003</span><span class="n">a4</span><span class="o">:</span> <span class="mi">7000</span>                      <span class="n">moveq</span>   <span class="err">#</span><span class="mi">0</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">000003</span><span class="n">a6</span><span class="o">:</span> <span class="mi">600</span><span class="n">a</span>                      <span class="n">bra</span><span class="o">.</span><span class="na">b</span>   <span class="mh">0x3b2</span>
<span class="mi">000003</span><span class="n">a8</span><span class="o">:</span> <span class="mi">41</span><span class="n">ee</span> <span class="mi">024</span><span class="n">c</span>                 <span class="n">lea</span>     <span class="mh">0x24c</span><span class="o">(</span><span class="n">a6</span><span class="o">),</span><span class="n">a0</span>
<span class="mi">000003</span><span class="n">ac</span><span class="o">:</span> <span class="mi">203</span><span class="n">c</span> <span class="n">ffff</span> <span class="n">e800</span>            <span class="n">move</span><span class="o">.</span><span class="na">l</span>  <span class="err">#</span><span class="o">-</span><span class="mh">0x1800</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">000003</span><span class="n">b2</span><span class="o">:</span> <span class="mi">323</span><span class="n">c</span> <span class="mi">0003</span>                 <span class="n">move</span><span class="o">.</span><span class="na">w</span>  <span class="err">#</span><span class="mh">0x3</span><span class="o">,</span><span class="n">d1</span>
<span class="mi">000003</span><span class="n">b6</span><span class="o">:</span> <span class="mi">2448</span>                      <span class="n">movea</span><span class="o">.</span><span class="na">l</span> <span class="n">a0</span><span class="o">,</span><span class="n">a2</span>
<span class="mi">000003</span><span class="n">b8</span><span class="o">:</span> <span class="mi">43</span><span class="n">fa</span> <span class="n">ff6c</span>                 <span class="n">lea</span>     <span class="mh">0x326</span><span class="o">(</span><span class="n">pc</span><span class="o">),</span><span class="n">a1</span>
<span class="mi">000003</span><span class="n">bc</span><span class="o">:</span> <span class="mi">74</span><span class="n">f6</span>                      <span class="n">moveq</span>   <span class="err">#</span><span class="o">-</span><span class="mh">0xa</span><span class="o">,</span><span class="n">d2</span>
<span class="mi">000003</span><span class="n">be</span><span class="o">:</span> <span class="n">d08b</span>                      <span class="n">add</span><span class="o">.</span><span class="na">l</span>   <span class="n">a3</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">000003</span><span class="n">c0</span><span class="o">:</span> <span class="mi">9088</span>                      <span class="n">sub</span><span class="o">.</span><span class="na">l</span>   <span class="n">a0</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">000003</span><span class="n">c2</span><span class="o">:</span> <span class="mi">6100</span> <span class="mi">1662</span>                 <span class="n">bsr</span><span class="o">.</span><span class="na">w</span>   <span class="mh">0x1a26</span>
<span class="mi">000003</span><span class="n">c6</span><span class="o">:</span> <span class="mi">224</span><span class="n">e</span>                      <span class="n">movea</span><span class="o">.</span><span class="na">l</span> <span class="n">a6</span><span class="o">,</span><span class="n">a1</span>
<span class="mi">000003</span><span class="n">c8</span><span class="o">:</span> <span class="mi">6100</span> <span class="mi">107</span><span class="n">e</span>                 <span class="n">bsr</span><span class="o">.</span><span class="na">w</span>   <span class="mh">0x1448</span>
</pre></div>


<p>As I did in the previous post I will split the code in parts and replace some addresses with labels to try and make the routine more understandable</p>
<div class="highlight"><pre><span></span><span class="n">Check_expansion</span><span class="o">:</span>
<span class="mi">00000380</span><span class="o">:</span> <span class="mi">200</span><span class="n">c</span>                      <span class="n">move</span><span class="o">.</span><span class="na">l</span>  <span class="n">a4</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">00000382</span><span class="o">:</span> <span class="mi">6724</span>                      <span class="n">beq</span><span class="o">.</span><span class="na">b</span>   <span class="n">Only_chip</span>

<span class="n">Add_expansion</span><span class="o">:</span>
<span class="mi">00000384</span><span class="o">:</span> <span class="mi">41</span><span class="n">ee</span> <span class="mi">024</span><span class="n">c</span>                 <span class="n">lea</span>     <span class="mh">0x24c</span><span class="o">(</span><span class="n">a6</span><span class="o">),</span><span class="n">a0</span>
<span class="mi">00000388</span><span class="o">:</span> <span class="mi">43</span><span class="n">fa</span> <span class="n">ffa8</span>                 <span class="n">lea</span>     <span class="mh">0x332</span><span class="o">(</span><span class="n">pc</span><span class="o">),</span><span class="n">a1</span>
<span class="mi">0000038</span><span class="n">c</span><span class="o">:</span> <span class="mi">7400</span>                      <span class="n">moveq</span>   <span class="err">#</span><span class="mi">0</span><span class="o">,</span><span class="n">d2</span>
<span class="mi">0000038</span><span class="n">e</span><span class="o">:</span> <span class="mi">323</span><span class="n">c</span> <span class="mi">0005</span>                 <span class="n">move</span><span class="o">.</span><span class="na">w</span>  <span class="err">#</span><span class="mh">0x5</span><span class="o">,</span><span class="n">d1</span>
<span class="mi">00000392</span><span class="o">:</span> <span class="mi">200</span><span class="n">c</span>                      <span class="n">move</span><span class="o">.</span><span class="na">l</span>  <span class="n">a4</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">00000394</span><span class="o">:</span> <span class="mi">9088</span>                      <span class="n">sub</span><span class="o">.</span><span class="na">l</span>   <span class="n">a0</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">00000396</span><span class="o">:</span> <span class="mi">0480</span> <span class="mi">0000</span> <span class="mi">1800</span>            <span class="n">subi</span><span class="o">.</span><span class="na">l</span>  <span class="err">#</span><span class="mh">0x1800</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">0000039</span><span class="n">c</span><span class="o">:</span> <span class="mi">6100</span> <span class="mi">1688</span>                 <span class="n">bsr</span><span class="o">.</span><span class="na">w</span>   <span class="mh">0x1a26</span>
<span class="mi">000003</span><span class="n">a0</span><span class="o">:</span> <span class="mi">41</span><span class="n">f8</span> <span class="mi">0400</span>                 <span class="n">lea</span>     <span class="mh">0x400</span><span class="o">.</span><span class="na">w</span><span class="o">,</span><span class="n">a0</span>
<span class="mi">000003</span><span class="n">a4</span><span class="o">:</span> <span class="mi">7000</span>                      <span class="n">moveq</span>   <span class="err">#</span><span class="mi">0</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">000003</span><span class="n">a6</span><span class="o">:</span> <span class="mi">600</span><span class="n">a</span>                      <span class="n">bra</span><span class="o">.</span><span class="na">b</span>   <span class="n">Add_chip</span>

<span class="n">Only_chip</span><span class="o">:</span>
<span class="mi">000003</span><span class="n">a8</span><span class="o">:</span> <span class="mi">41</span><span class="n">ee</span> <span class="mi">024</span><span class="n">c</span>                 <span class="n">lea</span>     <span class="mh">0x24c</span><span class="o">(</span><span class="n">a6</span><span class="o">),</span><span class="n">a0</span>
<span class="mi">000003</span><span class="n">ac</span><span class="o">:</span> <span class="mi">203</span><span class="n">c</span> <span class="n">ffff</span> <span class="n">e800</span>            <span class="n">move</span><span class="o">.</span><span class="na">l</span>  <span class="err">#</span><span class="o">-</span><span class="mh">0x1800</span><span class="o">,</span><span class="n">d0</span>

<span class="n">Add_chip</span><span class="o">:</span>
<span class="mi">000003</span><span class="n">b2</span><span class="o">:</span> <span class="mi">323</span><span class="n">c</span> <span class="mi">0003</span>                 <span class="n">move</span><span class="o">.</span><span class="na">w</span>  <span class="err">#</span><span class="mh">0x3</span><span class="o">,</span><span class="n">d1</span>
<span class="mi">000003</span><span class="n">b6</span><span class="o">:</span> <span class="mi">2448</span>                      <span class="n">movea</span><span class="o">.</span><span class="na">l</span> <span class="n">a0</span><span class="o">,</span><span class="n">a2</span>
<span class="mi">000003</span><span class="n">b8</span><span class="o">:</span> <span class="mi">43</span><span class="n">fa</span> <span class="n">ff6c</span>                 <span class="n">lea</span>     <span class="mh">0x326</span><span class="o">(</span><span class="n">pc</span><span class="o">),</span><span class="n">a1</span>
<span class="mi">000003</span><span class="n">bc</span><span class="o">:</span> <span class="mi">74</span><span class="n">f6</span>                      <span class="n">moveq</span>   <span class="err">#</span><span class="o">-</span><span class="mh">0xa</span><span class="o">,</span><span class="n">d2</span>
<span class="mi">000003</span><span class="n">be</span><span class="o">:</span> <span class="n">d08b</span>                      <span class="n">add</span><span class="o">.</span><span class="na">l</span>   <span class="n">a3</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">000003</span><span class="n">c0</span><span class="o">:</span> <span class="mi">9088</span>                      <span class="n">sub</span><span class="o">.</span><span class="na">l</span>   <span class="n">a0</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">000003</span><span class="n">c2</span><span class="o">:</span> <span class="mi">6100</span> <span class="mi">1662</span>                 <span class="n">bsr</span><span class="o">.</span><span class="na">w</span>   <span class="mh">0x1a26</span>
<span class="mi">000003</span><span class="n">c6</span><span class="o">:</span> <span class="mi">224</span><span class="n">e</span>                      <span class="n">movea</span><span class="o">.</span><span class="na">l</span> <span class="n">a6</span><span class="o">,</span><span class="n">a1</span>
<span class="mi">000003</span><span class="n">c8</span><span class="o">:</span> <span class="mi">6100</span> <span class="mi">107</span><span class="n">e</span>                 <span class="n">bsr</span><span class="o">.</span><span class="na">w</span>   <span class="mh">0x1448</span>
</pre></div>


<p>The two addresses <code>0x326</code> and <code>0x332</code> mentioned in the code contain the two zero-terminated strings <code>Chip Memory</code> and <code>Fast Memory</code></p>
<div class="highlight"><pre><span></span><span class="o">;</span> <span class="err">################################################################</span>
<span class="o">;</span> <span class="s1">&#39;Chip Memory&#39;</span> <span class="nt">string</span>

<span class="nt">00000326</span><span class="o">:</span> <span class="nt">43</span> <span class="o">;</span> <span class="nt">C</span>
<span class="nt">00000327</span><span class="o">:</span> <span class="nt">68</span> <span class="o">;</span> <span class="nt">h</span>
<span class="nt">00000328</span><span class="o">:</span> <span class="nt">69</span> <span class="o">;</span> <span class="nt">i</span>
<span class="nt">00000329</span><span class="o">:</span> <span class="nt">70</span> <span class="o">;</span> <span class="nt">p</span>
<span class="nt">0000032a</span><span class="o">:</span> <span class="nt">20</span> <span class="o">;</span> <span class="nt">SP</span>
<span class="nt">0000032b</span><span class="o">:</span> <span class="nt">4d</span> <span class="o">;</span> <span class="nt">M</span>
<span class="nt">0000032c</span><span class="o">:</span> <span class="nt">65</span> <span class="o">;</span> <span class="nt">e</span>
<span class="nt">0000032d</span><span class="o">:</span> <span class="nt">6d</span> <span class="o">;</span> <span class="nt">m</span>
<span class="nt">0000032e</span><span class="o">:</span> <span class="nt">6f</span> <span class="o">;</span> <span class="nt">o</span>
<span class="nt">0000032f</span><span class="o">:</span> <span class="nt">72</span> <span class="o">;</span> <span class="nt">r</span>
<span class="nt">00000330</span><span class="o">:</span> <span class="nt">79</span> <span class="o">;</span> <span class="nt">y</span>
<span class="nt">00000331</span><span class="o">:</span> <span class="nt">00</span> <span class="o">;</span> <span class="nt">NUL</span>

<span class="o">;</span> <span class="err">################################################################</span>
<span class="o">;</span> <span class="s1">&#39;Fast Memory&#39;</span> <span class="nt">string</span>

<span class="nt">00000332</span><span class="o">:</span> <span class="nt">46</span> <span class="o">;</span> <span class="nt">F</span>
<span class="nt">00000333</span><span class="o">:</span> <span class="nt">61</span> <span class="o">;</span> <span class="nt">a</span>
<span class="nt">00000334</span><span class="o">:</span> <span class="nt">73</span> <span class="o">;</span> <span class="nt">s</span>
<span class="nt">00000335</span><span class="o">:</span> <span class="nt">74</span> <span class="o">;</span> <span class="nt">t</span>
<span class="nt">00000336</span><span class="o">:</span> <span class="nt">20</span> <span class="o">;</span> <span class="nt">SP</span>
<span class="nt">00000337</span><span class="o">:</span> <span class="nt">4d</span> <span class="o">;</span> <span class="nt">M</span> 
<span class="nt">00000338</span><span class="o">:</span> <span class="nt">65</span> <span class="o">;</span> <span class="nt">e</span>
<span class="nt">00000339</span><span class="o">:</span> <span class="nt">6d</span> <span class="o">;</span> <span class="nt">m</span>
<span class="nt">0000033a</span><span class="o">:</span> <span class="nt">6f</span> <span class="o">;</span> <span class="nt">o</span>
<span class="nt">0000033b</span><span class="o">:</span> <span class="nt">72</span> <span class="o">;</span> <span class="nt">r</span>
<span class="nt">0000033c</span><span class="o">:</span> <span class="nt">79</span> <span class="o">;</span> <span class="nt">y</span>
<span class="nt">0000033d</span><span class="o">:</span> <span class="nt">00</span> <span class="o">;</span> <span class="nt">NUL</span>
</pre></div>


<p>Let's analyse the code line by line.</p>
<div class="highlight"><pre><span></span><span class="n">Check_expansion</span><span class="o">:</span>
<span class="mi">00000380</span><span class="o">:</span> <span class="mi">200</span><span class="n">c</span>                      <span class="n">move</span><span class="o">.</span><span class="na">l</span>  <span class="n">a4</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">00000382</span><span class="o">:</span> <span class="mi">6724</span>                      <span class="n">beq</span><span class="o">.</span><span class="na">b</span>   <span class="n">Only_chip</span>
</pre></div>


<p>The first thing that Kickstart does is to check if <code>a4</code> contains a non-zero value, which signals that we have a memory expansion board available. If <code>a4</code> is zero the code jumps to the part that initialises chip memory only.</p>
<div class="highlight"><pre><span></span><span class="n">Add_expansion</span><span class="o">:</span>
<span class="mi">00000384</span><span class="o">:</span> <span class="mi">41</span><span class="n">ee</span> <span class="mi">024</span><span class="n">c</span>                 <span class="n">lea</span>     <span class="mh">0x24c</span><span class="o">(</span><span class="n">a6</span><span class="o">),</span><span class="n">a0</span>
<span class="mi">00000388</span><span class="o">:</span> <span class="mi">43</span><span class="n">fa</span> <span class="n">ffa8</span>                 <span class="n">lea</span>     <span class="mh">0x332</span><span class="o">(</span><span class="n">pc</span><span class="o">),</span><span class="n">a1</span>
</pre></div>


<p>The code then loads two effective addresses. The first one is the first free memory location (<code>0x24c</code>) and the second one is the string <code>Fast Memory</code>. The reason behind the address <code>0x24c</code> is explained in a later section in detail.</p>
<p>The purpose of the code is to call the <code>AddMemList</code> routine, which adds the memory to the system free memory pool. It has the following prototype</p>
<div class="highlight"><pre><span></span>size = AddMemList(size, attributes, pri, base, name)
D0                D0    D1          D2   A0    A1
</pre></div>


<p>where <code>size</code> is the size of the memory (bytes), <code>attributes</code> contains flags that identify memory attributes, <code>pri</code> is the priority of the memory, <code>base</code> is the base address of the new area and <code>name</code> is a name for this list.</p>
<div class="highlight"><pre><span></span><span class="mi">0000038</span><span class="n">c</span><span class="o">:</span> <span class="mi">7400</span>                      <span class="n">moveq</span>   <span class="err">#</span><span class="mi">0</span><span class="o">,</span><span class="n">d2</span>
<span class="mi">0000038</span><span class="n">e</span><span class="o">:</span> <span class="mi">323</span><span class="n">c</span> <span class="mi">0005</span>                 <span class="n">move</span><span class="o">.</span><span class="na">w</span>  <span class="err">#</span><span class="mh">0x5</span><span class="o">,</span><span class="n">d1</span>
</pre></div>


<p>The code then prepares the registers for the <code>AddMemList</code> call. It gives this memory priority <code>0</code> and sets the <code>attributes</code> flags to <code>0x5</code>, which is <code>101</code>, or <code>PUBLIC</code> and <code>FAST</code> (see <code>include_i/exec/memory.i</code>).</p>
<div class="highlight"><pre><span></span><span class="mi">00000392</span><span class="o">:</span> <span class="mi">200</span><span class="n">c</span>                      <span class="n">move</span><span class="o">.</span><span class="na">l</span>  <span class="n">a4</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">00000394</span><span class="o">:</span> <span class="mi">9088</span>                      <span class="n">sub</span><span class="o">.</span><span class="na">l</span>   <span class="n">a0</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">00000396</span><span class="o">:</span> <span class="mi">0480</span> <span class="mi">0000</span> <span class="mi">1800</span>            <span class="n">subi</span><span class="o">.</span><span class="na">l</span>  <span class="err">#</span><span class="mh">0x1800</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">0000039</span><span class="n">c</span><span class="o">:</span> <span class="mi">6100</span> <span class="mi">1688</span>                 <span class="n">bsr</span><span class="o">.</span><span class="na">w</span>   <span class="mh">0x1a26</span>
</pre></div>


<p>The expansion memory base address is copied in <code>d0</code> (this is actually an unneeded repetition of what the code did 6 lines before, I think). It then subtracts the address of the first free location (because if this is not 0 it means that something is already stored in memory) and the size of the stack, that was initialised previously by Kickstart to 6 KBytes (hardcoded). After that the code jumps to <code>AddMemList</code> (<code>0x1a26</code>).</p>
<p>When the routine returns the code begins the initialisation of the chip memory. The chip memory has to be initialised in two different ways depending on the presence of the expansion memory, as the latter is preferably used by the CPU.</p>
<div class="highlight"><pre><span></span><span class="mi">000003</span><span class="n">a0</span><span class="o">:</span> <span class="mi">41</span><span class="n">f8</span> <span class="mi">0400</span>                 <span class="n">lea</span>     <span class="mh">0x400</span><span class="o">.</span><span class="na">w</span><span class="o">,</span><span class="n">a0</span>
<span class="mi">000003</span><span class="n">a4</span><span class="o">:</span> <span class="mi">7000</span>                      <span class="n">moveq</span>   <span class="err">#</span><span class="mi">0</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">000003</span><span class="n">a6</span><span class="o">:</span> <span class="mi">600</span><span class="n">a</span>                      <span class="n">bra</span><span class="o">.</span><span class="na">b</span>   <span class="n">Add_chip</span>

<span class="n">Only_chip</span><span class="o">:</span>
<span class="mi">000003</span><span class="n">a8</span><span class="o">:</span> <span class="mi">41</span><span class="n">ee</span> <span class="mi">024</span><span class="n">c</span>                 <span class="n">lea</span>     <span class="mh">0x24c</span><span class="o">(</span><span class="n">a6</span><span class="o">),</span><span class="n">a0</span>
<span class="mi">000003</span><span class="n">ac</span><span class="o">:</span> <span class="mi">203</span><span class="n">c</span> <span class="n">ffff</span> <span class="n">e800</span>            <span class="n">move</span><span class="o">.</span><span class="na">l</span>  <span class="err">#</span><span class="o">-</span><span class="mh">0x1800</span><span class="o">,</span><span class="n">d0</span>
</pre></div>


<p>If the initial test on the presence of the expansion memory fails the code jumps directly to <code>0x03a8</code>. If the expansion memory has already been initialised, instead, the CPU executes the code at <code>0x03a0</code> and then jumps to <code>0x03b2</code> (Renamed <code>Add_chip</code> here).</p>
<div class="highlight"><pre><span></span><span class="mi">000003</span><span class="n">a0</span><span class="o">:</span> <span class="mi">41</span><span class="n">f8</span> <span class="mi">0400</span>                 <span class="n">lea</span>     <span class="mh">0x400</span><span class="o">.</span><span class="na">w</span><span class="o">,</span><span class="n">a0</span>
</pre></div>


<p>So if there is expansion memory, Exec will be loaded there, which means that both it and the system stack are not in the chip memory. We can then add the whole space above <code>0x400</code> (more on this number in a later section)</p>
<div class="highlight"><pre><span></span><span class="mi">000003</span><span class="n">a4</span><span class="o">:</span> <span class="mi">7000</span>                      <span class="n">moveq</span>   <span class="err">#</span><span class="mi">0</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">000003</span><span class="n">a6</span><span class="o">:</span> <span class="mi">600</span><span class="n">a</span>                      <span class="n">bra</span><span class="o">.</span><span class="na">b</span>   <span class="n">Add_chip</span>
</pre></div>


<p>Since the stack has already been created in fast memory we can store a 0 in <code>d0</code> and jump to the code that adds the memory to the system lists</p>
<p>If the expansion is not present, instead, Exec is installed in the chip memory, so we compute the base like we did for the fast memory.</p>
<div class="highlight"><pre><span></span><span class="n">Only_chip</span><span class="o">:</span>
<span class="mi">000003</span><span class="n">a8</span><span class="o">:</span> <span class="mi">41</span><span class="n">ee</span> <span class="mi">024</span><span class="n">c</span>                 <span class="n">lea</span>     <span class="mh">0x24c</span><span class="o">(</span><span class="n">a6</span><span class="o">),</span><span class="n">a0</span>
<span class="mi">000003</span><span class="n">ac</span><span class="o">:</span> <span class="mi">203</span><span class="n">c</span> <span class="n">ffff</span> <span class="n">e800</span>            <span class="n">move</span><span class="o">.</span><span class="na">l</span>  <span class="err">#</span><span class="o">-</span><span class="mh">0x1800</span><span class="o">,</span><span class="n">d0</span>
</pre></div>


<p>Here we load the effective address of the first free location, <code>0x24c</code> bytes after the ExecBase address, and we specify the size of the memory as 6 Kbytes less than the maximum, to keep some space for the system stack. The size is negative as later the memory size will be added to the register.</p>
<div class="highlight"><pre><span></span><span class="n">Add_chip</span><span class="o">:</span>
<span class="mi">000003</span><span class="n">b2</span><span class="o">:</span> <span class="mi">323</span><span class="n">c</span> <span class="mi">0003</span>                 <span class="n">move</span><span class="o">.</span><span class="na">w</span>  <span class="err">#</span><span class="mh">0x3</span><span class="o">,</span><span class="n">d1</span>
<span class="mi">000003</span><span class="n">b6</span><span class="o">:</span> <span class="mi">2448</span>                      <span class="n">movea</span><span class="o">.</span><span class="na">l</span> <span class="n">a0</span><span class="o">,</span><span class="n">a2</span>
<span class="mi">000003</span><span class="n">b8</span><span class="o">:</span> <span class="mi">43</span><span class="n">fa</span> <span class="n">ff6c</span>                 <span class="n">lea</span>     <span class="mh">0x326</span><span class="o">(</span><span class="n">pc</span><span class="o">),</span><span class="n">a1</span>
<span class="mi">000003</span><span class="n">bc</span><span class="o">:</span> <span class="mi">74</span><span class="n">f6</span>                      <span class="n">moveq</span>   <span class="err">#</span><span class="o">-</span><span class="mh">0xa</span><span class="o">,</span><span class="n">d2</span>
<span class="mi">000003</span><span class="n">be</span><span class="o">:</span> <span class="n">d08b</span>                      <span class="n">add</span><span class="o">.</span><span class="na">l</span>   <span class="n">a3</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">000003</span><span class="n">c0</span><span class="o">:</span> <span class="mi">9088</span>                      <span class="n">sub</span><span class="o">.</span><span class="na">l</span>   <span class="n">a0</span><span class="o">,</span><span class="n">d0</span>
<span class="mi">000003</span><span class="n">c2</span><span class="o">:</span> <span class="mi">6100</span> <span class="mi">1662</span>                 <span class="n">bsr</span><span class="o">.</span><span class="na">w</span>   <span class="mh">0x1a26</span>
</pre></div>


<p>After this we repeat the same procedure that was described for the fast memory. The attributes are now <code>CHIP</code> and <code>PUBLIC</code> (<code>0x3</code>), the string at <code>0x326</code> is <code>Chip Memory</code>, and the priority is -10 (<code>-0xa</code>). The <code>a3</code> register already contains the end address of the chip memory, so we add it to <code>d0</code> and then subtract the first free location computed before to get the size of the memory. As happened before, the routine calls <code>AddMemList</code> at <code>0x1a26</code>.</p>
<div class="highlight"><pre><span></span><span class="mi">000003</span><span class="n">c6</span><span class="o">:</span> <span class="mi">224</span><span class="n">e</span>                      <span class="n">movea</span><span class="o">.</span><span class="na">l</span> <span class="n">a6</span><span class="o">,</span><span class="n">a1</span>
<span class="mi">000003</span><span class="n">c8</span><span class="o">:</span> <span class="mi">6100</span> <span class="mi">107</span><span class="n">e</span>                 <span class="n">bsr</span><span class="o">.</span><span class="na">w</span>   <span class="mh">0x1448</span>
</pre></div>


<p>The last action of this part of the code is to call <code>AddLibrary</code> at <code>0x1448</code>. The only parameter the routine requires is the base address of the library in <code>a1</code>, which is why the code copies <code>a6</code> there.</p>
<h1 id="the-magic-number-0x24c">The "magic number" <code>0x24c</code><a class="headerlink" href="#the-magic-number-0x24c" title="Permanent link">&para;</a></h1>
<p>When we discussed the way the memory is initialised we discovered a "magic number" that Kickstart uses to find the first free location in memory</p>
<div class="highlight"><pre><span></span><span class="mi">00000384</span><span class="o">:</span> <span class="mi">41</span><span class="n">ee</span> <span class="mi">024</span><span class="n">c</span>                 <span class="n">lea</span>     <span class="mh">0x24c</span><span class="o">(</span><span class="n">a6</span><span class="o">),</span><span class="n">a0</span>
</pre></div>


<p>The first free location, according to this code is <code>0x24c</code> (588) bytes after the Exec base address. The reason behind this number is simple. When the Exec library is installed its structures use exactly 588 bytes, thus that is the address of the first free space in memory.</p>
<p>It's easy to calculate this number. Here you find the annotated version of the <code>ExecBase</code> structure that I already used in the previous instalment.</p>
<p>The structure is described in the <code>include_i/exec/execbase.i</code> include file, and I added the displacement in bytes of each field. The first column is the displacement in the <code>ExecBase</code> structure, while the second starts from <code>0x22</code>. The latter comes from the fact that the structure follows an <code>LN</code> structure and a <code>LIB</code> structure, described in the fourth instalment of this series.</p>
<div class="highlight"><pre><span></span><span class="mi">0000</span> <span class="mi">0022</span>    <span class="n">UWORD</span>   <span class="n">SoftVer</span>
<span class="mi">0002</span> <span class="mi">0024</span>    <span class="n">WORD</span>    <span class="n">LowMemChkSum</span>
<span class="mi">0004</span> <span class="mi">0026</span>    <span class="n">ULONG</span>   <span class="n">ChkBase</span>
<span class="mi">0008</span> <span class="mi">002</span><span class="n">a</span>    <span class="n">APTR</span>    <span class="n">ColdCapture</span>
<span class="mi">000</span><span class="k">c</span> <span class="mi">002</span><span class="n">e</span>    <span class="n">APTR</span>    <span class="n">CoolCapture</span>
<span class="mi">0010</span> <span class="mi">0032</span>    <span class="n">APTR</span>    <span class="n">WarmCapture</span>
<span class="mi">0014</span> <span class="mi">0036</span>    <span class="n">APTR</span>    <span class="n">SysStkUpper</span>
<span class="mi">0018</span> <span class="mi">003</span><span class="n">a</span>    <span class="n">APTR</span>    <span class="n">SysStkLower</span>
<span class="mi">001</span><span class="k">c</span> <span class="mi">003</span><span class="n">e</span>    <span class="n">ULONG</span>   <span class="n">MaxLocMem</span>
<span class="mi">0020</span> <span class="mi">0042</span>    <span class="n">APTR</span>    <span class="n">DebugEntry</span>
<span class="mi">0024</span> <span class="mi">0046</span>    <span class="n">APTR</span>    <span class="n">DebugData</span>
<span class="mi">0028</span> <span class="mi">004</span><span class="n">a</span>    <span class="n">APTR</span>    <span class="n">AlertData</span>
<span class="mi">002</span><span class="k">c</span> <span class="mi">004</span><span class="n">e</span>    <span class="n">APTR</span>    <span class="n">MaxExtMem</span>

<span class="mi">0030</span> <span class="mi">0052</span>    <span class="n">WORD</span>    <span class="n">ChkSum</span>


<span class="o">*******</span> <span class="n">Interrupt</span> <span class="n">Related</span> <span class="o">********************************************</span>

    <span class="n">LABEL</span>   <span class="n">IntVects</span>
<span class="mi">0032</span> <span class="mi">0054</span>    <span class="n">STRUCT</span>  <span class="n">IVTBE</span><span class="p">,</span><span class="n">IV_SIZE</span>
<span class="mi">003</span><span class="n">e</span> <span class="mi">0060</span>    <span class="n">STRUCT</span>  <span class="n">IVDSKBLK</span><span class="p">,</span><span class="n">IV_SIZE</span>
<span class="mi">004</span><span class="n">a</span> <span class="mi">006</span><span class="k">c</span>    <span class="n">STRUCT</span>  <span class="n">IVSOFTINT</span><span class="p">,</span><span class="n">IV_SIZE</span>
<span class="mi">0056</span> <span class="mi">0078</span>    <span class="n">STRUCT</span>  <span class="n">IVPORTS</span><span class="p">,</span><span class="n">IV_SIZE</span>
<span class="mi">0062</span> <span class="mi">0084</span>    <span class="n">STRUCT</span>  <span class="n">IVCOPER</span><span class="p">,</span><span class="n">IV_SIZE</span>
<span class="mi">006</span><span class="n">e</span> <span class="mi">0090</span>    <span class="n">STRUCT</span>  <span class="n">IVVERTB</span><span class="p">,</span><span class="n">IV_SIZE</span>
<span class="mi">007</span><span class="n">a</span> <span class="mi">009</span><span class="k">c</span>    <span class="n">STRUCT</span>  <span class="n">IVBLIT</span><span class="p">,</span><span class="n">IV_SIZE</span>
<span class="mi">0086</span> <span class="mi">00</span><span class="n">a8</span>    <span class="n">STRUCT</span>  <span class="n">IVAUD0</span><span class="p">,</span><span class="n">IV_SIZE</span>
<span class="mi">0092</span> <span class="mi">00</span><span class="n">b4</span>    <span class="n">STRUCT</span>  <span class="n">IVAUD1</span><span class="p">,</span><span class="n">IV_SIZE</span>
<span class="mi">009</span><span class="n">e</span> <span class="mi">00</span><span class="n">c0</span>    <span class="n">STRUCT</span>  <span class="n">IVAUD2</span><span class="p">,</span><span class="n">IV_SIZE</span>
<span class="mi">00</span><span class="n">aa</span> <span class="mi">00</span><span class="n">cc</span>    <span class="n">STRUCT</span>  <span class="n">IVAUD3</span><span class="p">,</span><span class="n">IV_SIZE</span>
<span class="mi">00</span><span class="n">b6</span> <span class="mi">00</span><span class="n">d8</span>    <span class="n">STRUCT</span>  <span class="n">IVRBF</span><span class="p">,</span><span class="n">IV_SIZE</span>
<span class="mi">00</span><span class="n">c2</span> <span class="mi">00</span><span class="n">e4</span>    <span class="n">STRUCT</span>  <span class="n">IVDSKSYNC</span><span class="p">,</span><span class="n">IV_SIZE</span>
<span class="mi">00</span><span class="n">ce</span> <span class="mi">00</span><span class="n">f0</span>    <span class="n">STRUCT</span>  <span class="n">IVEXTER</span><span class="p">,</span><span class="n">IV_SIZE</span>
<span class="mi">00</span><span class="n">da</span> <span class="mi">00</span><span class="n">fc</span>    <span class="n">STRUCT</span>  <span class="n">IVINTEN</span><span class="p">,</span><span class="n">IV_SIZE</span>
<span class="mi">00</span><span class="n">e6</span> <span class="mi">0108</span>    <span class="n">STRUCT</span>  <span class="n">IVNMI</span><span class="p">,</span><span class="n">IV_SIZE</span>


<span class="o">*******</span> <span class="k">Dynamic</span> <span class="k">System</span> <span class="n">Variables</span> <span class="o">*************************************</span>

<span class="mi">00</span><span class="n">f2</span> <span class="mi">0114</span>    <span class="n">APTR</span>    <span class="n">ThisTask</span>

<span class="mi">00</span><span class="n">f6</span> <span class="mi">0118</span>    <span class="n">ULONG</span>   <span class="n">IdleCount</span>
<span class="mi">00</span><span class="n">fa</span> <span class="mi">011</span><span class="k">c</span>    <span class="n">ULONG</span>   <span class="n">DispCount</span>
<span class="mi">00</span><span class="n">fe</span> <span class="mi">0120</span>    <span class="n">UWORD</span>   <span class="n">Quantum</span>
<span class="mi">0100</span> <span class="mi">0122</span>    <span class="n">UWORD</span>   <span class="n">Elapsed</span>
<span class="mi">0102</span> <span class="mi">0124</span>    <span class="n">UWORD</span>   <span class="n">SysFlags</span>
<span class="mi">0104</span> <span class="mi">0126</span>    <span class="n">BYTE</span>    <span class="n">IDNestCnt</span>
<span class="mi">0105</span> <span class="mi">0127</span>    <span class="n">BYTE</span>    <span class="n">TDNestCnt</span>

<span class="mi">0106</span> <span class="mi">0128</span>    <span class="n">UWORD</span>   <span class="n">AttnFlags</span>

<span class="mi">0108</span> <span class="mi">012</span><span class="n">a</span>    <span class="n">UWORD</span>   <span class="n">AttnResched</span>
<span class="mi">010</span><span class="n">a</span> <span class="mi">012</span><span class="k">c</span>    <span class="n">APTR</span>    <span class="n">ResModules</span>
<span class="mi">010</span><span class="n">e</span> <span class="mi">0130</span>    <span class="n">APTR</span>    <span class="n">TaskTrapCode</span>
<span class="mi">0112</span> <span class="mi">0134</span>    <span class="n">APTR</span>    <span class="n">TaskExceptCode</span>
<span class="mi">0116</span> <span class="mi">0138</span>    <span class="n">APTR</span>    <span class="n">TaskExitCode</span>
<span class="mi">011</span><span class="n">a</span> <span class="mi">013</span><span class="k">c</span>    <span class="n">ULONG</span>   <span class="n">TaskSigAlloc</span>
<span class="mi">011</span><span class="n">e</span> <span class="mi">0140</span>    <span class="n">UWORD</span>   <span class="n">TaskTrapAlloc</span>


<span class="o">*******</span> <span class="k">System</span> <span class="n">List</span> <span class="n">Headers</span> <span class="p">(</span><span class="n">private</span><span class="o">!</span><span class="p">)</span> <span class="o">********************************</span>

<span class="mi">0120</span> <span class="mi">0142</span>    <span class="n">STRUCT</span>  <span class="n">MemList</span><span class="p">,</span><span class="n">LH_SIZE</span>
<span class="mi">012</span><span class="n">e</span> <span class="mi">0150</span>    <span class="n">STRUCT</span>  <span class="n">ResourceList</span><span class="p">,</span><span class="n">LH_SIZE</span>
<span class="mi">013</span><span class="k">c</span> <span class="mi">015</span><span class="n">e</span>    <span class="n">STRUCT</span>  <span class="n">DeviceList</span><span class="p">,</span><span class="n">LH_SIZE</span>
<span class="mi">014</span><span class="n">a</span> <span class="mi">016</span><span class="k">c</span>    <span class="n">STRUCT</span>  <span class="n">IntrList</span><span class="p">,</span><span class="n">LH_SIZE</span>
<span class="mi">0158</span> <span class="mi">017</span><span class="n">a</span>    <span class="n">STRUCT</span>  <span class="n">LibList</span><span class="p">,</span><span class="n">LH_SIZE</span>
<span class="mi">0166</span> <span class="mi">0188</span>    <span class="n">STRUCT</span>  <span class="n">PortList</span><span class="p">,</span><span class="n">LH_SIZE</span>
<span class="mi">0174</span> <span class="mi">0196</span>    <span class="n">STRUCT</span>  <span class="n">TaskReady</span><span class="p">,</span><span class="n">LH_SIZE</span>
<span class="mi">0182</span> <span class="mi">01</span><span class="n">a4</span>    <span class="n">STRUCT</span>  <span class="n">TaskWait</span><span class="p">,</span><span class="n">LH_SIZE</span>
<span class="mi">0190</span> <span class="mi">01</span><span class="n">b2</span>    <span class="n">STRUCT</span>  <span class="n">SoftInts</span><span class="p">,</span><span class="n">SH_SIZE</span><span class="o">*</span><span class="mi">5</span>

<span class="mi">01</span><span class="n">e0</span> <span class="mi">0202</span>    <span class="n">STRUCT</span>  <span class="n">LastAlert</span><span class="p">,</span><span class="mi">4</span><span class="o">*</span><span class="mi">4</span>

<span class="mi">01</span><span class="n">f0</span> <span class="mi">0212</span>    <span class="n">UBYTE</span>   <span class="n">VBlankFrequency</span>
<span class="mi">01</span><span class="n">f1</span> <span class="mi">0213</span>    <span class="n">UBYTE</span>   <span class="n">PowerSupplyFrequency</span>

<span class="mi">01</span><span class="n">f2</span> <span class="mi">0214</span>    <span class="n">STRUCT</span>  <span class="n">SemaphoreList</span><span class="p">,</span><span class="n">LH_SIZE</span>

<span class="mi">0200</span> <span class="mi">0222</span>    <span class="n">APTR</span>    <span class="n">KickMemPtr</span>
<span class="mi">0204</span> <span class="mi">0226</span>    <span class="n">APTR</span>    <span class="n">KickTagPtr</span>
<span class="mi">0208</span> <span class="mi">022</span><span class="n">a</span>    <span class="n">APTR</span>    <span class="n">KickCheckSum</span>

<span class="mi">020</span><span class="k">c</span> <span class="mi">022</span><span class="n">e</span>    <span class="n">UBYTE</span>   <span class="n">ExecBaseReserved</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<span class="mi">0216</span> <span class="mi">0238</span>    <span class="n">UBYTE</span>   <span class="n">ExecBaseNewReserved</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
<span class="mi">022</span><span class="n">a</span> <span class="mi">024</span><span class="k">c</span>    <span class="n">LABEL</span>   <span class="n">SYSBASESIZE</span>
</pre></div>


<p>The include file that I found in the Amiga Developer CD has a slightly different version of this structure that contains fields from higher versions of Exec. This structure can be found in the Amiga System Programmer's Guide, page 308. You can easily find the definitions of values like <code>SH_SIZE</code> in the include files contained in the <code>include_i/exec/</code> directory.</p>
<p>As you can see the final address is <code>0x24c</code>, which is exactly where the free memory begins (remember that <code>LABEL</code> is a macro and not a field, so it doesn't use space).</p>
<h1 id="the-magic-numbers-0x676-and-0x400">The "magic numbers" <code>0x676</code> and <code>0x400</code><a class="headerlink" href="#the-magic-numbers-0x676-and-0x400" title="Permanent link">&para;</a></h1>
<p>The Motorola 68000 architecture forces to reserve the first 1024 bytes (<code>0x400</code>) for the exception vectors. The table of these vectors can be found in the Programmer's Reference Manual, page B-2, and this is the source for the magic number used when adding the chip memory to the system lists in case an expansion memory is installed.</p>
<p>The Exec base address, however, is not <code>0x400</code> but <code>0x676</code>. As we already know the library is preceded by the jump table, and since Exec exports 105 functions we use <code>105*6 = 630</code> bytes for the jump vectors. Adding these 630 bytes to the first 1024 reserved for the exception vectors gives 1654 (<code>0x676</code>) as the base address of the library.</p>
<div class="highlight"><pre><span></span>        <span class="o">+---------------------------------------+</span>
        <span class="o">|</span> <span class="n">First</span> <span class="n">free</span> <span class="n">address</span>                    <span class="o">|</span>
   <span class="mi">2242</span> <span class="o">+---------------------------------------+</span> <span class="mh">0x8c2</span> <span class="o">&lt;-+</span>
        <span class="o">|</span> <span class="n">ExecBase</span> <span class="n">structure</span>                    <span class="o">|</span>         <span class="o">|</span>
   <span class="mi">1688</span> <span class="o">+---------------------------------------+</span> <span class="mh">0x698</span>   <span class="o">|</span>
        <span class="o">|</span> <span class="n">LIB</span> <span class="n">structure</span>                         <span class="o">|</span>         <span class="o">|</span> <span class="n">Exec</span> <span class="n">base</span>
   <span class="mi">1668</span> <span class="o">+---------------------------------------+</span> <span class="mh">0x684</span>   <span class="o">|</span> <span class="n">structure</span>
        <span class="o">|</span> <span class="n">LN</span> <span class="n">structure</span>                          <span class="o">|</span>         <span class="o">|</span>
   <span class="mi">1654</span> <span class="o">+---------------------------------------+</span> <span class="mh">0x676</span> <span class="o">&lt;-+</span>
        <span class="o">|</span> <span class="n">Jump</span> <span class="n">vector</span> <span class="err">#</span><span class="mi">105</span>                      <span class="o">|</span>         <span class="o">|</span>
        <span class="o">+---------------------------------------+</span>         <span class="o">|</span>
        <span class="o">|</span> <span class="p">[...]</span>                                 <span class="o">|</span>         <span class="o">|</span>
        <span class="o">+---------------------------------------+</span>         <span class="o">|</span> <span class="n">Exec</span> <span class="n">jump</span>
        <span class="o">|</span> <span class="n">Jump</span> <span class="n">vector</span> <span class="err">#</span><span class="mi">2</span>                        <span class="o">|</span>         <span class="o">|</span> <span class="n">vector</span> <span class="n">table</span>
   <span class="mi">1030</span> <span class="o">+---------------------------------------+</span> <span class="mh">0x406</span>   <span class="o">|</span>
        <span class="o">|</span> <span class="n">Jump</span> <span class="n">vector</span> <span class="err">#</span><span class="mi">1</span>                        <span class="o">|</span>         <span class="o">|</span>
   <span class="mi">1024</span> <span class="o">+---------------------------------------+</span> <span class="mh">0x400</span> <span class="o">&lt;-+</span>
        <span class="o">|</span> <span class="n">End</span> <span class="n">of</span> <span class="n">reserved</span> <span class="n">space</span>                 <span class="o">|</span>         <span class="o">|</span>
        <span class="o">+---------------------------------------+</span>         <span class="o">|</span>
        <span class="o">|</span> <span class="p">[...]</span>                                 <span class="o">|</span>         <span class="o">|</span>
     <span class="mi">12</span> <span class="o">+---------------------------------------+</span> <span class="mh">0xc</span>     <span class="o">|</span> <span class="mi">1</span> <span class="n">Kilobyte</span>
        <span class="o">|</span> <span class="n">Vector</span> <span class="err">#</span><span class="mi">2</span>                             <span class="o">|</span>         <span class="o">|</span> <span class="n">reserved</span> <span class="n">by</span>
      <span class="mi">8</span> <span class="o">+---------------------------------------+</span> <span class="mh">0x8</span>     <span class="o">|</span> <span class="n">the</span> <span class="n">M68k</span>
        <span class="o">|</span> <span class="n">Reset</span> <span class="n">Initial</span> <span class="n">Program</span> <span class="n">Counter</span>         <span class="o">|</span>         <span class="o">|</span> <span class="n">architecture</span>
      <span class="mi">4</span> <span class="o">+---------------------------------------+</span> <span class="mh">0x4</span>     <span class="o">|</span>
        <span class="o">|</span> <span class="n">Reset</span> <span class="n">Initial</span> <span class="n">Interrupt</span> <span class="n">Stack</span> <span class="n">Pointer</span> <span class="o">|</span>         <span class="o">|</span>
      <span class="mi">0</span> <span class="o">+---------------------------------------+</span> <span class="mh">0x0</span>   <span class="o">&lt;-+</span>
</pre></div>


<h1 id="whats-next">What's next<a class="headerlink" href="#whats-next" title="Permanent link">&para;</a></h1>
<p>It's time to show the complete Exec vector table, as we are going to use and analyse all the functions defined there. I will then discuss the structure of the memory list header and its relationship with linked lists. Last I will dissect the code of <code>AddMemList</code> and thus show in detail how the chip and expansion memory areas are added to to free memory pool.</p>
<h1 id="resources">Resources<a class="headerlink" href="#resources" title="Permanent link">&para;</a></h1>
<ul>
<li>Microprocessor-based system design by Ricardo Gutierrez-Osuna (<a href="http://courses.cs.tamu.edu/rgutier/ceg411_f01/">slides</a>), in particular <a href="http://courses.cs.tamu.edu/rgutier/ceg411_f01/l9.pdf">Lesson 9 - Exception processing</a></li>
<li>Motorola M68000 Family Programmer's Reference Manual <a href="https://www.nxp.com/docs/en/reference-manual/M68000PRM.pdf">PDF here</a></li>
<li>Amiga System Programmers Guide, Abacus (<a href="https://archive.org/details/Amiga_System_Programmers_Guide_1988_Abacus">pdf here</a>)</li>
</ul>
<h1 id="feedback">Feedback<a class="headerlink" href="#feedback" title="Permanent link">&para;</a></h1>
<p>Feel free to reach me on <a href="https://twitter.com/thedigicat">Twitter</a> if you have questions. The <a href="https://github.com/TheDigitalCatOnline/thedigitalcatonline.github.com/issues">GitHub issues</a> page is the best place to submit corrections.</p>
    </section>

    <section class="footer">
        <h1>Part 6 of the Exploring the Amiga series</h1>
        <div class="box">
            <h5>Previous articles</h5>
            <ul>
                <li><a href="/blog/2018/05/28/exploring-the-amiga-1/">Exploring the Amiga - Part 1</a></li>
                <li><a href="/blog/2018/05/28/exploring-the-amiga-2/">Exploring the Amiga - Part 2</a></li>
                <li><a href="/blog/2018/06/08/exploring-the-amiga-3/">Exploring the Amiga - Part 3</a></li>
                <li><a href="/blog/2018/06/14/exploring-the-amiga-4/">Exploring the Amiga - Part 4</a></li>
                <li><a href="/blog/2018/06/25/exploring-the-amiga-5/">Exploring the Amiga - Part 5</a></li>
            </ul>
        
            <h5>Next articles</h5>
            <ul>
                <li><a href="/blog/2019/02/19/exploring-the-amiga-7/">Exploring the Amiga - Part 7</a></li>
                <li><a href="/blog/2019/02/19/exploring-the-amiga-8/">Exploring the Amiga - Part 8</a></li>
            </ul>
        </div>
    </section>

    <section class="footer">
        <h1>Related Posts</h1>
        <div class="posts mini">
            <article class="card">
                <a href="/blog/2019/02/19/exploring-the-amiga-8/" class="image">
                    <img src="/images/exploring-the-amiga-8.jpg" alt="exploring-the-amiga-8" />
                </a>
                <div class="card-body">
                    <a href="/blog/2019/02/19/exploring-the-amiga-8/"><h2 class="card-title">Exploring the Amiga - Part 8</h2></a>
                    <p class="card-text">
                        <time datetime="2019-02-19T14:00:00+01:00">Feb 19, 2019</time>
                        <span class="fa fa-tags"></span>
                        <a href="/categories/assembly/" class="tag">assembly</a>                        <a href="/categories/amiga/" class="tag">amiga</a>                        <a href="/categories/retroprogramming/" class="tag">retroprogramming</a>                    </p>
                </div>
            </article>
            <article class="card">
                <a href="/blog/2019/02/19/exploring-the-amiga-7/" class="image">
                    <img src="/images/exploring-the-amiga-7.jpg" alt="exploring-the-amiga-7" />
                </a>
                <div class="card-body">
                    <a href="/blog/2019/02/19/exploring-the-amiga-7/"><h2 class="card-title">Exploring the Amiga - Part 7</h2></a>
                    <p class="card-text">
                        <time datetime="2019-02-19T13:00:00+01:00">Feb 19, 2019</time>
                        <span class="fa fa-tags"></span>
                        <a href="/categories/assembly/" class="tag">assembly</a>                        <a href="/categories/amiga/" class="tag">amiga</a>                        <a href="/categories/retroprogramming/" class="tag">retroprogramming</a>                    </p>
                </div>
            </article>
            <article class="card">
                <a href="/blog/2018/06/25/exploring-the-amiga-5/" class="image">
                    <img src="/images/exploring-the-amiga-5.jpg" alt="exploring-the-amiga-5" />
                </a>
                <div class="card-body">
                    <a href="/blog/2018/06/25/exploring-the-amiga-5/"><h2 class="card-title">Exploring the Amiga - Part 5</h2></a>
                    <p class="card-text">
                        <time datetime="2018-06-25T12:00:00+01:00">Jun 25, 2018</time>
                        <span class="fa fa-tags"></span>
                        <a href="/categories/assembly/" class="tag">assembly</a>                        <a href="/categories/amiga/" class="tag">amiga</a>                        <a href="/categories/retroprogramming/" class="tag">retroprogramming</a>                    </p>
                </div>
            </article>
            <article class="card">
                <a href="/blog/2018/06/14/exploring-the-amiga-4/" class="image">
                    <img src="/images/exploring-the-amiga-4.jpg" alt="exploring-the-amiga-4" />
                </a>
                <div class="card-body">
                    <a href="/blog/2018/06/14/exploring-the-amiga-4/"><h2 class="card-title">Exploring the Amiga - Part 4</h2></a>
                    <p class="card-text">
                        <time datetime="2018-06-14T14:30:00+01:00">Jun 14, 2018</time>
                        <span class="fa fa-tags"></span>
                        <a href="/categories/assembly/" class="tag">assembly</a>                        <a href="/categories/amiga/" class="tag">amiga</a>                        <a href="/categories/retroprogramming/" class="tag">retroprogramming</a>                    </p>
                </div>
            </article>
            <article class="card">
                <a href="/blog/2018/06/08/exploring-the-amiga-3/" class="image">
                    <img src="/images/exploring-the-amiga-3.jpg" alt="exploring-the-amiga-3" />
                </a>
                <div class="card-body">
                    <a href="/blog/2018/06/08/exploring-the-amiga-3/"><h2 class="card-title">Exploring the Amiga - Part 3</h2></a>
                    <p class="card-text">
                        <time datetime="2018-06-08T12:30:00+01:00">Jun 8, 2018</time>
                        <span class="fa fa-tags"></span>
                        <a href="/categories/assembly/" class="tag">assembly</a>                        <a href="/categories/amiga/" class="tag">amiga</a>                        <a href="/categories/retroprogramming/" class="tag">retroprogramming</a>                    </p>
                </div>
            </article>
            <article class="card">
                <a href="/blog/2018/05/28/exploring-the-amiga-2/" class="image">
                    <img src="/images/exploring-the-amiga-2.jpg" alt="exploring-the-amiga-2" />
                </a>
                <div class="card-body">
                    <a href="/blog/2018/05/28/exploring-the-amiga-2/"><h2 class="card-title">Exploring the Amiga - Part 2</h2></a>
                    <p class="card-text">
                        <time datetime="2018-05-28T15:00:00+01:00">May 28, 2018</time>
                        <span class="fa fa-tags"></span>
                        <a href="/categories/assembly/" class="tag">assembly</a>                        <a href="/categories/amiga/" class="tag">amiga</a>                        <a href="/categories/retroprogramming/" class="tag">retroprogramming</a>                    </p>
                </div>
            </article>
            <article class="card">
                <a href="/blog/2018/05/28/exploring-the-amiga-1/" class="image">
                    <img src="/images/exploring-the-amiga-1.jpg" alt="exploring-the-amiga-1" />
                </a>
                <div class="card-body">
                    <a href="/blog/2018/05/28/exploring-the-amiga-1/"><h2 class="card-title">Exploring the Amiga - Part 1</h2></a>
                    <p class="card-text">
                        <time datetime="2018-05-28T14:00:00+01:00">May 28, 2018</time>
                        <span class="fa fa-tags"></span>
                        <a href="/categories/assembly/" class="tag">assembly</a>                        <a href="/categories/amiga/" class="tag">amiga</a>                        <a href="/categories/retroprogramming/" class="tag">retroprogramming</a>                    </p>
                </div>
            </article>
            <article class="card">
                <a href="/blog/2019/03/04/motorola-68000-addressing-modes/" class="image">
                    <img src="/images/mc68000.jpg" alt="mc68000" />
                </a>
                <div class="card-body">
                    <a href="/blog/2019/03/04/motorola-68000-addressing-modes/"><h2 class="card-title">Motorola 68000: addressing modes</h2></a>
                    <p class="card-text">
                        <time datetime="2019-03-04T22:30:00+01:00">Mar 4, 2019</time>
                        <span class="fa fa-tags"></span>
                        <a href="/categories/assembly/" class="tag">assembly</a>                        <a href="/categories/m68000/" class="tag">M68000</a>                    </p>
                </div>
            </article>
        </div>
    </section>



    <!-- </article> -->

						</div>
					</div>

				<!-- Sidebar -->
					<div id="sidebar">
<div class="inner">
    <!-- Menu -->
        <nav id="menu">
            <header class="major">
                <h2>Menu</h2>
            </header>
<ul>
    <li><a href="/index.html">Homepage</a></li>
    <li><a href="/pages/about.html">About</a></li>
    <li><a href="/archives/index.html">Archives</a></li>
</ul>        </nav>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Categories</h2>
            </header>
<ul class="list-clean">
    <li><a href="/category/programming/">Programming</a></li>
    <li><a href="/category/projects/">Projects</a></li>
    <li><a href="/category/retro/">Retro</a></li>
</ul>
        </section>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Feeds</h2>
            </header>
<ul class="list-clean">
    <li><a href="/atom.xml"><i class="fa fa-rss"></i> All posts</a></li>


    <li><a href="/category/retro/atom.xml"><i class="fa fa-rss"></i> All posts in category: Retro</a></li>
</ul>        </section>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Tags</h2>
            </header>
<ul class="list-inline list-clean" id="tags-side">
    <li class="tag font-size-3">
        <a href="/categories/algorithms/">algorithms</a>
    </li>
    <li class="tag font-size-2">
        <a href="/categories/amiga/">amiga</a>
    </li>
    <li class="tag font-size-4">
        <a href="/categories/amqp/">AMQP</a>
    </li>
    <li class="tag font-size-3">
        <a href="/categories/architectures/">architectures</a>
    </li>
    <li class="tag font-size-2">
        <a href="/categories/assembly/">assembly</a>
    </li>
    <li class="tag font-size-4">
        <a href="/categories/aws/">AWS</a>
    </li>
    <li class="tag font-size-2">
        <a href="/categories/c/">C</a>
    </li>
    <li class="tag font-size-4">
        <a href="/categories/clojure/">Clojure</a>
    </li>
    <li class="tag font-size-2">
        <a href="/categories/compilers/">compilers</a>
    </li>
    <li class="tag font-size-2">
        <a href="/categories/concurrent-programming/">concurrent programming</a>
    </li>
    <li class="tag font-size-3">
        <a href="/categories/cryptography/">cryptography</a>
    </li>
    <li class="tag font-size-2">
        <a href="/categories/decorators/">decorators</a>
    </li>
    <li class="tag font-size-2">
        <a href="/categories/django/">Django</a>
    </li>
    <li class="tag font-size-3">
        <a href="/categories/erlang/">Erlang</a>
    </li>
    <li class="tag font-size-4">
        <a href="/categories/flask/">Flask</a>
    </li>
    <li class="tag font-size-1">
        <a href="/categories/functional-programming/">functional programming</a>
    </li>
    <li class="tag font-size-3">
        <a href="/categories/generators/">generators</a>
    </li>
    <li class="tag font-size-3">
        <a href="/categories/git/">Git</a>
    </li>
    <li class="tag font-size-4">
        <a href="/categories/http/">HTTP</a>
    </li>
    <li class="tag font-size-4">
        <a href="/categories/infrastructure/">infrastructure</a>
    </li>
    <li class="tag font-size-4">
        <a href="/categories/m68000/">M68000</a>
    </li>
    <li class="tag font-size-2">
        <a href="/categories/metaclasses/">metaclasses</a>
    </li>
    <li class="tag font-size-2">
        <a href="/categories/metaprogramming/">metaprogramming</a>
    </li>
    <li class="tag font-size-3">
        <a href="/categories/notebook/">Notebook</a>
    </li>
    <li class="tag font-size-1">
        <a href="/categories/oop/">OOP</a>
    </li>
    <li class="tag font-size-2">
        <a href="/categories/operating-systems/">operating systems</a>
    </li>
    <li class="tag font-size-4">
        <a href="/categories/pelican/">pelican</a>
    </li>
    <li class="tag font-size-4">
        <a href="/categories/pika/">Pika</a>
    </li>
    <li class="tag font-size-4">
        <a href="/categories/postage/">Postage</a>
    </li>
    <li class="tag font-size-1">
        <a href="/categories/python/">Python</a>
    </li>
    <li class="tag font-size-2">
        <a href="/categories/python2/">Python2</a>
    </li>
    <li class="tag font-size-1">
        <a href="/categories/python3/">Python3</a>
    </li>
    <li class="tag font-size-3">
        <a href="/categories/rabbitmq/">RabbitMQ</a>
    </li>
    <li class="tag font-size-4">
        <a href="/categories/refactoring/">refactoring</a>
    </li>
    <li class="tag font-size-2">
        <a href="/categories/retroprogramming/">retroprogramming</a>
    </li>
    <li class="tag font-size-4">
        <a href="/categories/rsa/">RSA</a>
    </li>
    <li class="tag font-size-1">
        <a href="/categories/scala/">Scala</a>
    </li>
    <li class="tag font-size-4">
        <a href="/categories/ssh/">SSH</a>
    </li>
    <li class="tag font-size-3">
        <a href="/categories/ssl/">SSL</a>
    </li>
    <li class="tag font-size-1">
        <a href="/categories/tdd/">TDD</a>
    </li>
    <li class="tag font-size-1">
        <a href="/categories/testing/">testing</a>
    </li>
    <li class="tag font-size-3">
        <a href="/categories/versioning/">versioning</a>
    </li>
    <li class="tag font-size-4">
        <a href="/categories/video/">video</a>
    </li>
    <li class="tag font-size-4">
        <a href="/categories/www/">WWW</a>
    </li>
</ul>        </section>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Recent posts</h2>
            </header>
<div class="mini-posts">
    <article>
        <a href="/blog/2020/02/16/dissecting-a-web-stack/" class="image"><img src="/images/dissecting-a-web-stack.jpg" alt="dissecting-a-web-stack" /></a>
        <p><strong>Dissecting a Web stack</strong> <a href="/blog/2020/02/16/dissecting-a-web-stack/">Read</a></p> 
    </article>
    <article>
        <a href="/blog/2019/11/21/punch-2-0-0/" class="image"><img src="/images/punch_2_0_0.jpg" alt="punch_2_0_0" /></a>
        <p><strong>Punch 2.0.0 is out</strong> <a href="/blog/2019/11/21/punch-2-0-0/">Read</a></p> 
    </article>
    <article>
        <a href="/blog/2019/06/07/run-a-pelican-blog/" class="image"><img src="/images/run-a-pelican-blog.jpg" alt="run-a-pelican-blog" /></a>
        <p><strong>Run a blog with pelican</strong> <a href="/blog/2019/06/07/run-a-pelican-blog/">Read</a></p> 
    </article>
</div>        </section>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Get in touch</h2>
            </header>
<ul class="contact">
    
    
    
    <li class="fa-twitter"><a href="https://twitter.com/thedigicat">Twitter</a></li>
    
    
    
    
    <li class="fa-github"><a href="https://github.com/TheDigitalCatOnline">GitHub</a></li>
    
</ul>        </section>

    <!-- Footer -->
        <footer id="footer">
            <p class="copyright">Editorial theme by: <a href="https://html5up.net">HTML5 UP</a>.</p>
            <p class="copyright">Cover picture by: <a href="https://pxhere.com/en/photo/1428515">An Min @ pxhere.com</a></p>
        </footer>

</div>					</div>

			</div>

		<!-- Scripts -->
			<script src="/theme/js/jquery.min.js"></script>
			<script src="/theme/js/browser.min.js"></script>
			<script src="/theme/js/breakpoints.min.js"></script>
            <script src="/theme/js/packed.js?fa89ff81"></script>

	</body>
</html>