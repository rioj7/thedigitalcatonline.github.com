<!DOCTYPE HTML>
<!--
    Editorial by HTML5 UP
    html5up.net | @ajlkn
    Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
    <head>
        <title>Exploring the Amiga - Part 4 - The Digital Cat</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
        <!--[if lte IE 8]><script src="http://blog.thedigitalcatonline.com/theme/js/ie/html5shiv.js"></script><![endif]-->
        <link rel="stylesheet" href="http://blog.thedigitalcatonline.com/theme/css/main.css" />

        <!-- Pygments CSS START -->
        <link rel="stylesheet" href="http://blog.thedigitalcatonline.com/theme/css/pygments/monokai.css">
        <!-- Pygments CSS END -->

        <link href="http://blog.thedigitalcatonline.com/images/TheDigitalCat_favicon_32.png" rel="icon">

        <!--[if lte IE 9]><link rel="stylesheet" href="http://blog.thedigitalcatonline.com/theme/css/ie9.css" /><![endif]-->
        <!--[if lte IE 8]><link rel="stylesheet" href="http://blog.thedigitalcatonline.com/theme/css/ie8.css" /><![endif]-->

        <!-- Google Analytics Universal -->
            <script type="text/javascript">
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
                ga('create', 'UA-74364524-1', 'auto');
                ga('send', 'pageview');
            </script>
        <!-- End Google Analytics Universal Code -->
    </head>
    <body>

        <!-- Wrapper -->
            <div id="wrapper">

                <!-- Main -->
                    <div id="main">
                        <div class="inner narrow">

    <header id="header">
        <a href="http://blog.thedigitalcatonline.com/category/retro/" title="Retro">Retro</a>
        <div class="align-right">        
            <a href="#series">Exploring the Amiga</a> part 4/4
        </div>
    </header>
    

    <article class="post">
        <header class="page-header">
            <h1>Exploring the Amiga - Part 4</h1>
        </header>

        <section id="tags" class="align-center">
            <a class="button special small" href="http://blog.thedigitalcatonline.com/categories/assembly/">assembly</a>            <a class="button special small" href="http://blog.thedigitalcatonline.com/categories/amiga/">amiga</a>            <a class="button special small" href="http://blog.thedigitalcatonline.com/categories/retroprogramming/">retroprogramming</a>        </section>

        <section id="author" class="align-center">
                By
                <a href="http://blog.thedigitalcatonline.com/authors/leonardo-giordani/">Leonardo Giordani</a>
                <span class="separator">â€¢</span>

            Published on
            <time datetime="2018-06-14T14:30:00+01:00"> 14/06/2018</time>

        </section>

        <section id="content">
            <h1>The Exec base functions</h1>
<p>We found the Kickstart 1.3 (<code>exec</code> 34.2) vector table at address <code>0x1a7c</code>, and the first 4 entries read</p>
<div class="highlight"><pre><span></span><span class="nl">00001a7c:</span> <span class="mi">08a0</span>
<span class="nl">00001a7e:</span> <span class="mi">08a8</span>
<span class="nl">00001a80:</span> <span class="mi">08ac</span>
<span class="nl">00001a82:</span> <span class="mi">08ac</span>
</pre></div>


<p>If we translate these relative values into absolute addresses, summing the address of the table itself, we discover the address of the 4 base functions that every Amiga library has to provide, namely <code>Open</code>, <code>Close</code>, <code>Expunge</code>, and a reserved slot that should contain a function that returns 0.</p>
<h2><code>Open</code></h2>
<p>The first value is <code>0x08a0</code>, and if we sum this value to the address of the table itself we get <code>0x1a7c + 0x08a0 = 0x231c</code>. At this address we will find the first function defined in the jump table, that is <code>Open</code>.</p>
<p>The code is the following</p>
<div class="highlight"><pre><span></span><span class="c1">; Open</span>

<span class="nl">0000231c:</span> <span class="mi">200e</span>      <span class="k">move</span><span class="o">.l</span>  <span class="o">a6</span><span class="p">,</span><span class="o">d0</span>
<span class="nl">0000231e:</span> <span class="mi">526e</span> <span class="mi">0020</span> <span class="k">addq</span><span class="o">.w</span>  <span class="nl">#0x1</span><span class="p">,</span><span class="mi">0x20</span><span class="p">(</span><span class="o">a6</span><span class="p">)</span>
<span class="nl">00002322:</span> <span class="mi">4e75</span>      <span class="k">rts</span>
</pre></div>


<p>The <code>Open</code> routine expects the address of the library to be in the <code>a6</code> register, and returns the same value in <code>d0</code>. It then adds 1 to the number contained 32 bytes (<code>0x20</code>) after the address of the library itself and then returns. To find out what this number is we can go back again to the NDK and its include files.</p>
<p>From a previous investigation we know that, once the library has been installed in memory, there are two structures defined one after the other. The first is the <code>LN</code> structure that represents a linked list node, and the second is the <code>LIB</code> structure that represents the library.</p>
<p>We find the definition of <code>LN</code> in <code>include_i/exec/nodes.i</code></p>
<div class="highlight"><pre><span></span> <span class="n">STRUCTURE</span>    <span class="n">LN</span><span class="p">,</span><span class="mi">0</span>    <span class="c1">; List Node</span>
    <span class="n">APTR</span>    <span class="n">LN_SUCC</span> <span class="c1">; Pointer to next (successor)</span>
    <span class="n">APTR</span>    <span class="n">LN_PRED</span> <span class="c1">; Pointer to previous (predecessor)</span>
    <span class="n">UBYTE</span>   <span class="n">LN_TYPE</span>
    <span class="n">BYTE</span>    <span class="n">LN_PRI</span>  <span class="c1">; Priority, for sorting</span>
    <span class="n">APTR</span>    <span class="n">LN_NAME</span> <span class="c1">; ID string, null terminated</span>
    <span class="n">LABEL</span>   <span class="n">LN_SIZE</span> <span class="c1">; Note: word aligned</span>
</pre></div>


<p>and the definition of <code>LIB</code> in <code>include_i/exewc/libraries.i</code></p>
<div class="highlight"><pre><span></span> <span class="n">STRUCTURE</span> <span class="n">LIB</span><span class="p">,</span><span class="n">LN_SIZE</span>
    <span class="n">UBYTE</span>   <span class="n">LIB_FLAGS</span>           <span class="c1">; see below</span>
    <span class="n">UBYTE</span>   <span class="n">LIB_pad</span>         <span class="c1">; must be zero</span>
    <span class="n">UWORD</span>   <span class="n">LIB_NEGSIZE</span>     <span class="c1">; number of bytes before LIB</span>
    <span class="n">UWORD</span>   <span class="n">LIB_POSSIZE</span>     <span class="c1">; number of bytes after LIB</span>
    <span class="n">UWORD</span>   <span class="n">LIB_VERSION</span>     <span class="c1">; major</span>
    <span class="n">UWORD</span>   <span class="n">LIB_REVISION</span>        <span class="c1">; minor</span>
    <span class="n">APTR</span>    <span class="n">LIB_IDSTRING</span>        <span class="c1">; ASCII identification</span>
    <span class="n">ULONG</span>   <span class="n">LIB_SUM</span>         <span class="c1">; the system-calculated checksum</span>
    <span class="n">UWORD</span>   <span class="n">LIB_OPENCNT</span>     <span class="c1">; number of current opens</span>
    <span class="n">LABEL</span>   <span class="n">LIB_SIZE</span>    <span class="c1">;Warning: Size is not a longword multiple!</span>
</pre></div>


<p>As you can see this latter mentions the former reserving space for it at the beginning (<code>LN_SIZE</code>).</p>
<p><code>LABEL</code> is a macro that creates an alias for the current size of the structure, and you can find its definition in <code>include_i/exec/types.i</code>. It works in conjunction with the type macros, which increment the global variable <code>SOFFSET</code>. The code <code>LABEL LN_SIZE</code> in the <code>LN</code> structure produces the definition <code>LN_SIZE EQU 14</code>, which is thus a simple marker and does not contribute to the size of the structure itself.</p>
<p>The comment after the <code>LABEL</code> macro in the <code>LN</code> structure says that the structure is word aligned, and indeed its size is a multiple of a word (2 bytes): 2 <code>APTR</code> (8 bytes) + 1 <code>UBYTE</code> (1 byte) + 1 <code>BYTE</code> (1 byte) + 1 <code>APTR</code> (4 byte) = 14 bytes.</p>
<p>To find the field updated by <code>Open</code> we need to skip 32 bytes. So, after we skip the whole <code>LN</code> structure, we still have 18 bytes to skip into the <code>LIB</code> structure. At that offset we find the <code>LIB_OPENCNT</code> field (remember that <code>UBYTE</code> is 1 byte, <code>UWORD</code> 2 bytes, and <code>APTR</code> and <code>ULONG</code> 4 bytes). This field is, as the comment reads, the "number of current opens".</p>
<p>The last instruction of the <code>Open</code> function is <code>rts</code> (<code>r</code>e<code>t</code>urn from <code>s</code>ubroutine) that returns to the instruction after the <code>jsr</code> that called the function.</p>
<h2><code>Close</code>, <code>Expunge</code>, and the reserved slot</h2>
<p>Immediately after the definition of the <code>Open</code> function, we find the definition of <code>Close</code>, listed in the vector table as <code>0x08a8</code>, which becomes <code>0x1a7c + 0x08a8 = 0x2324</code>. The next two entries in the vector table contain the same value <code>0x08ac</code>, which translates to the absolute address <code>0x1a7c + 0x08ac = 0x2328</code>. This address is then the location of both the <code>Expunge</code> function and the reserved function that must return 0.</p>
<p>The code of the <code>Close</code> function is very simple, it just decrements the open counter (<code>0x20</code> in the library). There is no explicit <code>rts</code> as <code>Close</code> uses the adjacent <code>Expunge</code> code for that. Since it's impossible to remove the Exec library in the Amiga system, the <code>Expunge</code> function of the Exec library just returns 0, which is exactly what the reserved function has to do (thus the same address in the vector table), and what <code>Close</code> does after having decremented the open counter.</p>
<div class="highlight"><pre><span></span><span class="c1">; Close</span>
<span class="nl">00002324:</span> <span class="mi">536e</span> <span class="mi">0020</span> <span class="k">subq</span><span class="o">.w</span>  <span class="nl">#0x1</span><span class="p">,</span><span class="mi">0x20</span><span class="p">(</span><span class="o">a6</span><span class="p">)</span>

<span class="c1">; Expunge</span>
<span class="nl">00002328:</span> <span class="mi">7000</span>      <span class="k">moveq</span>   <span class="nl">#0</span><span class="p">,</span><span class="o">d0</span>
<span class="nl">0000232a:</span> <span class="mi">4e75</span>      <span class="k">rts</span>     
</pre></div>


<h1><code>MakeFunctions</code></h1>
<p>The <code>MakeFunctions</code> routine is used by Exec to create the vector table at the beginning of the library when it is loaded in memory. You might recall that the vector table is created backward from the beginning of the library, thus allowing to use a simpler addressing scheme.</p>
<p>The prototype of the <code>MakeFunctions</code> routine is</p>
<div class="highlight"><pre><span></span><span class="n">size</span> <span class="o">=</span> <span class="n">MakeFunctions</span><span class="p">(</span><span class="n">addess</span><span class="p">,</span> <span class="n">vectors</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
<span class="n">d0</span>                   <span class="n">a0</span>      <span class="n">a1</span>       <span class="n">a2</span>
</pre></div>


<p>and the code that we found in one of the previous investigations is at offset <code>0x15b2</code></p>
<div class="highlight"><pre><span></span><span class="nl">000015b2:</span> <span class="mi">2f0b</span>                      <span class="k">move</span><span class="o">.l</span>  <span class="o">a3</span><span class="p">,-(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">000015b4:</span> <span class="mi">7000</span>                      <span class="k">moveq</span>   <span class="nl">#0</span><span class="p">,</span><span class="o">d0</span>
<span class="nl">000015b6:</span> <span class="mi">220a</span>                      <span class="k">move</span><span class="o">.l</span>  <span class="o">a2</span><span class="p">,</span><span class="o">d1</span>
<span class="nl">000015b8:</span> <span class="mi">6716</span>                      <span class="k">beq</span><span class="o">.b</span>   <span class="mi">0x15d0</span>
<span class="nl">000015ba:</span> <span class="mi">3219</span>                      <span class="k">move</span><span class="o">.w</span>  <span class="p">(</span><span class="o">a1</span><span class="p">)+,</span><span class="o">d1</span>
<span class="nl">000015bc:</span> <span class="mi">0c41</span> <span class="mi">ffff</span>                 <span class="k">cmpi</span><span class="o">.w</span>  <span class="p">#-</span><span class="mi">0x1</span><span class="p">,</span><span class="o">d1</span>
<span class="nl">000015c0:</span> <span class="mi">6722</span>                      <span class="k">beq</span><span class="o">.b</span>   <span class="mi">0x15e4</span>
<span class="nl">000015c2:</span> <span class="mi">47f2</span> <span class="mi">1000</span>                 <span class="k">lea</span>     <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">a2</span><span class="p">,</span><span class="o">d1.w</span><span class="p">),</span><span class="o">a3</span>
<span class="nl">000015c6:</span> <span class="mi">210b</span>                      <span class="k">move</span><span class="o">.l</span>  <span class="o">a3</span><span class="p">,-(</span><span class="o">a0</span><span class="p">)</span>
<span class="nl">000015c8:</span> <span class="mi">313c</span> <span class="mi">4ef9</span>                 <span class="k">move</span><span class="o">.w</span>  <span class="nl">#0x4ef9</span><span class="p">,-(</span><span class="o">a0</span><span class="p">)</span>
<span class="nl">000015cc:</span> <span class="mi">5c80</span>                      <span class="k">addq</span><span class="o">.l</span>  <span class="nl">#0x6</span><span class="p">,</span><span class="o">d0</span>
<span class="nl">000015ce:</span> <span class="mi">60ea</span>                      <span class="k">bra</span><span class="o">.b</span>   <span class="mi">0x15ba</span>
<span class="nl">000015d0:</span> <span class="mi">2219</span>                      <span class="k">move</span><span class="o">.l</span>  <span class="p">(</span><span class="o">a1</span><span class="p">)+,</span><span class="o">d1</span>
<span class="nl">000015d2:</span> <span class="mi">0c81</span> <span class="mi">ffff</span> <span class="mi">ffff</span>            <span class="k">cmpi</span><span class="o">.l</span>  <span class="p">#-</span><span class="mi">0x1</span><span class="p">,</span><span class="o">d1</span>
<span class="nl">000015d8:</span> <span class="mi">670a</span>                      <span class="k">beq</span><span class="o">.b</span>   <span class="mi">0x15e4</span>
<span class="nl">000015da:</span> <span class="mi">2101</span>                      <span class="k">move</span><span class="o">.l</span>  <span class="o">d1</span><span class="p">,-(</span><span class="o">a0</span><span class="p">)</span>
<span class="nl">000015dc:</span> <span class="mi">313c</span> <span class="mi">4ef9</span>                 <span class="k">move</span><span class="o">.w</span>  <span class="nl">#0x4ef9</span><span class="p">,-(</span><span class="o">a0</span><span class="p">)</span>
<span class="nl">000015e0:</span> <span class="mi">5c80</span>                      <span class="k">addq</span><span class="o">.l</span>  <span class="nl">#0x6</span><span class="p">,</span><span class="o">d0</span>
<span class="nl">000015e2:</span> <span class="mi">60ec</span>                      <span class="k">bra</span><span class="o">.b</span>   <span class="mi">0x15d0</span>
<span class="nl">000015e4:</span> <span class="mi">265f</span>                      <span class="k">movea</span><span class="o">.l</span> <span class="p">(</span><span class="n">sp</span><span class="p">)+,</span><span class="o">a3</span>
<span class="nl">000015e6:</span> <span class="mi">4e75</span>                      <span class="k">rts</span>     
</pre></div>


<p>The code is probably easier to read if we replace the addresses with some labels</p>
<div class="highlight"><pre><span></span><span class="nl">Setup:</span>
<span class="nl">000015b2:</span> <span class="mi">2f0b</span>                      <span class="k">move</span><span class="o">.l</span>  <span class="o">a3</span><span class="p">,-(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">000015b4:</span> <span class="mi">7000</span>                      <span class="k">moveq</span>   <span class="nl">#0</span><span class="p">,</span><span class="o">d0</span>
<span class="nl">000015b6:</span> <span class="mi">220a</span>                      <span class="k">move</span><span class="o">.l</span>  <span class="o">a2</span><span class="p">,</span><span class="o">d1</span>
<span class="nl">000015b8:</span> <span class="mi">6716</span>                      <span class="k">beq</span><span class="o">.b</span>   <span class="n">Absolute</span>

<span class="nl">Relative:</span>
<span class="nl">000015ba:</span> <span class="mi">3219</span>                      <span class="k">move</span><span class="o">.w</span>  <span class="p">(</span><span class="o">a1</span><span class="p">)+,</span><span class="o">d1</span>
<span class="nl">000015bc:</span> <span class="mi">0c41</span> <span class="mi">ffff</span>                 <span class="k">cmpi</span><span class="o">.w</span>  <span class="p">#-</span><span class="mi">0x1</span><span class="p">,</span><span class="o">d1</span>
<span class="nl">000015c0:</span> <span class="mi">6722</span>                      <span class="k">beq</span><span class="o">.b</span>   <span class="n">Cleanup</span>
<span class="nl">000015c2:</span> <span class="mi">47f2</span> <span class="mi">1000</span>                 <span class="k">lea</span>     <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">a2</span><span class="p">,</span><span class="o">d1.w</span><span class="p">),</span><span class="o">a3</span>
<span class="nl">000015c6:</span> <span class="mi">210b</span>                      <span class="k">move</span><span class="o">.l</span>  <span class="o">a3</span><span class="p">,-(</span><span class="o">a0</span><span class="p">)</span>
<span class="nl">000015c8:</span> <span class="mi">313c</span> <span class="mi">4ef9</span>                 <span class="k">move</span><span class="o">.w</span>  <span class="nl">#0x4ef9</span><span class="p">,-(</span><span class="o">a0</span><span class="p">)</span>
<span class="nl">000015cc:</span> <span class="mi">5c80</span>                      <span class="k">addq</span><span class="o">.l</span>  <span class="nl">#0x6</span><span class="p">,</span><span class="o">d0</span>
<span class="nl">000015ce:</span> <span class="mi">60ea</span>                      <span class="k">bra</span><span class="o">.b</span>   <span class="n">Relative</span>

<span class="nl">Absolute:</span>
<span class="nl">000015d0:</span> <span class="mi">2219</span>                      <span class="k">move</span><span class="o">.l</span>  <span class="p">(</span><span class="o">a1</span><span class="p">)+,</span><span class="o">d1</span>
<span class="nl">000015d2:</span> <span class="mi">0c81</span> <span class="mi">ffff</span> <span class="mi">ffff</span>            <span class="k">cmpi</span><span class="o">.l</span>  <span class="p">#-</span><span class="mi">0x1</span><span class="p">,</span><span class="o">d1</span>
<span class="nl">000015d8:</span> <span class="mi">670a</span>                      <span class="k">beq</span><span class="o">.b</span>   <span class="n">Cleanup</span>
<span class="nl">000015da:</span> <span class="mi">2101</span>                      <span class="k">move</span><span class="o">.l</span>  <span class="o">d1</span><span class="p">,-(</span><span class="o">a0</span><span class="p">)</span>
<span class="nl">000015dc:</span> <span class="mi">313c</span> <span class="mi">4ef9</span>                 <span class="k">move</span><span class="o">.w</span>  <span class="nl">#0x4ef9</span><span class="p">,-(</span><span class="o">a0</span><span class="p">)</span>
<span class="nl">000015e0:</span> <span class="mi">5c80</span>                      <span class="k">addq</span><span class="o">.l</span>  <span class="nl">#0x6</span><span class="p">,</span><span class="o">d0</span>
<span class="nl">000015e2:</span> <span class="mi">60ec</span>                      <span class="k">bra</span><span class="o">.b</span>   <span class="n">Absolute</span>

<span class="nl">Cleanup:</span>
<span class="nl">000015e4:</span> <span class="mi">265f</span>                      <span class="k">movea</span><span class="o">.l</span> <span class="p">(</span><span class="n">sp</span><span class="p">)+,</span><span class="o">a3</span>
<span class="nl">000015e6:</span> <span class="mi">4e75</span>                      <span class="k">rts</span>     
</pre></div>


<h2>Setup</h2>
<p>The first part of the code is</p>
<div class="highlight"><pre><span></span><span class="nl">Setup:</span>
<span class="nl">000015b2:</span> <span class="mi">2f0b</span>                      <span class="k">move</span><span class="o">.l</span>  <span class="o">a3</span><span class="p">,-(</span><span class="n">sp</span><span class="p">)</span>
<span class="nl">000015b4:</span> <span class="mi">7000</span>                      <span class="k">moveq</span>   <span class="nl">#0</span><span class="p">,</span><span class="o">d0</span>
<span class="nl">000015b6:</span> <span class="mi">220a</span>                      <span class="k">move</span><span class="o">.l</span>  <span class="o">a2</span><span class="p">,</span><span class="o">d1</span>
<span class="nl">000015b8:</span> <span class="mi">6716</span>                      <span class="k">beq</span><span class="o">.b</span>   <span class="n">Absolute</span>
</pre></div>


<p>The first thing this code does is to save the <code>a3</code> register in the stack because it will be changed during the routine.</p>
<div class="highlight"><pre><span></span><span class="nl">Setup:</span>
<span class="nl">000015b2:</span> <span class="mi">2f0b</span>                      <span class="k">move</span><span class="o">.l</span>  <span class="o">a3</span><span class="p">,-(</span><span class="n">sp</span><span class="p">)</span>
</pre></div>


<p>In Assembly, variables are provided by registers and thus are not namespaced, as the registers are the same through the whole program. This is why you should save and restore them and document which one you will change, for instance to return values.</p>
<p>Secondly, the code sets the <code>d0</code> register to 0.</p>
<div class="highlight"><pre><span></span><span class="nl">000015b4:</span> <span class="mi">7000</span>                      <span class="k">moveq</span>   <span class="nl">#0</span><span class="p">,</span><span class="o">d0</span>
</pre></div>


<p>This register, according to the function prototype, will contain the final size of the jump table, and 0 is a sensible starting value.</p>
<p>Lastly, the code moves the <code>a2</code> register to <code>d1</code> to be able to manipulate it. </p>
<div class="highlight"><pre><span></span><span class="nl">000015b6:</span> <span class="mi">220a</span>                      <span class="k">move</span><span class="o">.l</span>  <span class="o">a2</span><span class="p">,</span><span class="o">d1</span>
<span class="nl">000015b8:</span> <span class="mi">6716</span>                      <span class="k">beq</span><span class="o">.b</span>   <span class="n">Absolute</span>
</pre></div>


<p>This, however, also sets the processor flags according to the value of <code>a2</code> itself, and those flags are used in the next <code>beq.b</code> instruction. If <code>a2</code> contains the value 0 the table is absolute (code at <code>0x15d0</code>, labelled <code>Absolute</code> here) otherwise it is relative (code at <code>0x15ba</code>, labelled <code>Relative</code> here).</p>
<h2>Relative</h2>
<p>The second section manages relative jump vectors</p>
<div class="highlight"><pre><span></span><span class="nl">Relative:</span>
<span class="nl">000015ba:</span> <span class="mi">3219</span>                      <span class="k">move</span><span class="o">.w</span>  <span class="p">(</span><span class="o">a1</span><span class="p">)+,</span><span class="o">d1</span>
<span class="nl">000015bc:</span> <span class="mi">0c41</span> <span class="mi">ffff</span>                 <span class="k">cmpi</span><span class="o">.w</span>  <span class="p">#-</span><span class="mi">0x1</span><span class="p">,</span><span class="o">d1</span>
<span class="nl">000015c0:</span> <span class="mi">6722</span>                      <span class="k">beq</span><span class="o">.b</span>   <span class="n">Cleanup</span>
<span class="nl">000015c2:</span> <span class="mi">47f2</span> <span class="mi">1000</span>                 <span class="k">lea</span>     <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">a2</span><span class="p">,</span><span class="o">d1.w</span><span class="p">),</span><span class="o">a3</span>
<span class="nl">000015c6:</span> <span class="mi">210b</span>                      <span class="k">move</span><span class="o">.l</span>  <span class="o">a3</span><span class="p">,-(</span><span class="o">a0</span><span class="p">)</span>
<span class="nl">000015c8:</span> <span class="mi">313c</span> <span class="mi">4ef9</span>                 <span class="k">move</span><span class="o">.w</span>  <span class="nl">#0x4ef9</span><span class="p">,-(</span><span class="o">a0</span><span class="p">)</span>
<span class="nl">000015cc:</span> <span class="mi">5c80</span>                      <span class="k">addq</span><span class="o">.l</span>  <span class="nl">#0x6</span><span class="p">,</span><span class="o">d0</span>
<span class="nl">000015ce:</span> <span class="mi">60ea</span>                      <span class="k">bra</span><span class="o">.b</span>   <span class="n">Relative</span>
</pre></div>


<p>This fetches one of the vectors from the address stored in <code>a1</code> (the address of the vector table), immediately incrementing the register value to point at the next vector.</p>
<div class="highlight"><pre><span></span><span class="nl">Relative:</span>
<span class="nl">000015ba:</span> <span class="mi">3219</span>                      <span class="k">move</span><span class="o">.w</span>  <span class="p">(</span><span class="o">a1</span><span class="p">)+,</span><span class="o">d1</span>
</pre></div>


<p>then compares it with <code>0xffff</code> (or <code>#-0x1</code>) to see if we reached the end of the table. In that case the code jumps to the fourth section (<code>0x15e4</code>, labelled <code>Cleanup</code>), otherwise the execution continues with the next instruction</p>
<div class="highlight"><pre><span></span><span class="nl">000015bc:</span> <span class="mi">0c41</span> <span class="mi">ffff</span>                 <span class="k">cmpi</span><span class="o">.w</span>  <span class="p">#-</span><span class="mi">0x1</span><span class="p">,</span><span class="o">d1</span>
<span class="nl">000015c0:</span> <span class="mi">6722</span>                      <span class="k">beq</span><span class="o">.b</span>   <span class="n">Cleanup</span>
</pre></div>


<p>The routine then loads the effective address of the relative vector using <code>a2</code> as the base addressing, and stores it in <code>a3</code>. This register now contains the final entry that will be part of the jump table.</p>
<div class="highlight"><pre><span></span><span class="nl">000015c2:</span> <span class="mi">47f2</span> <span class="mi">1000</span>                 <span class="k">lea</span>     <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">a2</span><span class="p">,</span><span class="o">d1.w</span><span class="p">),</span><span class="o">a3</span>
</pre></div>


<p>Since the address of the jump table is contained in <code>a0</code>, the resulting absolute vector is stored there, then the code stores the value <code>0x4ef9</code> which is the code for the <code>jmp</code> instruction (more on this later)</p>
<div class="highlight"><pre><span></span><span class="nl">000015c6:</span> <span class="mi">210b</span>                      <span class="k">move</span><span class="o">.l</span>  <span class="o">a3</span><span class="p">,-(</span><span class="o">a0</span><span class="p">)</span>
<span class="nl">000015c8:</span> <span class="mi">313c</span> <span class="mi">4ef9</span>                 <span class="k">move</span><span class="o">.w</span>  <span class="nl">#0x4ef9</span><span class="p">,-(</span><span class="o">a0</span><span class="p">)</span>
</pre></div>


<p>Note that since we are storing the jump table at negative addresses starting from the library's base pointer we have to copy the argument (the address) first and then the function (the code for <code>jmp</code>). The last thing this part of the code does is to add 6 to the size of the jump table (1 word for the instruction, 2 words for the address) and then jumps back to the beginning of the loop.</p>
<div class="highlight"><pre><span></span><span class="nl">000015cc:</span> <span class="mi">5c80</span>                      <span class="k">addq</span><span class="o">.l</span>  <span class="nl">#0x6</span><span class="p">,</span><span class="o">d0</span>
<span class="nl">000015ce:</span> <span class="mi">60ea</span>                      <span class="k">bra</span><span class="o">.b</span>   <span class="n">Relative</span>
</pre></div>


<h2>Absolute</h2>
<p>The third section is very similar to the second one, because it performs the same actions, only with absolute addresses instead of relative ones.</p>
<div class="highlight"><pre><span></span><span class="nl">000015d0:</span> <span class="mi">2219</span>                      <span class="k">move</span><span class="o">.l</span>  <span class="p">(</span><span class="o">a1</span><span class="p">)+,</span><span class="o">d1</span>
<span class="nl">000015d2:</span> <span class="mi">0c81</span> <span class="mi">ffff</span> <span class="mi">ffff</span>            <span class="k">cmpi</span><span class="o">.l</span>  <span class="p">#-</span><span class="mi">0x1</span><span class="p">,</span><span class="o">d1</span>
<span class="nl">000015d8:</span> <span class="mi">670a</span>                      <span class="k">beq</span><span class="o">.b</span>   <span class="n">Cleanup</span>
<span class="nl">000015da:</span> <span class="mi">2101</span>                      <span class="k">move</span><span class="o">.l</span>  <span class="o">d1</span><span class="p">,-(</span><span class="o">a0</span><span class="p">)</span>
<span class="nl">000015dc:</span> <span class="mi">313c</span> <span class="mi">4ef9</span>                 <span class="k">move</span><span class="o">.w</span>  <span class="nl">#0x4ef9</span><span class="p">,-(</span><span class="o">a0</span><span class="p">)</span>
<span class="nl">000015e0:</span> <span class="mi">5c80</span>                      <span class="k">addq</span><span class="o">.l</span>  <span class="nl">#0x6</span><span class="p">,</span><span class="o">d0</span>
<span class="nl">000015e2:</span> <span class="mi">60ec</span>                      <span class="k">bra</span><span class="o">.b</span>   <span class="n">Absolute</span>
</pre></div>


<p>The only difference with the previous section is that there is no need to load the effective address, as the vale contained in <code>d1</code> is already absolute, so this latter can be stored directly.</p>
<h2>Cleanup</h2>
<p>The last section simply restores the stack pointer, popping the value of the <code>a3</code> register where the pointer was previously saved, and returns to the caller.</p>
<div class="highlight"><pre><span></span><span class="nl">000015e4:</span> <span class="mi">265f</span>                      <span class="k">movea</span><span class="o">.l</span> <span class="p">(</span><span class="n">sp</span><span class="p">)+,</span><span class="o">a3</span>
<span class="nl">000015e6:</span> <span class="mi">4e75</span>                      <span class="k">rts</span>     
</pre></div>


<h1>Self modifying code</h1>
<p>The creation of the jump table performed by the <code>MakeFunctions</code> routine leverages a very powerful feature of any assembly language, that is being able to produce code that self modifies. This feature comes from a property of machine languages called <a href="https://en.wikipedia.org/wiki/Homoiconicity">homoiconicity</a>.</p>
<p>The basic idea of homoiconicity is that the language doesn't consider data and code two different things, thus allowing to use the code as an input for routines and to change it programmatically. Pay attention that self-modifying code is just one of the implications of homoiconicity, and not its definition.</p>
<p>Homoiconicity is a feature rarely provided by languages. It is very powerful, but it basically forces to keep the language at the level of its own AST (Abstract Syntax Tree), which in turn means that you cannot add a proper abstraction, or, if you prefer, a proper high level language, if we identify with this term a computer language that is similar to the human language.</p>
<p>Famous examples of high level languages that are homoiconic are Lisp and Prolog. Lisp is a language that manages lists and its syntax is based on... lists. This means that you can pass Lisp code to a function and transform it like you would do with standard data.</p>
<p>Back to the Motorola Assembly code, the line we are interested in is </p>
<div class="highlight"><pre><span></span><span class="nl">000015c8:</span> <span class="mi">313c</span> <span class="mi">4ef9</span>                 <span class="k">move</span><span class="o">.w</span>  <span class="nl">#0x4ef9</span><span class="p">,-(</span><span class="o">a0</span><span class="p">)</span>
</pre></div>


<p>This decrements the address contained in <code>a0</code> by 2 bytes, then stores at the resulting address the hexadecimal number <code>0x4ef9</code>.</p>
<p>The interesting part is that the number <code>0x4ef9</code> has a specific meaning for the Motorola 68000 processor, and namely that of the <code>jmp</code> instruction. This is clearly shown by the tables in the Programmer's Reference Manual (Section 8, Instruction Format Summary, 8-15).</p>
<p>First we have to convert the number in binary, and we get</p>
<div class="highlight"><pre><span></span>0x4ef9 -&gt; 0100 1110 1111 1001
</pre></div>


<p>The first 10 bits (<code>0100 1110 11</code>) already identify a <code>jmp</code> instruction. The following 6 bits (<code>111 001</code>) identify the addressing mode, which in this case is <code>Absolute Long</code> or <code>(xxx).L</code> (Programmer's Reference Manual, 4-108). This instruction shall then be followed by a 4 bytes absolute address.</p>
<p>With that <code>move.w</code>, then, the code writes in memory some Assembly code. Techniques like this have been and are used by games and viruses to obfuscate the code, as a static analysis of the binary will not reveal what will be there only at runtime!</p>
<h1>Resources</h1>
<ul>
<li>Motorola M68000 Family Programmer's Reference Manual <a href="https://www.nxp.com/docs/en/reference-manual/M68000PRM.pdf">PDF here</a></li>
<li><a href="http://amigadev.elowar.com">AmigaOS Developer Docs</a></li>
</ul>
<h1>Feedback</h1>
<p>Feel free to reach me on <a href="https://twitter.com/thedigicat">Twitter</a> if you have questions. The <a href="http://github.com/TheDigitalCatOnline/thedigitalcatonline.github.com/issues">GitHub issues</a> page is the best place to submit corrections.</p>
        </section>

<section id="related-posts">
    <h2>Related Posts</h2>
    <div class="box">
        <ul>
            <li><a href="http://blog.thedigitalcatonline.com/blog/2018/06/08/exploring-the-amiga-3/">Exploring the Amiga - Part 3</a></li>
            <li><a href="http://blog.thedigitalcatonline.com/blog/2018/05/28/exploring-the-amiga-2/">Exploring the Amiga - Part 2</a></li>
            <li><a href="http://blog.thedigitalcatonline.com/blog/2018/05/28/exploring-the-amiga-1/">Exploring the Amiga - Part 1</a></li>
        </ul>
    </div>
</section>
<section id="series">
    <h2>Part 4 of the Exploring the Amiga series</h2>
    <div class="box">
        <h5>Previous articles</h5>
        <ul>
            <li><a href="http://blog.thedigitalcatonline.com/blog/2018/05/28/exploring-the-amiga-1/">Exploring the Amiga - Part 1</a></li>
            <li><a href="http://blog.thedigitalcatonline.com/blog/2018/05/28/exploring-the-amiga-2/">Exploring the Amiga - Part 2</a></li>
            <li><a href="http://blog.thedigitalcatonline.com/blog/2018/06/08/exploring-the-amiga-3/">Exploring the Amiga - Part 3</a></li>
        </ul>
    
    </div>
</section>
    </article>


                        </div>
                    </div>

                <!-- Sidebar -->
                    <div id="sidebar">
<div class="inner">
    <!-- Menu -->
    <nav id="menu">
        <header class="major">
            <h2>Menu</h2>
        </header>
        <ul>
            <li><a href="http://blog.thedigitalcatonline.com/">Homepage</a></li>
            <li><a href="http://blog.thedigitalcatonline.com/pages/about.html">About</a></li>
            <li><a href="http://blog.thedigitalcatonline.com/archives/">Archives</a></li>
        </ul>
    </nav>

    <!-- Feeds -->
<section>
    <header class="major">
        <h2>Feeds</h2>
    </header>
    <ul class="list-clean">
        <li><a href="http://blog.thedigitalcatonline.com/atom.xml"><i class="fa fa-rss"></i> All posts</a></li>


        <li><a href="http://blog.thedigitalcatonline.com/category/retro/atom.xml"><i class="fa fa-rss"></i> All posts in category: Retro</a></li>
    </ul>
</section>
    <!-- Recent posts -->
<section>
    <header class="major">
        <h2>Recent posts</h2>
    </header>
    <div class="mini-posts">
        <article>
            Exploring the Amiga - Part 4
            <a href="http://blog.thedigitalcatonline.com/blog/2018/06/14/exploring-the-amiga-4/"> Read</a>
        </article>
        <article>
            Exploring the Amiga - Part 3
            <a href="http://blog.thedigitalcatonline.com/blog/2018/06/08/exploring-the-amiga-3/"> Read</a>
        </article>
        <article>
            A game of tokens: solution - Part 4
            <a href="http://blog.thedigitalcatonline.com/blog/2018/06/02/a-game-of-tokens-solution-part-4/"> Read</a>
        </article>
        <article>
            A game of tokens: write an interpreter in Python with TDD - Part 4
            <a href="http://blog.thedigitalcatonline.com/blog/2018/06/02/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-4/"> Read</a>
        </article>
        <article>
            Exploring the Amiga - Part 2
            <a href="http://blog.thedigitalcatonline.com/blog/2018/05/28/exploring-the-amiga-2/"> Read</a>
        </article>
    </div>
</section>
    <!-- Tags -->
<section>
    <header class="major">
        <h2>Tags</h2>
    </header>
    <ul class="list-inline list-clean" id="tags-side">
        <li class="tag-3">
            <a href="http://blog.thedigitalcatonline.com/categories/algorithms/">algorithms</a>
        </li>
        <li class="tag-2">
            <a href="http://blog.thedigitalcatonline.com/categories/amiga/">amiga</a>
        </li>
        <li class="tag-4">
            <a href="http://blog.thedigitalcatonline.com/categories/amqp/">AMQP</a>
        </li>
        <li class="tag-4">
            <a href="http://blog.thedigitalcatonline.com/categories/architectures/">architectures</a>
        </li>
        <li class="tag-2">
            <a href="http://blog.thedigitalcatonline.com/categories/assembly/">assembly</a>
        </li>
        <li class="tag-2">
            <a href="http://blog.thedigitalcatonline.com/categories/c/">C</a>
        </li>
        <li class="tag-4">
            <a href="http://blog.thedigitalcatonline.com/categories/clojure/">Clojure</a>
        </li>
        <li class="tag-2">
            <a href="http://blog.thedigitalcatonline.com/categories/compilers/">compilers</a>
        </li>
        <li class="tag-2">
            <a href="http://blog.thedigitalcatonline.com/categories/concurrent-programming/">concurrent programming</a>
        </li>
        <li class="tag-4">
            <a href="http://blog.thedigitalcatonline.com/categories/cryptography/">cryptography</a>
        </li>
        <li class="tag-2">
            <a href="http://blog.thedigitalcatonline.com/categories/decorators/">decorators</a>
        </li>
        <li class="tag-3">
            <a href="http://blog.thedigitalcatonline.com/categories/django/">Django</a>
        </li>
        <li class="tag-3">
            <a href="http://blog.thedigitalcatonline.com/categories/erlang/">Erlang</a>
        </li>
        <li class="tag-1">
            <a href="http://blog.thedigitalcatonline.com/categories/functional-programming/">functional programming</a>
        </li>
        <li class="tag-3">
            <a href="http://blog.thedigitalcatonline.com/categories/generators/">generators</a>
        </li>
        <li class="tag-3">
            <a href="http://blog.thedigitalcatonline.com/categories/git/">Git</a>
        </li>
        <li class="tag-2">
            <a href="http://blog.thedigitalcatonline.com/categories/metaclasses/">metaclasses</a>
        </li>
        <li class="tag-2">
            <a href="http://blog.thedigitalcatonline.com/categories/metaprogramming/">metaprogramming</a>
        </li>
        <li class="tag-3">
            <a href="http://blog.thedigitalcatonline.com/categories/notebook/">Notebook</a>
        </li>
        <li class="tag-1">
            <a href="http://blog.thedigitalcatonline.com/categories/oop/">OOP</a>
        </li>
        <li class="tag-2">
            <a href="http://blog.thedigitalcatonline.com/categories/operating-systems/">operating systems</a>
        </li>
        <li class="tag-4">
            <a href="http://blog.thedigitalcatonline.com/categories/pika/">Pika</a>
        </li>
        <li class="tag-4">
            <a href="http://blog.thedigitalcatonline.com/categories/postage/">Postage</a>
        </li>
        <li class="tag-1">
            <a href="http://blog.thedigitalcatonline.com/categories/python/">Python</a>
        </li>
        <li class="tag-2">
            <a href="http://blog.thedigitalcatonline.com/categories/python2/">Python2</a>
        </li>
        <li class="tag-1">
            <a href="http://blog.thedigitalcatonline.com/categories/python3/">Python3</a>
        </li>
        <li class="tag-3">
            <a href="http://blog.thedigitalcatonline.com/categories/rabbitmq/">RabbitMQ</a>
        </li>
        <li class="tag-4">
            <a href="http://blog.thedigitalcatonline.com/categories/refactoring/">refactoring</a>
        </li>
        <li class="tag-2">
            <a href="http://blog.thedigitalcatonline.com/categories/retroprogramming/">retroprogramming</a>
        </li>
        <li class="tag-4">
            <a href="http://blog.thedigitalcatonline.com/categories/rsa/">RSA</a>
        </li>
        <li class="tag-1">
            <a href="http://blog.thedigitalcatonline.com/categories/scala/">Scala</a>
        </li>
        <li class="tag-4">
            <a href="http://blog.thedigitalcatonline.com/categories/ssh/">SSH</a>
        </li>
        <li class="tag-4">
            <a href="http://blog.thedigitalcatonline.com/categories/ssl/">SSL</a>
        </li>
        <li class="tag-1">
            <a href="http://blog.thedigitalcatonline.com/categories/tdd/">TDD</a>
        </li>
        <li class="tag-1">
            <a href="http://blog.thedigitalcatonline.com/categories/testing/">testing</a>
        </li>
        <li class="tag-3">
            <a href="http://blog.thedigitalcatonline.com/categories/versioning/">versioning</a>
        </li>
    </ul>
</section>
    <!-- Section -->
<section>
    <header class="major">
        <h2>Get in touch</h2>
    </header>
    <ul class="list-clean" id="social">
        
        
        
        <li class="list-item-spaced"><a href="https://twitter.com/thedigicat"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
        
        
        
        
        <li class="list-item-spaced"><a href="https://plus.google.com/u/0/111444750762335924049"><i class="fa fa-google-plus-square fa-lg"></i> Google+</a></li>
        
        
        
        
        <li class="list-item-spaced"><a href="https://github.com/TheDigitalCatOnline"><i class="fa fa-github-square fa-lg"></i> GitHub</a></li>
        
    </ul>
</section>
    <!-- Footer -->
    <footer id="footer">
        <p class="copyright">Editorial theme by: <a href="https://html5up.net">HTML5 UP</a>.</p>
    </footer>

</div>                    </div>

            </div>

        <!-- Scripts -->
            <script src="http://blog.thedigitalcatonline.com/theme/js/jquery.min.js"></script>
            <script src="http://blog.thedigitalcatonline.com/theme/js/skel.min.js"></script>
            <script src="http://blog.thedigitalcatonline.com/theme/js/util.js"></script>
            <!--[if lte IE 8]><script src="http://blog.thedigitalcatonline.com/theme/js/ie/respond.min.js"></script><![endif]-->
            <script src="http://blog.thedigitalcatonline.com/theme/js/main.js"></script>

    </body>
</html>