<!DOCTYPE HTML>
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
        <title>Flask project setup: TDD, Docker, Postgres and more - Part 2 - The Digital Cat</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<meta name="description" content="A step-by-step tutorial on how to setup a Flask project with TDD, Docker and Postgres">
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@thedigicat" />
<meta name="twitter:title" content="Flask project setup: TDD, Docker, Postgres and more - Part 2" />
<meta name="twitter:description" content="A step-by-step tutorial on how to setup a Flask project with TDD, Docker and Postgres" />
<meta name="twitter:image" content="https://www.thedigitalcatonline.com/images/flask-project-setup-tdd-docker-postgres-and-more-part-2.jpg" />
		<script src="https://kit.fontawesome.com/15214b60ba.js" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,400italic,600italic|Roboto+Slab:400,700">

        <link rel="stylesheet" href="/theme/css/main.min.css?59943907">

        
        <link href="/images/global/favicon.jpg" rel="icon">

        <!-- Google Analytics Universal -->
        <script type="text/javascript">
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-74364524-1', 'auto');
            ga('send', 'pageview');
        </script>
        <!-- End Google Analytics Universal Code -->

<script type="application/ld+json">
  {
      "@context" : "https://schema.org",
      "@type" : "Article",
      "name" : "Flask project setup: TDD, Docker, Postgres and more - Part 2",
      "author" : {
	  "@type" : "Person",
	  "name" : "Leonardo Giordani"
      },
      "publisher" : {
	  "@type" : "Organization",
	  "name" : "The Digital Cat",
	  "logo" : {
	      "@type" : "ImageObject",
	      "url" : "https://www.thedigitalcatonline.com/images/global/logo_200.jpg",
	      "height" : 200,
	      "width" : 200
	  }
      },
      "mainEntityOfPage": {
	  "@type": "WebPage",
	  "@id": "https://www.thedigitalcatonline.com/blog/2020/07/06/flask-project-setup-tdd-docker-postgres-and-more-part-2/"
      },
      "datePublished" : "06/07/2020",
      "dateModified" : "06/07/2020",
      "image" : "https://www.thedigitalcatonline.com/images/flask-project-setup-tdd-docker-postgres-and-more-part-2.jpg",
      "description" : "A step-by-step tutorial on how to setup a Flask project with TDD, Docker and Postgres",
      "headline" : "A step-by-step tutorial on how to setup a Flask project with TDD, Docker and Postgres",
      "url" : "https://www.thedigitalcatonline.com/blog/2020/07/06/flask-project-setup-tdd-docker-postgres-and-more-part-2/"
  }
</script>
	</head>
	<body class="is-preload">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Main -->
					<div id="main">
						<div class="inner">

<header id="header">
  <a class="logo" href="/category/programming/" title="Programming">All posts in category Programming <i class="fas fa-link"></i></a>
  <div class="align-right">

    <a href="/blog/2020/07/05/flask-project-setup-tdd-docker-postgres-and-more-part-1/"><i class="fas fa-caret-square-left"></i></a>
    
    Flask project setup #2

    <a href="/blog/2020/07/07/flask-project-setup-tdd-docker-postgres-and-more-part-3/"><i class="fas fa-caret-square-right"></i></a>

  </div>
</header>

<!-- <article class="post"> -->

  <section id="header">
    <header class="main">
      <h1>Flask project setup: TDD, Docker, Postgres and more - Part 2</h1>
    </header>
  </section>

  <section id="post-info">
    <p class="article-info">
    By Leonardo Giordani

    <span class="fas fa-calendar-alt"></span> <time datetime="2020-07-06T13:00:00+01:00"> 06/07/2020</time>


    <span class="fas fa-tags"></span>
    <a class="tag" href="/categories/aws/">AWS</a>    <a class="tag" href="/categories/docker/">Docker</a>    <a class="tag" href="/categories/flask/">Flask</a>    <a class="tag" href="/categories/http/">HTTP</a>    <a class="tag" href="/categories/postgres/">Postgres</a>    <a class="tag" href="/categories/python/">Python</a>    <a class="tag" href="/categories/python3/">Python3</a>    <a class="tag" href="/categories/tdd/">TDD</a>    <a class="tag" href="/categories/testing/">testing</a>    <a class="tag" href="/categories/www/">WWW</a>    <br>
    Share on: <span><a class="" href="https://twitter.com/intent/tweet?text=Flask%20project%20setup%3A%20TDD%2C%20Docker%2C%20Postgres%20and%20more%20-%20Part%202&url=https%3A//www.thedigitalcatonline.com/blog/2020/07/06/flask-project-setup-tdd-docker-postgres-and-more-part-2/&via=thedigicat&hashtags=aws,docker,flask,http,postgres,python,python3,tdd,testing,www" target="_blank" title="Share on Twitter"><i class="fab fa-twitter"></i> Twitter</a></span>
<span><a class="" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A//www.thedigitalcatonline.com/blog/2020/07/06/flask-project-setup-tdd-docker-postgres-and-more-part-2/&title=Flask%20project%20setup%3A%20TDD%2C%20Docker%2C%20Postgres%20and%20more%20-%20Part%202&summary=A%20step-by-step%20tutorial%20on%20how%20to%20setup%20a%20Flask%20project%20with%20TDD%2C%20Docker%20and%20Postgres&source=https%3A//www.thedigitalcatonline.com/blog/2020/07/06/flask-project-setup-tdd-docker-postgres-and-more-part-2/" target="_blank" title="Share on LinkedIn"><i class="fab fa-linkedin"></i> LinkedIn</a></span>
<span><a class="" href="https://news.ycombinator.com/submitlink?t=Flask%20project%20setup%3A%20TDD%2C%20Docker%2C%20Postgres%20and%20more%20-%20Part%202&u=https%3A//www.thedigitalcatonline.com/blog/2020/07/06/flask-project-setup-tdd-docker-postgres-and-more-part-2/" target="_blank" title="Share on HackerNews"><i class="fab fa-hacker-news"></i> HackerNews</a></span>
<span><a class="" href="mailto:?subject=Flask%20project%20setup%3A%20TDD%2C%20Docker%2C%20Postgres%20and%20more%20-%20Part%202&amp;body=https%3A//www.thedigitalcatonline.com/blog/2020/07/06/flask-project-setup-tdd-docker-postgres-and-more-part-2/" target="_blank" title="Share via Email"><i class="fas fa-envelope"></i> Email</a></span>
<span><a class="" href="https://www.reddit.com/submit?url=https%3A//www.thedigitalcatonline.com/blog/2020/07/06/flask-project-setup-tdd-docker-postgres-and-more-part-2/&title=Flask%20project%20setup%3A%20TDD%2C%20Docker%2C%20Postgres%20and%20more%20-%20Part%202" target="_blank" title="Share via Reddit"><i class="fab fa-reddit"></i> Reddit</a></span>    </p>
  </section>

  <section id="content">
    <p>In this series of posts I explore the development of a Flask project with a setup that is built with efficiency and tidiness in mind, using TDD, Docker and Postgres.</p>
<h2 id="catch-up">Catch-up<a class="headerlink" href="#catch-up" title="Permanent link">&para;</a></h2>
<p>In the <a href="https://www.thedigitalcatonline.com/blog/2020/07/05/flask-project-setup-tdd-docker-postgres-and-more-part-1/">previous post</a> we started from an empty project and learned how to add the minimal code to run a Flask project. Then we created a static configuration file and a management script that wraps the <code>flask</code> and <code>docker-compose</code> commands to run the application with a specific configuration</p>
<p>In this post I will show you how to run a production-ready database alongside your code in a Docker container, both in your development setup and for the tests.</p>
<h2 id="step-1-adding-a-database-container">Step 1 - Adding a database container<a class="headerlink" href="#step-1-adding-a-database-container" title="Permanent link">&para;</a></h2>
<p>A database is an integral part of a web application, so in this step I will add my database of choice, Postgres, to the project setup. To do this I need to add a service in the docker-compose configuration file</p>
<p>File: <code>docker/development.yml</code></p>
<div class="highlight"><pre><span></span><code><span class="nt">version</span><span class="p">:</span> <span class="s">&#39;3.4&#39;</span>

<span class="nt">services</span><span class="p">:</span>
  <span class="nt">db</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="nt">POSTGRES_DB</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_DB}</span>
      <span class="nt">POSTGRES_USER</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_USER}</span>
      <span class="nt">POSTGRES_HOSTNAME</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_HOSTNAME}</span>
      <span class="nt">POSTGRES_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_PASSWORD}</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;${POSTGRES_PORT}:5432&quot;</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pgdata:/var/lib/postgresql/data</span>
  <span class="nt">web</span><span class="p">:</span>
    <span class="nt">build</span><span class="p">:</span>
      <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${PWD}</span>
      <span class="nt">dockerfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker/Dockerfile</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="nt">FLASK_ENV</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${FLASK_ENV}</span>
      <span class="nt">FLASK_CONFIG</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${FLASK_CONFIG}</span>
    <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">flask run --host 0.0.0.0</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">${PWD}:/opt/code</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;5000:5000&quot;</span>

<span class="nt">volumes</span><span class="p">:</span>
  <span class="nt">pgdata</span><span class="p">:</span>
</code></pre></div>


<p>The variables starting with <code>POSTGRES_</code> are requested by the PostgreSQL Docker image. In particular, remember that <code>POSTGRESQL_DB</code> is the database that gets created by default when you create the image, and also the one that contains data on other databases as well, so for the application we usually want to use a different one.</p>
<p>Notice also that for the <code>db</code> service I'm creating a persistent volume, so that the content of the database is not lost when we tear down the container. For this service I'm using the default image, so no build step is needed.</p>
<p>To orchestrate this setup we need to add those variables to the JSON configuration</p>
<p>File: <code>config/development.json</code></p>
<div class="highlight"><pre><span></span><code><span class="p">[</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;FLASK_ENV&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;development&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;FLASK_CONFIG&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;development&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_DB&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;postgres&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_USER&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;postgres&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_HOSTNAME&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_PORT&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;5432&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_PASSWORD&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;postgres&quot;</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre></div>


<p>These are all development variables so there are no secrets. In production we will need a way to keep the secrets in a safe place and convert them into environment variables. The AWS Secret Manager for example can directly map secrets into environment variables passed to the containers, saving you from having to explicitly connect to the service with the API.</p>
<p>We can run the <code>./manage.py compose up -d</code> and <code>./manage.py compose down</code> here to check that the database container works properly.</p>
<div class="highlight"><pre><span></span><code>CONTAINER ID  IMAGE       COMMAND                 ...  PORTS                   NAMES
9b5828dccd1c  docker_web  &quot;flask run --host 0.…&quot;  ...  0.0.0.0:5000-&gt;5000/tcp  docker_web_1
4440a18a1527  postgres    &quot;docker-entrypoint.s…&quot;  ...  0.0.0.0:5432-&gt;5432/tcp  docker_db_1
</code></pre></div>


<p>Now we need to connect the application to the database and to do this we can leverage flask-postgresql. As we will use this at every stage of the life of the application, the requirement goes among the production ones. We also need psycopg2 as it is the library used to connect to Postgres.</p>
<p>File: <code>requirements/production.txt</code></p>
<div class="highlight"><pre><span></span><code>Flask
flask-sqlalchemy
psycopg2
</code></pre></div>


<p>Remember to run <code>pip install -r requirements/development.txt</code> to install the requirements locally and <code>./manage.py compose build web</code> to rebuild the image.</p>
<p>At this point I need to create a connection string in the configuration of the application. The connection string parameters come fromt he same environment variables used to spin up the <code>db</code> container</p>
<p>File: <code>application/config.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>

<span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base configuration&quot;&quot;&quot;</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;POSTGRES_USER&quot;</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;POSTGRES_PASSWORD&quot;</span><span class="p">]</span>
    <span class="n">hostname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;POSTGRES_HOSTNAME&quot;</span><span class="p">]</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;POSTGRES_PORT&quot;</span><span class="p">]</span>
    <span class="n">database</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;APPLICATION_DB&quot;</span><span class="p">]</span>

    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;postgresql+psycopg2://</span><span class="si">{user}</span><span class="s2">:</span><span class="si">{password}</span><span class="s2">@</span><span class="si">{hostname}</span><span class="s2">:</span><span class="si">{port}</span><span class="s2">/</span><span class="si">{database}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">SQLALCHEMY_TRACK_MODIFICATIONS</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">ProductionConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Production configuration&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">DevelopmentConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Development configuration&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">TestingConfig</span><span class="p">(</span><span class="n">Config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Testing configuration&quot;&quot;&quot;</span>

    <span class="n">TESTING</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>


<p>As you can see, here I use the variable <code>APPLICATION_DB</code> and not <code>POSTGRES_DB</code>, so I need to specify that as well in the config file</p>
<p>File: <code>config/development.json</code></p>
<div class="highlight"><pre><span></span><code><span class="p">[</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;FLASK_ENV&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;development&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;FLASK_CONFIG&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;development&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_DB&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;postgres&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_USER&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;postgres&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_HOSTNAME&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_PORT&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;5432&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_PASSWORD&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;postgres&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;APPLICATION_DB&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;application&quot;</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre></div>


<p>At this point the application container needs to access some of the Postgres environment variables and the <code>APPLICATION_DB</code> one</p>
<p>File: <code>docker/development.yml</code></p>
<div class="highlight"><pre><span></span><code><span class="nt">version</span><span class="p">:</span> <span class="s">&#39;3.4&#39;</span>

<span class="nt">services</span><span class="p">:</span>
  <span class="nt">db</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="nt">POSTGRES_DB</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_DB}</span>
      <span class="nt">POSTGRES_USER</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_USER}</span>
      <span class="nt">POSTGRES_HOSTNAME</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_HOSTNAME}</span>
      <span class="nt">POSTGRES_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_PASSWORD}</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;${POSTGRES_PORT}:5432&quot;</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pgdata:/var/lib/postgresql/data</span>
  <span class="nt">web</span><span class="p">:</span>
    <span class="nt">build</span><span class="p">:</span>
      <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${PWD}</span>
      <span class="nt">dockerfile</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker/Dockerfile</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="nt">FLASK_ENV</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${FLASK_ENV}</span>
      <span class="nt">FLASK_CONFIG</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${FLASK_CONFIG}</span>
      <span class="nt">APPLICATION_DB</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${APPLICATION_DB}</span>
      <span class="nt">POSTGRES_USER</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_USER}</span>
      <span class="nt">POSTGRES_HOSTNAME</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_HOSTNAME}</span>
      <span class="nt">POSTGRES_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_PASSWORD}</span>
      <span class="nt">POSTGRES_PORT</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_PORT}</span>
    <span class="nt">command</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">flask run --host 0.0.0.0</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">${PWD}:/opt/code</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;5000:5000&quot;</span>

<span class="nt">volumes</span><span class="p">:</span>
  <span class="nt">pgdata</span><span class="p">:</span>
</code></pre></div>


<p>Running compose now spins up both Flask and Postgres but the application is not properly connected to the database yet.</p>
<h4 id="resources">Resources<a class="headerlink" href="#resources" title="Permanent link">&para;</a></h4>
<ul>
<li><a href="https://hub.docker.com/_/postgres">Postgres Docker image</a></li>
<li><a href="https://flask-sqlalchemy.palletsprojects.com/en/2.x/">Flask-SQLAlchemy</a> - A Flask extension to work with SQLAlchemy</li>
<li><a href="https://docs.sqlalchemy.org/en/13/dialects/postgresql.html">SQLAlchemy and PostgreSQL</a> - The Python SQL Toolkit and ORM</li>
</ul>
<h2 id="step-2-connecting-the-application-and-the-database">Step 2 - Connecting the application and the database<a class="headerlink" href="#step-2-connecting-the-application-and-the-database" title="Permanent link">&para;</a></h2>
<p>To connect the Flask application with the database running in the container I need to initialise an <code>SQLAlchemy</code> object and add it to the application factory.</p>
<p>File: <code>application/models.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>
</code></pre></div>


<p>File: <code>application/app.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>


<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">config_name</span><span class="p">):</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">config_module</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;application.config.{config_name.capitalize()}Config&quot;</span>

    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config_module</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">application.models</span> <span class="kn">import</span> <span class="n">db</span>

    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
        <span class="k">return</span> <span class="s2">&quot;Hello, World!&quot;</span>

    <span class="k">return</span> <span class="n">app</span>
</code></pre></div>


<p>A pretty standard way to manage the database in Flask is to use flask-migrate, that adds some commands that allow us to create migrations and apply them.</p>
<p>With flask-migrate you have to create the migrations folder once and for all with <code>flask db init</code> and then, every time you change your models, run <code>flask db migrate -m "Some message"</code> and <code>flask db upgrade</code>. As both <code>db init</code> and <code>db migrate</code> create files in the current directory we now face a problem that every Docker-based setup has to face: file permissions.</p>
<p>The situation is the following: the application is running in the Docker container as root, and there is no connection between the users namespace in the container and that of the host. The result is that if the Docker container creates files in a directory that is mounted from the host (like the one that contains the application code in our example), those files will result as belonging to <code>root</code>. While this doesn't make impossible to work (we usually can become <code>root</code> on our devlopment machines), it is annoying to say the least. The solution is to run those commands from outside the container, but this requires the Flask application to be configured.</p>
<p>Fortunately I wrapped the <code>flask</code> command in the <code>manage.py</code> script, which loads all the required environment variables. Let's add falsk-migrate to the production requirements, together </p>
<p>File: <code>requirements/production.txt</code></p>
<div class="highlight"><pre><span></span><code>Flask
flask-sqlalchemy
psycopg2
flask-migrate
</code></pre></div>


<p>Remember to run <code>pip install -r requirements/development.txt</code> to install the requirements locally and <code>./manage.py compose build web</code> to rebuild the image.</p>
<p>Now we can initialise a <code>Migrate</code> object and add it to the application factory</p>
<p>File: <code>application/models.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">Migrate</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>
<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">()</span>
</code></pre></div>


<p>File: <code>application/app.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>


<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">config_name</span><span class="p">):</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">config_module</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;application.config.{config_name.capitalize()}Config&quot;</span>

    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">config_module</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">application.models</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">migrate</span>

    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">migrate</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
        <span class="k">return</span> <span class="s2">&quot;Hello, World!&quot;</span>

    <span class="k">return</span> <span class="n">app</span>
</code></pre></div>


<p>I can now run the database initialisation script</p>
<div class="highlight"><pre><span></span><code>$ ./manage.py flask db init<span class="sb">`</span>
  Creating directory /home/leo/devel/flask-tutorial/migrations ...  <span class="k">done</span>
  Creating directory /home/leo/devel/flask-tutorial/migrations/versions ...  <span class="k">done</span>
  Generating /home/leo/devel/flask-tutorial/migrations/env.py ...  <span class="k">done</span>
  Generating /home/leo/devel/flask-tutorial/migrations/README ...  <span class="k">done</span>
  Generating /home/leo/devel/flask-tutorial/migrations/script.py.mako ...  <span class="k">done</span>
  Generating /home/leo/devel/flask-tutorial/migrations/alembic.ini ...  <span class="k">done</span>
  Please edit configuration/connection/logging settings in <span class="s1">&#39;/home/leo/devel/flask-tutorial/migrations/alembic.ini&#39;</span> before proceeding.
</code></pre></div>


<p>And, when we will start creating models we will use the commands <code>./manage.py flask db migrate</code> and <code>./manage.py flask db upgrade</code>. You will find a complete example at the end of this post.</p>
<h4 id="resources_1">Resources<a class="headerlink" href="#resources_1" title="Permanent link">&para;</a></h4>
<ul>
<li><a href="https://flask-sqlalchemy.palletsprojects.com/en/2.x/">Flask-SQLAlchemy</a> - A Flask extension to work with SQLAlchemy</li>
<li><a href="https://flask-migrate.readthedocs.io/en/latest/">Flask-Migrate</a> - A Flask extension to handle database migrations with Alembic.</li>
</ul>
<h2 id="step-3-testing-setup">Step 3 - Testing setup<a class="headerlink" href="#step-3-testing-setup" title="Permanent link">&para;</a></h2>
<p>I want to use a TDD approach as much as possible when developing my applications, so I need to setup a good testing enviroment upfront, and it has to be as ephemereal as possible. It is not unusual in big projects to create (or scale up) infrastructure components explicitly to run tests, and through Docker and docker-compose we can easily do the same. Namely, I will:</p>
<ol>
<li>spin up a test database in a container without permanent volumes</li>
<li>initialise it</li>
<li>run all the tests against it</li>
<li>tear down the container</li>
</ol>
<p>This approach has one big advantage, which is that it requires no previous setup and can this be executed on infrastructure created on the fly. It also has disadvantages, however, as it can slow down the testing part of the application, which should be as fast as possible in a TDD setup. Tests that involve the databse, however, should be considered integration tests, and not run continuously in a TDD process, which is impossible (or very hard) when using a framework that merges the concept of entity and database model. If you want to know more about this read <a href="https://www.thedigitalcatonline.com/blog/2016/11/14/clean-architectures-in-python-a-step-by-step-example/">my post on the clean architecture</a>, and <a href="https://leanpub.com/clean-architectures-in-python">the book</a> that I wrote on the subject.</p>
<p>Another advantage of this setup is it that we might need other things during the test, e.g. Celery, other databases, other servers. They can all be created through the docker-compose file.</p>
<p>Generally speaking testing is an umbrella under which many different things can happen. As I will use pytest I can run the full suite, but I might want to select specific tests, mentioning a single file or using the powerful <code>-k</code> option that allows me to select tests by pattern-matching their name. For this reason I want to map the management command line to that of pytest.</p>
<p>Let's add pytest to the testing requirements</p>
<p>File: <code>requirements/testing.txt</code></p>
<div class="highlight"><pre><span></span><code><span class="o">-</span><span class="n">r</span> <span class="n">production</span><span class="p">.</span><span class="n">txt</span>

<span class="n">pytest</span>
<span class="n">coverage</span>
<span class="n">pytest</span><span class="o">-</span><span class="n">cov</span>
</code></pre></div>


<p>As you can see I also use the coverage plugin to keep an eye on how well I cover the code with the tests. Remember to run <code>pip install -r requirements/development.txt</code> to install the requirements locally and <code>./manage.py compose build web</code> to rebuild the image.</p>
<p>File: <code>manage.py</code></p>
<div class="highlight"><pre><span></span><code><span class="ch">#! /usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">click</span>


<span class="c1"># Ensure an environment variable exists and has a value</span>
<span class="k">def</span> <span class="nf">setenv</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>


<span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">,</span> <span class="s2">&quot;development&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">configure_app</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="c1"># Read configuration from the relative JSON file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{config}</span><span class="s2">.json&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">config_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># Convert the config into a usable Python dictionary</span>
    <span class="n">config_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">config_data</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">config_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">setenv</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="nd">@click</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">cli</span><span class="p">():</span>
    <span class="k">pass</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">context_settings</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ignore_unknown_options&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;subcommand&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">flask</span><span class="p">(</span><span class="n">subcommand</span><span class="p">):</span>
    <span class="n">configure_app</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">))</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;flask&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">subcommand</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">docker_compose_cmdline</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">configure_app</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">))</span>

    <span class="n">docker_compose_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;docker&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{config}</span><span class="s2">.yml&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">docker_compose_file</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The file </span><span class="si">{docker_compose_file}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="s2">&quot;docker-compose&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-p&quot;</span><span class="p">,</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="s2">&quot;-f&quot;</span><span class="p">,</span>
        <span class="n">docker_compose_file</span><span class="p">,</span>
    <span class="p">]</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">context_settings</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ignore_unknown_options&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;subcommand&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">compose</span><span class="p">(</span><span class="n">subcommand</span><span class="p">):</span>
    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">docker_compose_cmdline</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">subcommand</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;filenames&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;testing&quot;</span>
    <span class="n">configure_app</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">))</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">docker_compose_cmdline</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="s2">&quot;-d&quot;</span><span class="p">]</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">docker_compose_cmdline</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;logs&quot;</span><span class="p">,</span> <span class="s2">&quot;db&quot;</span><span class="p">]</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>
    <span class="k">while</span> <span class="s2">&quot;ready to accept connections&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">logs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pytest&quot;</span><span class="p">,</span> <span class="s2">&quot;-svv&quot;</span><span class="p">,</span> <span class="s2">&quot;--cov=application&quot;</span><span class="p">,</span> <span class="s2">&quot;--cov-report=term-missing&quot;</span><span class="p">]</span>
    <span class="n">cmdline</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">docker_compose_cmdline</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;down&quot;</span><span class="p">]</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">cli</span><span class="p">()</span>
</code></pre></div>


<p>Notable changes are</p>
<ul>
<li>The environment configuration code is now in the function <code>configure_app</code>. This allows me to force the variable <code>APPLICATION_CONFIG</code> inside the script and then configure the environment, which saves me from having to call tests with <code>APPLICATION_CONFIG=testing flask test</code>.</li>
<li>Both commands <code>flask</code> and <code>compose</code> use the <code>development</code> configuration. Since that is the default value of the <code>APPLICATION_CONFIG</code> variable they just have to call the <code>configure_app</code> function.</li>
<li>The docker-compose command line is needed both in the <code>compose</code> and in the <code>test</code> commands, so I isolated some code into a function called <code>docker_compose_cmdline</code> which returns a list as needed by <code>subprocess</code> functions. The command line now uses also the <code>-p</code> (project name) option to give a prefix to the containers. This way we can run tests while running the development server.</li>
<li>The <code>test</code> command forces <code>APPLICATION_CONFIG</code> to be <code>testing</code>, which loads the file <code>config/testing.json</code>, then runs docker-compose using the file <code>docker/testing.yml</code> (both file have not bee created yet), runs the pytest command line, and tears down the testing database container. Before running the tests the script waits for the service to be available. Postgres doesn't allow connection until the database is ready to accept them.</li>
</ul>
<p>File: <code>config/testing.json</code></p>
<div class="highlight"><pre><span></span><code><span class="p">[</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;FLASK_ENV&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;production&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;FLASK_CONFIG&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;testing&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_DB&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;postgres&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_USER&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;postgres&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_HOSTNAME&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_PORT&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;5433&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_PASSWORD&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;postgres&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;APPLICATION_DB&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre></div>


<p>Note that here I specified <code>5433</code> for the <code>POSTGRES_PORT</code>. This allows us to spin up the test database container while the development one is running, as that will use port <code>5432</code> and you can't have two different containers using the same port on the host. A more general solution could be to leave Docker pick a random host port for the container and then use that, but this requires a bit more code to be properly implemented, so I will come back to this problem when setting up the scenarios.</p>
<p>The last piece of setup that we need is the orchestration configuration for docker-compose</p>
<p>File: <code>docker/testing.yml</code></p>
<div class="highlight"><pre><span></span><code><span class="nt">version</span><span class="p">:</span> <span class="s">&#39;3.4&#39;</span>

<span class="nt">services</span><span class="p">:</span>
  <span class="nt">db</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="nt">POSTGRES_DB</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_DB}</span>
      <span class="nt">POSTGRES_USER</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_USER}</span>
      <span class="nt">POSTGRES_HOSTNAME</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_HOSTNAME}</span>
      <span class="nt">POSTGRES_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_PASSWORD}</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;${POSTGRES_PORT}:5432&quot;</span>
</code></pre></div>


<p>Now we can run <code>./manage.py test</code> and get</p>
<div class="highlight"><pre><span></span><code><span class="n">Creating</span> <span class="n">network</span> <span class="ss">&quot;testing_default&quot;</span> <span class="k">with</span> <span class="n">the</span> <span class="k">default</span> <span class="n">driver</span>
<span class="n">Creating</span> <span class="n">testing_db_1</span> <span class="p">...</span> <span class="n">done</span>
<span class="o">=========================</span> <span class="n">test</span> <span class="k">session</span> <span class="n">starts</span> <span class="o">=========================</span>
<span class="n">platform</span> <span class="n">linux</span> <span class="c1">-- Python 3.7.5, pytest-5.4.3, py-1.8.2, pluggy-0.13.1</span>
<span class="c1">-- /home/leo/devel/flask-tutorial/venv3/bin/python3</span>
<span class="n">cachedir</span><span class="p">:</span> <span class="p">.</span><span class="n">pytest_cache</span>
<span class="n">rootdir</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">leo</span><span class="o">/</span><span class="n">devel</span><span class="o">/</span><span class="n">flask</span><span class="o">-</span><span class="n">tutorial</span>
<span class="n">plugins</span><span class="p">:</span> <span class="n">cov</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">0</span>
<span class="n">collected</span> <span class="mi">0</span> <span class="n">items</span>
<span class="n">Coverage</span><span class="p">.</span><span class="n">py</span> <span class="n">warning</span><span class="p">:</span> <span class="k">No</span> <span class="k">data</span> <span class="n">was</span> <span class="n">collected</span><span class="p">.</span> <span class="p">(</span><span class="k">no</span><span class="o">-</span><span class="k">data</span><span class="o">-</span><span class="n">collected</span><span class="p">)</span>


<span class="c1">----------- coverage: platform linux, python 3.7.5-final-0 -----------</span>
<span class="n">Name</span>                    <span class="n">Stmts</span>   <span class="n">Miss</span>  <span class="n">Cover</span>   <span class="n">Missing</span>
<span class="c1">-----------------------------------------------------</span>
<span class="n">application</span><span class="o">/</span><span class="n">app</span><span class="p">.</span><span class="n">py</span>         <span class="mi">11</span>     <span class="mi">11</span>     <span class="mi">0</span><span class="o">%</span>   <span class="mi">1</span><span class="o">-</span><span class="mi">21</span>
<span class="n">application</span><span class="o">/</span><span class="n">config</span><span class="p">.</span><span class="n">py</span>      <span class="mi">13</span>     <span class="mi">13</span>     <span class="mi">0</span><span class="o">%</span>   <span class="mi">1</span><span class="o">-</span><span class="mi">31</span>
<span class="n">application</span><span class="o">/</span><span class="n">models</span><span class="p">.</span><span class="n">py</span>       <span class="mi">4</span>      <span class="mi">4</span>     <span class="mi">0</span><span class="o">%</span>   <span class="mi">1</span><span class="o">-</span><span class="mi">5</span>
<span class="c1">-----------------------------------------------------</span>
<span class="n">TOTAL</span>                      <span class="mi">28</span>     <span class="mi">28</span>     <span class="mi">0</span><span class="o">%</span>

<span class="o">=======================</span> <span class="k">no</span> <span class="n">tests</span> <span class="n">ran</span> <span class="k">in</span> <span class="mi">0</span><span class="p">.</span><span class="mi">07</span><span class="n">s</span> <span class="o">=======================</span>
<span class="n">Stopping</span> <span class="n">testing_db_1</span> <span class="p">...</span> <span class="n">done</span>
<span class="n">Removing</span> <span class="n">testing_db_1</span> <span class="p">...</span> <span class="n">done</span>
<span class="n">Removing</span> <span class="n">network</span> <span class="n">testing_default</span>
</code></pre></div>


<h4 id="resources_2">Resources<a class="headerlink" href="#resources_2" title="Permanent link">&para;</a></h4>
<ul>
<li><a href="https://docs.pytest.org/en/latest/">pytest</a> - A full-featured Python testing framework</li>
<li><a href="https://www.thedigitalcatonline.com/blog/2018/07/05/useful-pytest-command-line-options/">Useful pytest command line options</a></li>
</ul>
<h2 id="step-4-initialise-the-testing-database">Step 4 - Initialise the testing database<a class="headerlink" href="#step-4-initialise-the-testing-database" title="Permanent link">&para;</a></h2>
<p>When you develop a web application and then run it in production, you typically create the database once and then upgrade it through migrations. When running tests we need to create the database every time, so I need to add a way to run SQL commands on the testing database before I run pytest.</p>
<p>As running sql commands directly on the the database is often useful I will create a function that wraps the boilerplate for the connection. The command that creates the initial database at that point will be trivial.</p>
<p>File: <code>manage.py</code></p>
<div class="highlight"><pre><span></span><code><span class="ch">#! /usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">from</span> <span class="nn">psycopg2.extensions</span> <span class="kn">import</span> <span class="n">ISOLATION_LEVEL_AUTOCOMMIT</span>


<span class="c1"># Ensure an environment variable exists and has a value</span>
<span class="k">def</span> <span class="nf">setenv</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>


<span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">,</span> <span class="s2">&quot;development&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">configure_app</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="c1"># Read configuration from the relative JSON file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{config}</span><span class="s2">.json&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">config_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># Convert the config into a usable Python dictionary</span>
    <span class="n">config_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">config_data</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">config_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">setenv</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="nd">@click</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">cli</span><span class="p">():</span>
    <span class="k">pass</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">context_settings</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ignore_unknown_options&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;subcommand&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">flask</span><span class="p">(</span><span class="n">subcommand</span><span class="p">):</span>
    <span class="n">configure_app</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">))</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;flask&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">subcommand</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">docker_compose_cmdline</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">configure_app</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">))</span>

    <span class="n">docker_compose_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;docker&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{config}</span><span class="s2">.yml&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">docker_compose_file</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The file </span><span class="si">{docker_compose_file}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="s2">&quot;docker-compose&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-p&quot;</span><span class="p">,</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="s2">&quot;-f&quot;</span><span class="p">,</span>
        <span class="n">docker_compose_file</span><span class="p">,</span>
    <span class="p">]</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">context_settings</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ignore_unknown_options&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;subcommand&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">compose</span><span class="p">(</span><span class="n">subcommand</span><span class="p">):</span>
    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">docker_compose_cmdline</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">subcommand</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">run_sql</span><span class="p">(</span><span class="n">statements</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
        <span class="n">dbname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_DB&quot;</span><span class="p">),</span>
        <span class="n">user</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_USER&quot;</span><span class="p">),</span>
        <span class="n">password</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_PASSWORD&quot;</span><span class="p">),</span>
        <span class="n">host</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_HOSTNAME&quot;</span><span class="p">),</span>
        <span class="n">port</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_PORT&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="n">ISOLATION_LEVEL_AUTOCOMMIT</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">statements</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">create_initial_db</span><span class="p">():</span>
    <span class="n">configure_app</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">run_sql</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;CREATE DATABASE {os.getenv(&#39;APPLICATION_DB&#39;)}&quot;</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">DuplicateDatabase</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The database {os.getenv(&#39;APPLICATION_DB&#39;)} already exists and will not be recreated&quot;</span>
        <span class="p">)</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;filenames&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;testing&quot;</span>
    <span class="n">configure_app</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">))</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">docker_compose_cmdline</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;up&quot;</span><span class="p">,</span> <span class="s2">&quot;-d&quot;</span><span class="p">]</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">docker_compose_cmdline</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;logs&quot;</span><span class="p">,</span> <span class="s2">&quot;db&quot;</span><span class="p">]</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>
    <span class="k">while</span> <span class="s2">&quot;ready to accept connections&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">logs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>

    <span class="n">run_sql</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;CREATE DATABASE {os.getenv(&#39;APPLICATION_DB&#39;)}&quot;</span><span class="p">])</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pytest&quot;</span><span class="p">,</span> <span class="s2">&quot;-svv&quot;</span><span class="p">,</span> <span class="s2">&quot;--cov=application&quot;</span><span class="p">,</span> <span class="s2">&quot;--cov-report=term-missing&quot;</span><span class="p">]</span>
    <span class="n">cmdline</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">docker_compose_cmdline</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;down&quot;</span><span class="p">]</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">cli</span><span class="p">()</span>
</code></pre></div>


<p>As you can see I took the opportunity to write the <code>create_initial_db</code> command as well, that just runs the very same SQL command that creates the testing database, but in any configuration I will use. </p>
<p>Before moving on I think it's time to refactor the <code>manage.py</code> file. Refactoring is not mandatory, but I feel like some parts of the script are not generic enough, and when I will add the scenarios I will definitely need my functions to be flexible.</p>
<p>The new script is</p>
<div class="highlight"><pre><span></span><code><span class="ch">#! /usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">from</span> <span class="nn">psycopg2.extensions</span> <span class="kn">import</span> <span class="n">ISOLATION_LEVEL_AUTOCOMMIT</span>


<span class="c1"># Ensure an environment variable exists and has a value</span>
<span class="k">def</span> <span class="nf">setenv</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>


<span class="n">setenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">,</span> <span class="s2">&quot;development&quot;</span><span class="p">)</span>

<span class="n">APPLICATION_CONFIG_PATH</span> <span class="o">=</span> <span class="s2">&quot;config&quot;</span>
<span class="n">DOCKER_PATH</span> <span class="o">=</span> <span class="s2">&quot;docker&quot;</span>


<span class="k">def</span> <span class="nf">app_config_file</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">APPLICATION_CONFIG_PATH</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{config}</span><span class="s2">.json&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">docker_compose_file</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DOCKER_PATH</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{config}</span><span class="s2">.yml&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">configure_app</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="c1"># Read configuration from the relative JSON file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">app_config_file</span><span class="p">(</span><span class="n">config</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">config_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># Convert the config into a usable Python dictionary</span>
    <span class="n">config_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">config_data</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">config_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">setenv</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="nd">@click</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">cli</span><span class="p">():</span>
    <span class="k">pass</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">context_settings</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ignore_unknown_options&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;subcommand&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">flask</span><span class="p">(</span><span class="n">subcommand</span><span class="p">):</span>
    <span class="n">configure_app</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">))</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;flask&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">subcommand</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">docker_compose_cmdline</span><span class="p">(</span><span class="n">commands_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">)</span>
    <span class="n">configure_app</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="n">compose_file</span> <span class="o">=</span> <span class="n">docker_compose_file</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">compose_file</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The file </span><span class="si">{compose_file}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>

    <span class="n">command_line</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;docker-compose&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-p&quot;</span><span class="p">,</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="s2">&quot;-f&quot;</span><span class="p">,</span>
        <span class="n">compose_file</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">commands_string</span><span class="p">:</span>
        <span class="n">command_line</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">commands_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">command_line</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">context_settings</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ignore_unknown_options&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;subcommand&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">click</span><span class="o">.</span><span class="n">Path</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">compose</span><span class="p">(</span><span class="n">subcommand</span><span class="p">):</span>
    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">docker_compose_cmdline</span><span class="p">()</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">subcommand</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="n">p</span><span class="o">.</span><span class="n">send_signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">run_sql</span><span class="p">(</span><span class="n">statements</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
        <span class="n">dbname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_DB&quot;</span><span class="p">),</span>
        <span class="n">user</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_USER&quot;</span><span class="p">),</span>
        <span class="n">password</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_PASSWORD&quot;</span><span class="p">),</span>
        <span class="n">host</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_HOSTNAME&quot;</span><span class="p">),</span>
        <span class="n">port</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_PORT&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="n">ISOLATION_LEVEL_AUTOCOMMIT</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">statements</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">wait_for_logs</span><span class="p">(</span><span class="n">cmdline</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">message</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">logs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">create_initial_db</span><span class="p">():</span>
    <span class="n">configure_app</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">run_sql</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;CREATE DATABASE {os.getenv(&#39;APPLICATION_DB&#39;)}&quot;</span><span class="p">])</span>
    <span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">DuplicateDatabase</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The database {os.getenv(&#39;APPLICATION_DB&#39;)} already exists and will not be recreated&quot;</span>
        <span class="p">)</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;filenames&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;testing&quot;</span>
    <span class="n">configure_app</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">))</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">docker_compose_cmdline</span><span class="p">(</span><span class="s2">&quot;up -d&quot;</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">docker_compose_cmdline</span><span class="p">(</span><span class="s2">&quot;logs db&quot;</span><span class="p">)</span>
    <span class="n">wait_for_logs</span><span class="p">(</span><span class="n">cmdline</span><span class="p">,</span> <span class="s2">&quot;ready to accept connections&quot;</span><span class="p">)</span>

    <span class="n">run_sql</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;CREATE DATABASE {os.getenv(&#39;APPLICATION_DB&#39;)}&quot;</span><span class="p">])</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pytest&quot;</span><span class="p">,</span> <span class="s2">&quot;-svv&quot;</span><span class="p">,</span> <span class="s2">&quot;--cov=application&quot;</span><span class="p">,</span> <span class="s2">&quot;--cov-report=term-missing&quot;</span><span class="p">]</span>
    <span class="n">cmdline</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">docker_compose_cmdline</span><span class="p">(</span><span class="s2">&quot;down&quot;</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">cli</span><span class="p">()</span>
</code></pre></div>


<p>Notable changes:</p>
<ul>
<li>I created two new functions <code>app_config_file</code> and <code>docker_compose_file</code> that encapsulate the creation of the file paths.</li>
<li>I isolated the code that waits for a message in the database container logs, creating the <code>wait_for_logs</code> function.</li>
<li>The <code>docker_compose_cmdline</code> now receives a string and converts it into a list internally. This way expressing commands is more natural, as it doesn't require the ugly list syntax that subprocess works with.</li>
</ul>
<h4 id="resources_3">Resources<a class="headerlink" href="#resources_3" title="Permanent link">&para;</a></h4>
<ul>
<li><a href="https://www.psycopg.org/docs/">Psycopg</a> – PostgreSQL database adapter for Python</li>
</ul>
<h2 id="step-5-fixtures-for-tests">Step 5 - Fixtures for tests<a class="headerlink" href="#step-5-fixtures-for-tests" title="Permanent link">&para;</a></h2>
<p>Pytest uses fixtures for tests, so we should prepare some basic ones that will be generally useful. First let's include pytest-flask, which provides already some basic fixtures</p>
<p>File: <code>requirements/testing.txt</code></p>
<div class="highlight"><pre><span></span><code>-r production.txt

pytest
coverage
pytest-cov
pytest-flask
</code></pre></div>


<p>Then add the <code>app</code> and the <code>database</code> fixtures to the <code>tests/conftest.py</code> file. The first is required by pytest-flask itself (it's used by other fixtures) and the second one is useful every time you need to interact with the database itself.</p>
<p>File: <code>tests/conftest.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">application.app</span> <span class="kn">import</span> <span class="n">create_app</span>
<span class="kn">from</span> <span class="nn">application.models</span> <span class="kn">import</span> <span class="n">db</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">app</span><span class="p">():</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">(</span><span class="s2">&quot;testing&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">app</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">database</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>
        <span class="n">db</span><span class="o">.</span><span class="n">drop_all</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>

    <span class="k">yield</span> <span class="n">db</span>
</code></pre></div>


<p>As you can see, the <code>database</code> fixture uses the <code>drop_all</code> and <code>create_all</code> methods to reset the database. The reason is that this fixture is recreated for each function, and we can't be sure a previous function left the database clean. As a matter of fact, we might be almost sure of the opposite.</p>
<h4 id="resources_4">Resources<a class="headerlink" href="#resources_4" title="Permanent link">&para;</a></h4>
<ul>
<li><a href="https://docs.pytest.org/en/stable/fixture.html">pytest fixtures</a> - One of the most powerful features of pytest</li>
<li><a href="https://pytest-flask.readthedocs.io/en/latest/">pytest-flask</a> - A plugin for pytest that simplifies testing Flask applications</li>
<li><a href="https://flask-sqlalchemy.palletsprojects.com/en/2.x/api/">Flask-SQLAlchemy API</a></li>
</ul>
<h2 id="bonus-step-a-full-tdd-example">Bonus step - A full TDD example<a class="headerlink" href="#bonus-step-a-full-tdd-example" title="Permanent link">&para;</a></h2>
<p>Before wrapping up this post, I want to give you a full example of the TDD process that I would follow given the current state of the setup, which is already complete enough to start the development of an application. Let's pretend my goal is that of adding a <code>User</code> model that can be created with an <code>id</code> (primary key) and an <code>email</code> fields.</p>
<p>First of all I write a test that creates a user in the database and then retrieves it, checking its attributes</p>
<p>File: <code>tests/test_user.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">application.models</span> <span class="kn">import</span> <span class="n">User</span>


<span class="k">def</span> <span class="nf">test__create_user</span><span class="p">(</span><span class="n">database</span><span class="p">):</span>
    <span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;some.email@server.com&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
    <span class="n">database</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">database</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">==</span> <span class="n">email</span>
</code></pre></div>


<p>Running this test results in an error, because the <code>User</code> model does not exist</p>
<div class="highlight"><pre><span></span><code>$ ./manage.py <span class="nb">test</span>
Creating network <span class="s2">&quot;testing_default&quot;</span> with the default driver
Creating testing_db_1 ... <span class="k">done</span>
<span class="o">======================================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">======================================</span>
platform linux -- Python <span class="m">3</span>.7.5, pytest-5.4.3, py-1.9.0, pluggy-0.13.1 --
/home/leo/devel/flask-tutorial/venv3/bin/python3
cachedir: .pytest_cache
rootdir: /home/leo/devel/flask-tutorial
plugins: flask-1.0.0, cov-2.10.0
collected <span class="m">0</span> items / <span class="m">1</span> <span class="nv">error</span>
<span class="o">============================================</span> <span class="nv">ERRORS</span> <span class="o">=============================================</span>
___________________________ ERROR collecting tests/tests/test_user.py ___________________________
ImportError <span class="k">while</span> importing <span class="nb">test</span> module <span class="s1">&#39;/home/leo/devel/flask-tutorial/tests/tests/test_user.py&#39;</span>.
Hint: make sure your <span class="nb">test</span> modules/packages have valid Python names.
Traceback:
venv3/lib/python3.7/site-packages/_pytest/python.py:511: in _importtestmodule
    <span class="nv">mod</span> <span class="o">=</span> self.fspath.pyimport<span class="o">(</span><span class="nv">ensuresyspath</span><span class="o">=</span>importmode<span class="o">)</span>
venv3/lib/python3.7/site-packages/py/_path/local.py:704: in pyimport
    __import__<span class="o">(</span>modname<span class="o">)</span>
venv3/lib/python3.7/site-packages/_pytest/assertion/rewrite.py:152: in exec_module
    exec<span class="o">(</span>co, module.__dict__<span class="o">)</span>
tests/tests/test_user.py:1: in &lt;module&gt;
    from application.models import User
E   ImportError: cannot import name <span class="s1">&#39;User&#39;</span> from <span class="s1">&#39;application.models&#39;</span>
    <span class="o">(</span>/home/leo/devel/flask-tutorial/application/models.py<span class="o">)</span>

----------- coverage: platform linux, python <span class="m">3</span>.7.5-final-0 -----------
Name                    Stmts   Miss  Cover   Missing
-----------------------------------------------------
application/app.py         <span class="m">11</span>      <span class="m">9</span>    <span class="m">18</span>%   <span class="m">6</span>-21
application/config.py      <span class="m">14</span>     <span class="m">14</span>     <span class="m">0</span>%   <span class="m">1</span>-32
application/models.py       <span class="m">4</span>      <span class="m">0</span>   <span class="m">100</span>%
-----------------------------------------------------
TOTAL                      <span class="m">29</span>     <span class="m">23</span>    <span class="m">21</span>%

<span class="o">===================================</span> short <span class="nb">test</span> summary <span class="nv">info</span> <span class="o">===================================</span>
ERROR tests/tests/test_user.py
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Interrupted: <span class="m">1</span> error during collection !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
<span class="o">======================================</span> <span class="m">1</span> error in <span class="m">0</span>.20s <span class="o">=======================================</span>
Stopping testing_db_1 ... <span class="k">done</span>
Removing testing_db_1 ... <span class="k">done</span>
Removing network testing_default
$ 
</code></pre></div>


<p>I won't show here all the steps of the strict TDD methodology, and implement directly the final solution, which is</p>
<p>File: <code>application/models.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">Migrate</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>
<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;users&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>


<p>With this model the test passes</p>
<div class="highlight"><pre><span></span><code>$ ./manage.py <span class="nb">test</span>
Creating network <span class="s2">&quot;testing_default&quot;</span> with the default driver
Creating testing_db_1 ... <span class="k">done</span>
<span class="o">==================================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">==================================</span>
platform linux -- Python <span class="m">3</span>.7.5, pytest-5.4.3, py-1.9.0, pluggy-0.13.1 --
/home/leo/devel/flask-tutorial/venv3/bin/python3
cachedir: .pytest_cache
rootdir: /home/leo/devel/flask-tutorial
plugins: flask-1.0.0, cov-2.10.0
collected <span class="m">1</span> item                                                                                                                          

tests/test_user.py::test__create_user PASSED

----------- coverage: platform linux, python <span class="m">3</span>.7.5-final-0 -----------
Name                    Stmts   Miss  Cover   Missing
-----------------------------------------------------
application/app.py         <span class="m">11</span>      <span class="m">1</span>    <span class="m">91</span>%   <span class="m">19</span>
application/config.py      <span class="m">14</span>      <span class="m">0</span>   <span class="m">100</span>%
application/models.py       <span class="m">8</span>      <span class="m">0</span>   <span class="m">100</span>%
-----------------------------------------------------
TOTAL                      <span class="m">33</span>      <span class="m">1</span>    <span class="m">97</span>%


<span class="o">===================================</span> <span class="m">1</span> passed in <span class="m">0</span>.14s <span class="o">===================================</span>
Stopping testing_db_1 ... <span class="k">done</span>
Removing testing_db_1 ... <span class="k">done</span>
Removing network testing_default
$ 
</code></pre></div>


<p>Please not that this is a very simple example and that in a real case I would add some other tests before accepting this code. In particular we should check that the <code>email</code> field can be empty, and maybe also test some validation on that field.</p>
<p>Once we are satisfied by the code we can generate the migration in the database. Spin up the development environment with</p>
<div class="highlight"><pre><span></span><code>$ ./manage compose up -d
</code></pre></div>


<p>If this is the first time I spin up the environment I have to create the application database and to initialise the migrations, so I run</p>
<div class="highlight"><pre><span></span><code>$ ./manage.py create-initial-db
</code></pre></div>


<p>which returns no output, and</p>
<div class="highlight"><pre><span></span><code>$ ./manage.py flask db init
  Creating directory /home/leo/devel/flask-tutorial/migrations ...  done
  Creating directory /home/leo/devel/flask-tutorial/migrations/versions ...  done
  Generating /home/leo/devel/flask-tutorial/migrations/env.py ...  done
  Generating /home/leo/devel/flask-tutorial/migrations/README ...  done
  Generating /home/leo/devel/flask-tutorial/migrations/script.py.mako ...  done
  Generating /home/leo/devel/flask-tutorial/migrations/alembic.ini ...  done
  Please edit configuration/connection/logging settings in &#39;/home/leo/devel/flask-tutorial/migrations/alembic.ini&#39; before proceeding.
</code></pre></div>


<p>Once this is done (or if that was already done), I can create the migration with</p>
<div class="highlight"><pre><span></span><code>$ ./manage.py flask db migrate -m &quot;Initial user model&quot;
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added table &#39;users&#39;
  Generating /home/leo/devel/flask-tutorial/migrations/versions/7a09d7f8a8fa_initial_user_model.py ...  done
</code></pre></div>


<p>and finally apply the migration with</p>
<div class="highlight"><pre><span></span><code>$ ./manage.py flask db upgrade
INFO  <span class="o">[</span>alembic.runtime.migration<span class="o">]</span> Context impl PostgresqlImpl.
INFO  <span class="o">[</span>alembic.runtime.migration<span class="o">]</span> Will assume transactional DDL.
INFO  <span class="o">[</span>alembic.runtime.migration<span class="o">]</span> Running upgrade  -&gt; 7a09d7f8a8fa, Initial user model
</code></pre></div>


<p>After this I can safely commit my code and move on with the next requirement.</p>
<h2 id="final-words">Final words<a class="headerlink" href="#final-words" title="Permanent link">&para;</a></h2>
<p>I hope this post already showed you why a good setup can make the difference. The project is clean and wrapping the command in the management script plus the centralised config proved to be a good choice as it allowed me to solve the problem of migrations and testing in (what I think is) an elegant way. In the next post I'll show you how to easily create scenarios where you can test queries with only specific data in the database. If you find my posts useful please share them with whoever you thing might be interested.</p>
<h2 id="feedback">Feedback<a class="headerlink" href="#feedback" title="Permanent link">&para;</a></h2>
<p>Feel free to reach me on <a href="https://twitter.com/thedigicat">Twitter</a> if you have questions. The <a href="https://github.com/TheDigitalCatOnline/thedigitalcatonline.github.com/issues">GitHub issues</a> page is the best place to submit corrections.</p>
  </section>

  <section class="footer">
    <h1>Part 2 of the Flask project setup series</h1>
    <div class="box">
      <h5>Previous articles</h5>
      <ul>
        <li><a href="/blog/2020/07/05/flask-project-setup-tdd-docker-postgres-and-more-part-1/">Flask project setup: TDD, Docker, Postgres and more - Part 1</a></li>
      </ul>
      
      <h5>Next articles</h5>
      <ul>
        <li><a href="/blog/2020/07/07/flask-project-setup-tdd-docker-postgres-and-more-part-3/">Flask project setup: TDD, Docker, Postgres and more - Part 3</a></li>
      </ul>
    </div>
  </section>

  <section class="footer">
    <h1>Related Posts</h1>
    <div class="posts mini">
      <article class="card">
        <a href="/blog/2020/07/07/flask-project-setup-tdd-docker-postgres-and-more-part-3/" class="image">
          <img src="/images/flask-project-setup-tdd-docker-postgres-and-more-part-3.jpg" alt="flask-project-setup-tdd-docker-postgres-and-more-part-3" />
        </a>
        <div class="card-body">
          <a href="/blog/2020/07/07/flask-project-setup-tdd-docker-postgres-and-more-part-3/"><h2 class="card-title">Flask project setup: TDD, Docker, Postgres and more - Part 3</h2></a>
	  <p class="article-info">
            <time datetime="2020-07-07T13:00:00+01:00">Jul 7, 2020</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/aws/" class="tag">AWS</a>            <a href="/categories/docker/" class="tag">Docker</a>            <a href="/categories/flask/" class="tag">Flask</a>            <a href="/categories/http/" class="tag">HTTP</a>            <a href="/categories/postgres/" class="tag">Postgres</a>            <a href="/categories/python/" class="tag">Python</a>            <a href="/categories/python3/" class="tag">Python3</a>            <a href="/categories/tdd/" class="tag">TDD</a>            <a href="/categories/testing/" class="tag">testing</a>            <a href="/categories/www/" class="tag">WWW</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2020/07/05/flask-project-setup-tdd-docker-postgres-and-more-part-1/" class="image">
          <img src="/images/flask-project-setup-tdd-docker-postgres-and-more-part-1.jpg" alt="flask-project-setup-tdd-docker-postgres-and-more-part-1" />
        </a>
        <div class="card-body">
          <a href="/blog/2020/07/05/flask-project-setup-tdd-docker-postgres-and-more-part-1/"><h2 class="card-title">Flask project setup: TDD, Docker, Postgres and more - Part 1</h2></a>
	  <p class="article-info">
            <time datetime="2020-07-05T13:00:00+01:00">Jul 5, 2020</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/aws/" class="tag">AWS</a>            <a href="/categories/docker/" class="tag">Docker</a>            <a href="/categories/flask/" class="tag">Flask</a>            <a href="/categories/http/" class="tag">HTTP</a>            <a href="/categories/postgres/" class="tag">Postgres</a>            <a href="/categories/python/" class="tag">Python</a>            <a href="/categories/python3/" class="tag">Python3</a>            <a href="/categories/tdd/" class="tag">TDD</a>            <a href="/categories/testing/" class="tag">testing</a>            <a href="/categories/www/" class="tag">WWW</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2020/02/16/dissecting-a-web-stack/" class="image">
          <img src="/images/dissecting-a-web-stack.jpg" alt="dissecting-a-web-stack" />
        </a>
        <div class="card-body">
          <a href="/blog/2020/02/16/dissecting-a-web-stack/"><h2 class="card-title">Dissecting a Web stack</h2></a>
	  <p class="article-info">
            <time datetime="2020-02-16T15:00:00+00:00">Feb 16, 2020</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/architectures/" class="tag">architectures</a>            <a href="/categories/concurrent-programming/" class="tag">concurrent programming</a>            <a href="/categories/cryptography/" class="tag">cryptography</a>            <a href="/categories/infrastructure/" class="tag">infrastructure</a>            <a href="/categories/flask/" class="tag">Flask</a>            <a href="/categories/django/" class="tag">Django</a>            <a href="/categories/python/" class="tag">Python</a>            <a href="/categories/ssl/" class="tag">SSL</a>            <a href="/categories/http/" class="tag">HTTP</a>            <a href="/categories/www/" class="tag">WWW</a>            <a href="/categories/aws/" class="tag">AWS</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2019/05/27/youtube-channel/" class="image">
          <img src="/images/youtube-channel.jpg" alt="youtube-channel" />
        </a>
        <div class="card-body">
          <a href="/blog/2019/05/27/youtube-channel/"><h2 class="card-title">The Digital Cat Youtube Channel</h2></a>
	  <p class="article-info">
            <time datetime="2019-05-27T12:00:00+01:00">May 27, 2019</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/python/" class="tag">Python</a>            <a href="/categories/python2/" class="tag">Python2</a>            <a href="/categories/python3/" class="tag">Python3</a>            <a href="/categories/tdd/" class="tag">TDD</a>            <a href="/categories/testing/" class="tag">testing</a>            <a href="/categories/video/" class="tag">video</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2018/12/20/cabook/" class="image">
          <img src="/images/cabook.jpg" alt="cabook" />
        </a>
        <div class="card-body">
          <a href="/blog/2018/12/20/cabook/"><h2 class="card-title">Clean Architectures in Python: the book</h2></a>
	  <p class="article-info">
            <time datetime="2018-12-20T08:00:00+01:00">Dec 20, 2018</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/oop/" class="tag">OOP</a>            <a href="/categories/python/" class="tag">Python</a>            <a href="/categories/python2/" class="tag">Python2</a>            <a href="/categories/python3/" class="tag">Python3</a>            <a href="/categories/tdd/" class="tag">TDD</a>            <a href="/categories/testing/" class="tag">testing</a>            <a href="/categories/architectures/" class="tag">architectures</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2018/07/05/useful-pytest-command-line-options/" class="image">
          <img src="/images/useful-pytest-command-line-options.jpg" alt="useful-pytest-command-line-options" />
        </a>
        <div class="card-body">
          <a href="/blog/2018/07/05/useful-pytest-command-line-options/"><h2 class="card-title">Useful pytest command line options</h2></a>
	  <p class="article-info">
            <time datetime="2018-07-05T11:00:00+01:00">Jul 5, 2018</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/python/" class="tag">Python</a>            <a href="/categories/python2/" class="tag">Python2</a>            <a href="/categories/python3/" class="tag">Python3</a>            <a href="/categories/tdd/" class="tag">TDD</a>            <a href="/categories/testing/" class="tag">testing</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2018/06/02/a-game-of-tokens-solution-part-4/" class="image">
          <img src="/images/a-game-of-tokens-solutions.jpg" alt="a-game-of-tokens-solutions" />
        </a>
        <div class="card-body">
          <a href="/blog/2018/06/02/a-game-of-tokens-solution-part-4/"><h2 class="card-title">A game of tokens: solution - Part 4</h2></a>
	  <p class="article-info">
            <time datetime="2018-06-02T13:30:00+00:00">Jun 2, 2018</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/python/" class="tag">Python</a>            <a href="/categories/python3/" class="tag">Python3</a>            <a href="/categories/tdd/" class="tag">TDD</a>            <a href="/categories/testing/" class="tag">testing</a>            <a href="/categories/compilers/" class="tag">compilers</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2018/06/02/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-4/" class="image">
          <img src="/images/a-game-of-tokens.jpg" alt="a-game-of-tokens" />
        </a>
        <div class="card-body">
          <a href="/blog/2018/06/02/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-4/"><h2 class="card-title">A game of tokens: write an interpreter in Python with TDD - Part 4</h2></a>
	  <p class="article-info">
            <time datetime="2018-06-02T13:00:00+00:00">Jun 2, 2018</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/python/" class="tag">Python</a>            <a href="/categories/python3/" class="tag">Python3</a>            <a href="/categories/tdd/" class="tag">TDD</a>            <a href="/categories/testing/" class="tag">testing</a>            <a href="/categories/compilers/" class="tag">compilers</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2017/10/31/a-game-of-tokens-solution-part-3/" class="image">
          <img src="/images/a-game-of-tokens-solutions.jpg" alt="a-game-of-tokens-solutions" />
        </a>
        <div class="card-body">
          <a href="/blog/2017/10/31/a-game-of-tokens-solution-part-3/"><h2 class="card-title">A game of tokens: solution - Part 3</h2></a>
	  <p class="article-info">
            <time datetime="2017-10-31T12:00:00+00:00">Oct 31, 2017</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/python/" class="tag">Python</a>            <a href="/categories/python3/" class="tag">Python3</a>            <a href="/categories/tdd/" class="tag">TDD</a>            <a href="/categories/testing/" class="tag">testing</a>            <a href="/categories/compilers/" class="tag">compilers</a>          </p>
        </div>
      </article>
      <article class="card">
        <a href="/blog/2017/10/31/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-3/" class="image">
          <img src="/images/a-game-of-tokens.jpg" alt="a-game-of-tokens" />
        </a>
        <div class="card-body">
          <a href="/blog/2017/10/31/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-3/"><h2 class="card-title">A game of tokens: write an interpreter in Python with TDD - Part 3</h2></a>
	  <p class="article-info">
            <time datetime="2017-10-31T11:00:00+00:00">Oct 31, 2017</time>
            <span class="fas fa-tags"></span>
            <a href="/categories/python/" class="tag">Python</a>            <a href="/categories/python3/" class="tag">Python3</a>            <a href="/categories/tdd/" class="tag">TDD</a>            <a href="/categories/testing/" class="tag">testing</a>            <a href="/categories/compilers/" class="tag">compilers</a>          </p>
        </div>
      </article>
    </div>
  </section>



  <!-- </article> -->

						</div>
					</div>

				<!-- Sidebar -->
					<div id="sidebar">
<div class="inner">
    <!-- Menu -->
        <nav id="menu">
            <header class="major">
                <h2>Menu</h2>
            </header>
<ul>
    <li><a href="/index.html">Homepage</a></li>
    <li><a href="/pages/about.html">About</a></li>
    <li><a href="/archives/index.html">Archives</a></li>
</ul>        </nav>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Categories</h2>
            </header>
<ul class="list-clean">
    <li><a href="/category/programming/">Programming</a></li>
    <li><a href="/category/projects/">Projects</a></li>
    <li><a href="/category/retro/">Retro</a></li>
</ul>
        </section>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Feeds</h2>
            </header>
<ul class="list-clean">
    <li><a href="/atom.xml"><i class="fas fa-rss"></i> All posts</a></li>


    <li><a href="/category/programming/atom.xml"><i class="fas fa-rss"></i> All posts in category: Programming</a></li>
</ul>        </section>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Tags</h2>
            </header>
<ul class="list-inline list-clean" id="tags-side">
    <li class="tag font-size-3">
        <a title="Posts about algorithms" href="/categories/algorithms/">algorithms</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about amiga" href="/categories/amiga/">amiga</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about AMQP" href="/categories/amqp/">AMQP</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about architectures" href="/categories/architectures/">architectures</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about assembly" href="/categories/assembly/">assembly</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about AWS" href="/categories/aws/">AWS</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about C" href="/categories/c/">C</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about Clojure" href="/categories/clojure/">Clojure</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about compilers" href="/categories/compilers/">compilers</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about concurrent programming" href="/categories/concurrent-programming/">concurrent programming</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about cryptography" href="/categories/cryptography/">cryptography</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about decorators" href="/categories/decorators/">decorators</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about Django" href="/categories/django/">Django</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about Docker" href="/categories/docker/">Docker</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about Erlang" href="/categories/erlang/">Erlang</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about Flask" href="/categories/flask/">Flask</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about functional programming" href="/categories/functional-programming/">functional programming</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about generators" href="/categories/generators/">generators</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about Git" href="/categories/git/">Git</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about HTTP" href="/categories/http/">HTTP</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about infrastructure" href="/categories/infrastructure/">infrastructure</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about M68000" href="/categories/m68000/">M68000</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about metaclasses" href="/categories/metaclasses/">metaclasses</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about metaprogramming" href="/categories/metaprogramming/">metaprogramming</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about Notebook" href="/categories/notebook/">Notebook</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about OOP" href="/categories/oop/">OOP</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about operating systems" href="/categories/operating-systems/">operating systems</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about pelican" href="/categories/pelican/">pelican</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about Pika" href="/categories/pika/">Pika</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about Postage" href="/categories/postage/">Postage</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about Postgres" href="/categories/postgres/">Postgres</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about Python" href="/categories/python/">Python</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about Python2" href="/categories/python2/">Python2</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about Python3" href="/categories/python3/">Python3</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about RabbitMQ" href="/categories/rabbitmq/">RabbitMQ</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about refactoring" href="/categories/refactoring/">refactoring</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about retroprogramming" href="/categories/retroprogramming/">retroprogramming</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about RSA" href="/categories/rsa/">RSA</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about Scala" href="/categories/scala/">Scala</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about SSH" href="/categories/ssh/">SSH</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about SSL" href="/categories/ssl/">SSL</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about TDD" href="/categories/tdd/">TDD</a>
    </li>
    <li class="tag font-size-1">
        <a title="Posts about testing" href="/categories/testing/">testing</a>
    </li>
    <li class="tag font-size-3">
        <a title="Posts about versioning" href="/categories/versioning/">versioning</a>
    </li>
    <li class="tag font-size-4">
        <a title="Posts about video" href="/categories/video/">video</a>
    </li>
    <li class="tag font-size-2">
        <a title="Posts about WWW" href="/categories/www/">WWW</a>
    </li>
</ul>        </section>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Recent posts</h2>
            </header>
<div class="mini-posts">
    <article>
        <a href="/blog/2020/07/07/flask-project-setup-tdd-docker-postgres-and-more-part-3/" class="image"><img src="/images/flask-project-setup-tdd-docker-postgres-and-more-part-3.jpg" alt="flask-project-setup-tdd-docker-postgres-and-more-part-3" /></a>
        <p><strong>Flask project setup: TDD, Docker, Postgres and more - Part 3</strong> <a href="/blog/2020/07/07/flask-project-setup-tdd-docker-postgres-and-more-part-3/">Read</a></p> 
    </article>
    <article>
        <a href="/blog/2020/07/06/flask-project-setup-tdd-docker-postgres-and-more-part-2/" class="image"><img src="/images/flask-project-setup-tdd-docker-postgres-and-more-part-2.jpg" alt="flask-project-setup-tdd-docker-postgres-and-more-part-2" /></a>
        <p><strong>Flask project setup: TDD, Docker, Postgres and more - Part 2</strong> <a href="/blog/2020/07/06/flask-project-setup-tdd-docker-postgres-and-more-part-2/">Read</a></p> 
    </article>
    <article>
        <a href="/blog/2020/07/05/flask-project-setup-tdd-docker-postgres-and-more-part-1/" class="image"><img src="/images/flask-project-setup-tdd-docker-postgres-and-more-part-1.jpg" alt="flask-project-setup-tdd-docker-postgres-and-more-part-1" /></a>
        <p><strong>Flask project setup: TDD, Docker, Postgres and more - Part 1</strong> <a href="/blog/2020/07/05/flask-project-setup-tdd-docker-postgres-and-more-part-1/">Read</a></p> 
    </article>
</div>        </section>

    <!-- Section -->
        <section>
            <header class="major">
                <h2>Get in touch</h2>
            </header>
<ul class="contact">
    
    
    
    <li class="fa-twitter"><a href="https://twitter.com/thedigicat">Twitter</a></li>
    
    
    
    
    <li class="fa-github"><a href="https://github.com/TheDigitalCatOnline">GitHub</a></li>
    
</ul>        </section>

    <!-- Footer -->
        <footer id="footer">
            <p class="copyright">Editorial theme by: <a href="https://html5up.net">HTML5 UP</a>.</p>
            <p class="copyright">Cover picture by: <a href="https://pxhere.com/en/photo/1428515">An Min @ pxhere.com</a></p>
        </footer>

</div>					</div>

			</div>

		<!-- Scripts -->
			<script src="/theme/js/jquery.min.js"></script>
			<script src="/theme/js/browser.min.js"></script>
			<script src="/theme/js/breakpoints.min.js"></script>
            <script src="/theme/js/packed.js?fa89ff81"></script>

	</body>
</html>