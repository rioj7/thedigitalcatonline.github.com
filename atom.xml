<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>The Digital Cat</title><link href="https://www.thedigitalcatonline.com/" rel="alternate"></link><link href="https://www.thedigitalcatonline.com/atom.xml" rel="self"></link><id>https://www.thedigitalcatonline.com/</id><updated>2019-06-07T15:30:00+01:00</updated><subtitle>Adventures of a curious cat in the land of programming</subtitle><entry><title>Run a blog with pelican</title><link href="https://www.thedigitalcatonline.com/blog/2019/06/07/run-a-pelican-blog/" rel="alternate"></link><published>2019-06-07T15:30:00+01:00</published><updated>2019-06-07T15:30:00+01:00</updated><author><name>Leonardo Giordani</name></author><id>tag:www.thedigitalcatonline.com,2019-06-07:/blog/2019/06/07/run-a-pelican-blog/</id><summary type="html"></summary><content type="html">&lt;p&gt;One of the biggest piece of advice I can give to beginner developers is: write a blog.&lt;/p&gt;
&lt;p&gt;Writing, and in general teaching, is a perfect way to understand concepts. Some say that you cannot claim you understood something until you can explain it properly. This unfortunately doesn't take into account that not everyone is a good communicator, and writing (also technical writing) is an art, not just a set of checkboxes to tick.&lt;/p&gt;
&lt;p&gt;Nevertheless, explaining a concept forces you to try to organise your thought, to write them down in a sequential way, to explore corners that you take for granted while the concepts involved are all but simple.&lt;/p&gt;
&lt;p&gt;So my advice is once again: write a blog. Share your experience as a programmer, mathematician, physicist, data scientist (and thousands of other interesting jobs that I can't mention here). Don't worry if you don't have a revolutionary discovery to share with others. We are standing on the shoulders of giants, and every little contribution is welcome.&lt;/p&gt;
&lt;p&gt;One of my most successful posts on this blog is something I wrote after fighting for 3 hours with a trivial Python syntax mistake. I was already a senior programmer, I did a novice mistake. I shared the solution and now that post has a huge amount of visits every day, which hopefully means that some people stuck with the same problem can quickly find a solution. Maybe these people will one day write the new Google or the new AWS, and I'm glad I helped them today.&lt;/p&gt;
&lt;h1 id="pelican"&gt;Pelican&lt;a class="headerlink" href="#pelican" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;I run this blog since 2013. I wanted to use a static website generator because I liked the simplicity of the concept, and since GitHub was providing free hosting on &lt;a href="https://pages.github.com/"&gt;GitHub Pages&lt;/a&gt; I considered it a viable option.&lt;/p&gt;
&lt;p&gt;I started with &lt;a href="https://jekyllrb.com/"&gt;Jekyll&lt;/a&gt;, a very well-known static website generator written in Ruby, because it was the system used by the vast majority of technical bloggers out there at the time. Unfortunately I'm not a Ruby programmer, so every issue I had with the build system that ended in a crash was a mystery to me. I also wanted to add functionalities to the system, and the language once again was a barrier. Jekyll is surely a very good system but it didn't suit my needs.&lt;/p&gt;
&lt;p&gt;Since I didn't have the time to study Ruby at that point, I tried to find a good static site generator written in Python, a language that I know, and I found it in &lt;a href="https://blog.getpelican.com/"&gt;Pelican&lt;/a&gt;. Arguably, the Pelican website is not graphically amazing, and this worried me a bit, but I quickly discovered that the whole system is pretty good.&lt;/p&gt;
&lt;p&gt;In 6 years, with the help of Pelican, I developed a wonderfully simple blogging work flow based on Git, so I decided to share my Pelican setup with a Cookiecutter template. Recently I refurbished the template to update it with the latest changes that I made to my personal setup and I realised that, despite the documentation, setting up a blog based on pelican might still be difficult for some.&lt;/p&gt;
&lt;p&gt;In this post I will show you how to create your blog from scratch using Pelican. You don't need to know Python to use it, even though, as it happened to me with Jekyll, it might help if you want to get involved in the development of the project.&lt;/p&gt;
&lt;p&gt;You can also run Pelican without this template, just follow the &lt;a href="http://docs.getpelican.com/en/latest/install.html"&gt;instructions&lt;/a&gt; on the official documentation. My template simplifies the initial installation, and creates some script that make you follow a specific work flow, but you are free to change them to suit you needs.&lt;/p&gt;
&lt;p&gt;If you are not acquainted with static web sites have a look at the &lt;a href="https://en.wikipedia.org/wiki/Static_web_page"&gt;Wikipedia page&lt;/a&gt;.&lt;/p&gt;
&lt;h1 id="prerequisites"&gt;Prerequisites&lt;a class="headerlink" href="#prerequisites" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;You need to have &lt;a href="https://www.python.org/"&gt;Python 3&lt;/a&gt; and &lt;a href="https://git-scm.com/"&gt;Git&lt;/a&gt; installed in your system. &lt;a href="https://github.com/petervanderdoes/gitflow-avh"&gt;Git Flow&lt;/a&gt; is optional, so if you don't want to use it you can avoid installing it.&lt;/p&gt;
&lt;h1 id="github"&gt;GitHub&lt;a class="headerlink" href="#github" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;You need to create two repositories in your GitHub account. The first one will host the source files of your blog (the &lt;em&gt;source&lt;/em&gt; repository), while the second one will host the actual static site files (deploy repository). Follow the instructions &lt;a href="https://help.github.com/en/articles/create-a-repo"&gt;here&lt;/a&gt; if you are not sure how to create them.&lt;/p&gt;
&lt;p&gt;Call the first repository &lt;code&gt;blog_source&lt;/code&gt; and the second one &lt;code&gt;&amp;lt;your_user_name&amp;gt;.github.io&lt;/code&gt;. The former is just a convention followed by my template, while the latter is enforced by GitHub pages, which uses by default that repository to publish the website at the address with that name.&lt;/p&gt;
&lt;h1 id="install-the-template"&gt;Install the template&lt;a class="headerlink" href="#install-the-template" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Create a &lt;a href="https://docs.python.org/3/tutorial/venv.html"&gt;Python virtual environment&lt;/a&gt; and install &lt;code&gt;cookiecutter&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;pip install cookiecutter
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Then run &lt;code&gt;cookiecutter&lt;/code&gt; on the template I prepared&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;cookiecutter https://github.com/lgiordani/cookiecutter-pelicanblog.git
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now, you will be asked some questions, let's look at them in detail. Remember that you can always start from scratch of fix the values you entered manually later.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;github_username [yourusername]&lt;/code&gt; - Well, this should be self-explanatory.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;blog_source_repo [blog_source]&lt;/code&gt; - This is just the name of the source repository that you created on GitHub. You can accept the default if you didn't change the name.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;deploy_repository [yourusername.github.com]&lt;/code&gt; - This is the name of the deploy repository, i.e. the one that contains the actual static website. The default value is already filled with your GitHub username, so if you are setting up a GitHub Pages blog you can just accept it.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;deploy_directory [deploy]&lt;/code&gt; - The local directory where the deploy repository is cloned and that will be updated by the deployment process. By default, this is set to &lt;code&gt;deploy&lt;/code&gt; inside the project directory.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;use_versioning [y]&lt;/code&gt; - Say &lt;code&gt;y&lt;/code&gt; if you want to have a release process for your website with a version number and associated Git tags.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;use_git_flow [y]&lt;/code&gt; - Say &lt;code&gt;y&lt;/code&gt; if you want to initialise Git Flow on the repository (you need to have Git Flow already installed in the system).&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="set-up-the-environment"&gt;Set up the environment&lt;a class="headerlink" href="#set-up-the-environment" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Now enter the directory that was created by the template, install the requirements and run the &lt;code&gt;setup.sh&lt;/code&gt; script&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; &amp;lt;blog_source_repo&amp;gt;
pip install -r requirements.txt
./setup.sh
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This script performs the following actions&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;it initializes git in the local repository, adding the source repository as a remote with the name &lt;code&gt;origin&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;if you decided to use Git Flow, it initializes the repository, creating the &lt;code&gt;develop&lt;/code&gt; branch.&lt;/li&gt;
&lt;li&gt;it clones the https://github.com/getpelican/pelican-plugins repository&lt;/li&gt;
&lt;li&gt;it clones the https://github.com/getpelican/pelican-themes repository&lt;/li&gt;
&lt;li&gt;it creates the &lt;code&gt;deploy&lt;/code&gt; directory which is a local clone one of the deploy repository&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="configure-pelican"&gt;Configure Pelican&lt;a class="headerlink" href="#configure-pelican" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Now everything is ready to run the &lt;code&gt;pelican-quickstart&lt;/code&gt; script.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;pelican-quickstart
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This script asks the following questions. I marked with a &lt;strong&gt;!!!&lt;/strong&gt; the answers that are not up to you but depend on the current setup&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Where do you want to create your new web site? [.]&lt;/code&gt; - &lt;strong&gt;!!!&lt;/strong&gt; Answer &lt;code&gt;pelican&lt;/code&gt; so everything will be installed in that directory inside the current one, keeping the installation tidy.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;What will be the title of this web site?&lt;/code&gt; - This is up to you&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Who will be the author of this web site?&lt;/code&gt; - This is up to you&lt;/li&gt;
&lt;li&gt;&lt;code&gt;What will be the default language of this web site? [en]&lt;/code&gt; - This is up to you&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Do you want to specify a URL prefix? e.g., https://example.com   (Y/n)&lt;/code&gt; &lt;strong&gt;!!!&lt;/strong&gt; Answer &lt;code&gt;Y&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;What is your URL prefix? (see above example; no trailing slash)&lt;/code&gt; &lt;strong&gt;!!!&lt;/strong&gt; This is &lt;code&gt;https://&amp;lt;username&amp;gt;.github.io&lt;/code&gt; if you are using GH pages&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Do you want to enable article pagination? (Y/n)&lt;/code&gt; - This is up to you&lt;/li&gt;
&lt;li&gt;&lt;code&gt;How many articles per page do you want? [10]&lt;/code&gt; - This is up to you&lt;/li&gt;
&lt;li&gt;&lt;code&gt;What is your time zone? [Europe/Paris]&lt;/code&gt; - This is up to you&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Do you want to generate a tasks.py/Makefile to automate generation and publishing? (Y/n)&lt;/code&gt; - &lt;strong&gt;!!!&lt;/strong&gt; Answer &lt;code&gt;Y&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Answer &lt;code&gt;n&lt;/code&gt; to all the following questions&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If you have questions on this part you can read the &lt;a href="http://docs.getpelican.com/en/latest/install.html"&gt;Pelican documentation&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Now you can enter the &lt;code&gt;pelican&lt;/code&gt; directory and run &lt;code&gt;make devserver&lt;/code&gt; which will run the development server at http://localhost:8000. &lt;a href="http://docs.getpelican.com/en/latest/publish.html#make"&gt;This page&lt;/a&gt; of the official documentation explains all the options of the Makefile.&lt;/p&gt;
&lt;h1 id="the-work-flow"&gt;The work flow&lt;a class="headerlink" href="#the-work-flow" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;The work flow that you will follow using this setup is the following (I assume you use Git Flow, change the git commands accordingly if you are using another flow)&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Create a git branch: &lt;code&gt;git flow feature start &amp;lt;branch&amp;gt;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Create one or more new articles / Edit previous articles: create the files as &lt;code&gt;pelican/content/&amp;lt;slug&amp;gt;.markdown&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Commit: &lt;code&gt;git commit&lt;/code&gt; (repeat 2 and 3 until you are satisfied with the results)&lt;/li&gt;
&lt;li&gt;Merge the branch: &lt;code&gt;git flow feature finish&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Release: &lt;code&gt;./release.sh&lt;/code&gt; (this runs Punch to create a new release)&lt;/li&gt;
&lt;li&gt;Deploy: &lt;code&gt;./deploy.sh&lt;/code&gt; (this runs Pelican to create the static site and copies everything in the &lt;code&gt;deploy&lt;/code&gt; directory)&lt;/li&gt;
&lt;li&gt;Publish: &lt;code&gt;./publish.sh&lt;/code&gt; (this adds, commits, and pushes the files in the &lt;code&gt;deploy&lt;/code&gt; directory)&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Each one of these steps, with the notable exception of the second one, is performed through a single command and takes up to few seconds in the worst case. I prefer to have control on the publishing process, so often I run the git commands manually in the &lt;code&gt;deploy&lt;/code&gt; directory, but you can safely use the provided Make directive.&lt;/p&gt;
&lt;h1 id="versioning"&gt;Versioning&lt;a class="headerlink" href="#versioning" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Versioning is not the most important thing to do in a blog, but I personally like to have a trace of what I created and when in my Git log. I use &lt;a href="https://pypi.org/project/punch.py/"&gt;Punch&lt;/a&gt;, a package that I developed to replace bumpversion. If you want to customise the default versioning scheme contained in the template read the &lt;a href="https://punch.readthedocs.io/en/latest/"&gt;Punch documentation&lt;/a&gt;.&lt;/p&gt;</content><category term="Python"></category><category term="Python3"></category><category term="pelican"></category></entry><entry><title>The Digital Cat Youtube Channel</title><link href="https://www.thedigitalcatonline.com/blog/2019/05/27/youtube-channel/" rel="alternate"></link><published>2019-05-27T12:00:00+01:00</published><updated>2019-05-27T12:00:00+01:00</updated><author><name>Leonardo Giordani</name></author><id>tag:www.thedigitalcatonline.com,2019-05-27:/blog/2019/05/27/youtube-channel/</id><summary type="html">&lt;p&gt;The new Youtube channel The Digital Cat is out in the wild&lt;/p&gt;</summary><content type="html">&lt;p&gt;The Digital Cat &lt;a href="https://www.youtube.com/channel/UCJ70w0WzWjWerpk3utRcAKA"&gt;Youtube channel&lt;/a&gt; just launched!&lt;/p&gt;
&lt;p&gt;The channel will host workshops and tutorial on Python and other languages, on operating systems, cryptography, and other topics that you can find here on this blog. I just finished recording the first part of my workshop "TDD in Python with pytest", which was successfully presented at PyCon UK, PyCon IT, PyCon Ireland, EuroPython and PyLadies London, and the 4 videos are already available on the channel.&lt;/p&gt;
&lt;div class="big-image"&gt;
&lt;img src="/images/global/banner_large.jpg" alt="Youtube Channel banner" /&gt;
&lt;/div&gt;

&lt;p&gt;You can subscribe to the channel at &lt;a href="https://www.youtube.com/channel/UCJ70w0WzWjWerpk3utRcAKA"&gt;this link&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;I appreciate that many people struggle to follow a long post or a tutorial and prefer to see how someone works and hear a voice explaining the steps. Well, I'm not sure if they will like hearing my voice, but this channel is the attempts to reach that type of audience. These are my first videos, so the production is not at its best, but I hope I will improve it in the future.&lt;/p&gt;
&lt;p&gt;I hope you will find them useful, feel free to post comments under the videos if you have suggestions, if you need clarifications, or just to say that you enjoyed them. Thanks!&lt;/p&gt;</content><category term="Python"></category><category term="Python2"></category><category term="Python3"></category><category term="TDD"></category><category term="testing"></category><category term="video"></category></entry><entry><title>Motorola 68000: addressing modes</title><link href="https://www.thedigitalcatonline.com/blog/2019/03/04/motorola-68000-addressing-modes/" rel="alternate"></link><published>2019-03-04T22:30:00+01:00</published><updated>2019-03-04T22:30:00+01:00</updated><author><name>Leonardo Giordani</name></author><id>tag:www.thedigitalcatonline.com,2019-03-04:/blog/2019/03/04/motorola-68000-addressing-modes/</id><summary type="html"></summary><content type="html">&lt;p&gt;The Motorola 68000 is an impressive microprocessor, and this is reflected by the large amount of addressing modes that it provides; it is actually surprising, for people used to the x86 family, to find in this microprocessor's Assembly language constructs that are very similar to the ones provided by high level languages such as pre- and postdecrements, or multiconditional branching instructions.&lt;/p&gt;
&lt;p&gt;The processor provides 6 different addressing modes, each of which has multiple versions, for a grand total of 14. The specific instruction used to manipulate the data can also work on different data sizes, but these variations are not considered here, being features of the instruction and not of the addressing mode.&lt;/p&gt;
&lt;p&gt;Addressing refers to the format of the &lt;strong&gt;effective address&lt;/strong&gt; (&lt;code&gt;ea&lt;/code&gt; or &lt;code&gt;EA&lt;/code&gt; in many manuals), that is the representation of the source or destination of an instruction. Remember that not all the instructions support all 14 modes, so whenever you read &lt;code&gt;ea&lt;/code&gt; remember that we are talking about data which address can be represented by one or more of those modes. &lt;/p&gt;
&lt;p&gt;The syntax of the &lt;code&gt;movea&lt;/code&gt; instruction, for example, is &lt;code&gt;movea &amp;lt;ea&amp;gt;, An&lt;/code&gt;, which tells us that the source is one of the 14 possible combinations presented here, while the destination is one of the address registers &lt;code&gt;a1-a6&lt;/code&gt;. Strictly speaking, however, the syntax of the instruction is &lt;code&gt;movea &amp;lt;ea1&amp;gt;, &amp;lt;ea2&amp;gt;&lt;/code&gt;, where &lt;code&gt;&amp;lt;ea1&amp;gt;&lt;/code&gt; can be one of the 14 modes, and &lt;code&gt;&amp;lt;ea2&amp;gt;&lt;/code&gt; can only be an address register (Address Register Direct Mode).&lt;/p&gt;
&lt;p&gt;The addressing mode is encoded using three fields of the binary instruction. The &lt;strong&gt;EA Mode&lt;/strong&gt; field, the &lt;strong&gt;EA register&lt;/strong&gt; field, and the &lt;strong&gt;Extension words&lt;/strong&gt;. The first two are 3-bit fields contained in the instruction word, which combination uniquely identifies the addressing mode and the number of the register, in case this is needed. The extension words, instead, are words that follow the instruction word in memory, and that usually represent actual 8-, 16-, or 32-bit numbers.&lt;/p&gt;
&lt;h1 id="sign-extension"&gt;Sign extension&lt;a class="headerlink" href="#sign-extension" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Before we discuss the addressing modes provided by the MC68000 it is worth explaining the sign-extension mechanism used by this processor. Sometimes addressing modes use 8-bit or 16-bit data instead of a full long word, for example to provide a constant that is added to a register before using its value. Calculations inside the microprocessor, however, are always performed on 32-bits numbers, so such values are &lt;em&gt;extended&lt;/em&gt; to a long word.&lt;/p&gt;
&lt;p&gt;There are two ways to extend a byte/word to a long word. One is to pad with zeroes on the left (unsigned extension) and the other is to pad preserving the sign (signed extension). While this doesn't change positive numbers it affects negative ones. Let's consider an 8-bit negative number like -126, which is represented by &lt;code&gt;10000010&lt;/code&gt; in 8-bit two's complement, &lt;code&gt;0x82&lt;/code&gt; in hexadecimal. A 32-bit signed extension of this number becomes &lt;code&gt;0xffffff82&lt;/code&gt;, which is still -126 in 32-bit two's complement, but an unsigned extension would give &lt;code&gt;0x00000082&lt;/code&gt;, which is 130.&lt;/p&gt;
&lt;p&gt;While the MC68000 can use both address and data registers for general-purpose data storage, the two categories are meant to manage data of different nature. In particular, &lt;em&gt;data registers never sign-extend bytes or words&lt;/em&gt;, as this would change the pure representation of that sequence of bits, adding spurious bits to keep the sign. Addressed, instead, should never change their value, so the &lt;em&gt;address registers sign-extend incoming values&lt;/em&gt; to preserve the real address or displacement represented by the bits.&lt;/p&gt;
&lt;h1 id="addressing-modes"&gt;Addressing Modes&lt;a class="headerlink" href="#addressing-modes" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;h2 id="register-direct"&gt;Register Direct&lt;a class="headerlink" href="#register-direct" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;This is the simplest addressing mode, as it reads or writes data in one of the microprocessor's registers. There are two versions of it, one for data registers and one for address registers.&lt;/p&gt;
&lt;h3 id="data-register-direct"&gt;Data Register Direct&lt;a class="headerlink" href="#data-register-direct" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Assembly syntax: &lt;code&gt;Dn&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Mode field: &lt;code&gt;000&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Register field: Register number&lt;/li&gt;
&lt;li&gt;Extension words: 0&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This mode addresses the data contained in one of the data registers &lt;code&gt;d0-d7&lt;/code&gt;. The EA Mode field is &lt;code&gt;000&lt;/code&gt; and the EA Register field contains the register number. The official documentation uses the syntax &lt;code&gt;Dn&lt;/code&gt; to identify this mode. No extension words are used.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;cmpi.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x1111&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;                           Compare
                        +----------+
                        |  0x1111  |
                        +----------+
d1 0x12ca ------------&amp;gt; |  0x12ca  |
                        +----------+
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="address-register-direct-mode"&gt;Address Register Direct Mode&lt;a class="headerlink" href="#address-register-direct-mode" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Assembly syntax: &lt;code&gt;An&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Mode field: &lt;code&gt;001&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Register field: Register number&lt;/li&gt;
&lt;li&gt;Extension words: 0&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This mode identifies the data contained in one of the address registers &lt;code&gt;a0-a6&lt;/code&gt;. The EA Mode field is &lt;code&gt;001&lt;/code&gt; and the EA Register field is the number of the register, while the official syntax for it is &lt;code&gt;An&lt;/code&gt;.  No extension words are used.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;cmpi.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x1111&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;                           Compare
                        +------------+
                        |  0x1111    |
                        +------------+
a1 0xfc1d28 ----------&amp;gt; |  0xfc1d28  |
                        +------------+
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="register-indirect"&gt;Register Indirect&lt;a class="headerlink" href="#register-indirect" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;As the name of this mode suggests, the addressing is performed using a register, but the data is accessed indirectly. The register doesn't contain the data we want to use, but the address in memory of the data. This is what higher level languages like C call &lt;em&gt;memory pointer&lt;/em&gt;.&lt;/p&gt;
&lt;h3 id="address-register-indirect"&gt;Address Register Indirect&lt;a class="headerlink" href="#address-register-indirect" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Assembly syntax: &lt;code&gt;(An)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Mode field: &lt;code&gt;010&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Register field: Register number&lt;/li&gt;
&lt;li&gt;Extension words: 0&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The simplest form of indirect access is when the address of the data is stored in one of the address registers &lt;code&gt;a0-a6&lt;/code&gt;. The syntax for this mode is &lt;code&gt;(An)&lt;/code&gt;, while the binary form has the EA Mode field set to &lt;code&gt;010&lt;/code&gt; and the EA Register field represents the number of the address register in use. No extension words are used.&lt;/p&gt;
&lt;p&gt;The following example compares the number &lt;code&gt;0x1111&lt;/code&gt; with the content of the memory cell which address is contained in &lt;code&gt;a1&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;cmpi.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x1111&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;a1 0xfc1d28
      |              0xfc1d24  |         |                Compare
      |                        +---------+              +----------+
      |              0xfc1d26  |         |              |  0x1111  |
      |                        +---------+              +----------+
      +------------&amp;gt; 0xfc1d28  |  0x13c  | -----------&amp;gt; |   0x13c  |
                               +---------+              +----------+
                     0xfc1d2a  |         |
                               +---------+
                     0xfc1d2c  |         |
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="address-register-indirect-with-postincrement"&gt;Address Register Indirect with Postincrement&lt;a class="headerlink" href="#address-register-indirect-with-postincrement" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Assembly syntax: &lt;code&gt;(An)+&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Mode field: &lt;code&gt;011&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Register field: Register number&lt;/li&gt;
&lt;li&gt;Extension words: 0&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This addressing mode is another of the high-level languages constructs that the MC68000 provides directly in its Assembly language. This mode works exactly like the Address Register Indirect, but &lt;em&gt;after&lt;/em&gt; the data has been fetched from memory the address register is incremented by the size of the data itself. So, this addressing mode is perfectly suited for algorithms that need to read consecutive arrays from memory, as there is no need to add instructions that increment the pointer.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;cmpi.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x1111&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)+&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;    a1 0xfc1d28
     ^       |              0xfc1d24  |         |                Compare
     |       |                        +---------+              +----------+
     |       |              0xfc1d26  |         |              |  0x1111  |
   +----+    v                        +---------+              +----------+
   | +2 | &amp;lt;--+------------&amp;gt; 0xfc1d28  |  0x13c  | -----------&amp;gt; |   0x13c  |
   +----+                             +---------+              +----------+
                            0xfc1d2a  |         |
                                      +---------+
                            0xfc1d2c  |         |
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The standard syntax is &lt;code&gt;(An)+&lt;/code&gt;, and for this mode, the EA Mode field is &lt;code&gt;011&lt;/code&gt;, while the EA Register field contains the register number.  No extension words are used.&lt;/p&gt;
&lt;p&gt;This mode and the following one are very powerful, as they automatically add to the address the size of the data that has been read, so 1 for a byte read, 2 for a word, and 4 for a long word. The only exception to this rule is when the register is &lt;code&gt;a7&lt;/code&gt;, which is an alias for &lt;code&gt;sp&lt;/code&gt;, the system Stack Pointer. In that case the pointer is always kept aligned to a word boundary, so the increment is 2 even for a byte read.&lt;/p&gt;
&lt;h3 id="address-register-indirect-with-predecrement"&gt;Address Register Indirect with Predecrement&lt;a class="headerlink" href="#address-register-indirect-with-predecrement" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Assembly syntax: &lt;code&gt;-(An)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Mode field: &lt;code&gt;100&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Register field: Register number&lt;/li&gt;
&lt;li&gt;Extension words: 0&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This is the specular version of the previous mode, where the address register used to point to the data is decremented &lt;em&gt;before&lt;/em&gt; the addressing is performed. The standard syntax is &lt;code&gt;-(An)&lt;/code&gt;; the EA Mode field is &lt;code&gt;100&lt;/code&gt; and the EA Register field contains the register number. No extension words are used.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;cmpi.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x1111&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;   a1 0xfc1d28
    ^       |
    |       v
    |    +----+
    |    | -2 |          0xfc1d22  |         |                Compare
    |    +----+                    +---------+              +----------+
    |       |            0xfc1d24  |         |              |  0x1111  |
    |       v                      +---------+              +----------+
    +-------+----------&amp;gt; 0xfc1d26  |  0x13c  | -----------&amp;gt; |   0x13c  |
                                   +---------+              +----------+
                         0xfc1d28  |         |
                                   +---------+
                         0xfc1d2a  |         |
&lt;/pre&gt;&lt;/div&gt;


&lt;h3 id="address-register-indirect-with-displacement"&gt;Address Register Indirect with Displacement&lt;a class="headerlink" href="#address-register-indirect-with-displacement" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Assembly syntax: &lt;code&gt;(d16,An) / d16(An)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Mode field: &lt;code&gt;101&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Register field: Register number&lt;/li&gt;
&lt;li&gt;Extension words: 1&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The natural evolution of the previous two addressing modes is to use an arbitrary offset that is added to the base address contained in the register. The standard syntax for this mode is &lt;code&gt;(d16,An)&lt;/code&gt; or &lt;code&gt;d16(An)&lt;/code&gt;, where &lt;code&gt;d16&lt;/code&gt; is a 16-bit signed integer. So for example &lt;code&gt;0xf(a1)&lt;/code&gt; is the data contained in memory at the address &lt;code&gt;a1 + 0xf&lt;/code&gt;. The EA Mode field is &lt;code&gt;101&lt;/code&gt; and the EA register fields is the number of the address register used. This address mode requires 1 extension word that contains the 16-bit displacement.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;cmpi.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x1111&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x140&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;     a1 0xfc1d28
           |
           v
         +---+
0x140 -&amp;gt; | + |            0xfc1e64  |         |                Compare
         +---+                      +---------+              +----------+
           |              0xfc1e66  |         |              |  0x1111  |
           v                        +---------+              +----------+
           +------------&amp;gt; 0xfc1e68  |  0x13c  | -----------&amp;gt; |   0x13c  |
                                    +---------+              +----------+
                          0xfc1e6a  |         |
                                    +---------+
                          0xfc1e6c  |         |
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Please note that the displacement is fixed to 16-bit, so its value limited in the range &lt;code&gt;(-32768,32767)&lt;/code&gt;; the displacement is however sign-extended to 32-bit before being added to the base address.&lt;/p&gt;
&lt;p&gt;Note: this mode is sometimes called "Register Indirect with Offset".&lt;/p&gt;
&lt;h3 id="address-register-indirect-with-index"&gt;Address Register Indirect with Index&lt;a class="headerlink" href="#address-register-indirect-with-index" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Assembly syntax: &lt;code&gt;(d8,Dn,An)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Mode field: &lt;code&gt;110&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Register field: Register number&lt;/li&gt;
&lt;li&gt;Extension words: 1&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Besides an addressing mode that mimics C-style loops and a way to perform random access of arrays through a 16-bit displacement, the MC68000 provides a double-indexed array access with this addressing mode. The base address contained in one of the address registers is added to the content of a 16/32-bit register and an 8-bit index. This address mode requires 1 extension word that contains the 8-bit index; only the 8 least significant bits of the extension words are kept and sign-extended to 32-bits before any calculation.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;cmpi.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x1111&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;    a1 0xfc1d28   d0 0x140
          |            |
          v            |
        +---+          |
        | + | &amp;lt;--------+
        +---+
          |
          v
        +---+
0x4 --&amp;gt; | + |            0xfc1e68  |          |                Compare
        +---+                      +----------+              +----------+
          |              0xfc1e6a  |          |              |  0x1111  |
          v                        +----------+              +----------+
          +------------&amp;gt; 0xfc1e6c  |   data   | -----------&amp;gt; |   0x13c  |
                                   +----------+              +----------+
                         0xfc1e6e  |          |
                                   +----------+
                         0xfc1e70  |          |
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;For this mode the EA Mode field is set to &lt;code&gt;110&lt;/code&gt; and the EA Register field contains the number of the address register in use. The standard syntax used by manuals is &lt;code&gt;(d8, An, Dn.SIZE)&lt;/code&gt;, where &lt;code&gt;SIZE&lt;/code&gt; can be either &lt;code&gt;w&lt;/code&gt; or &lt;code&gt;l&lt;/code&gt;. This addressing mode can provide an invaluable way to access two-dimensional arrays, and once again shows how powerful this microprocessor is.&lt;/p&gt;
&lt;p&gt;Note: this mode is sometimes called "Indexed Register Indirect with Offset"&lt;/p&gt;
&lt;h2 id="absolute-data"&gt;Absolute Data&lt;a class="headerlink" href="#absolute-data" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;These modes provide a version of the Address Register Indirect mode where the address is specified directly in the instruction and not through a register.&lt;/p&gt;
&lt;h3 id="absolute-short-data"&gt;Absolute Short Data&lt;a class="headerlink" href="#absolute-short-data" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Assembly syntax: &lt;code&gt;&amp;lt;address&amp;gt;.w&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Mode field: &lt;code&gt;111&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Register field: &lt;code&gt;000&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Extension words: 1&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This mode specifies the address of the data in memory through a 16-bit direct operand specified in the extension word. The standard syntax is &lt;code&gt;&amp;lt;address&amp;gt;.w&lt;/code&gt;, while the EA mode and EA register fields are respectively &lt;code&gt;111&lt;/code&gt; and &lt;code&gt;000&lt;/code&gt;. Since the address is a signed word, only the first or the last 32KiB of memory can be addressed (respectively using positive and negative addresses).&lt;/p&gt;
&lt;h3 id="absolute-long-data"&gt;Absolute Long Data&lt;a class="headerlink" href="#absolute-long-data" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Assembly syntax: &lt;code&gt;&amp;lt;address&amp;gt;.l&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Mode field: &lt;code&gt;111&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Register field: &lt;code&gt;001&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Extension words: 2&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This is the 32-bit version of the previous mode, with EA mode and EA register fields set respectively to &lt;code&gt;111&lt;/code&gt; and &lt;code&gt;001&lt;/code&gt;. The standard syntax is &lt;code&gt;&amp;lt;address&amp;gt;.l&lt;/code&gt;, and it requires two extension words. As always in the MC68000 long words are given in big endian order, that is the first word is the most significant part of the address and the second word is the least significant one.&lt;/p&gt;
&lt;p&gt;It is worth noting that this mode overcomes the limitation of the previous one, allowing you to access the full 16MiB address space. However, it requires more memory space, having two extension words, and 4 additional CPU cycles to be executed.&lt;/p&gt;
&lt;h2 id="program-counter-relative"&gt;Program Counter Relative&lt;a class="headerlink" href="#program-counter-relative" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The addressing modes relative to the Program Counter (PC) are the fundamental building block of relocatable programs, as the effective address is computed as a displacement from the address of the current instruction being executed. Strictly speaking the base address is that of the extension word, as will be shown in detail later in this article.&lt;/p&gt;
&lt;p&gt;Please note that effective addresses expressed with Program Counter Relative can only be used to read from memory.&lt;/p&gt;
&lt;h3 id="program-counter-relative-with-displacement"&gt;Program Counter Relative with Displacement&lt;a class="headerlink" href="#program-counter-relative-with-displacement" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Assembly syntax: &lt;code&gt;(d16,PC)&lt;/code&gt; or &lt;code&gt;d16(PC)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Mode field: &lt;code&gt;111&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Register field: &lt;code&gt;010&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Extension words: 1&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This mode is very similar to Address Register Indirect with Displacement, as both use a 16-bit offset added to a base address; in this case the latter is provided by the PC instead of an address register. The EA mode field is &lt;code&gt;111&lt;/code&gt; and the EA Register field is &lt;code&gt;010&lt;/code&gt;. One extension word is needed, to provide the signed 16-bits displacement, extended to 32-bit before any other calculation.&lt;/p&gt;
&lt;p&gt;Note: this mode is sometimes called "Program Counter Relative with Offset".&lt;/p&gt;
&lt;h3 id="program-counter-relative-with-index"&gt;Program Counter Relative with Index&lt;a class="headerlink" href="#program-counter-relative-with-index" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Assembly syntax: &lt;code&gt;(d8,Dn,PC)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Mode field: &lt;code&gt;111&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Register field: &lt;code&gt;011&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Extension words: 1&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This is the Program Counter version of Address Register Indirect with Index. The EA mode field is &lt;code&gt;111&lt;/code&gt; and the EA Register field is &lt;code&gt;011&lt;/code&gt;. One extension word is needed, to provide the signed 8-bits displacement, which will be extended to 32 bit before using it.&lt;/p&gt;
&lt;p&gt;Note: this mode is sometimes called "Program Counter Relative with Index and Offset".&lt;/p&gt;
&lt;h2 id="immediate-data"&gt;Immediate Data&lt;a class="headerlink" href="#immediate-data" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Assembly syntax: &lt;code&gt;#&amp;lt;data&amp;gt;&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Mode field: &lt;code&gt;111&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;EA Register field: &lt;code&gt;100&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Extension words: 1,2&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Immediate data uses the plain data written in the extension words instead of referring to the system memory. In this mode you can specify a constant of any length (byte, word, long word). The EA mode and EA register fields are respectively &lt;code&gt;111&lt;/code&gt; and &lt;code&gt;100&lt;/code&gt;, and the number of extension words is either 1 (byte and word) or 2 (long word). Remember that the 68000 sign-extends data only when the destination is an address register, leaving it untouched when a data register is used. The standard syntax for this addressing mode is &lt;code&gt;#&amp;lt;data&amp;gt;&lt;/code&gt;&lt;/p&gt;
&lt;h3 id="quick-immediate"&gt;Quick Immediate&lt;a class="headerlink" href="#quick-immediate" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;This addressing mode is available for a set of 3 instructions only, namely &lt;code&gt;addq&lt;/code&gt;, &lt;code&gt;subq&lt;/code&gt;, and &lt;code&gt;moveq&lt;/code&gt;. For the first two instructions, it allows to specify a value between 1 and 8 (3 bits), while the third one can interact with a full signed byte, managing a value between -128 and 127. The "quick" label comes from the fact that the instructions use bits of their own binary representation to store the data, thus requiring no extension words. As happens for the simple Immediate Data addressing, EA mode field is &lt;code&gt;111&lt;/code&gt; and EA Register field is &lt;code&gt;100&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id="implied"&gt;Implied&lt;a class="headerlink" href="#implied" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;This is another mode that is available only for some instructions. Those are bound to specific registers, and are thus not really allowing any generic effective address to be used. The registers used in this addressing mode are only &lt;code&gt;SP&lt;/code&gt;, &lt;code&gt;PC&lt;/code&gt;, &lt;code&gt;SP&lt;/code&gt;, &lt;code&gt;SSP&lt;/code&gt;, &lt;code&gt;SR&lt;/code&gt;, and &lt;code&gt;USP&lt;/code&gt;.&lt;/p&gt;
&lt;h1 id="table-of-addressing-modes"&gt;Table of addressing modes&lt;a class="headerlink" href="#table-of-addressing-modes" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;The following table gives an overview of all the addressing modes. For each of them I show the name, the standard Assembly syntax, the value of the EA Mode field, the value of the EA Register field, and the number of extension word required.&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Name&lt;/th&gt;
&lt;th&gt;Syntax&lt;/th&gt;
&lt;th&gt;EA Mode&lt;/th&gt;
&lt;th&gt;EA Register&lt;/th&gt;
&lt;th&gt;Extension words&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Data Register Direct&lt;/td&gt;
&lt;td&gt;&lt;code&gt;Dn&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;000&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Reg. number&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Address Register Direct Mode&lt;/td&gt;
&lt;td&gt;&lt;code&gt;An&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;001&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Reg. number&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Address Register Indirect&lt;/td&gt;
&lt;td&gt;&lt;code&gt;(An)&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;010&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Reg. number&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Address Register Indirect with Postincrement&lt;/td&gt;
&lt;td&gt;&lt;code&gt;(An)+&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;011&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Reg. number&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Address Register Indirect with Predecrement&lt;/td&gt;
&lt;td&gt;&lt;code&gt;-(An)&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;100&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Reg. number&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Address Register Indirect with Displacement&lt;/td&gt;
&lt;td&gt;&lt;code&gt;(d16,An)&lt;/code&gt; or &lt;code&gt;d16(An)&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;101&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Reg. number&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Address Register Indirect with Index&lt;/td&gt;
&lt;td&gt;&lt;code&gt;(d8,Dn,An)&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;110&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Reg. number&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Absolute Short Data&lt;/td&gt;
&lt;td&gt;&lt;code&gt;&amp;lt;address&amp;gt;.w&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;111&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;000&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Absolute Long Data&lt;/td&gt;
&lt;td&gt;&lt;code&gt;&amp;lt;address&amp;gt;.l&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;111&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;001&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Program Counter Relative with Displacement&lt;/td&gt;
&lt;td&gt;&lt;code&gt;(d16,PC)&lt;/code&gt; / &lt;code&gt;d16(PC)&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;111&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;010&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Program Counter Relative with Index&lt;/td&gt;
&lt;td&gt;&lt;code&gt;(d8,Dn,PC)&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;111&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;011&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Immediate&lt;/td&gt;
&lt;td&gt;&lt;code&gt;#&amp;lt;data&amp;gt;&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;111&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;&lt;code&gt;100&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;1,2&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h1 id="examples"&gt;Examples&lt;a class="headerlink" href="#examples" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Let's consider some example of actual MC68000 code that uses effective addressing modes.&lt;/p&gt;
&lt;h2 id="example-1"&gt;Example 1&lt;a class="headerlink" href="#example-1" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;0280&lt;/span&gt; &lt;span class="mi"&gt;0003&lt;/span&gt;&lt;span class="s"&gt; ffff          andi&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="s"&gt;l  &lt;/span&gt;&lt;span class="mi"&gt;#0x3ffff&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;d0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This instruction uses the the Data Register Direct mode to address register &lt;code&gt;d0&lt;/code&gt;. The instruction format of &lt;code&gt;andi&lt;/code&gt; is the following&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;| 15 | 14 | 13 | 12 | 11 | 10 | 09 | 08 | 07 | 06 | 05 | 04 | 03 | 02 | 01 | 00 |
| 0  | 0  | 0  | 0  | 0  | 0  | 1  | 0  | SIZE    | EFFECTIVE ADDRESS           |
|                                       |         | MODE         | REGISTER     |
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;which in the example shown above translates to&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;00000010  10    000  000 0000000000000011 1111111111111111
^         ^     ^    ^
andi      long  Dn   d0  
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;So the microprocessor expects the instruction to be followed by two extension words (long), that will contain the immediate data that will be added to the register. The register is selected among the data ones because the EA Mode field is &lt;code&gt;000&lt;/code&gt;, and the EA Register field selects register number 0. The two following extension words are &lt;code&gt;0003&lt;/code&gt; and &lt;code&gt;ffff&lt;/code&gt;, so the number &lt;code&gt;0x3ffff&lt;/code&gt; is added to the register.&lt;/p&gt;
&lt;h2 id="example-2"&gt;Example 2&lt;a class="headerlink" href="#example-2" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;2052&lt;/span&gt;                    &lt;span class="s"&gt;movea&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="s"&gt;l (a2)&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;a0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The &lt;code&gt;movea&lt;/code&gt; instruction moves data into an address register, but in this case uses the Address Register Indirect mode to specify the source. The instruction format is&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;| 15 | 14 | 13 | 12 | 11 | 10 | 09 | 08 | 07 | 06 | 05 | 04 | 03 | 02 | 01 | 00 |
| 0  | 0  | SIZE    | DEST. REG.   | 0  | 0  | 1  | SOURCE EFFECTIVE ADDRESS    |
|         |         |              |              | MODE         | REGISTER     |
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;so in this case the hexadecimal code &lt;code&gt;2052&lt;/code&gt; becomes&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;00  10    000  001  010   010
    ^     ^         ^     ^
    long  a0        (An)  a2
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="example-3"&gt;Example 3&lt;a class="headerlink" href="#example-3" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;397c&lt;/span&gt; &lt;span class="mi"&gt;0200&lt;/span&gt;&lt;span class="s"&gt; 0100          move&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="s"&gt;w  &lt;/span&gt;&lt;span class="mi"&gt;#0x200&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x100&lt;/span&gt;&lt;span class="s"&gt;(a4)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This &lt;code&gt;move&lt;/code&gt; instruction puts a word with the value &lt;code&gt;0x200&lt;/code&gt; into an address which is &lt;code&gt;0x100&lt;/code&gt; above the address pointed by &lt;code&gt;a4&lt;/code&gt;. It uses Immediate Data for the source and Address Register Indirect with Displacement for the destination. The format of the &lt;code&gt;move&lt;/code&gt; instruction is&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;| 15 | 14 | 13 | 12 | 11 | 10 | 09 | 08 | 07 | 06 | 05 | 04 | 03 | 02 | 01 | 00 |
| 0  | 0  | SIZE    | DEST. EFFECTIVE ADDRESS     | SOURCE EFFECTIVE ADDRESS    |
|         |         | REGISTER     | MODE         | MODE         | REGISTER     |
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;(please note that register and mode are swapped in the destination part)&lt;/p&gt;
&lt;p&gt;In this case we have&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;00    11    100  101       111100
^     ^     ^    ^         ^    
move  word  a4   (d16,An)  Immediate Data
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;It is interesting to note that the word for the source is given with Immediate Data, and is indeed just after the instruction (&lt;code&gt;0x0200&lt;/code&gt;), followed by the 16-bit displacement for Address Register Indirect with Displacement (&lt;code&gt;0x0100&lt;/code&gt;).&lt;/p&gt;
&lt;h1 id="lea-load-effective-address"&gt;LEA: Load Effective Address&lt;a class="headerlink" href="#lea-load-effective-address" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Many newcomers to Assembly are confused by the need of the &lt;code&gt;lea&lt;/code&gt; instruction, so I want to briefly show why we need it, and dig into its low-level representation to clarify possible doubts.&lt;/p&gt;
&lt;p&gt;As we saw in the previous sections there are three ways to manage data in the M68000 Assembly language: the first is to mention a &lt;em&gt;pure number&lt;/em&gt;, the second is to use a &lt;em&gt;register&lt;/em&gt;, and the third is to use a &lt;em&gt;memory address&lt;/em&gt;. Registers can be considered memory, but since they are not proper arrays I will consider them something different.&lt;/p&gt;
&lt;p&gt;The Immediate Data addressing mode allows us to use pure data in an instruction. For example we may write &lt;code&gt;move.l  #0x20000,d0&lt;/code&gt;, which puts the number &lt;code&gt;0x20000&lt;/code&gt; into the first data register. So when we mention a pure number the microprocessor uses its binary representation directly.&lt;/p&gt;
&lt;p&gt;When we mention a register, the microprocessor does the only thing it can do with it, that is it reads its value or writes into it. The instruction mentioned previously, &lt;code&gt;move.l  #0x20000,d0&lt;/code&gt;, puts the number into the register &lt;code&gt;d0&lt;/code&gt;. An instruction like &lt;code&gt;cmp.l d2,d3&lt;/code&gt;, instead, reads the value of both registers and performs the comparison.&lt;/p&gt;
&lt;p&gt;Memory addresses are similar to registers, but they are identified by a number and not by a name (and are part of a contiguous array). Whenever an instruction mentions a memory address the microprocessor automatically tries to access that location, to read or to write. An instruction like &lt;code&gt;move.l 0x4,d3&lt;/code&gt; moves into &lt;code&gt;d3&lt;/code&gt; &lt;em&gt;the content&lt;/em&gt; of the address &lt;code&gt;0x4&lt;/code&gt;, and this happens just because &lt;code&gt;0x4&lt;/code&gt; is a memory address.&lt;/p&gt;
&lt;p&gt;That said, the problem we face is that often we want to compute a memory address and deal with &lt;em&gt;its value&lt;/em&gt; and not with its content. For example, if we write &lt;code&gt;move.w 0xe(a1),d0&lt;/code&gt;, the microprocessor computes &lt;code&gt;a1 + 0xe&lt;/code&gt;, that is, the content of &lt;code&gt;a1&lt;/code&gt; plus the number &lt;code&gt;0xe&lt;/code&gt;, and then fetches the content of that address in memory, putting it into &lt;code&gt;d0&lt;/code&gt;. How can we compute &lt;code&gt;a1 + 0xe&lt;/code&gt; and put that &lt;em&gt;result&lt;/em&gt; into &lt;code&gt;d0&lt;/code&gt;?&lt;/p&gt;
&lt;p&gt;This is where &lt;code&gt;lea&lt;/code&gt; comes into play. This instruction loads the effective address computed by the addressing mode that we are using into an address register. So &lt;code&gt;lea 0xe(a1),a2&lt;/code&gt; puts the sum between the content of &lt;code&gt;a1&lt;/code&gt; and &lt;code&gt;0xe&lt;/code&gt; into the register &lt;code&gt;a2&lt;/code&gt;. Familiarising with &lt;code&gt;lea&lt;/code&gt; is very important, as it is one of the most important instructions that the Motorola 68000 provides. A quick analysis of the Amiga Kickstart code shows that &lt;code&gt;lea&lt;/code&gt; is the 4th most used instruction, after &lt;code&gt;move&lt;/code&gt;, &lt;code&gt;jsr&lt;/code&gt;, and &lt;code&gt;bra&lt;/code&gt;.&lt;/p&gt;
&lt;h1 id="program-counter-relative-syntax-and-representation"&gt;Program Counter Relative syntax and representation&lt;a class="headerlink" href="#program-counter-relative-syntax-and-representation" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;As we discussed previously, the two Program Counter Relative modes just mirror Address Register Indirect with Displacement and Address Register Indirect with Index, binding them to the Program Counter instead of a generic register. It is worth however digging exactly into what the microprocessor is doing when decoding this addressing mode, and what the standard Assembly representation means.&lt;/p&gt;
&lt;p&gt;To describe the mechanism behind this modes let's consider an example of actual M68000 code&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00000364: 41fa ffa6&lt;/span&gt;         &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x30c&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;pc&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This &lt;code&gt;lea&lt;/code&gt; instruction stores the address &lt;code&gt;0x30c&lt;/code&gt; into &lt;code&gt;a0&lt;/code&gt;, but it's pretty evident that this address mode doesn't work like the traditional Address Register Indirect with Displacement. The instruction is at address &lt;code&gt;0x364&lt;/code&gt; and if we read the displacement as usual we would expect the effective address to be at &lt;code&gt;0x364 + 0x30c&lt;/code&gt;. It is important to understand that this is what the Assembler (or the disassembler) shows, and that the proper meaning of &lt;code&gt;0x30c(pc)&lt;/code&gt; is "the address &lt;code&gt;0x30c&lt;/code&gt; knowing that this instruction is at &lt;code&gt;0x364&lt;/code&gt;". I believe this clearly shows why relocatable code makes use of this addressing mode. The address that we identify with &lt;code&gt;0x364&lt;/code&gt; might actually be anywhere in memory, as this number means only &lt;code&gt;0x364&lt;/code&gt; words after the first instruction (which is at &lt;code&gt;0x0&lt;/code&gt; in our relative space).&lt;/p&gt;
&lt;p&gt;The binary representation of the instruction is actually revealing. The hexadecimal values of the two words &lt;code&gt;41fa ffa6&lt;/code&gt; become &lt;code&gt;01000001111110101111111110100110&lt;/code&gt; which can be split as follows&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;0100  000  111  111010    1111111110100110
^     ^         ^         ^
lea   a0        (d16,PC)  extension word
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;According to the documentation of the addressing mode, the extension word &lt;code&gt;1111111110100110&lt;/code&gt; is a signed 16-bit displacement, so it is a number expressed in two's complement notation. The conversion gives &lt;code&gt;-0x5a&lt;/code&gt;, which added to the instruction relative address &lt;code&gt;0x364&lt;/code&gt; surprisingly gives &lt;code&gt;0x30a&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The documentation of the addressing mode, however, states that&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;In this mode, the operand is in memory. The address of the operand is the sum of the address in the program counter (PC) and the sign-extended 16-bit displacement integer in the extension word. The value in the PC is the address of the extension word.&lt;/p&gt;
&lt;p&gt;(2.2.11, page 13)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The thing that can be easily overlooked is that the PC points to the extension word and not to the instruction word. In this case, while the instruction word is at &lt;code&gt;0x364&lt;/code&gt;, the extension word is at &lt;code&gt;0x366&lt;/code&gt;, and &lt;code&gt;0x366 - 0x5a&lt;/code&gt; gives exactly &lt;code&gt;0x30c&lt;/code&gt;, which is what the Assembly syntax shows us. As you can see, the Assembler and the Disassembler have to perform some calculations to show the actual relative final value.&lt;/p&gt;
&lt;h1 id="resources"&gt;Resources&lt;a class="headerlink" href="#resources" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;Motorola M68000 Family Programmer's Reference Manual &lt;a href="https://www.nxp.com/docs/en/reference-manual/M68000PRM.pdf"&gt;PDF here&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;M68000 Microprocessors User's Manual &lt;a href="https://www.nxp.com/docs/en/reference-manual/MC68000UM.pdf"&gt;PDF here&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;The 68000 Principles and Programming, Leo J. Scanion, 1981&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="updates"&gt;Updates&lt;a class="headerlink" href="#updates" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;2017-12-24: Reddit user &lt;a href="https://new.reddit.com/user/SpaceShrimp"&gt;SpaceShrimp&lt;/a&gt; pointed out the rage of a signed 16-bit number is &lt;code&gt;(-32768,32767)&lt;/code&gt; and not &lt;code&gt;(-32767,32768)&lt;/code&gt;. Thanks!&lt;/p&gt;
&lt;h1 id="feedback"&gt;Feedback&lt;a class="headerlink" href="#feedback" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Feel free to reach me on &lt;a href="https://twitter.com/thedigicat"&gt;Twitter&lt;/a&gt; if you have questions. The &lt;a href="https://github.com/TheDigitalCatOnline/thedigitalcatonline.github.com/issues"&gt;GitHub issues&lt;/a&gt; page is the best place to submit corrections.&lt;/p&gt;</content><category term="assembly"></category><category term="M68000"></category></entry><entry><title>Exploring the Amiga - Part 8</title><link href="https://www.thedigitalcatonline.com/blog/2019/02/19/exploring-the-amiga-8/" rel="alternate"></link><published>2019-02-19T14:00:00+01:00</published><updated>2019-02-19T14:00:00+01:00</updated><author><name>Leonardo Giordani</name></author><id>tag:www.thedigitalcatonline.com,2019-02-19:/blog/2019/02/19/exploring-the-amiga-8/</id><summary type="html"></summary><content type="html">&lt;h1 id="branching"&gt;Branching&lt;a class="headerlink" href="#branching" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;As branching is one of the most important ways to control the program flow it is worth discussing how it works in the Motorola 68000 processor, and review what options we have.&lt;/p&gt;
&lt;p&gt;Contrary to what happens in higher level languages, in Assembly we do not have a way to represent logical expressions. In a language like C we can compare two integers with something like &lt;code&gt;a &amp;gt; b&lt;/code&gt; which tells us if the first number is greater than the second. But in Assembly there is no such syntax, so we have to rely on processor flags; these are bits that the processor sets according to the result of some operation, be it a direct comparison of two values or another instruction that manages integer numbers.&lt;/p&gt;
&lt;p&gt;The Motorola 68000 flags are kept in the 5 least significant bits of the Status Register (SR). The latter is not available during the normal operations in user mode, but these 5 bits, called Condition Code Register (CCR) are always accessible. The 5 bits are named &lt;code&gt;X&lt;/code&gt;, &lt;code&gt;N&lt;/code&gt;, &lt;code&gt;Z&lt;/code&gt;, &lt;code&gt;V&lt;/code&gt;, and &lt;code&gt;C&lt;/code&gt;. Of these, the ones we need to take into consideration for branching are the rightmost 4.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;N&lt;/code&gt; (Negative) is set to the value of the most significant bit of the result of an instruction, to show that a negative number was produced.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Z&lt;/code&gt; (Zero) is set if the result is zero.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;V&lt;/code&gt; (Overflow) is set when an arithmetic operation results in a number that cannot be represented with the size of the operand.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;C&lt;/code&gt; (Carry) is set when an addition or a subtraction need to carry a bit (carry out or borrow).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;To branch according to the value of these flags we can use the &lt;code&gt;Bcc&lt;/code&gt; family of instruction, where &lt;code&gt;cc&lt;/code&gt; is a two-letter mnemonic that represents the condition that is under test. For example the condition &lt;code&gt;MI&lt;/code&gt; stands for &lt;code&gt;MInus&lt;/code&gt; and tests if the &lt;code&gt;N&lt;/code&gt; flag is set. Thus, &lt;code&gt;bmi &amp;lt;address&amp;gt;&lt;/code&gt; will branch to &lt;code&gt;&amp;lt;address&amp;gt;&lt;/code&gt; if the result of the previous instruction was negative, because that instruction set the &lt;code&gt;N&lt;/code&gt; flag.&lt;/p&gt;
&lt;p&gt;There are multiple families of instructions that use the CCR: &lt;code&gt;Bcc&lt;/code&gt;, &lt;code&gt;DBcc&lt;/code&gt;, &lt;code&gt;Scc&lt;/code&gt;, and &lt;code&gt;TRAPcc&lt;/code&gt;. The following table lists all the possible conditions we can test on the Motorola 68000 and their meaning&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Instruction&lt;/th&gt;
&lt;th&gt;Full name&lt;/th&gt;
&lt;th&gt;Tested condition&lt;/th&gt;
&lt;th&gt;Notes&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;CC&lt;/td&gt;
&lt;td&gt;Carry Clear&lt;/td&gt;
&lt;td&gt;C == 0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;CS&lt;/td&gt;
&lt;td&gt;Carry Set&lt;/td&gt;
&lt;td&gt;C == 1&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;EQ&lt;/td&gt;
&lt;td&gt;EQual&lt;/td&gt;
&lt;td&gt;Z == 1&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;F&lt;/td&gt;
&lt;td&gt;False&lt;/td&gt;
&lt;td&gt;Always false&lt;/td&gt;
&lt;td&gt;Not available for Bcc&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;GE&lt;/td&gt;
&lt;td&gt;Greater or Equal&lt;/td&gt;
&lt;td&gt;N == V&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;GT&lt;/td&gt;
&lt;td&gt;Greater Than&lt;/td&gt;
&lt;td&gt;N == V and Z == 0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;HI&lt;/td&gt;
&lt;td&gt;HIgher than&lt;/td&gt;
&lt;td&gt;C == 0 and Z == 0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;LE&lt;/td&gt;
&lt;td&gt;Less or Equal&lt;/td&gt;
&lt;td&gt;Z == 1 or N != V&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;LS&lt;/td&gt;
&lt;td&gt;Lower or Same&lt;/td&gt;
&lt;td&gt;C == 1 or Z == 1&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;LT&lt;/td&gt;
&lt;td&gt;Less Than&lt;/td&gt;
&lt;td&gt;N != V&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;MI&lt;/td&gt;
&lt;td&gt;MInus&lt;/td&gt;
&lt;td&gt;N == 1&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;NE&lt;/td&gt;
&lt;td&gt;Not Equal&lt;/td&gt;
&lt;td&gt;Z == 0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;PL&lt;/td&gt;
&lt;td&gt;PLus&lt;/td&gt;
&lt;td&gt;N == 0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;T&lt;/td&gt;
&lt;td&gt;True&lt;/td&gt;
&lt;td&gt;Always true&lt;/td&gt;
&lt;td&gt;Not available for Bcc&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;VC&lt;/td&gt;
&lt;td&gt;V Clear&lt;/td&gt;
&lt;td&gt;V == 0&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;VS&lt;/td&gt;
&lt;td&gt;V Set&lt;/td&gt;
&lt;td&gt;V == 1&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;The reason why the &lt;code&gt;T&lt;/code&gt; and &lt;code&gt;F&lt;/code&gt; conditions are not available for &lt;code&gt;Bcc&lt;/code&gt; instructions is simple: &lt;code&gt;bt&lt;/code&gt; would mean "branch always", and the &lt;code&gt;bra&lt;/code&gt; instruction does exactly this, while &lt;code&gt;bf&lt;/code&gt; would mean "never branch" and it's arguably useless.&lt;/p&gt;
&lt;p&gt;Let's see an example of use with a standard comparison instruction: &lt;code&gt;cmp&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;cmp.w&lt;/span&gt;   &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="k"&gt;beq.b&lt;/span&gt;   &lt;span class="mi"&gt;0x1522&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Here, the processor compares &lt;code&gt;d0&lt;/code&gt; and &lt;code&gt;d1&lt;/code&gt; computing the subtraction &lt;code&gt;d1 - d0&lt;/code&gt; and setting the CCR flags according to the nature of the result. The processors manual (Programmer's Reference Manual, section 4-75, page 179) tells us that the flags are affected according to these rules&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;X&lt;/code&gt;  Not affected.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;N&lt;/code&gt;  Set if the result is negative; cleared otherwise.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Z&lt;/code&gt;  Set if the result is zero; cleared otherwise.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;V&lt;/code&gt;  Set if an overflow occurs; cleared otherwise.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;C&lt;/code&gt;  Set if a borrow occurs; cleared otherwise.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The &lt;code&gt;beq&lt;/code&gt; instruction on the second line checks only the &lt;code&gt;Z&lt;/code&gt; flag, however, so what we are checking here is if &lt;code&gt;d0&lt;/code&gt; and &lt;code&gt;d1&lt;/code&gt; have the same value.&lt;/p&gt;
&lt;p&gt;A less straightforward example involves &lt;code&gt;move&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="mi"&gt;0x1c&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="k"&gt;beq.b&lt;/span&gt;   &lt;span class="mi"&gt;0x151e&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The first line moves the value at &lt;code&gt;a1 + 0x1c&lt;/code&gt; into &lt;code&gt;d0&lt;/code&gt;. The &lt;code&gt;move&lt;/code&gt; instruction page (Programmer's Reference Manual, section 4-116, page 220) says that it affects only the &lt;code&gt;N&lt;/code&gt; and &lt;code&gt;Z&lt;/code&gt; flags&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;X&lt;/code&gt;  Not affected.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;N&lt;/code&gt;  Set if the result is negative; cleared otherwise.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Z&lt;/code&gt;  Set if the result is zero; cleared otherwise.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;V&lt;/code&gt;  Always cleared.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;C&lt;/code&gt;  Always cleared.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Here, the tested result is the value that has been moved. So, the next line branches only if the address &lt;code&gt;a1 + 0x1c&lt;/code&gt; (and later &lt;code&gt;d0&lt;/code&gt;) contains a zero.&lt;/p&gt;
&lt;p&gt;Pay attention that &lt;code&gt;GE&lt;/code&gt;, &lt;code&gt;GT&lt;/code&gt;, &lt;code&gt;LE&lt;/code&gt;, and &lt;code&gt;LT&lt;/code&gt; read &lt;code&gt;N&lt;/code&gt;, so they should be used only with signed integers Unsigned integers, instead, should be compared using &lt;code&gt;HI&lt;/code&gt; and &lt;code&gt;LS&lt;/code&gt;.&lt;/p&gt;
&lt;h1 id="enqueue"&gt;&lt;code&gt;Enqueue&lt;/code&gt;&lt;a class="headerlink" href="#enqueue" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;In the previous article we discussed the structure of a memory node created by &lt;code&gt;AddMemList&lt;/code&gt; and I briefly mentioned &lt;code&gt;Enqueue&lt;/code&gt; and a protected version of it. &lt;code&gt;Enqueue&lt;/code&gt; is the function that Exec uses to add a node into a linked list, following a simple schema based on priorities, but it turns out &lt;code&gt;AddMemList&lt;/code&gt; does not use it directly, resorting to a version of it wrapped by two other functions, namely &lt;code&gt;Forbid&lt;/code&gt; and &lt;code&gt;Permit&lt;/code&gt; that are connected to task rescheduling. For the time being, however, we may forget the wrappers and jump directly to &lt;code&gt;Enqueue&lt;/code&gt; and learn how the Amiga operating system was managing linked lists.&lt;/p&gt;
&lt;p&gt;If the list we are managing is a singly linked list, where each node points to the successor only, we are forced to find the node &lt;em&gt;after which&lt;/em&gt; we want to insert the new one. This is mandatory, as we have to change its outgoing pointer, redirecting it to the new inserted node. In a doubly linked list such the ones used by the Amiga system this is not a problem, as from any point in the list we can start traversing it either forward or backward.&lt;/p&gt;
&lt;p&gt;The following drawing is a simple representation of what happens in the Kickstart code when the &lt;code&gt;Enqueue&lt;/code&gt; function is executed. &lt;code&gt;Ins&lt;/code&gt; is the node we want to insert, &lt;code&gt;Pred&lt;/code&gt; is the node after which we will insert &lt;code&gt;Ins&lt;/code&gt;, and &lt;code&gt;Next&lt;/code&gt; is the node before which we will insert &lt;code&gt;Ins&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;                                  &lt;span class="n"&gt;TAILPRED&lt;/span&gt;  &lt;span class="n"&gt;TAIL&lt;/span&gt;
                                     &lt;span class="o"&gt;|&lt;/span&gt;       &lt;span class="o"&gt;|&lt;/span&gt;
                                     &lt;span class="n"&gt;v&lt;/span&gt;       &lt;span class="n"&gt;v&lt;/span&gt;
&lt;span class="nl"&gt;BEFORE&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;       &lt;span class="n"&gt;HEAD&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Node&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Pred&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Next&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Node&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="mh"&gt;0x0&lt;/span&gt;


                                         &lt;span class="n"&gt;TAILPRED&lt;/span&gt;  &lt;span class="n"&gt;TAIL&lt;/span&gt;
                                            &lt;span class="o"&gt;|&lt;/span&gt;       &lt;span class="o"&gt;|&lt;/span&gt;
                                            &lt;span class="n"&gt;v&lt;/span&gt;       &lt;span class="n"&gt;v&lt;/span&gt;
&lt;span class="nl"&gt;AFTER&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;        &lt;span class="n"&gt;HEAD&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Node&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Pred&lt;/span&gt;           &lt;span class="n"&gt;Next&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Node&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="mh"&gt;0x0&lt;/span&gt;
                                  &lt;span class="o"&gt;|&lt;/span&gt;         &lt;span class="o"&gt;^&lt;/span&gt;
                                  &lt;span class="o"&gt;|&lt;/span&gt;         &lt;span class="o"&gt;|&lt;/span&gt;
                                  &lt;span class="o"&gt;+-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;Ins&lt;/span&gt; &lt;span class="o"&gt;--+&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;As you can see there are several pointers that need to be changed. Both the &lt;code&gt;LN_SUCC&lt;/code&gt; of &lt;code&gt;Pred&lt;/code&gt; and &lt;code&gt;Ins&lt;/code&gt;, but also the &lt;code&gt;LN_PRED&lt;/code&gt; of &lt;code&gt;Next&lt;/code&gt; and &lt;code&gt;Ins&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Enqueue&lt;/code&gt; has a very simple prototype&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;Enqueue(list, node)
        aO    a1
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;where &lt;code&gt;a0&lt;/code&gt; and &lt;code&gt;a1&lt;/code&gt; are pointers respectively to the list header and to the node we are going to insert. It is worth recalling how the list header status is at the time when the first insertion happens, that is when either the chip or expansion memory are added to the system memory pool, managed through &lt;code&gt;MemList&lt;/code&gt;. The latter is a list header &lt;code&gt;LH&lt;/code&gt; structure and the actual values are the following&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;    &lt;span class="mh"&gt;0xe&lt;/span&gt; &lt;span class="o"&gt;+-------+&lt;/span&gt; &lt;span class="mh"&gt;0x150&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt;       &lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="mh"&gt;0xd&lt;/span&gt; &lt;span class="o"&gt;+-------+&lt;/span&gt; &lt;span class="mh"&gt;0x14f&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;LH_pad&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mh"&gt;0xa&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="mh"&gt;0xc&lt;/span&gt; &lt;span class="o"&gt;+-------+&lt;/span&gt; &lt;span class="mh"&gt;0x14e&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;LH_TYPE&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mh"&gt;0x142&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="mh"&gt;0x8&lt;/span&gt; &lt;span class="o"&gt;+-------+&lt;/span&gt; &lt;span class="mh"&gt;0x14a&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;LH_TAILPRED&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mh"&gt;0x0&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="mh"&gt;0x4&lt;/span&gt; &lt;span class="o"&gt;+-------+&lt;/span&gt; &lt;span class="mh"&gt;0x146&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;LH_TAIL&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mh"&gt;0x146&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="mh"&gt;0x0&lt;/span&gt; &lt;span class="o"&gt;+-------+&lt;/span&gt; &lt;span class="mh"&gt;0x142&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;LH_HEAD&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;With this structure in mind, let's dive into the source code of &lt;code&gt;Enqueue&lt;/code&gt;. The function is defined at &lt;code&gt;0xfc1670&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00001670: 1229 0009&lt;/span&gt;                 &lt;span class="k"&gt;move.b&lt;/span&gt;  &lt;span class="mi"&gt;0x9&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;00001674: 2010&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;00001676: 2040&lt;/span&gt;                      &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;00001678: 2010&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;0000167a: 6706&lt;/span&gt;                      &lt;span class="k"&gt;beq.b&lt;/span&gt;   &lt;span class="mi"&gt;0x1682&lt;/span&gt;
&lt;span class="m"&gt;0000167c: b228 0009&lt;/span&gt;                 &lt;span class="k"&gt;cmp.b&lt;/span&gt;   &lt;span class="mi"&gt;0x9&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;00001680: 6ff4&lt;/span&gt;                      &lt;span class="k"&gt;ble.b&lt;/span&gt;   &lt;span class="mi"&gt;0x1676&lt;/span&gt;
&lt;span class="m"&gt;00001682: 2028 0004&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;00001686: 2149 0004&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;0000168a: 2288&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;0000168c: 2340 0004&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001690: 2040&lt;/span&gt;                      &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;00001692: 2089&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001694: 4e75&lt;/span&gt;                      &lt;span class="k"&gt;rts&lt;/span&gt;     
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And it can be roughly divided into three sections, according to the internal jumps.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nl"&gt;Init:&lt;/span&gt;
&lt;span class="m"&gt;00001670: 1229 0009&lt;/span&gt;                 &lt;span class="k"&gt;move.b&lt;/span&gt;  &lt;span class="mi"&gt;0x9&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;00001674: 2010&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;

&lt;span class="nl"&gt;FindPos:&lt;/span&gt;
&lt;span class="m"&gt;00001676: 2040&lt;/span&gt;                      &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;00001678: 2010&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;0000167a: 6706&lt;/span&gt;                      &lt;span class="k"&gt;beq.b&lt;/span&gt;   &lt;span class="nl"&gt;InsertNode&lt;/span&gt;
&lt;span class="m"&gt;0000167c: b228 0009&lt;/span&gt;                 &lt;span class="k"&gt;cmp.b&lt;/span&gt;   &lt;span class="mi"&gt;0x9&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;00001680: 6ff4&lt;/span&gt;                      &lt;span class="k"&gt;ble.b&lt;/span&gt;   &lt;span class="nl"&gt;FindPos&lt;/span&gt;

&lt;span class="nl"&gt;InsertNode:&lt;/span&gt;
&lt;span class="m"&gt;00001682: 2028 0004&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;00001686: 2149 0004&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;0000168a: 2288&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;0000168c: 2340 0004&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001690: 2040&lt;/span&gt;                      &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;00001692: 2089&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001694: 4e75&lt;/span&gt;                      &lt;span class="k"&gt;rts&lt;/span&gt;     
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The first section, &lt;code&gt;Init&lt;/code&gt;, prepares the execution of the rest of the function. The rest bla&lt;/p&gt;
&lt;p&gt;As I did for other functions in the previous articles, I'm going to dissect this line by line. Let's start from the &lt;code&gt;Init&lt;/code&gt; part.&lt;/p&gt;
&lt;h2 id="init"&gt;Init&lt;a class="headerlink" href="#init" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nl"&gt;Init:&lt;/span&gt;
&lt;span class="m"&gt;00001670: 1229 0009&lt;/span&gt;                 &lt;span class="k"&gt;move.b&lt;/span&gt;  &lt;span class="mi"&gt;0x9&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;00001674: 2010&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Since &lt;code&gt;a1&lt;/code&gt; points to the node to be inserted, &lt;code&gt;0x9(a1)&lt;/code&gt; is the &lt;code&gt;LN_PRI&lt;/code&gt; field of that node, that is the priority. The first line thus stores it in &lt;code&gt;d1&lt;/code&gt; because it will be used to search for the insertion point, as the list is maintained in priority order.&lt;/p&gt;
&lt;p&gt;The second line is the core or the node traversal algorithm. Since &lt;code&gt;a0&lt;/code&gt; points to a &lt;code&gt;LH&lt;/code&gt; structure, it is also the address of the first field &lt;code&gt;LH_HEAD&lt;/code&gt;. &lt;code&gt;(a0)&lt;/code&gt;, thus, is the dereferencing of that address, which means the address of the first node in the list. Given the figures I showed before for &lt;code&gt;MemList&lt;/code&gt;, &lt;code&gt;a0&lt;/code&gt; is &lt;code&gt;0x142&lt;/code&gt; so a &lt;code&gt;move a0,d0&lt;/code&gt; would store &lt;code&gt;0x142&lt;/code&gt; (the value of &lt;code&gt;a0&lt;/code&gt;) in &lt;code&gt;d0&lt;/code&gt;. &lt;code&gt;(a0)&lt;/code&gt;, instead, is the content of that address in memory, namely &lt;code&gt;0x146&lt;/code&gt;, so &lt;code&gt;move (a0),d0&lt;/code&gt; stores &lt;code&gt;0x146&lt;/code&gt; (the content of &lt;code&gt;0x142&lt;/code&gt;) in &lt;code&gt;d0&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Putting aside the intricacies of the addressing modes, the second line stores the address of the first node in the list, which is the part of the header that starts with &lt;code&gt;LH_TAIL&lt;/code&gt;. The header thus acts as the first node of the list.&lt;/p&gt;
&lt;h2 id="findpos"&gt;FindPos&lt;a class="headerlink" href="#findpos" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nl"&gt;FindPos:&lt;/span&gt;
&lt;span class="m"&gt;00001676: 2040&lt;/span&gt;                      &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;00001678: 2010&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;0000167a: 6706&lt;/span&gt;                      &lt;span class="k"&gt;beq.b&lt;/span&gt;   &lt;span class="nl"&gt;InsertNode&lt;/span&gt;
&lt;span class="m"&gt;0000167c: b228 0009&lt;/span&gt;                 &lt;span class="k"&gt;cmp.b&lt;/span&gt;   &lt;span class="mi"&gt;0x9&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;00001680: 6ff4&lt;/span&gt;                      &lt;span class="k"&gt;ble.b&lt;/span&gt;   &lt;span class="nl"&gt;FindPos&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The first two lines repeat the same algorithm. The address of the current node (&lt;code&gt;d0&lt;/code&gt;) is moved to &lt;code&gt;a0&lt;/code&gt; and the dereferencing operation &lt;code&gt;(a0)&lt;/code&gt; puts in &lt;code&gt;d0&lt;/code&gt; the address of the following node. The reason why we do it in two lines is that the Address Register Indirect Mode can be used only with &lt;code&gt;An&lt;/code&gt; registers. At this point &lt;code&gt;d0&lt;/code&gt; contains the address of the second node, the successor of the header.&lt;/p&gt;
&lt;p&gt;If the list contains at least one node, &lt;code&gt;d0&lt;/code&gt; contains its address. But if the list is empty at this point &lt;code&gt;d0&lt;/code&gt; contains &lt;code&gt;0x0&lt;/code&gt;, and this is the condition tested by the &lt;code&gt;beq.b&lt;/code&gt; instruction. If &lt;code&gt;d0&lt;/code&gt; is empty we reached the end of the list, which means that there was no better place to insert the node, and we jump to the actual node insertion code, &lt;code&gt;InsertNode&lt;/code&gt;. If the value is not zero, the current node has a proper successor, so let's check it's priority to see if we need to go on or if we can stop here. The code compares the priorities of the current node and of the &lt;code&gt;Ins&lt;/code&gt; node, and if the latter is less than the former we can loop back to &lt;code&gt;FindPos&lt;/code&gt; and move to the next node. Remember that priorities are expressed with negative numbers only, so "less than" actually means "higher priority".&lt;/p&gt;
&lt;h2 id="insertnode"&gt;InsertNode&lt;a class="headerlink" href="#insertnode" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nl"&gt;InsertNode:&lt;/span&gt;
&lt;span class="m"&gt;00001682: 2028 0004&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;00001686: 2149 0004&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;0000168a: 2288&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;0000168c: 2340 0004&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001690: 2040&lt;/span&gt;                      &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;00001692: 2089&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001694: 4e75&lt;/span&gt;                      &lt;span class="k"&gt;rts&lt;/span&gt;     
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;In either case, when we reach the tail or when the priority of the next node is lower than the one of the new node, we reach &lt;code&gt;InsertNode&lt;/code&gt;. At this point &lt;code&gt;a0&lt;/code&gt; points to &lt;code&gt;Next&lt;/code&gt; and we can access &lt;code&gt;Pred&lt;/code&gt; through &lt;code&gt;0x4(a0)&lt;/code&gt; (that is &lt;code&gt;LN_SUCC&lt;/code&gt; of &lt;code&gt;Next&lt;/code&gt;).&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00001682: 2028 0004&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;00001686: 2149 0004&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This first stores the aforementioned address of &lt;code&gt;Pred&lt;/code&gt; in &lt;code&gt;d0&lt;/code&gt;, then replaces it with the value of &lt;code&gt;a1&lt;/code&gt;. The result is that the predecessor of &lt;code&gt;Next&lt;/code&gt; becomes &lt;code&gt;Ins&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;0000168a: 2288&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;0000168c: 2340 0004&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This moves &lt;code&gt;a0&lt;/code&gt;, the address of &lt;code&gt;Next&lt;/code&gt;, into the first field of &lt;code&gt;Ins&lt;/code&gt;, that is &lt;code&gt;Next&lt;/code&gt; becomes the successor of &lt;code&gt;Ins&lt;/code&gt;. The second line moves &lt;code&gt;d0&lt;/code&gt; (the address of &lt;code&gt;Pred&lt;/code&gt;) into the &lt;code&gt;LN_PRED&lt;/code&gt; of &lt;code&gt;Ins&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00001690: 2040&lt;/span&gt;                      &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;00001692: 2089&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001694: 4e75&lt;/span&gt;                      &lt;span class="k"&gt;rts&lt;/span&gt;     
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Last, the address of &lt;code&gt;Ins&lt;/code&gt; becomes the &lt;code&gt;LN_SUCC&lt;/code&gt; of &lt;code&gt;Pred&lt;/code&gt;, so we move &lt;code&gt;d0&lt;/code&gt; into &lt;code&gt;a0&lt;/code&gt; because, as I already mentioned, the Address Register Indirect Mode can be used only with &lt;code&gt;An&lt;/code&gt; registers. After this the function returns to the caller.&lt;/p&gt;
&lt;h1 id="remove"&gt;&lt;code&gt;Remove&lt;/code&gt;&lt;a class="headerlink" href="#remove" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Since we reviewed the code of &lt;code&gt;Enqueue&lt;/code&gt; it makes sense to have a look at the opposite function, &lt;code&gt;Remove&lt;/code&gt;. A protected version of this exists as well, but here I will just show the code of the pure function without the wrapper.&lt;/p&gt;
&lt;p&gt;Removing a node is simpler than adding it, as all we have to do is to make &lt;code&gt;Pred&lt;/code&gt; point to &lt;code&gt;Next&lt;/code&gt; and vice versa, so the function is much shorter. It's worth noting that while the function accepts the address of the node in &lt;code&gt;a1&lt;/code&gt; the value in this register is eventually overwritten, so the address has to be kept elsewhere when the function is called.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;0000163c: 2051&lt;/span&gt;                      &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;0000163e: 2269 0004&lt;/span&gt;                 &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;
&lt;span class="m"&gt;00001642: 2288&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001644: 2149 0004&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001648: 4e75&lt;/span&gt; 
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The first two lines store the address of &lt;code&gt;Next&lt;/code&gt; in &lt;code&gt;a0&lt;/code&gt; and of &lt;code&gt;Pred&lt;/code&gt; in &lt;code&gt;a1&lt;/code&gt; (overwriting the input value). The third line makes &lt;code&gt;Next&lt;/code&gt; the successor of &lt;code&gt;Pred&lt;/code&gt; and the fourth line makes &lt;code&gt;Pred&lt;/code&gt; the predecessor of &lt;code&gt;Next&lt;/code&gt;. Then the function returns to the caller.&lt;/p&gt;
&lt;h1 id="addlibrary"&gt;&lt;code&gt;AddLibrary&lt;/code&gt;&lt;a class="headerlink" href="#addlibrary" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;In the &lt;a href="https://www.thedigitalcatonline.com/blog/2018/06/25/exploring-the-amiga-6/"&gt;6th post&lt;/a&gt; of this series we left Kickstart just after it finished adding the physical memory to the system pool. The last instruction we mentioned was a call to &lt;code&gt;AddLibrary&lt;/code&gt;, and this is then the next function I will explore.&lt;/p&gt;
&lt;p&gt;The code of the function is at &lt;code&gt;fc1448&lt;/code&gt;, and required some work before I was able to read it (see the section "Manual decompilation").&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00001448: 41ee 017a&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt; &lt;span class="mi"&gt;0x17a&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;0000144c: 6100 0270&lt;/span&gt;                 &lt;span class="k"&gt;bsr.w&lt;/span&gt; &lt;span class="mi"&gt;0x16be&lt;/span&gt;
&lt;span class="m"&gt;00001450: 6100 0082&lt;/span&gt;                 &lt;span class="k"&gt;bsr.w&lt;/span&gt; &lt;span class="mi"&gt;0x14d4&lt;/span&gt;
&lt;span class="m"&gt;00001454: 4e75&lt;/span&gt;                      &lt;span class="k"&gt;rts&lt;/span&gt;     
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The first line loads the absolute address of an object &lt;code&gt;0x17a&lt;/code&gt; bytes after the ExecBase address, and looking up this displacement in the library structure published in both the fifth and sixth instalment we find, rather unsurprisingly, that this is the address of &lt;code&gt;LibList&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The following lines call the protected version of &lt;code&gt;Enqueue&lt;/code&gt; and &lt;code&gt;SumLibrary&lt;/code&gt;, after which the routine returns to the caller. The call to &lt;code&gt;Enqueue&lt;/code&gt; follows what I explained at the beginning of this post, where this time &lt;code&gt;a0&lt;/code&gt; points to the library system list and &lt;code&gt;a1&lt;/code&gt; points to the base address of Exec, set just before the call to &lt;code&gt;AddLibrary&lt;/code&gt;. So the Exec library itself is added to the system libraries through this routine.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;SumLibrary&lt;/code&gt;, as the name suggests, computes the checksum of a library, or checks the existing one.&lt;/p&gt;
&lt;h1 id="manual-decompilation"&gt;Manual decompilation&lt;a class="headerlink" href="#manual-decompilation" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;When I was following the call to &lt;code&gt;AddLibrary&lt;/code&gt; from the main body of Kickstart I was surprised to find this code&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00001446: 0000 41ee&lt;/span&gt;                 &lt;span class="k"&gt;ori.b&lt;/span&gt;   &lt;span class="p"&gt;#-&lt;/span&gt;&lt;span class="mi"&gt;0x12&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;0000144a: 017a 6100&lt;/span&gt;                 &lt;span class="k"&gt;bchg&lt;/span&gt;    &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x754c&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;pc&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;0000144e: 0270 6100 0082&lt;/span&gt;            &lt;span class="k"&gt;andi.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x6100&lt;/span&gt;&lt;span class="p"&gt;,(-&lt;/span&gt;&lt;span class="mi"&gt;0x7e&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nl"&gt;w&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001454: 4e75&lt;/span&gt;                      &lt;span class="k"&gt;rts&lt;/span&gt;     
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;which at first glance doesn't look like a basic function, as the instructions are too convoluted. Furthermore, the branch uses the address &lt;code&gt;0x1448&lt;/code&gt;, which is thus supposed to be the beginning of the function. A quick look at the hexadecimal values reveals the truth: at &lt;code&gt;0x1446&lt;/code&gt; Kickstart contains a padding word &lt;code&gt;0000&lt;/code&gt; that confused the decompiler. To see the code of the function I had to manually decompile the machine code, and since the process is very interesting I decided to show it in detail here.&lt;/p&gt;
&lt;p&gt;When you try to manually decompile some machine code you need a cheat sheet and the processor manual (see the resources section), which can help you to quickly track down the meaning of the single bits. The values we are interested in are&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00001448: 41ee&lt;/span&gt;
&lt;span class="m"&gt;0000144a: 017a&lt;/span&gt;
&lt;span class="m"&gt;0000144c: 6100&lt;/span&gt;
&lt;span class="m"&gt;0000144e: 0270&lt;/span&gt;
&lt;span class="m"&gt;00001450: 6100&lt;/span&gt;
&lt;span class="m"&gt;00001452: 0082&lt;/span&gt;
&lt;span class="m"&gt;00001454: 4e75&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;since &lt;code&gt;fc1456&lt;/code&gt; is listed as the address of the &lt;code&gt;RemLibrary&lt;/code&gt; function. THe binary representation of these values is&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00001448: 0100 0001 1110 1110&lt;/span&gt;
&lt;span class="m"&gt;0000144a: 0000 0001 0111 1010&lt;/span&gt;
&lt;span class="m"&gt;0000144c: 0110 0001 0000 0000&lt;/span&gt;
&lt;span class="m"&gt;0000144e: 0000 0010 0111 0000&lt;/span&gt;
&lt;span class="m"&gt;00001450: 0110 0001 0000 0000&lt;/span&gt;
&lt;span class="m"&gt;00001452: 0000 0000 1000 0010&lt;/span&gt;
&lt;span class="m"&gt;00001454: 0100 1110 0111 0101&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now, the first 4 bits of any Motorola 68k instruction are the instruction code. While multiple instructions share the same 4 bits (for example &lt;code&gt;andi&lt;/code&gt; and &lt;code&gt;subi&lt;/code&gt;), those bits are never used for addressing or to specify modes, so they are a good starting point.&lt;/p&gt;
&lt;p&gt;The instruction at &lt;code&gt;0x1448&lt;/code&gt; starts with &lt;code&gt;0100&lt;/code&gt; followed by a &lt;code&gt;0&lt;/code&gt;, and this narrows the selection to either &lt;code&gt;lea&lt;/code&gt; or &lt;code&gt;chk&lt;/code&gt;. Both instructions use the following 3 bits to specify a register (&lt;code&gt;An&lt;/code&gt; for &lt;code&gt;lea&lt;/code&gt;, &lt;code&gt;Dn&lt;/code&gt; for &lt;code&gt;chk&lt;/code&gt;), but then the first has a fixed group &lt;code&gt;111&lt;/code&gt;, while the second has a group &lt;code&gt;110&lt;/code&gt;. This means that we are looking at a &lt;code&gt;lea&lt;/code&gt;. The three bits I mentioned are &lt;code&gt;000&lt;/code&gt;, which translates in &lt;code&gt;a0&lt;/code&gt; as a target. The last 6 bits are the addressing mode and the register, and the cheat sheet tells us that &lt;code&gt;101 110&lt;/code&gt; corresponds to Address Register Indirect with Displacement Mode on &lt;code&gt;a6&lt;/code&gt;. &lt;code&gt;101&lt;/code&gt; is labelled as &lt;code&gt;(d16, An)&lt;/code&gt;, while &lt;code&gt;110&lt;/code&gt; is the number 6. The following word is thus the &lt;code&gt;d16&lt;/code&gt; displacement from &lt;code&gt;a6&lt;/code&gt;, which means that &lt;code&gt;41ee 017a&lt;/code&gt; translates to &lt;code&gt;lea 0x17a(a6),a0&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The second instruction starts at &lt;code&gt;0x144c&lt;/code&gt; with &lt;code&gt;0110&lt;/code&gt;, which is the signature of all the branch commands: &lt;code&gt;bra&lt;/code&gt;, &lt;code&gt;bsr&lt;/code&gt;, and all the condition-based ones like &lt;code&gt;bgt&lt;/code&gt;, &lt;code&gt;blt&lt;/code&gt;, and so on. Since the following 4 bits are &lt;code&gt;0001&lt;/code&gt; we know this is a &lt;code&gt;bsr&lt;/code&gt;, branch to subroutine. Now, in this instruction the 8 least significant bits tell us what the displacement is, and thus the type of the operand (Programmer's Manual, section 4-59, page 163). In this case they are all &lt;code&gt;0&lt;/code&gt;, which means a word displacement, which is in the next 16 bits. Pay attention that, as we discussed for &lt;code&gt;lea&lt;/code&gt; in the &lt;a href="https://www.thedigitalcatonline.com/blog/2018/05/28/exploring-the-amiga-1/"&gt;first post&lt;/a&gt; the Program Counter contains the address of the first displacement word. In this case the displacement is &lt;code&gt;0x270&lt;/code&gt; at address &lt;code&gt;0x144e&lt;/code&gt;, so the branch address is the sum of the two, that is &lt;code&gt;0x16be&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The third instruction is again a &lt;code&gt;bsr&lt;/code&gt; and following the same process we find out that the branch address is the sum between &lt;code&gt;0x82&lt;/code&gt; and &lt;code&gt;0x1452&lt;/code&gt;, that is &lt;code&gt;0x14d4&lt;/code&gt;. The final instruction is an &lt;code&gt;rts&lt;/code&gt;, as we expected, and as the decompiler correctly told us.&lt;/p&gt;
&lt;p&gt;The most important thing to keep in mind when manually reading instructions is the position of the Program Counter. As we already saw two times, with &lt;code&gt;lea&lt;/code&gt; and with &lt;code&gt;bsr&lt;/code&gt;, the PC moves as soon as the 16-bit instruction has been read, which means that when a displacement is given we have to use the address of the displacement itself as a base for our calculations.&lt;/p&gt;
&lt;h1 id="resources"&gt;Resources&lt;a class="headerlink" href="#resources" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;Motorola M68000 Family Programmer's Reference Manual &lt;a href="https://www.nxp.com/docs/en/reference-manual/M68000PRM.pdf"&gt;PDF here&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Motorola 68000 Opcodes Cheat Sheet http://goldencrystal.free.fr/M68kOpcodes-v2.3.pdf&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="feedback"&gt;Feedback&lt;a class="headerlink" href="#feedback" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Feel free to reach me on &lt;a href="https://twitter.com/thedigicat"&gt;Twitter&lt;/a&gt; if you have questions. The &lt;a href="https://github.com/TheDigitalCatOnline/thedigitalcatonline.github.com/issues"&gt;GitHub issues&lt;/a&gt; page is the best place to submit corrections.&lt;/p&gt;</content><category term="assembly"></category><category term="amiga"></category><category term="retroprogramming"></category></entry><entry><title>Exploring the Amiga - Part 7</title><link href="https://www.thedigitalcatonline.com/blog/2019/02/19/exploring-the-amiga-7/" rel="alternate"></link><published>2019-02-19T13:00:00+01:00</published><updated>2019-02-19T13:00:00+01:00</updated><author><name>Leonardo Giordani</name></author><id>tag:www.thedigitalcatonline.com,2019-02-19:/blog/2019/02/19/exploring-the-amiga-7/</id><summary type="html"></summary><content type="html">&lt;h1 id="the-complete-exec-vector-table"&gt;The complete Exec vector table&lt;a class="headerlink" href="#the-complete-exec-vector-table" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;In &lt;a href="https://www.thedigitalcatonline.com/blog/2018/06/08/exploring-the-amiga-3/"&gt;the 3rd post&lt;/a&gt; of this series I showed the Exec vectors table and the way &lt;code&gt;MakeFunctions&lt;/code&gt; creates the jump table when Exec is installed in memory. In that post I focused on the first 4 reserved vectors, but it is useful to have the full table while reading the Kickstart code. This is the full vectors table for Exec 34.2 (28 Oct 1987).&lt;/p&gt;
&lt;p&gt;The &lt;strong&gt;Relative offset&lt;/strong&gt; column contains the offset of the function in the jump table once the library has been installed, which allows any Amiga program to call Exec functions through the &lt;code&gt;offset(a6)&lt;/code&gt; syntax (e.g. &lt;code&gt;OpenLibrary&lt;/code&gt; can be called by &lt;code&gt;jsr -0x228(a6)&lt;/code&gt;). &lt;strong&gt;Vector position&lt;/strong&gt; is the offset of the vector in the Kickstart 1.3 ROM (i.e. &lt;code&gt;0x0001a7c&lt;/code&gt; is the position of the vector table itself), &lt;strong&gt;Relative address&lt;/strong&gt; is the hexadecimal value stored in the table before the relocation, &lt;strong&gt;Absolute address&lt;/strong&gt; is the function position after relocation (i.e. the wrapped sum between the table address and the relative address), and &lt;strong&gt;Function&lt;/strong&gt; is the function name according to the include files and the Amiga documentation.&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Relative offset&lt;/th&gt;
&lt;th&gt;Vector position&lt;/th&gt;
&lt;th&gt;Relative address&lt;/th&gt;
&lt;th&gt;Absolute address&lt;/th&gt;
&lt;th&gt;Function&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;-0x00&lt;/td&gt;
&lt;td&gt;00001a7c&lt;/td&gt;
&lt;td&gt;08a0&lt;/td&gt;
&lt;td&gt;0000231c&lt;/td&gt;
&lt;td&gt;Open()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x06&lt;/td&gt;
&lt;td&gt;00001a7e&lt;/td&gt;
&lt;td&gt;08a8&lt;/td&gt;
&lt;td&gt;00002324&lt;/td&gt;
&lt;td&gt;Close()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x12&lt;/td&gt;
&lt;td&gt;00001a80&lt;/td&gt;
&lt;td&gt;08ac&lt;/td&gt;
&lt;td&gt;00002328&lt;/td&gt;
&lt;td&gt;Expunge()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x18&lt;/td&gt;
&lt;td&gt;00001a82&lt;/td&gt;
&lt;td&gt;08ac&lt;/td&gt;
&lt;td&gt;00002328&lt;/td&gt;
&lt;td&gt;Reserved for future use&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x1e&lt;/td&gt;
&lt;td&gt;00001a84&lt;/td&gt;
&lt;td&gt;ee6a&lt;/td&gt;
&lt;td&gt;000008e6&lt;/td&gt;
&lt;td&gt;Supervisor()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x24&lt;/td&gt;
&lt;td&gt;00001a86&lt;/td&gt;
&lt;td&gt;f420&lt;/td&gt;
&lt;td&gt;00000e9c&lt;/td&gt;
&lt;td&gt;ExitIntr()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x2a&lt;/td&gt;
&lt;td&gt;00001a88&lt;/td&gt;
&lt;td&gt;f446&lt;/td&gt;
&lt;td&gt;00000ec2&lt;/td&gt;
&lt;td&gt;Schedule()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x30&lt;/td&gt;
&lt;td&gt;00001a8a&lt;/td&gt;
&lt;td&gt;04f8&lt;/td&gt;
&lt;td&gt;00001f74&lt;/td&gt;
&lt;td&gt;Reschedule()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x36&lt;/td&gt;
&lt;td&gt;00001a8c&lt;/td&gt;
&lt;td&gt;f4a0&lt;/td&gt;
&lt;td&gt;00000f1c&lt;/td&gt;
&lt;td&gt;Switch()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x3c&lt;/td&gt;
&lt;td&gt;00001a8e&lt;/td&gt;
&lt;td&gt;f4ea&lt;/td&gt;
&lt;td&gt;00000f66&lt;/td&gt;
&lt;td&gt;Dispatch()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x42&lt;/td&gt;
&lt;td&gt;00001a90&lt;/td&gt;
&lt;td&gt;f58e&lt;/td&gt;
&lt;td&gt;0000100a&lt;/td&gt;
&lt;td&gt;Exception()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x48&lt;/td&gt;
&lt;td&gt;00001a92&lt;/td&gt;
&lt;td&gt;f0b0&lt;/td&gt;
&lt;td&gt;00000b2c&lt;/td&gt;
&lt;td&gt;InitCode()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x4e&lt;/td&gt;
&lt;td&gt;00001a94&lt;/td&gt;
&lt;td&gt;f188&lt;/td&gt;
&lt;td&gt;00000c04&lt;/td&gt;
&lt;td&gt;InitStruct()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x54&lt;/td&gt;
&lt;td&gt;00001a96&lt;/td&gt;
&lt;td&gt;faac&lt;/td&gt;
&lt;td&gt;00001528&lt;/td&gt;
&lt;td&gt;MakeLibrary()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x5a&lt;/td&gt;
&lt;td&gt;00001a98&lt;/td&gt;
&lt;td&gt;fb36&lt;/td&gt;
&lt;td&gt;000015b2&lt;/td&gt;
&lt;td&gt;MakeFunctions()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x60&lt;/td&gt;
&lt;td&gt;00001a9a&lt;/td&gt;
&lt;td&gt;f080&lt;/td&gt;
&lt;td&gt;00000afc&lt;/td&gt;
&lt;td&gt;FindResident()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x66&lt;/td&gt;
&lt;td&gt;00001a9c&lt;/td&gt;
&lt;td&gt;f0e8&lt;/td&gt;
&lt;td&gt;00000b64&lt;/td&gt;
&lt;td&gt;InitResident()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x6c&lt;/td&gt;
&lt;td&gt;00001a9e&lt;/td&gt;
&lt;td&gt;1596&lt;/td&gt;
&lt;td&gt;00003012&lt;/td&gt;
&lt;td&gt;Alert()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x72&lt;/td&gt;
&lt;td&gt;00001aa0&lt;/td&gt;
&lt;td&gt;08ee&lt;/td&gt;
&lt;td&gt;0000236a&lt;/td&gt;
&lt;td&gt;Debug()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x78&lt;/td&gt;
&lt;td&gt;00001aa2&lt;/td&gt;
&lt;td&gt;f9ac&lt;/td&gt;
&lt;td&gt;00001428&lt;/td&gt;
&lt;td&gt;Disable()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x7e&lt;/td&gt;
&lt;td&gt;00001aa4&lt;/td&gt;
&lt;td&gt;f9ba&lt;/td&gt;
&lt;td&gt;00001436&lt;/td&gt;
&lt;td&gt;Enable()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x84&lt;/td&gt;
&lt;td&gt;00001aa6&lt;/td&gt;
&lt;td&gt;051a&lt;/td&gt;
&lt;td&gt;00001f96&lt;/td&gt;
&lt;td&gt;Forbid()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x8a&lt;/td&gt;
&lt;td&gt;00001aa8&lt;/td&gt;
&lt;td&gt;0520&lt;/td&gt;
&lt;td&gt;00001f9c&lt;/td&gt;
&lt;td&gt;Permit()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x90&lt;/td&gt;
&lt;td&gt;00001aaa&lt;/td&gt;
&lt;td&gt;f6e2&lt;/td&gt;
&lt;td&gt;0000115e&lt;/td&gt;
&lt;td&gt;SetSR()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x96&lt;/td&gt;
&lt;td&gt;00001aac&lt;/td&gt;
&lt;td&gt;f708&lt;/td&gt;
&lt;td&gt;00001184&lt;/td&gt;
&lt;td&gt;SuperState()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x9c&lt;/td&gt;
&lt;td&gt;00001aae&lt;/td&gt;
&lt;td&gt;f734&lt;/td&gt;
&lt;td&gt;000011b0&lt;/td&gt;
&lt;td&gt;UserState()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0xa2&lt;/td&gt;
&lt;td&gt;00001ab0&lt;/td&gt;
&lt;td&gt;f74e&lt;/td&gt;
&lt;td&gt;000011ca&lt;/td&gt;
&lt;td&gt;SetIntVector()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0xa8&lt;/td&gt;
&lt;td&gt;00001ab2&lt;/td&gt;
&lt;td&gt;f794&lt;/td&gt;
&lt;td&gt;00001210&lt;/td&gt;
&lt;td&gt;AddIntServer()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0xae&lt;/td&gt;
&lt;td&gt;00001ab4&lt;/td&gt;
&lt;td&gt;f7d4&lt;/td&gt;
&lt;td&gt;00001250&lt;/td&gt;
&lt;td&gt;RemIntServer()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0xb4&lt;/td&gt;
&lt;td&gt;00001ab6&lt;/td&gt;
&lt;td&gt;f8e0&lt;/td&gt;
&lt;td&gt;0000135c&lt;/td&gt;
&lt;td&gt;Cause()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0xba&lt;/td&gt;
&lt;td&gt;00001ab8&lt;/td&gt;
&lt;td&gt;fc5c&lt;/td&gt;
&lt;td&gt;000016d8&lt;/td&gt;
&lt;td&gt;Allocate()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0xc0&lt;/td&gt;
&lt;td&gt;00001ac0&lt;/td&gt;
&lt;td&gt;fcc4&lt;/td&gt;
&lt;td&gt;00001740&lt;/td&gt;
&lt;td&gt;Deallocate()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0xc6&lt;/td&gt;
&lt;td&gt;00001abc&lt;/td&gt;
&lt;td&gt;fd54&lt;/td&gt;
&lt;td&gt;000017d0&lt;/td&gt;
&lt;td&gt;AllocMem()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0xcc&lt;/td&gt;
&lt;td&gt;00001abe&lt;/td&gt;
&lt;td&gt;fe00&lt;/td&gt;
&lt;td&gt;0000187c&lt;/td&gt;
&lt;td&gt;AllocAbs()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0xd2&lt;/td&gt;
&lt;td&gt;00001ac0&lt;/td&gt;
&lt;td&gt;fdb0&lt;/td&gt;
&lt;td&gt;0000182c&lt;/td&gt;
&lt;td&gt;FreeMem()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0xd8&lt;/td&gt;
&lt;td&gt;00001ac2&lt;/td&gt;
&lt;td&gt;fe90&lt;/td&gt;
&lt;td&gt;0000190c&lt;/td&gt;
&lt;td&gt;AvailMem()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0xde&lt;/td&gt;
&lt;td&gt;00001ac4&lt;/td&gt;
&lt;td&gt;fede&lt;/td&gt;
&lt;td&gt;0000195a&lt;/td&gt;
&lt;td&gt;AllocEntry()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0xe4&lt;/td&gt;
&lt;td&gt;00001ac6&lt;/td&gt;
&lt;td&gt;ff6c&lt;/td&gt;
&lt;td&gt;000019e8&lt;/td&gt;
&lt;td&gt;FreeEntry()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0xea&lt;/td&gt;
&lt;td&gt;00001ac8&lt;/td&gt;
&lt;td&gt;fb6c&lt;/td&gt;
&lt;td&gt;000015e8&lt;/td&gt;
&lt;td&gt;Insert()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0xf0&lt;/td&gt;
&lt;td&gt;00001aca&lt;/td&gt;
&lt;td&gt;fb98&lt;/td&gt;
&lt;td&gt;00001614&lt;/td&gt;
&lt;td&gt;AddHead()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0xf6&lt;/td&gt;
&lt;td&gt;00001acc&lt;/td&gt;
&lt;td&gt;fba8&lt;/td&gt;
&lt;td&gt;00001624&lt;/td&gt;
&lt;td&gt;AddTail()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0xfc&lt;/td&gt;
&lt;td&gt;00001ace&lt;/td&gt;
&lt;td&gt;fbc0&lt;/td&gt;
&lt;td&gt;0000163c&lt;/td&gt;
&lt;td&gt;Remove()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x102&lt;/td&gt;
&lt;td&gt;00001ad0&lt;/td&gt;
&lt;td&gt;fbce&lt;/td&gt;
&lt;td&gt;0000164a&lt;/td&gt;
&lt;td&gt;RemHead()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x108&lt;/td&gt;
&lt;td&gt;00001ad2&lt;/td&gt;
&lt;td&gt;fbde&lt;/td&gt;
&lt;td&gt;0000165a&lt;/td&gt;
&lt;td&gt;RemTail()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x10e&lt;/td&gt;
&lt;td&gt;00001ad4&lt;/td&gt;
&lt;td&gt;fbf4&lt;/td&gt;
&lt;td&gt;00001670&lt;/td&gt;
&lt;td&gt;Enqueue()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x114&lt;/td&gt;
&lt;td&gt;00001ad6&lt;/td&gt;
&lt;td&gt;fc1a&lt;/td&gt;
&lt;td&gt;00001696&lt;/td&gt;
&lt;td&gt;FindName()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x11a&lt;/td&gt;
&lt;td&gt;00001ad8&lt;/td&gt;
&lt;td&gt;0208&lt;/td&gt;
&lt;td&gt;00001c84&lt;/td&gt;
&lt;td&gt;AddTask()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x120&lt;/td&gt;
&lt;td&gt;00001ada&lt;/td&gt;
&lt;td&gt;02b4&lt;/td&gt;
&lt;td&gt;00001d30&lt;/td&gt;
&lt;td&gt;RemTask()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x126&lt;/td&gt;
&lt;td&gt;00001adc&lt;/td&gt;
&lt;td&gt;0334&lt;/td&gt;
&lt;td&gt;00001db0&lt;/td&gt;
&lt;td&gt;FindTask()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x12c&lt;/td&gt;
&lt;td&gt;00001ade&lt;/td&gt;
&lt;td&gt;0388&lt;/td&gt;
&lt;td&gt;00001e04&lt;/td&gt;
&lt;td&gt;SetTaskPri()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x132&lt;/td&gt;
&lt;td&gt;00001ae0&lt;/td&gt;
&lt;td&gt;03e2&lt;/td&gt;
&lt;td&gt;00001e5e&lt;/td&gt;
&lt;td&gt;SetSignal()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x138&lt;/td&gt;
&lt;td&gt;00001ae2&lt;/td&gt;
&lt;td&gt;03d8&lt;/td&gt;
&lt;td&gt;00001e54&lt;/td&gt;
&lt;td&gt;SetExcept()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x13e&lt;/td&gt;
&lt;td&gt;00001ae4&lt;/td&gt;
&lt;td&gt;0490&lt;/td&gt;
&lt;td&gt;00001f0c&lt;/td&gt;
&lt;td&gt;Wait()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x144&lt;/td&gt;
&lt;td&gt;00001ae6&lt;/td&gt;
&lt;td&gt;0408&lt;/td&gt;
&lt;td&gt;00001e84&lt;/td&gt;
&lt;td&gt;Signal()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x14a&lt;/td&gt;
&lt;td&gt;00001ae8&lt;/td&gt;
&lt;td&gt;0584&lt;/td&gt;
&lt;td&gt;00002000&lt;/td&gt;
&lt;td&gt;AllocSignal()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x150&lt;/td&gt;
&lt;td&gt;00001aea&lt;/td&gt;
&lt;td&gt;05bc&lt;/td&gt;
&lt;td&gt;00002038&lt;/td&gt;
&lt;td&gt;FreeSignal()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x156&lt;/td&gt;
&lt;td&gt;00001aec&lt;/td&gt;
&lt;td&gt;054e&lt;/td&gt;
&lt;td&gt;00001fca&lt;/td&gt;
&lt;td&gt;AllocTrap()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x15c&lt;/td&gt;
&lt;td&gt;00001aee&lt;/td&gt;
&lt;td&gt;0574&lt;/td&gt;
&lt;td&gt;00001ff0&lt;/td&gt;
&lt;td&gt;FreeTrap()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x162&lt;/td&gt;
&lt;td&gt;00001af0&lt;/td&gt;
&lt;td&gt;00d8&lt;/td&gt;
&lt;td&gt;00001b54&lt;/td&gt;
&lt;td&gt;AddPort()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x168&lt;/td&gt;
&lt;td&gt;00001af2&lt;/td&gt;
&lt;td&gt;00f0&lt;/td&gt;
&lt;td&gt;00001b6c&lt;/td&gt;
&lt;td&gt;RemPort()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x16e&lt;/td&gt;
&lt;td&gt;00001af4&lt;/td&gt;
&lt;td&gt;00f4&lt;/td&gt;
&lt;td&gt;00001b70&lt;/td&gt;
&lt;td&gt;PutMsg()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x174&lt;/td&gt;
&lt;td&gt;00001af6&lt;/td&gt;
&lt;td&gt;016e&lt;/td&gt;
&lt;td&gt;00001bea&lt;/td&gt;
&lt;td&gt;GetMsg()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x17a&lt;/td&gt;
&lt;td&gt;00001af8&lt;/td&gt;
&lt;td&gt;019c&lt;/td&gt;
&lt;td&gt;00001c18&lt;/td&gt;
&lt;td&gt;ReplyMsg()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x180&lt;/td&gt;
&lt;td&gt;00001afa&lt;/td&gt;
&lt;td&gt;01b6&lt;/td&gt;
&lt;td&gt;00001c32&lt;/td&gt;
&lt;td&gt;WaitPort()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x186&lt;/td&gt;
&lt;td&gt;00001afc&lt;/td&gt;
&lt;td&gt;01de&lt;/td&gt;
&lt;td&gt;00001c5a&lt;/td&gt;
&lt;td&gt;FindPort()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x18c&lt;/td&gt;
&lt;td&gt;00001afe&lt;/td&gt;
&lt;td&gt;f9cc&lt;/td&gt;
&lt;td&gt;00001448&lt;/td&gt;
&lt;td&gt;AddLibrary()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x192&lt;/td&gt;
&lt;td&gt;00001b00&lt;/td&gt;
&lt;td&gt;f9da&lt;/td&gt;
&lt;td&gt;00001456&lt;/td&gt;
&lt;td&gt;RemLibrary()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x198&lt;/td&gt;
&lt;td&gt;00001b02&lt;/td&gt;
&lt;td&gt;f9f0&lt;/td&gt;
&lt;td&gt;0000146c&lt;/td&gt;
&lt;td&gt;OldOpenLibrary()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x19e&lt;/td&gt;
&lt;td&gt;00001b04&lt;/td&gt;
&lt;td&gt;fa26&lt;/td&gt;
&lt;td&gt;000014a2&lt;/td&gt;
&lt;td&gt;CloseLibrary()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x1a4&lt;/td&gt;
&lt;td&gt;00001b06&lt;/td&gt;
&lt;td&gt;fa3a&lt;/td&gt;
&lt;td&gt;000014b6&lt;/td&gt;
&lt;td&gt;SetFunction()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x1aa&lt;/td&gt;
&lt;td&gt;00001b08&lt;/td&gt;
&lt;td&gt;fa58&lt;/td&gt;
&lt;td&gt;000014d4&lt;/td&gt;
&lt;td&gt;SumLibrary()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x1b0&lt;/td&gt;
&lt;td&gt;00001b0a&lt;/td&gt;
&lt;td&gt;ec14&lt;/td&gt;
&lt;td&gt;00000690&lt;/td&gt;
&lt;td&gt;AddDevice()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x1b6&lt;/td&gt;
&lt;td&gt;00001b0c&lt;/td&gt;
&lt;td&gt;ec22&lt;/td&gt;
&lt;td&gt;0000069e&lt;/td&gt;
&lt;td&gt;RemDevice()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x1bc&lt;/td&gt;
&lt;td&gt;00001b0e&lt;/td&gt;
&lt;td&gt;ec26&lt;/td&gt;
&lt;td&gt;000006a2&lt;/td&gt;
&lt;td&gt;OpenDevice()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x1c2&lt;/td&gt;
&lt;td&gt;00001b10&lt;/td&gt;
&lt;td&gt;ec74&lt;/td&gt;
&lt;td&gt;000006f0&lt;/td&gt;
&lt;td&gt;CloseDevice()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x1c8&lt;/td&gt;
&lt;td&gt;00001b12&lt;/td&gt;
&lt;td&gt;ec9c&lt;/td&gt;
&lt;td&gt;00000718&lt;/td&gt;
&lt;td&gt;DoIO()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x1ce&lt;/td&gt;
&lt;td&gt;00001b14&lt;/td&gt;
&lt;td&gt;ec8a&lt;/td&gt;
&lt;td&gt;00000706&lt;/td&gt;
&lt;td&gt;SendIO()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x1d4&lt;/td&gt;
&lt;td&gt;00001b16&lt;/td&gt;
&lt;td&gt;ed0e&lt;/td&gt;
&lt;td&gt;0000078a&lt;/td&gt;
&lt;td&gt;CheckIO()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x1da&lt;/td&gt;
&lt;td&gt;00001b18&lt;/td&gt;
&lt;td&gt;ecb2&lt;/td&gt;
&lt;td&gt;0000072e&lt;/td&gt;
&lt;td&gt;WaitIO()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x1e0&lt;/td&gt;
&lt;td&gt;00001b1a&lt;/td&gt;
&lt;td&gt;ed2a&lt;/td&gt;
&lt;td&gt;000007a6&lt;/td&gt;
&lt;td&gt;AbortIO()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x1e6&lt;/td&gt;
&lt;td&gt;00001b1c&lt;/td&gt;
&lt;td&gt;01e8&lt;/td&gt;
&lt;td&gt;00001c64&lt;/td&gt;
&lt;td&gt;AddResource()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x1ec&lt;/td&gt;
&lt;td&gt;00001b1e&lt;/td&gt;
&lt;td&gt;01f0&lt;/td&gt;
&lt;td&gt;00001c6c&lt;/td&gt;
&lt;td&gt;RemResource()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x1f2&lt;/td&gt;
&lt;td&gt;00001b20&lt;/td&gt;
&lt;td&gt;01f4&lt;/td&gt;
&lt;td&gt;00001c70&lt;/td&gt;
&lt;td&gt;OpenResource()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x1f8&lt;/td&gt;
&lt;td&gt;00001b22&lt;/td&gt;
&lt;td&gt;07b8&lt;/td&gt;
&lt;td&gt;00002234&lt;/td&gt;
&lt;td&gt;execPrivate7()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x1fe&lt;/td&gt;
&lt;td&gt;00001b24&lt;/td&gt;
&lt;td&gt;07c2&lt;/td&gt;
&lt;td&gt;0000223e&lt;/td&gt;
&lt;td&gt;execPrivate8()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x204&lt;/td&gt;
&lt;td&gt;00001b26&lt;/td&gt;
&lt;td&gt;07ee&lt;/td&gt;
&lt;td&gt;0000226a&lt;/td&gt;
&lt;td&gt;execPrivate9()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x20a&lt;/td&gt;
&lt;td&gt;00001b28&lt;/td&gt;
&lt;td&gt;06a8&lt;/td&gt;
&lt;td&gt;00002124&lt;/td&gt;
&lt;td&gt;RawDoFmt()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x210&lt;/td&gt;
&lt;td&gt;00001b2a&lt;/td&gt;
&lt;td&gt;f700&lt;/td&gt;
&lt;td&gt;0000117c&lt;/td&gt;
&lt;td&gt;GetCC()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x216&lt;/td&gt;
&lt;td&gt;00001b2c&lt;/td&gt;
&lt;td&gt;fdda&lt;/td&gt;
&lt;td&gt;00001856&lt;/td&gt;
&lt;td&gt;TypeOfMem()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x21c&lt;/td&gt;
&lt;td&gt;00001b2e&lt;/td&gt;
&lt;td&gt;131c&lt;/td&gt;
&lt;td&gt;00002d98&lt;/td&gt;
&lt;td&gt;Procure()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x222&lt;/td&gt;
&lt;td&gt;00001b30&lt;/td&gt;
&lt;td&gt;1332&lt;/td&gt;
&lt;td&gt;00002dae&lt;/td&gt;
&lt;td&gt;Vacate()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x228&lt;/td&gt;
&lt;td&gt;00001b32&lt;/td&gt;
&lt;td&gt;f9f8&lt;/td&gt;
&lt;td&gt;00001474&lt;/td&gt;
&lt;td&gt;OpenLibrary()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x22e&lt;/td&gt;
&lt;td&gt;00001b34&lt;/td&gt;
&lt;td&gt;1354&lt;/td&gt;
&lt;td&gt;00002dd0&lt;/td&gt;
&lt;td&gt;InitSemaphore()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x234&lt;/td&gt;
&lt;td&gt;00001b36&lt;/td&gt;
&lt;td&gt;1374&lt;/td&gt;
&lt;td&gt;00002df0&lt;/td&gt;
&lt;td&gt;ObtainSemaphore()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x23a&lt;/td&gt;
&lt;td&gt;00001b38&lt;/td&gt;
&lt;td&gt;13c4&lt;/td&gt;
&lt;td&gt;00002e40&lt;/td&gt;
&lt;td&gt;ReleaseSemaphore()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x240&lt;/td&gt;
&lt;td&gt;00001b3a&lt;/td&gt;
&lt;td&gt;1428&lt;/td&gt;
&lt;td&gt;00002ea4&lt;/td&gt;
&lt;td&gt;AttemptSemaphore()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x246&lt;/td&gt;
&lt;td&gt;00001b3c&lt;/td&gt;
&lt;td&gt;1458&lt;/td&gt;
&lt;td&gt;00002ed4&lt;/td&gt;
&lt;td&gt;ObtainSemaphoreList()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x24c&lt;/td&gt;
&lt;td&gt;00001b3e&lt;/td&gt;
&lt;td&gt;14ce&lt;/td&gt;
&lt;td&gt;00002f4a&lt;/td&gt;
&lt;td&gt;ReleaseSemaphoreList()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x252&lt;/td&gt;
&lt;td&gt;00001b40&lt;/td&gt;
&lt;td&gt;14f4&lt;/td&gt;
&lt;td&gt;00002f70&lt;/td&gt;
&lt;td&gt;FindSemaphore()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x258&lt;/td&gt;
&lt;td&gt;00001b42&lt;/td&gt;
&lt;td&gt;14e4&lt;/td&gt;
&lt;td&gt;00002f60&lt;/td&gt;
&lt;td&gt;AddSemaphore()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x25e&lt;/td&gt;
&lt;td&gt;00001b44&lt;/td&gt;
&lt;td&gt;14f0&lt;/td&gt;
&lt;td&gt;00002f6c&lt;/td&gt;
&lt;td&gt;RemSemaphore()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x264&lt;/td&gt;
&lt;td&gt;00001b46&lt;/td&gt;
&lt;td&gt;effc&lt;/td&gt;
&lt;td&gt;00000a78&lt;/td&gt;
&lt;td&gt;SumKickData()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x26a&lt;/td&gt;
&lt;td&gt;00001b48&lt;/td&gt;
&lt;td&gt;ffaa&lt;/td&gt;
&lt;td&gt;00001a26&lt;/td&gt;
&lt;td&gt;AddMemList()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x270&lt;/td&gt;
&lt;td&gt;00001b4a&lt;/td&gt;
&lt;td&gt;1504&lt;/td&gt;
&lt;td&gt;00002f80&lt;/td&gt;
&lt;td&gt;CopyMem()&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;-0x276&lt;/td&gt;
&lt;td&gt;00001b4c&lt;/td&gt;
&lt;td&gt;1500&lt;/td&gt;
&lt;td&gt;00002f7c&lt;/td&gt;
&lt;td&gt;CopyMemQuick()&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h1 id="the-memory-list-header"&gt;The memory list header&lt;a class="headerlink" href="#the-memory-list-header" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Before we dig into the code of the &lt;code&gt;AddMemList&lt;/code&gt; function to see how the memory space is added to the free memory list, let's have a look at the status of the memory list itself, as we need to be familiar with its structure to understand the rest of the process.&lt;/p&gt;
&lt;p&gt;You might recall from the &lt;a href="https://www.thedigitalcatonline.com/blog/2018/06/25/exploring-the-amiga-5/"&gt;fifth article&lt;/a&gt; that the &lt;code&gt;MemList&lt;/code&gt; structure is created &lt;code&gt;0x142&lt;/code&gt; bytes after ExecBase, and that the structure is the following&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;    &lt;span class="mh"&gt;0xe&lt;/span&gt; &lt;span class="o"&gt;+-------+&lt;/span&gt; &lt;span class="mh"&gt;0x150&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt;       &lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="mh"&gt;0xd&lt;/span&gt; &lt;span class="o"&gt;+-------+&lt;/span&gt; &lt;span class="mh"&gt;0x14f&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;LH_pad&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mh"&gt;0xa&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="mh"&gt;0xc&lt;/span&gt; &lt;span class="o"&gt;+-------+&lt;/span&gt; &lt;span class="mh"&gt;0x14e&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;LH_TYPE&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mh"&gt;0x142&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="mh"&gt;0x8&lt;/span&gt; &lt;span class="o"&gt;+-------+&lt;/span&gt; &lt;span class="mh"&gt;0x14a&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;LH_TAILPRED&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mh"&gt;0x0&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="mh"&gt;0x4&lt;/span&gt; &lt;span class="o"&gt;+-------+&lt;/span&gt; &lt;span class="mh"&gt;0x146&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;LH_TAIL&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mh"&gt;0x146&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="mh"&gt;0x0&lt;/span&gt; &lt;span class="o"&gt;+-------+&lt;/span&gt; &lt;span class="mh"&gt;0x142&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;LH_HEAD&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This means that we can access the memory list with &lt;code&gt;lea 0x142(a6),a0&lt;/code&gt;, as &lt;code&gt;0x142&lt;/code&gt; is the relative address, i.e. assuming ExecBase is 0. Once the absolute address is in one of the address registers we can access the first node through &lt;code&gt;(a0)&lt;/code&gt;, which is the Motorola Assembly version of the C pointer dereference operation (Address Register Indirect Mode). With &lt;code&gt;(a0)&lt;/code&gt; we do not use the content of &lt;code&gt;a0&lt;/code&gt;, but the content of the memory location which address is contained in &lt;code&gt;a0&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;So if &lt;code&gt;a0&lt;/code&gt; is &lt;code&gt;0x142&lt;/code&gt; in the previous figure, &lt;code&gt;(a0)&lt;/code&gt; is &lt;code&gt;0x0&lt;/code&gt; (&lt;code&gt;0x142&lt;/code&gt; contains &lt;code&gt;0x146&lt;/code&gt;, &lt;code&gt;0x146&lt;/code&gt; contains &lt;code&gt;0x0&lt;/code&gt;). It's thus convenient to think of &lt;code&gt;a0&lt;/code&gt; as the pointer, and of &lt;code&gt;(a0)&lt;/code&gt; as the value.&lt;/p&gt;
&lt;p&gt;It is also interesting to note that the structure at &lt;code&gt;0x146&lt;/code&gt; is very similar to the &lt;code&gt;LN&lt;/code&gt; structure. Recall that the latter is defined in &lt;code&gt;include_i/exec/nodes.i&lt;/code&gt; as&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt; &lt;span class="nv"&gt;STRUCTURE&lt;/span&gt;    &lt;span class="s"&gt;LN&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="s"&gt;    &lt;/span&gt;&lt;span class="c"&gt;; List Node&lt;/span&gt;
    &lt;span class="nv"&gt;APTR&lt;/span&gt;    &lt;span class="s"&gt;LN_SUCC &lt;/span&gt;&lt;span class="c"&gt;; Pointer to next (successor)&lt;/span&gt;
    &lt;span class="nv"&gt;APTR&lt;/span&gt;    &lt;span class="s"&gt;LN_PRED &lt;/span&gt;&lt;span class="c"&gt;; Pointer to previous (predecessor)&lt;/span&gt;
    &lt;span class="nv"&gt;UBYTE&lt;/span&gt;   &lt;span class="s"&gt;LN_TYPE&lt;/span&gt;
    &lt;span class="nv"&gt;BYTE&lt;/span&gt;    &lt;span class="s"&gt;LN_PRI  &lt;/span&gt;&lt;span class="c"&gt;; Priority, for sorting&lt;/span&gt;
    &lt;span class="nv"&gt;APTR&lt;/span&gt;    &lt;span class="s"&gt;LN_NAME &lt;/span&gt;&lt;span class="c"&gt;; ID string, null terminated&lt;/span&gt;
    &lt;span class="nv"&gt;LABEL&lt;/span&gt;   &lt;span class="s"&gt;LN_SIZE &lt;/span&gt;&lt;span class="c"&gt;; Note: word aligned&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and as you can see &lt;code&gt;LH_TAIL&lt;/code&gt;, &lt;code&gt;LH_TAILPRED&lt;/code&gt;, and &lt;code&gt;LH_TYPE&lt;/code&gt; can act as a proper node of a linked list. This is done on purpose (obviously), as the tail of the list has to be processed by the code that manages linked lists.&lt;/p&gt;
&lt;h1 id="adding-free-memory-to-the-system-list"&gt;Adding free memory to the system list&lt;a class="headerlink" href="#adding-free-memory-to-the-system-list" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;At the end of the &lt;a href="https://www.thedigitalcatonline.com/blog/2018/06/25/exploring-the-amiga-6/"&gt;previous post&lt;/a&gt; we left Exec just after its code prepared the parameters of the free memory that was available on the system. As we saw in that post, this operation is always executed for the chip memory, and optionally for the fast memory if the hardware expansion is installed.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;AddMemList&lt;/code&gt; function at &lt;code&gt;0x1a26&lt;/code&gt; is called with the following prototype&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;size = AddMemList(size, attributes, pri, base, name)
D0                D0    D1          D2   A0    A1
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;with the purpose of adding the given memory &lt;code&gt;size&lt;/code&gt;, starting from the &lt;code&gt;base&lt;/code&gt; address, to the system pool. The memory &lt;code&gt;attributes&lt;/code&gt; will be store in the memory block and the priority (&lt;code&gt;pri&lt;/code&gt;) will be used to find the insertion point. The name is also added to the memory node to identify it.&lt;/p&gt;
&lt;p&gt;We can split the memory addition in two different parts. &lt;code&gt;AddMemList&lt;/code&gt; will create a node that contain the parameters of the memory region, then will call &lt;code&gt;Enqueue&lt;/code&gt; to add it to the &lt;code&gt;MemList&lt;/code&gt; linked list. When Exec bootstraps the system the memory list is empty, but these functions must work in a generic case. Actually when the system has a memory expansion (fast memory), this is the first that is added to the list, but it's immediately followed by the chip memory.&lt;/p&gt;
&lt;p&gt;To help you to follow what happens in the function, this is a depiction of the memory area that we want to add to the system pool at the end of &lt;code&gt;AddMemList&lt;/code&gt;, just before the call to &lt;code&gt;Enqueue&lt;/code&gt;. The area contains a header made of three structures, &lt;code&gt;LN&lt;/code&gt; (linked list node), &lt;code&gt;MH&lt;/code&gt; (memory header), and &lt;code&gt;MC&lt;/code&gt; (memory chunk)&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;   &lt;span class="n"&gt;SIZE&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Free&lt;/span&gt; &lt;span class="n"&gt;memory&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;+---------------+&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="p"&gt;...&lt;/span&gt;           &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;+---------------+&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Free&lt;/span&gt; &lt;span class="n"&gt;memory&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
   &lt;span class="mh"&gt;0x2c&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;-+&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;MC_SIZE&lt;/span&gt;       &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
   &lt;span class="mh"&gt;0x28&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;MC_BYTES&lt;/span&gt;      &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;MC&lt;/span&gt;
   &lt;span class="mh"&gt;0x24&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;MC_NEXT&lt;/span&gt;       &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
   &lt;span class="mh"&gt;0x20&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;-+&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;MH_FREE&lt;/span&gt;       &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
   &lt;span class="mh"&gt;0x1c&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;MH_UPPER&lt;/span&gt;      &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
   &lt;span class="mh"&gt;0x18&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;MH_LOWER&lt;/span&gt;      &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;MH&lt;/span&gt;
   &lt;span class="mh"&gt;0x14&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;MH_FIRST&lt;/span&gt;      &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
   &lt;span class="mh"&gt;0x10&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;MH_ATTRIBUTES&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="mh"&gt;0xe&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;-+&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;LN_NAME&lt;/span&gt;       &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="mh"&gt;0xa&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;LN_PRI&lt;/span&gt;        &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="mh"&gt;0x9&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;LN_TYPE&lt;/span&gt;       &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;LN&lt;/span&gt;
    &lt;span class="mh"&gt;0x8&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;LN_PRED&lt;/span&gt;       &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="mh"&gt;0x4&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;LN_SUCC&lt;/span&gt;       &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="mh"&gt;0x0&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;-+&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;It is interesting to note that, since we are managing the system memory, we cannot store information about it other than in the memory itself. The presence of management structures, then, is reducing the amount of free memory. This has to taken into account when designing a memory management system, but will not be considered in this article.&lt;/p&gt;
&lt;p&gt;When we create the structure shown in figure, we need to ensure that the actual free memory is a multiple of a long word (8 bytes), as this is generally desirable. The memory space we are dealing with starts from 0 in the picture, but can actually be anywhere in the system memory, so it is not guaranteed that either the beginning or the end of the free memory space are aligned with long words.&lt;/p&gt;
&lt;p&gt;The code of &lt;code&gt;AddMemList&lt;/code&gt; performs the alignment in two steps. First it aligns the address of &lt;code&gt;MC&lt;/code&gt; to the upper nearest long word (multiple of 8), then aligns the total size to the lower nearest long word. For example, if the starting point was 0 and the total size 64 bytes, we would leave all the values untouched:&lt;code&gt;LN_SUCC&lt;/code&gt; at &lt;code&gt;0x0&lt;/code&gt;, &lt;code&gt;MC_NEXT&lt;/code&gt; at &lt;code&gt;0x20&lt;/code&gt;, and the total size of the chunk (structure 'MC' + free memory) would be 32 bytes.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;   &lt;span class="mh"&gt;0x40&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;-+&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Free&lt;/span&gt; &lt;span class="n"&gt;memory&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;+---------------+&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mi"&gt;32&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;MC&lt;/span&gt;            &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
   &lt;span class="mh"&gt;0x20&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;-+&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;MH&lt;/span&gt;            &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;+---------------+&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mi"&gt;32&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;LN&lt;/span&gt;            &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="mh"&gt;0x0&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;-+&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;If the starting point was 1 and the total size 65 bytes, however, the result would be: &lt;code&gt;LN_SUCC&lt;/code&gt; at &lt;code&gt;0x1&lt;/code&gt;, &lt;code&gt;MC_NEXT&lt;/code&gt; at &lt;code&gt;0x28&lt;/code&gt; (upper long word), and the total size of the memory would be 56 bytes (65-7 gives 58, rounded down to a multiple of 8), which means a chunk of 24 bytes&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;   &lt;span class="mh"&gt;0x42&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;-+&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Ignored&lt;/span&gt;       &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt;
   &lt;span class="mh"&gt;0x40&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;-+&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Free&lt;/span&gt; &lt;span class="n"&gt;memory&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;+---------------+&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mi"&gt;24&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;MC&lt;/span&gt;            &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
   &lt;span class="mh"&gt;0x28&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;-+&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;EMPTY&lt;/span&gt;         &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mi"&gt;7&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt;
   &lt;span class="mh"&gt;0x21&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;-+&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;MH&lt;/span&gt;            &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;+---------------+&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mi"&gt;32&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;LN&lt;/span&gt;            &lt;span class="o"&gt;|&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
    &lt;span class="mh"&gt;0x1&lt;/span&gt; &lt;span class="o"&gt;+---------------+&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;-+&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h1 id="addmemlist-internals"&gt;&lt;code&gt;AddMemList&lt;/code&gt; internals&lt;a class="headerlink" href="#addmemlist-internals" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;According to the Exec vectors table, &lt;code&gt;AddMemList&lt;/code&gt; can be found at &lt;code&gt;00001a26&lt;/code&gt;, and ends at &lt;code&gt;00001a78&lt;/code&gt;. It is immediately followed by a padding word &lt;code&gt;0000&lt;/code&gt; and the vectors table itself&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00001a26: 2149 000a&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0xa&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001a2a: 43e8 0020&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x20&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;
&lt;span class="m"&gt;00001a2e: 117c 000a 0008&lt;/span&gt;            &lt;span class="k"&gt;move.b&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0xa&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x8&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001a34: 1142 0009&lt;/span&gt;                 &lt;span class="k"&gt;move.b&lt;/span&gt;  &lt;span class="nv"&gt;d2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x9&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001a38: 3141 000e&lt;/span&gt;                 &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="nv"&gt;d1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0xe&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001a3c: 2209&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;00001a3e: 5e81&lt;/span&gt;                      &lt;span class="k"&gt;addq.l&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x7&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;00001a40: 0201 00f8&lt;/span&gt;                 &lt;span class="k"&gt;andi.b&lt;/span&gt;  &lt;span class="p"&gt;#-&lt;/span&gt;&lt;span class="mi"&gt;0x8&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;00001a44: c389&lt;/span&gt;                      &lt;span class="k"&gt;exg&lt;/span&gt;     &lt;span class="nv"&gt;d1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;
&lt;span class="m"&gt;00001a46: 9289&lt;/span&gt;                      &lt;span class="k"&gt;sub.l&lt;/span&gt;   &lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;00001a48: d081&lt;/span&gt;                      &lt;span class="k"&gt;add.l&lt;/span&gt;   &lt;span class="nv"&gt;d1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;00001a4a: 0200 00f8&lt;/span&gt;                 &lt;span class="k"&gt;andi.b&lt;/span&gt;  &lt;span class="p"&gt;#-&lt;/span&gt;&lt;span class="mi"&gt;0x8&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;00001a4e: 0480 0000 0020&lt;/span&gt;            &lt;span class="k"&gt;subi.l&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x20&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;00001a54: 2149 0010&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x10&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001a58: 2149 0014&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x14&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001a5c: 2209&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;00001a5e: d280&lt;/span&gt;                      &lt;span class="k"&gt;add.l&lt;/span&gt;   &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;00001a60: 2141 0018&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;d1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x18&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001a64: 2140 001c&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x1c&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001a68: 2340 0004&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001a6c: 4291&lt;/span&gt;                      &lt;span class="k"&gt;clr.l&lt;/span&gt;   &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001a6e: 2248&lt;/span&gt;                      &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;
&lt;span class="m"&gt;00001a70: 41ee 0142&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x142&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;00001a74: 6100 fc48&lt;/span&gt;                 &lt;span class="k"&gt;bsr.w&lt;/span&gt;   &lt;span class="mi"&gt;0x16be&lt;/span&gt;
&lt;span class="m"&gt;00001a78: 4e75&lt;/span&gt;                      &lt;span class="k"&gt;rts&lt;/span&gt;     
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Let's comment the function line by line. I will refer to the fields shown in the picture above by name, mentioning the offsets for clarity.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00001a26: 2149 000a&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0xa&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This code stores the address of the memory area name in &lt;code&gt;LN_NAME&lt;/code&gt; (&lt;code&gt;0xa(a0)&lt;/code&gt;).&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00001a2a: 43e8 0020&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x20&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This loads the absolute address of the memory chunk (structure &lt;code&gt;MC&lt;/code&gt;). The purpose of this is to align the memory chunk to a long word later in the code.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00001a2e: 117c 000a 0008&lt;/span&gt;            &lt;span class="k"&gt;move.b&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0xa&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x8&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001a34: 1142 0009&lt;/span&gt;                 &lt;span class="k"&gt;move.b&lt;/span&gt;  &lt;span class="nv"&gt;d2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x9&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001a38: 3141 000e&lt;/span&gt;                 &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="nv"&gt;d1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0xe&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This stores &lt;code&gt;0xa&lt;/code&gt; in the &lt;code&gt;LN_TYPE&lt;/code&gt; field (&lt;code&gt;0x8(a0)&lt;/code&gt;). This corresponds to &lt;code&gt;NT_MEMORY&lt;/code&gt; (see &lt;code&gt;include_i/exec/nodes.i&lt;/code&gt;). It then copies the list priority into the &lt;code&gt;LN_PRI&lt;/code&gt; field (&lt;code&gt;0x9(a0)&lt;/code&gt;), and the memory attributes in the &lt;code&gt;MH_ATTRIBUTES&lt;/code&gt; field (&lt;code&gt;0xe(a0)&lt;/code&gt;).&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00001a3c: 2209&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;00001a3e: 5e81&lt;/span&gt;                      &lt;span class="k"&gt;addq.l&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x7&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;00001a40: 0201 00f8&lt;/span&gt;                 &lt;span class="k"&gt;andi.b&lt;/span&gt;  &lt;span class="p"&gt;#-&lt;/span&gt;&lt;span class="mi"&gt;0x8&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;00001a4e: 0480 0000 0020&lt;/span&gt;            &lt;span class="k"&gt;subi.l&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x20&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;These three lines of code align the address of &lt;code&gt;MC&lt;/code&gt; (&lt;code&gt;a1&lt;/code&gt;) to a long word, adding 7 and removing the least significant 3 bits. Then the size of the headers (&lt;code&gt;0x20&lt;/code&gt;) is removed from the total size of the memory region that was passed as an argument.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00001a54: 2149 0010&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x10&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001a58: 2149 0014&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x14&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Store the first free memory location (&lt;code&gt;a1&lt;/code&gt;) in &lt;code&gt;MH_FIRST&lt;/code&gt; (&lt;code&gt;0x10(a0)&lt;/code&gt;) and in &lt;code&gt;MH_LOWER&lt;/code&gt; (&lt;code&gt;0x14(a0)&lt;/code&gt;).&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00001a5c: 2209&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;00001a5e: d280&lt;/span&gt;                      &lt;span class="k"&gt;add.l&lt;/span&gt;   &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;00001a60: 2141 0018&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;d1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x18&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001a64: 2140 001c&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x1c&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The size of the free memory is then added to the first free address and stored in &lt;code&gt;MH_UPPER&lt;/code&gt; (&lt;code&gt;0x18(a0)&lt;/code&gt;). The size of the free memory is stored in &lt;code&gt;MH_FREE&lt;/code&gt; (&lt;code&gt;0x1c(a0)&lt;/code&gt;).&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00001a68: 2340 0004&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00001a6c: 4291&lt;/span&gt;                      &lt;span class="k"&gt;clr.l&lt;/span&gt;   &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This code creates the memory chunk in the free memory area. The size of the chunk is stored in the &lt;code&gt;MC_BYTES&lt;/code&gt; field (&lt;code&gt;0x4(a1)&lt;/code&gt;), and the &lt;code&gt;MC_NEXT&lt;/code&gt; field is cleared.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00001a6e: 2248&lt;/span&gt;                      &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;
&lt;span class="m"&gt;00001a70: 41ee 0142&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x142&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;00001a74: 6100 fc48&lt;/span&gt;                 &lt;span class="k"&gt;bsr.w&lt;/span&gt;   &lt;span class="mi"&gt;0x16be&lt;/span&gt;
&lt;span class="m"&gt;00001a78: 4e75&lt;/span&gt;                      &lt;span class="k"&gt;rts&lt;/span&gt;     
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The rest of the code prepares the call to the protected version of &lt;code&gt;Enqueue&lt;/code&gt;, copying the address of the node in &lt;code&gt;a1&lt;/code&gt; , the absolute address of &lt;code&gt;MemList&lt;/code&gt; in &lt;code&gt;a0&lt;/code&gt;, and branching to the subroutine. When &lt;code&gt;Enqueue&lt;/code&gt; returns, &lt;code&gt;AddMemList&lt;/code&gt; terminates and returns as well.&lt;/p&gt;
&lt;h1 id="resources"&gt;Resources&lt;a class="headerlink" href="#resources" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;Motorola M68000 Family Programmer's Reference Manual &lt;a href="https://www.nxp.com/docs/en/reference-manual/M68000PRM.pdf"&gt;PDF here&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Amiga System Programmers Guide, Abacus (&lt;a href="https://archive.org/details/Amiga_System_Programmers_Guide_1988_Abacus"&gt;pdf here&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="feedback"&gt;Feedback&lt;a class="headerlink" href="#feedback" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Feel free to reach me on &lt;a href="https://twitter.com/thedigicat"&gt;Twitter&lt;/a&gt; if you have questions. The &lt;a href="https://github.com/TheDigitalCatOnline/thedigitalcatonline.github.com/issues"&gt;GitHub issues&lt;/a&gt; page is the best place to submit corrections.&lt;/p&gt;</content><category term="assembly"></category><category term="amiga"></category><category term="retroprogramming"></category></entry><entry><title>Clean Architectures in Python: the book</title><link href="https://www.thedigitalcatonline.com/blog/2018/12/20/cabook/" rel="alternate"></link><published>2018-12-20T08:00:00+01:00</published><updated>2019-03-15T09:30:00+00:00</updated><author><name>Leonardo Giordani</name></author><id>tag:www.thedigitalcatonline.com,2018-12-20:/blog/2018/12/20/cabook/</id><summary type="html">&lt;p&gt;A practical approach to better software design&lt;/p&gt;</summary><content type="html">&lt;p&gt;&lt;strong&gt;UPDATE&lt;/strong&gt;: a Russian translation is in the works!&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;UPDATE&lt;/strong&gt;: version 1.0.7 is out, the book reached 7,400 downloads. Thanks!&lt;/p&gt;
&lt;p&gt;I'm excited to announce that the success of &lt;a href="https://www.thedigitalcatonline.com/blog/2016/11/14/clean-architectures-in-python-a-step-by-step-example/"&gt;the post on clean architectures&lt;/a&gt; encouraged me to expand the subject and to write a book that I titled "Clean Architectures in Python. A practical approach to better software design".&lt;/p&gt;
&lt;p&gt;The book contains a complete introduction to TDD and clean architectures, two topics that I believe are strictly interconnected. The book is 170 pages long and it is complete, at least for a first edition, but I am already planning to add content that could not fit in this release for several reasons (mostly because still unclear in my mind).&lt;/p&gt;
&lt;div class="center-image"&gt;
&lt;img src="/images/cabook/cover.jpg" alt="Cover" /&gt;
&lt;/div&gt;

&lt;p&gt;The book is available for free &lt;a href="https://leanpub.com/clean-architectures-in-python"&gt;on Leanpub&lt;/a&gt;. If you enjoy it, please tweet about it with the &lt;code&gt;#pycabook&lt;/code&gt; hashtag.&lt;/p&gt;
&lt;p&gt;So far more than 7,400 readers downloaded the book. Thank you all!&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;The book will soon be translated into Russian by   (Alexey Pyltsyn), who already worked on the translation of technical books like "The Majesty of Vue.js 2" and "The Road to learn React".&lt;/p&gt;
&lt;p&gt;Alexey is a web developer and maintainer of the official PHP documentation in Russian. His website is https://lex111.ru/.&lt;/p&gt;
&lt;div class="center-image"&gt;
&lt;img src="/images/cabook/cover_ru.jpg" alt="Russian cover" /&gt;
&lt;/div&gt;

&lt;p&gt;If you are interested you can show you support &lt;a href="https://leanpub.com/clean-architectures-in-python-russian"&gt;on the Leanpub page&lt;/a&gt;&lt;/p&gt;</content><category term="OOP"></category><category term="Python"></category><category term="Python2"></category><category term="Python3"></category><category term="TDD"></category><category term="testing"></category><category term="architectures"></category></entry><entry><title>Useful pytest command line options</title><link href="https://www.thedigitalcatonline.com/blog/2018/07/05/useful-pytest-command-line-options/" rel="alternate"></link><published>2018-07-05T11:00:00+01:00</published><updated>2018-07-05T11:00:00+01:00</updated><author><name>Leonardo Giordani</name></author><id>tag:www.thedigitalcatonline.com,2018-07-05:/blog/2018/07/05/useful-pytest-command-line-options/</id><summary type="html">&lt;p&gt;A curated list of useful command line options of the Python unit testing framework pytest&lt;/p&gt;</summary><content type="html">&lt;p&gt;I recently gave a workshop on "TDD in Python with pytest", where I developed a very simple Python project together with the attendees following a TDD approach. It's a good way to introduce TDD, I think. I wrote each test together with the attendees, and then I left them the task of writing the Python code that passes the test. This way I could show TDD in action, introducing pytest features like the &lt;code&gt;pytest.raises&lt;/code&gt; context manager or the use of &lt;code&gt;assert&lt;/code&gt; while they become useful for the actual tests.&lt;/p&gt;
&lt;p&gt;This is the approach that I follow in some of my posts on TDD here on the blog, for example &lt;a href="https://www.thedigitalcatonline.com/blog/2015/05/13/python-oop-tdd-example-part1/"&gt;A simple example of Python OOP development (with TDD)&lt;/a&gt; and &lt;a href="https://www.thedigitalcatonline.com/blog/2017/05/09/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-1/"&gt;A game of tokens: write an interpreter in Python with TDD - Part 1&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Part of the workshop was dedicated to pytest command line options and in general to what pytest can do as a testing framework. Unfortunately there was no time to go through this part, so I promised some of the attendees to give them a written version of it. This post is the fulfilment of that promise.&lt;/p&gt;
&lt;p&gt;Please remember to &lt;code&gt;import pytest&lt;/code&gt; before using functions, decorators or attributes prefixed by &lt;code&gt;pytest.&lt;/code&gt;, as I will not repeat it in each example.&lt;/p&gt;
&lt;h1 id="run-single-tests"&gt;Run single tests&lt;a class="headerlink" href="#run-single-tests" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;If you want to run only a specific test you can provide its name on the pytest command line&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ pytest -svv tests/test_calc.py::test_addition
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;which for example runs the &lt;code&gt;tests_addition&lt;/code&gt; test inside the &lt;code&gt;tests/test_calc.py&lt;/code&gt; file. You can also specify the file name only to run all the tests contained there&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ pytest -svv tests/test_calc.py
&lt;/pre&gt;&lt;/div&gt;


&lt;h1 id="skipping-tests"&gt;Skipping tests&lt;a class="headerlink" href="#skipping-tests" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Sometimes it is useful to skip tests. The reason might be that some new code broke too many tests, and we want to face them one at a time, or that a specific feature had to be temporarily disabled. In all those cases the &lt;code&gt;pytest.mark.skip&lt;/code&gt; decorator is your friend. Remember that a decorator is something that changes the way the decorated function works (for the skilled reader: it's a function wrapper). Assuming we are working on a &lt;code&gt;tests/test_calc.py&lt;/code&gt; file the code might be&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nd"&gt;@pytest.mark.skip&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test_test_addition&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="o"&gt;...&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The result on the command line will be (after running &lt;code&gt;py.test -svv&lt;/code&gt;)&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;tests/test_calc.py::test_addition SKIPPED
&lt;/pre&gt;&lt;/div&gt;


&lt;h1 id="skipping-with-a-reason"&gt;Skipping with a reason&lt;a class="headerlink" href="#skipping-with-a-reason" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;The previous solution is good for a temporary skip, but if the test has to remain deactivated for a long time it's better to annotate a specific reason for the exclusion. In my experience 1 day is enough to forget small details like this, so my advice is to always put a well-written reason on skipped tests. To add it you can use the &lt;code&gt;reason&lt;/code&gt; attribute of the &lt;code&gt;skip&lt;/code&gt; decorator&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nd"&gt;@pytest.mark.skip&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;reason&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Addition has been deactivated because of issue #123&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test_test_addition&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="o"&gt;...&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Remember to add the &lt;code&gt;-rs&lt;/code&gt; option to your command line to see the &lt;code&gt;r&lt;/code&gt;eason behind &lt;code&gt;s&lt;/code&gt;kipped tests. So after running &lt;code&gt;py.test -svv -rs&lt;/code&gt; we will get something like&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;tests/test_calc.py::test_addition SKIPPED
&lt;span class="o"&gt;[&lt;/span&gt;...&lt;span class="o"&gt;]&lt;/span&gt;
&lt;span class="o"&gt;=============================&lt;/span&gt; short &lt;span class="nb"&gt;test&lt;/span&gt; summary &lt;span class="nv"&gt;info&lt;/span&gt; &lt;span class="o"&gt;=============================&lt;/span&gt;
SKIP &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; tests/test_calc.py:5: Addition has been deactivated because of issue &lt;span class="c1"&gt;#123&lt;/span&gt;

&lt;span class="o"&gt;======================&lt;/span&gt; &lt;span class="m"&gt;12&lt;/span&gt; passed, &lt;span class="m"&gt;1&lt;/span&gt; skipped in &lt;span class="m"&gt;0&lt;/span&gt;.02 &lt;span class="nv"&gt;seconds&lt;/span&gt; &lt;span class="o"&gt;=======================&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h1 id="skipping-tests-conditionally"&gt;Skipping tests conditionally&lt;a class="headerlink" href="#skipping-tests-conditionally" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Well, most of the time we will skip tests not for a stable reason, but according to some other condition that we can retrieve from the system, like the Python version, or maybe the region in which a server is running. The decorator that we need to use in that case is &lt;code&gt;skipif&lt;/code&gt;, which accepts a condition (a boolean value) and a reason&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;os&lt;/span&gt;


&lt;span class="nd"&gt;@pytest.mark.skipif&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
    &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;environ&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;AWS_REGION&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;us-west-2&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="n"&gt;reason&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Addition has been deactivated in us-west-2 because of issue #234&amp;quot;&lt;/span&gt;
&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test_addition&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="o"&gt;...&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;With this code running &lt;code&gt;AWS_REGION=eu-west-1 py.test -svv -rs&lt;/code&gt; will run the &lt;code&gt;test_addition&lt;/code&gt; test, while running &lt;code&gt;AWS_REGION=us-west-2 py.test -svv -rs&lt;/code&gt; will skip it. The environment variable &lt;code&gt;AWS_REGION&lt;/code&gt; set in the previous command lines is an example that simulates the presence of the variable in the system.&lt;/p&gt;
&lt;h1 id="run-tests-by-name"&gt;Run tests by name&lt;a class="headerlink" href="#run-tests-by-name" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;You can selectively run tests by name using &lt;code&gt;-k&lt;/code&gt;. This option accepts Python expressions that try to match the name of the test with the provided values. So&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ pytest -svv -k &lt;span class="s2"&gt;&amp;quot;test_addition&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;will run all those tests which name contains the substring &lt;code&gt;'addition'&lt;/code&gt;, like &lt;code&gt;test_addiiton&lt;/code&gt;, &lt;code&gt;test_addition_multiple_inputs&lt;/code&gt;, and &lt;code&gt;test_complex_addition&lt;/code&gt;. A more complex expression could be for example&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ pytest -svv -k &lt;span class="s2"&gt;&amp;quot;test_addition and not complex&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;which will run both &lt;code&gt;test_addition&lt;/code&gt; and &lt;code&gt;test_addition_multiple_inputs&lt;/code&gt; but not &lt;code&gt;test_complex_addition&lt;/code&gt;.&lt;/p&gt;
&lt;h1 id="tagging-tests"&gt;Tagging tests&lt;a class="headerlink" href="#tagging-tests" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Tests can be tagged or labelled using &lt;code&gt;pytest.mark&lt;/code&gt;, and the tag can be used to run or skip sets of tests. Let's say that we identify a set of very slow tests that we don't want to run continuously.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nd"&gt;@pytest.mark.slow&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test_addition&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="o"&gt;...&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;


&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test_subtraction&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="o"&gt;...&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;


&lt;span class="nd"&gt;@pytest.mark.slow&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test_multiplication&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="o"&gt;...&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;In the above example &lt;code&gt;test_addition&lt;/code&gt; and &lt;code&gt;test_multiplication&lt;/code&gt; have been decorated with &lt;code&gt;pytest.mark.slow&lt;/code&gt; which tells pytest to label them with the &lt;code&gt;slow&lt;/code&gt; identifier. At this point we can run all the tests that are tagged with the &lt;code&gt;-m&lt;/code&gt; option&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ pytest -svv -m slow
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Tests can be tagged multiple times&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nd"&gt;@pytest.mark.complex&lt;/span&gt;
&lt;span class="nd"&gt;@pytest.mark.slow&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test_addition&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="o"&gt;...&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;In this case the test will be run both by &lt;code&gt;pytest -svv -m slow&lt;/code&gt; and by &lt;code&gt;pytest -svv -m complex&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;-m&lt;/code&gt; option supports complex expressions like&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ pytest -svv -m &lt;span class="s1"&gt;&amp;#39;not slow&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;which runs all the tests that are not tagged with &lt;code&gt;slow&lt;/code&gt;, or&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ pytest -svv -m &lt;span class="s1"&gt;&amp;#39;mac or linux&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;which runs all the tests tagged with &lt;code&gt;mac&lt;/code&gt; and all the tests tagged with &lt;code&gt;linux&lt;/code&gt;. Pay attention that &lt;code&gt;-m&lt;/code&gt; expressions refer to the tags of each single test, so &lt;code&gt;slow and complex&lt;/code&gt; will run only those tests that are tagged both with &lt;code&gt;slow&lt;/code&gt; and with &lt;code&gt;complex&lt;/code&gt;, and not all the tests marked with the first and all the tests marked with the second.&lt;/p&gt;
&lt;h1 id="adding-a-command-line-option"&gt;Adding a command line option&lt;a class="headerlink" href="#adding-a-command-line-option" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;You can add custom command line options to pytest with the &lt;code&gt;pytest_addoption&lt;/code&gt; and &lt;code&gt;pytest_runtest_setup&lt;/code&gt; hooks that allows you to manage the command line parser and the setup for each test.&lt;/p&gt;
&lt;p&gt;Let's say, for example, that we want to add a &lt;code&gt;--runslow&lt;/code&gt; option that runs all the tests marked with &lt;code&gt;slow&lt;/code&gt;. First, create the file &lt;code&gt;tests/conftest.py&lt;/code&gt;, which is a file that pytest imports before running your tests, and use the &lt;code&gt;pytest_addoption&lt;/code&gt; hook&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;pytest_addoption&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;parser&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;parser&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;addoption&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;--runslow&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;action&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;store_true&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                     &lt;span class="n"&gt;help&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;run slow tests&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The command line parser configuration will be stored into the &lt;code&gt;config&lt;/code&gt; attribute of the setup of each test. Thus we can use the &lt;code&gt;pytest_runtest_setup&lt;/code&gt; hook that runs before each test&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;pytest_runtest_setup&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;slow&amp;#39;&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;keywords&lt;/span&gt; &lt;span class="ow"&gt;and&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getvalue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;runslow&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;pytest&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;skip&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;need --runslow option to run&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Here &lt;code&gt;item&lt;/code&gt; is the single test, so &lt;code&gt;item.keywords&lt;/code&gt; is the set of tags attached to the test, and &lt;code&gt;item.config&lt;/code&gt; is the configuration after the parser run on the command line. This makes the previous code match all the tests that are decorated with &lt;code&gt;@pytest.mark.slow&lt;/code&gt; and only when the &lt;code&gt;--runslow&lt;/code&gt; option has been specified on the command line. If both those conditions are satisfied the &lt;code&gt;pytest.skip&lt;/code&gt; function is run, which skips the current test adding the specified string as a reason.&lt;/p&gt;
&lt;h1 id="coverage"&gt;Coverage&lt;a class="headerlink" href="#coverage" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Coverage is a measure of the percentage of code lines are "hit" when running tests. Basically the idea is to discover if there are parts of the code that are not run during the tests, thus being untested.&lt;/p&gt;
&lt;p&gt;If you follow a strict TDD methodology your coverage will be 100% always, because the only code you will write is the one that you need to pass the tests. But please, please, please keep this in mind: not everything is easily tested and in front of some complex parts of the code you always have to ask yourself "Is it worth?".&lt;/p&gt;
&lt;p&gt;Is it worth spending 3 days to write a test for a feature? Well, if a failure in the new code means a huge financial loss for your company, yes. If you are writing a tool for yourself, and the code you are writing is not dangerous at all, maybe not. With all the shades of grey between these two black and white extreme cases.&lt;/p&gt;
&lt;p&gt;So, don't become a slave of the coverage index. A coverage of more than 90% is heaven, and being over 80% is perfectly fine. I would say that, except for specific corner cases being under 80% means that you are not really following a TDD methodology. So, maybe go and review your work flow.&lt;/p&gt;
&lt;p&gt;Anyway, pytest gives you a nice way to report the coverage using the &lt;code&gt;coverage&lt;/code&gt; program. Just install &lt;code&gt;pytest-cov&lt;/code&gt; with&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ pip install pytest-cov
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and run pytest with&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ pytest -svv --cov&lt;span class="o"&gt;=&lt;/span&gt;&amp;lt;name&amp;gt; --cov-report&lt;span class="o"&gt;=&lt;/span&gt;term
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;where &lt;code&gt;&amp;lt;name&amp;gt;&lt;/code&gt; is the name of the Python module you are testing (actually the path where the code you are testing is). This gives you a nice report with the percentage of covered code file by file.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ py.test -svv --cov&lt;span class="o"&gt;=&lt;/span&gt;mypymodule --cov-report&lt;span class="o"&gt;=&lt;/span&gt;term

----------- coverage: platform linux, python &lt;span class="m"&gt;3&lt;/span&gt;.6.5-final-0 -----------
Name                          Stmts   Miss  Cover
-------------------------------------------------
mypymodule/__init__.py       &lt;span class="m"&gt;3&lt;/span&gt;      &lt;span class="m"&gt;0&lt;/span&gt;   &lt;span class="m"&gt;100&lt;/span&gt;%
mypymodule/calc.py          &lt;span class="m"&gt;23&lt;/span&gt;      &lt;span class="m"&gt;0&lt;/span&gt;   &lt;span class="m"&gt;100&lt;/span&gt;%
-------------------------------------------------
TOTAL                            &lt;span class="m"&gt;26&lt;/span&gt;      &lt;span class="m"&gt;0&lt;/span&gt;   &lt;span class="m"&gt;100&lt;/span&gt;%
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;You may also use the &lt;code&gt;term-missing&lt;/code&gt; report instad of just &lt;code&gt;term&lt;/code&gt;, that lists the code blocks that are not covered&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ py.test -svv --cov&lt;span class="o"&gt;=&lt;/span&gt;mypymodule --cov-report&lt;span class="o"&gt;=&lt;/span&gt;term-missing

----------- coverage: platform linux, python &lt;span class="m"&gt;3&lt;/span&gt;.6.5-final-0 -----------
Name                          Stmts   Miss  Cover   Missing
-----------------------------------------------------------
mypymodule/__init__.py       &lt;span class="m"&gt;3&lt;/span&gt;      &lt;span class="m"&gt;0&lt;/span&gt;   &lt;span class="m"&gt;100&lt;/span&gt;%
mypymodule/calc.py          &lt;span class="m"&gt;23&lt;/span&gt;      &lt;span class="m"&gt;2&lt;/span&gt;    &lt;span class="m"&gt;91&lt;/span&gt;%   &lt;span class="m"&gt;6&lt;/span&gt;, &lt;span class="m"&gt;11&lt;/span&gt;
-----------------------------------------------------------
TOTAL                            &lt;span class="m"&gt;26&lt;/span&gt;      &lt;span class="m"&gt;2&lt;/span&gt;    &lt;span class="m"&gt;92&lt;/span&gt;%
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Here I commented some of the tests to force the coverage percentage to drop. As you can see the report tells us that lines 6 and 11 of the &lt;code&gt;mypymodule/calc.py&lt;/code&gt; file are not covered by any test.&lt;/p&gt;
&lt;h1 id="updates"&gt;Updates&lt;a class="headerlink" href="#updates" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;2017-12-24: pytest.org (such an honour!) spotted a misspelled &lt;code&gt;pytest.mark.skip&lt;/code&gt;. Thanks!&lt;/p&gt;
&lt;h1 id="feedback"&gt;Feedback&lt;a class="headerlink" href="#feedback" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Feel free to use &lt;a href="https://plus.google.com/u/0/111444750762335924049"&gt;the blog Google+ page&lt;/a&gt; to comment the post. Feel free to reach me on &lt;a href="https://twitter.com/thedigicat"&gt;Twitter&lt;/a&gt; if you have questions. The &lt;a href="https://github.com/TheDigitalCatOnline/thedigitalcatonline.github.com/issues"&gt;GitHub issues&lt;/a&gt; page is the best place to submit corrections.&lt;/p&gt;</content><category term="Python"></category><category term="Python2"></category><category term="Python3"></category><category term="TDD"></category><category term="testing"></category></entry><entry><title>Exploring the Amiga - Part 6</title><link href="https://www.thedigitalcatonline.com/blog/2018/06/25/exploring-the-amiga-6/" rel="alternate"></link><published>2018-06-25T13:00:00+01:00</published><updated>2019-02-12T20:00:00+00:00</updated><author><name>Leonardo Giordani</name></author><id>tag:www.thedigitalcatonline.com,2018-06-25:/blog/2018/06/25/exploring-the-amiga-6/</id><summary type="html"></summary><content type="html">&lt;h1 id="memory-initialisation"&gt;Memory initialisation&lt;a class="headerlink" href="#memory-initialisation" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;The Amiga has two types of memory. The first one is found on-board and it is traditionally referred to as "Chip Memory". This name comes from the fact that both the CPU and the custom chips have access to it, which also means that all this components have to share the access. This slows down the CPU when the custom chips are using the memory. While they can use DMA to access it without blocking the CPU, the memory cannot be accessed by multiple components at the same time.&lt;/p&gt;
&lt;p&gt;The second type of memory is called "Fast Memory" because the CPU has exclusive access to it, thus providing better performances. It is also referred to as "expansion memory" since it comes with expansion boards.&lt;/p&gt;
&lt;p&gt;At a certain point during boot time Kickstart figures out the types of memory installed in the Amiga machine and puts the expansion memory size in &lt;code&gt;a4&lt;/code&gt;. If this register contains a non-zero value, Kickstart knows that an expansion board has been installed and configures the memory accordingly.&lt;/p&gt;
&lt;p&gt;The memory initialisation code is the following&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00000380: 200c&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;00000382: 6724&lt;/span&gt;                      &lt;span class="k"&gt;beq.b&lt;/span&gt;   &lt;span class="mi"&gt;0x3a8&lt;/span&gt;
&lt;span class="m"&gt;00000384: 41ee 024c&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x24c&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;00000388: 43fa ffa8&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x332&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;pc&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;
&lt;span class="m"&gt;0000038c: 7400&lt;/span&gt;                      &lt;span class="k"&gt;moveq&lt;/span&gt;   &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d2&lt;/span&gt;
&lt;span class="m"&gt;0000038e: 323c 0005&lt;/span&gt;                 &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;00000392: 200c&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;00000394: 9088&lt;/span&gt;                      &lt;span class="k"&gt;sub.l&lt;/span&gt;   &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;00000396: 0480 0000 1800&lt;/span&gt;            &lt;span class="k"&gt;subi.l&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x1800&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;0000039c: 6100 1688&lt;/span&gt;                 &lt;span class="k"&gt;bsr.w&lt;/span&gt;   &lt;span class="mi"&gt;0x1a26&lt;/span&gt;
&lt;span class="m"&gt;000003a0: 41f8 0400&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x400&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nl"&gt;w&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;000003a4: 7000&lt;/span&gt;                      &lt;span class="k"&gt;moveq&lt;/span&gt;   &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000003a6: 600a&lt;/span&gt;                      &lt;span class="k"&gt;bra.b&lt;/span&gt;   &lt;span class="mi"&gt;0x3b2&lt;/span&gt;
&lt;span class="m"&gt;000003a8: 41ee 024c&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x24c&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;000003ac: 203c ffff e800&lt;/span&gt;            &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="p"&gt;#-&lt;/span&gt;&lt;span class="mi"&gt;0x1800&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000003b2: 323c 0003&lt;/span&gt;                 &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;000003b6: 2448&lt;/span&gt;                      &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a2&lt;/span&gt;
&lt;span class="m"&gt;000003b8: 43fa ff6c&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x326&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;pc&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;
&lt;span class="m"&gt;000003bc: 74f6&lt;/span&gt;                      &lt;span class="k"&gt;moveq&lt;/span&gt;   &lt;span class="p"&gt;#-&lt;/span&gt;&lt;span class="mi"&gt;0xa&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d2&lt;/span&gt;
&lt;span class="m"&gt;000003be: d08b&lt;/span&gt;                      &lt;span class="k"&gt;add.l&lt;/span&gt;   &lt;span class="nv"&gt;a3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000003c0: 9088&lt;/span&gt;                      &lt;span class="k"&gt;sub.l&lt;/span&gt;   &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000003c2: 6100 1662&lt;/span&gt;                 &lt;span class="k"&gt;bsr.w&lt;/span&gt;   &lt;span class="mi"&gt;0x1a26&lt;/span&gt;
&lt;span class="m"&gt;000003c6: 224e&lt;/span&gt;                      &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;
&lt;span class="m"&gt;000003c8: 6100 107e&lt;/span&gt;                 &lt;span class="k"&gt;bsr.w&lt;/span&gt;   &lt;span class="mi"&gt;0x1448&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;As I did in the previous post I will split the code in parts and replace some addresses with labels to try and make the routine more understandable&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nl"&gt;Check_expansion:&lt;/span&gt;
&lt;span class="m"&gt;00000380: 200c&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;00000382: 6724&lt;/span&gt;                      &lt;span class="k"&gt;beq.b&lt;/span&gt;   &lt;span class="nl"&gt;Only_chip&lt;/span&gt;

&lt;span class="nl"&gt;Add_expansion:&lt;/span&gt;
&lt;span class="m"&gt;00000384: 41ee 024c&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x24c&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;00000388: 43fa ffa8&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x332&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;pc&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;
&lt;span class="m"&gt;0000038c: 7400&lt;/span&gt;                      &lt;span class="k"&gt;moveq&lt;/span&gt;   &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d2&lt;/span&gt;
&lt;span class="m"&gt;0000038e: 323c 0005&lt;/span&gt;                 &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;00000392: 200c&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;00000394: 9088&lt;/span&gt;                      &lt;span class="k"&gt;sub.l&lt;/span&gt;   &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;00000396: 0480 0000 1800&lt;/span&gt;            &lt;span class="k"&gt;subi.l&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x1800&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;0000039c: 6100 1688&lt;/span&gt;                 &lt;span class="k"&gt;bsr.w&lt;/span&gt;   &lt;span class="mi"&gt;0x1a26&lt;/span&gt;
&lt;span class="m"&gt;000003a0: 41f8 0400&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x400&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nl"&gt;w&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;000003a4: 7000&lt;/span&gt;                      &lt;span class="k"&gt;moveq&lt;/span&gt;   &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000003a6: 600a&lt;/span&gt;                      &lt;span class="k"&gt;bra.b&lt;/span&gt;   &lt;span class="nl"&gt;Add_chip&lt;/span&gt;

&lt;span class="nl"&gt;Only_chip:&lt;/span&gt;
&lt;span class="m"&gt;000003a8: 41ee 024c&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x24c&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;000003ac: 203c ffff e800&lt;/span&gt;            &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="p"&gt;#-&lt;/span&gt;&lt;span class="mi"&gt;0x1800&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;

&lt;span class="nl"&gt;Add_chip:&lt;/span&gt;
&lt;span class="m"&gt;000003b2: 323c 0003&lt;/span&gt;                 &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;000003b6: 2448&lt;/span&gt;                      &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a2&lt;/span&gt;
&lt;span class="m"&gt;000003b8: 43fa ff6c&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x326&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;pc&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;
&lt;span class="m"&gt;000003bc: 74f6&lt;/span&gt;                      &lt;span class="k"&gt;moveq&lt;/span&gt;   &lt;span class="p"&gt;#-&lt;/span&gt;&lt;span class="mi"&gt;0xa&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d2&lt;/span&gt;
&lt;span class="m"&gt;000003be: d08b&lt;/span&gt;                      &lt;span class="k"&gt;add.l&lt;/span&gt;   &lt;span class="nv"&gt;a3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000003c0: 9088&lt;/span&gt;                      &lt;span class="k"&gt;sub.l&lt;/span&gt;   &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000003c2: 6100 1662&lt;/span&gt;                 &lt;span class="k"&gt;bsr.w&lt;/span&gt;   &lt;span class="mi"&gt;0x1a26&lt;/span&gt;
&lt;span class="m"&gt;000003c6: 224e&lt;/span&gt;                      &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;
&lt;span class="m"&gt;000003c8: 6100 107e&lt;/span&gt;                 &lt;span class="k"&gt;bsr.w&lt;/span&gt;   &lt;span class="mi"&gt;0x1448&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The two addresses &lt;code&gt;0x326&lt;/code&gt; and &lt;code&gt;0x332&lt;/code&gt; mentioned in the code contain the two zero-terminated strings &lt;code&gt;Chip Memory&lt;/code&gt; and &lt;code&gt;Fast Memory&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c"&gt;; ################################################################&lt;/span&gt;
&lt;span class="c"&gt;; &amp;#39;Chip Memory&amp;#39; string&lt;/span&gt;

&lt;span class="m"&gt;00000326: 43&lt;/span&gt; &lt;span class="c"&gt;; C&lt;/span&gt;
&lt;span class="m"&gt;00000327: 68&lt;/span&gt; &lt;span class="c"&gt;; h&lt;/span&gt;
&lt;span class="m"&gt;00000328: 69&lt;/span&gt; &lt;span class="c"&gt;; i&lt;/span&gt;
&lt;span class="m"&gt;00000329: 70&lt;/span&gt; &lt;span class="c"&gt;; p&lt;/span&gt;
&lt;span class="m"&gt;0000032a: 20&lt;/span&gt; &lt;span class="c"&gt;; SP&lt;/span&gt;
&lt;span class="m"&gt;0000032b: 4d&lt;/span&gt; &lt;span class="c"&gt;; M&lt;/span&gt;
&lt;span class="m"&gt;0000032c: 65&lt;/span&gt; &lt;span class="c"&gt;; e&lt;/span&gt;
&lt;span class="m"&gt;0000032d: 6d&lt;/span&gt; &lt;span class="c"&gt;; m&lt;/span&gt;
&lt;span class="m"&gt;0000032e: 6f&lt;/span&gt; &lt;span class="c"&gt;; o&lt;/span&gt;
&lt;span class="m"&gt;0000032f: 72&lt;/span&gt; &lt;span class="c"&gt;; r&lt;/span&gt;
&lt;span class="m"&gt;00000330: 79&lt;/span&gt; &lt;span class="c"&gt;; y&lt;/span&gt;
&lt;span class="m"&gt;00000331: 00&lt;/span&gt; &lt;span class="c"&gt;; NUL&lt;/span&gt;

&lt;span class="c"&gt;; ################################################################&lt;/span&gt;
&lt;span class="c"&gt;; &amp;#39;Fast Memory&amp;#39; string&lt;/span&gt;

&lt;span class="m"&gt;00000332: 46&lt;/span&gt; &lt;span class="c"&gt;; F&lt;/span&gt;
&lt;span class="m"&gt;00000333: 61&lt;/span&gt; &lt;span class="c"&gt;; a&lt;/span&gt;
&lt;span class="m"&gt;00000334: 73&lt;/span&gt; &lt;span class="c"&gt;; s&lt;/span&gt;
&lt;span class="m"&gt;00000335: 74&lt;/span&gt; &lt;span class="c"&gt;; t&lt;/span&gt;
&lt;span class="m"&gt;00000336: 20&lt;/span&gt; &lt;span class="c"&gt;; SP&lt;/span&gt;
&lt;span class="m"&gt;00000337: 4d&lt;/span&gt; &lt;span class="c"&gt;; M &lt;/span&gt;
&lt;span class="m"&gt;00000338: 65&lt;/span&gt; &lt;span class="c"&gt;; e&lt;/span&gt;
&lt;span class="m"&gt;00000339: 6d&lt;/span&gt; &lt;span class="c"&gt;; m&lt;/span&gt;
&lt;span class="m"&gt;0000033a: 6f&lt;/span&gt; &lt;span class="c"&gt;; o&lt;/span&gt;
&lt;span class="m"&gt;0000033b: 72&lt;/span&gt; &lt;span class="c"&gt;; r&lt;/span&gt;
&lt;span class="m"&gt;0000033c: 79&lt;/span&gt; &lt;span class="c"&gt;; y&lt;/span&gt;
&lt;span class="m"&gt;0000033d: 00&lt;/span&gt; &lt;span class="c"&gt;; NUL&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Let's analyse the code line by line.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nl"&gt;Check_expansion:&lt;/span&gt;
&lt;span class="m"&gt;00000380: 200c&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;00000382: 6724&lt;/span&gt;                      &lt;span class="k"&gt;beq.b&lt;/span&gt;   &lt;span class="nl"&gt;Only_chip&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The first thing that Kickstart does is to check if &lt;code&gt;a4&lt;/code&gt; contains a non-zero value, which signals that we have a memory expansion board available. If &lt;code&gt;a4&lt;/code&gt; is zero the code jumps to the part that initialises chip memory only.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nl"&gt;Add_expansion:&lt;/span&gt;
&lt;span class="m"&gt;00000384: 41ee 024c&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x24c&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;00000388: 43fa ffa8&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x332&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;pc&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The code then loads two effective addresses. The first one is the first free memory location (&lt;code&gt;0x24c&lt;/code&gt;) and the second one is the string &lt;code&gt;Fast Memory&lt;/code&gt;. The reason behind the address &lt;code&gt;0x24c&lt;/code&gt; is explained in a later section in detail.&lt;/p&gt;
&lt;p&gt;The purpose of the code is to call the &lt;code&gt;AddMemList&lt;/code&gt; routine, which adds the memory to the system free memory pool. It has the following prototype&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;size = AddMemList(size, attributes, pri, base, name)
D0                D0    D1          D2   A0    A1
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;where &lt;code&gt;size&lt;/code&gt; is the size of the memory (bytes), &lt;code&gt;attributes&lt;/code&gt; contains flags that identify memory attributes, &lt;code&gt;pri&lt;/code&gt; is the priority of the memory, &lt;code&gt;base&lt;/code&gt; is the base address of the new area and &lt;code&gt;name&lt;/code&gt; is a name for this list.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;0000038c: 7400&lt;/span&gt;                      &lt;span class="k"&gt;moveq&lt;/span&gt;   &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d2&lt;/span&gt;
&lt;span class="m"&gt;0000038e: 323c 0005&lt;/span&gt;                 &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The code then prepares the registers for the &lt;code&gt;AddMemList&lt;/code&gt; call. It gives this memory priority &lt;code&gt;0&lt;/code&gt; and sets the &lt;code&gt;attributes&lt;/code&gt; flags to &lt;code&gt;0x5&lt;/code&gt;, which is &lt;code&gt;101&lt;/code&gt;, or &lt;code&gt;PUBLIC&lt;/code&gt; and &lt;code&gt;FAST&lt;/code&gt; (see &lt;code&gt;include_i/exec/memory.i&lt;/code&gt;).&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00000392: 200c&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a4&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;00000394: 9088&lt;/span&gt;                      &lt;span class="k"&gt;sub.l&lt;/span&gt;   &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;00000396: 0480 0000 1800&lt;/span&gt;            &lt;span class="k"&gt;subi.l&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x1800&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;0000039c: 6100 1688&lt;/span&gt;                 &lt;span class="k"&gt;bsr.w&lt;/span&gt;   &lt;span class="mi"&gt;0x1a26&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The expansion memory base address is copied in &lt;code&gt;d0&lt;/code&gt; (this is actually an unneeded repetition of what the code did 6 lines before, I think). It then subtracts the address of the first free location (because if this is not 0 it means that something is already stored in memory) and the size of the stack, that was initialised previously by Kickstart to 6 KBytes (hardcoded). After that the code jumps to &lt;code&gt;AddMemList&lt;/code&gt; (&lt;code&gt;0x1a26&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;When the routine returns the code begins the initialisation of the chip memory. The chip memory has to be initialised in two different ways depending on the presence of the expansion memory, as the latter is preferably used by the CPU.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000003a0: 41f8 0400&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x400&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nl"&gt;w&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;000003a4: 7000&lt;/span&gt;                      &lt;span class="k"&gt;moveq&lt;/span&gt;   &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000003a6: 600a&lt;/span&gt;                      &lt;span class="k"&gt;bra.b&lt;/span&gt;   &lt;span class="nl"&gt;Add_chip&lt;/span&gt;

&lt;span class="nl"&gt;Only_chip:&lt;/span&gt;
&lt;span class="m"&gt;000003a8: 41ee 024c&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x24c&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;000003ac: 203c ffff e800&lt;/span&gt;            &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="p"&gt;#-&lt;/span&gt;&lt;span class="mi"&gt;0x1800&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;If the initial test on the presence of the expansion memory fails the code jumps directly to &lt;code&gt;0x03a8&lt;/code&gt;. If the expansion memory has already been initialised, instead, the CPU executes the code at &lt;code&gt;0x03a0&lt;/code&gt; and then jumps to &lt;code&gt;0x03b2&lt;/code&gt; (Renamed &lt;code&gt;Add_chip&lt;/code&gt; here).&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000003a0: 41f8 0400&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x400&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nl"&gt;w&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;So if there is expansion memory, Exec will be loaded there, which means that both it and the system stack are not in the chip memory. We can then add the whole space above &lt;code&gt;0x400&lt;/code&gt; (more on this number in a later section)&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000003a4: 7000&lt;/span&gt;                      &lt;span class="k"&gt;moveq&lt;/span&gt;   &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000003a6: 600a&lt;/span&gt;                      &lt;span class="k"&gt;bra.b&lt;/span&gt;   &lt;span class="nl"&gt;Add_chip&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Since the stack has already been created in fast memory we can store a 0 in &lt;code&gt;d0&lt;/code&gt; and jump to the code that adds the memory to the system lists&lt;/p&gt;
&lt;p&gt;If the expansion is not present, instead, Exec is installed in the chip memory, so we compute the base like we did for the fast memory.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nl"&gt;Only_chip:&lt;/span&gt;
&lt;span class="m"&gt;000003a8: 41ee 024c&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x24c&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;000003ac: 203c ffff e800&lt;/span&gt;            &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="p"&gt;#-&lt;/span&gt;&lt;span class="mi"&gt;0x1800&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Here we load the effective address of the first free location, &lt;code&gt;0x24c&lt;/code&gt; bytes after the ExecBase address, and we specify the size of the memory as 6 Kbytes less than the maximum, to keep some space for the system stack. The size is negative as later the memory size will be added to the register.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nl"&gt;Add_chip:&lt;/span&gt;
&lt;span class="m"&gt;000003b2: 323c 0003&lt;/span&gt;                 &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;000003b6: 2448&lt;/span&gt;                      &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a2&lt;/span&gt;
&lt;span class="m"&gt;000003b8: 43fa ff6c&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x326&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;pc&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;
&lt;span class="m"&gt;000003bc: 74f6&lt;/span&gt;                      &lt;span class="k"&gt;moveq&lt;/span&gt;   &lt;span class="p"&gt;#-&lt;/span&gt;&lt;span class="mi"&gt;0xa&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d2&lt;/span&gt;
&lt;span class="m"&gt;000003be: d08b&lt;/span&gt;                      &lt;span class="k"&gt;add.l&lt;/span&gt;   &lt;span class="nv"&gt;a3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000003c0: 9088&lt;/span&gt;                      &lt;span class="k"&gt;sub.l&lt;/span&gt;   &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000003c2: 6100 1662&lt;/span&gt;                 &lt;span class="k"&gt;bsr.w&lt;/span&gt;   &lt;span class="mi"&gt;0x1a26&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;After this we repeat the same procedure that was described for the fast memory. The attributes are now &lt;code&gt;CHIP&lt;/code&gt; and &lt;code&gt;PUBLIC&lt;/code&gt; (&lt;code&gt;0x3&lt;/code&gt;), the string at &lt;code&gt;0x326&lt;/code&gt; is &lt;code&gt;Chip Memory&lt;/code&gt;, and the priority is -10 (&lt;code&gt;-0xa&lt;/code&gt;). The &lt;code&gt;a3&lt;/code&gt; register already contains the end address of the chip memory, so we add it to &lt;code&gt;d0&lt;/code&gt; and then subtract the first free location computed before to get the size of the memory. As happened before, the routine calls &lt;code&gt;AddMemList&lt;/code&gt; at &lt;code&gt;0x1a26&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000003c6: 224e&lt;/span&gt;                      &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;
&lt;span class="m"&gt;000003c8: 6100 107e&lt;/span&gt;                 &lt;span class="k"&gt;bsr.w&lt;/span&gt;   &lt;span class="mi"&gt;0x1448&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The last action of this part of the code is to call &lt;code&gt;AddLibrary&lt;/code&gt; at &lt;code&gt;0x1448&lt;/code&gt;. The only parameter the routine requires is the base address of the library in &lt;code&gt;a1&lt;/code&gt;, which is why the code copies &lt;code&gt;a6&lt;/code&gt; there.&lt;/p&gt;
&lt;h1 id="the-magic-number-0x24c"&gt;The "magic number" &lt;code&gt;0x24c&lt;/code&gt;&lt;a class="headerlink" href="#the-magic-number-0x24c" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;When we discussed the way the memory is initialised we discovered a "magic number" that Kickstart uses to find the first free location in memory&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00000384: 41ee 024c&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x24c&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The first free location, according to this code is &lt;code&gt;0x24c&lt;/code&gt; (588) bytes after the Exec base address. The reason behind this number is simple. When the Exec library is installed its structures use exactly 588 bytes, thus that is the address of the first free space in memory.&lt;/p&gt;
&lt;p&gt;It's easy to calculate this number. Here you find the annotated version of the &lt;code&gt;ExecBase&lt;/code&gt; structure that I already used in the previous instalment.&lt;/p&gt;
&lt;p&gt;The structure is described in the &lt;code&gt;include_i/exec/execbase.i&lt;/code&gt; include file, and I added the displacement in bytes of each field. The first column is the displacement in the &lt;code&gt;ExecBase&lt;/code&gt; structure, while the second starts from &lt;code&gt;0x22&lt;/code&gt;. The latter comes from the fact that the structure follows an &lt;code&gt;LN&lt;/code&gt; structure and a &lt;code&gt;LIB&lt;/code&gt; structure, described in the fourth instalment of this series.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;0000&lt;/span&gt; &lt;span class="mi"&gt;0022&lt;/span&gt;&lt;span class="s"&gt;    UWORD   SoftVer&lt;/span&gt;
&lt;span class="nv"&gt;0002&lt;/span&gt; &lt;span class="mi"&gt;0024&lt;/span&gt;&lt;span class="s"&gt;    WORD    LowMemChkSum&lt;/span&gt;
&lt;span class="nv"&gt;0004&lt;/span&gt; &lt;span class="mi"&gt;0026&lt;/span&gt;&lt;span class="s"&gt;    ULONG   ChkBase&lt;/span&gt;
&lt;span class="nv"&gt;0008&lt;/span&gt; &lt;span class="mi"&gt;002a&lt;/span&gt;&lt;span class="s"&gt;    APTR    ColdCapture&lt;/span&gt;
&lt;span class="nv"&gt;000c&lt;/span&gt; &lt;span class="mi"&gt;002e&lt;/span&gt;&lt;span class="s"&gt;    APTR    CoolCapture&lt;/span&gt;
&lt;span class="nv"&gt;0010&lt;/span&gt; &lt;span class="mi"&gt;0032&lt;/span&gt;&lt;span class="s"&gt;    APTR    WarmCapture&lt;/span&gt;
&lt;span class="nv"&gt;0014&lt;/span&gt; &lt;span class="mi"&gt;0036&lt;/span&gt;&lt;span class="s"&gt;    APTR    SysStkUpper&lt;/span&gt;
&lt;span class="nv"&gt;0018&lt;/span&gt; &lt;span class="mi"&gt;003a&lt;/span&gt;&lt;span class="s"&gt;    APTR    SysStkLower&lt;/span&gt;
&lt;span class="nv"&gt;001c&lt;/span&gt; &lt;span class="mi"&gt;003e&lt;/span&gt;&lt;span class="s"&gt;    ULONG   MaxLocMem&lt;/span&gt;
&lt;span class="nv"&gt;0020&lt;/span&gt; &lt;span class="mi"&gt;0042&lt;/span&gt;&lt;span class="s"&gt;    APTR    DebugEntry&lt;/span&gt;
&lt;span class="nv"&gt;0024&lt;/span&gt; &lt;span class="mi"&gt;0046&lt;/span&gt;&lt;span class="s"&gt;    APTR    DebugData&lt;/span&gt;
&lt;span class="nv"&gt;0028&lt;/span&gt; &lt;span class="mi"&gt;004a&lt;/span&gt;&lt;span class="s"&gt;    APTR    AlertData&lt;/span&gt;
&lt;span class="nv"&gt;002c&lt;/span&gt; &lt;span class="mi"&gt;004e&lt;/span&gt;&lt;span class="s"&gt;    APTR    MaxExtMem&lt;/span&gt;

&lt;span class="nv"&gt;0030&lt;/span&gt; &lt;span class="mi"&gt;0052&lt;/span&gt;&lt;span class="s"&gt;    WORD    ChkSum&lt;/span&gt;


&lt;span class="c"&gt;******* Interrupt Related ********************************************&lt;/span&gt;

    &lt;span class="nv"&gt;LABEL&lt;/span&gt;   &lt;span class="s"&gt;IntVects&lt;/span&gt;
&lt;span class="nv"&gt;0032&lt;/span&gt; &lt;span class="mi"&gt;0054&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVTBE&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;003e&lt;/span&gt; &lt;span class="mi"&gt;0060&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVDSKBLK&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;004a&lt;/span&gt; &lt;span class="mi"&gt;006c&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVSOFTINT&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;0056&lt;/span&gt; &lt;span class="mi"&gt;0078&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVPORTS&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;0062&lt;/span&gt; &lt;span class="mi"&gt;0084&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVCOPER&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;006e&lt;/span&gt; &lt;span class="mi"&gt;0090&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVVERTB&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;007a&lt;/span&gt; &lt;span class="mi"&gt;009c&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVBLIT&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;0086&lt;/span&gt; &lt;span class="mi"&gt;00a8&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVAUD0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;0092&lt;/span&gt; &lt;span class="mi"&gt;00b4&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVAUD1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;009e&lt;/span&gt; &lt;span class="mi"&gt;00c0&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVAUD2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;00aa&lt;/span&gt; &lt;span class="mi"&gt;00cc&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVAUD3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;00b6&lt;/span&gt; &lt;span class="mi"&gt;00d8&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVRBF&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;00c2&lt;/span&gt; &lt;span class="mi"&gt;00e4&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVDSKSYNC&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;00ce&lt;/span&gt; &lt;span class="mi"&gt;00f0&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVEXTER&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;00da&lt;/span&gt; &lt;span class="mi"&gt;00fc&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVINTEN&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;00e6&lt;/span&gt; &lt;span class="mi"&gt;0108&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVNMI&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;


&lt;span class="c"&gt;******* Dynamic System Variables *************************************&lt;/span&gt;

&lt;span class="nv"&gt;00f2&lt;/span&gt; &lt;span class="mi"&gt;0114&lt;/span&gt;&lt;span class="s"&gt;    APTR    ThisTask&lt;/span&gt;

&lt;span class="nv"&gt;00f6&lt;/span&gt; &lt;span class="mi"&gt;0118&lt;/span&gt;&lt;span class="s"&gt;    ULONG   IdleCount&lt;/span&gt;
&lt;span class="nv"&gt;00fa&lt;/span&gt; &lt;span class="mi"&gt;011c&lt;/span&gt;&lt;span class="s"&gt;    ULONG   DispCount&lt;/span&gt;
&lt;span class="nv"&gt;00fe&lt;/span&gt; &lt;span class="mi"&gt;0120&lt;/span&gt;&lt;span class="s"&gt;    UWORD   Quantum&lt;/span&gt;
&lt;span class="nv"&gt;0100&lt;/span&gt; &lt;span class="mi"&gt;0122&lt;/span&gt;&lt;span class="s"&gt;    UWORD   Elapsed&lt;/span&gt;
&lt;span class="nv"&gt;0102&lt;/span&gt; &lt;span class="mi"&gt;0124&lt;/span&gt;&lt;span class="s"&gt;    UWORD   SysFlags&lt;/span&gt;
&lt;span class="nv"&gt;0104&lt;/span&gt; &lt;span class="mi"&gt;0126&lt;/span&gt;&lt;span class="s"&gt;    BYTE    IDNestCnt&lt;/span&gt;
&lt;span class="nv"&gt;0105&lt;/span&gt; &lt;span class="mi"&gt;0127&lt;/span&gt;&lt;span class="s"&gt;    BYTE    TDNestCnt&lt;/span&gt;

&lt;span class="nv"&gt;0106&lt;/span&gt; &lt;span class="mi"&gt;0128&lt;/span&gt;&lt;span class="s"&gt;    UWORD   AttnFlags&lt;/span&gt;

&lt;span class="nv"&gt;0108&lt;/span&gt; &lt;span class="mi"&gt;012a&lt;/span&gt;&lt;span class="s"&gt;    UWORD   AttnResched&lt;/span&gt;
&lt;span class="nv"&gt;010a&lt;/span&gt; &lt;span class="mi"&gt;012c&lt;/span&gt;&lt;span class="s"&gt;    APTR    ResModules&lt;/span&gt;
&lt;span class="nv"&gt;010e&lt;/span&gt; &lt;span class="mi"&gt;0130&lt;/span&gt;&lt;span class="s"&gt;    APTR    TaskTrapCode&lt;/span&gt;
&lt;span class="nv"&gt;0112&lt;/span&gt; &lt;span class="mi"&gt;0134&lt;/span&gt;&lt;span class="s"&gt;    APTR    TaskExceptCode&lt;/span&gt;
&lt;span class="nv"&gt;0116&lt;/span&gt; &lt;span class="mi"&gt;0138&lt;/span&gt;&lt;span class="s"&gt;    APTR    TaskExitCode&lt;/span&gt;
&lt;span class="nv"&gt;011a&lt;/span&gt; &lt;span class="mi"&gt;013c&lt;/span&gt;&lt;span class="s"&gt;    ULONG   TaskSigAlloc&lt;/span&gt;
&lt;span class="nv"&gt;011e&lt;/span&gt; &lt;span class="mi"&gt;0140&lt;/span&gt;&lt;span class="s"&gt;    UWORD   TaskTrapAlloc&lt;/span&gt;


&lt;span class="c"&gt;******* System List Headers (private!) ********************************&lt;/span&gt;

&lt;span class="nv"&gt;0120&lt;/span&gt; &lt;span class="mi"&gt;0142&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  MemList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;012e&lt;/span&gt; &lt;span class="mi"&gt;0150&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  ResourceList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;013c&lt;/span&gt; &lt;span class="mi"&gt;015e&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  DeviceList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;014a&lt;/span&gt; &lt;span class="mi"&gt;016c&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IntrList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;0158&lt;/span&gt; &lt;span class="mi"&gt;017a&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  LibList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;0166&lt;/span&gt; &lt;span class="mi"&gt;0188&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  PortList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;0174&lt;/span&gt; &lt;span class="mi"&gt;0196&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  TaskReady&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;0182&lt;/span&gt; &lt;span class="mi"&gt;01a4&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  TaskWait&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;0190&lt;/span&gt; &lt;span class="mi"&gt;01b2&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  SoftInts&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;SH_SIZE*5&lt;/span&gt;

&lt;span class="nv"&gt;01e0&lt;/span&gt; &lt;span class="mi"&gt;0202&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  LastAlert&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="s"&gt;*4&lt;/span&gt;

&lt;span class="nv"&gt;01f0&lt;/span&gt; &lt;span class="mi"&gt;0212&lt;/span&gt;&lt;span class="s"&gt;    UBYTE   VBlankFrequency&lt;/span&gt;
&lt;span class="nv"&gt;01f1&lt;/span&gt; &lt;span class="mi"&gt;0213&lt;/span&gt;&lt;span class="s"&gt;    UBYTE   PowerSupplyFrequency&lt;/span&gt;

&lt;span class="nv"&gt;01f2&lt;/span&gt; &lt;span class="mi"&gt;0214&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  SemaphoreList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;

&lt;span class="nv"&gt;0200&lt;/span&gt; &lt;span class="mi"&gt;0222&lt;/span&gt;&lt;span class="s"&gt;    APTR    KickMemPtr&lt;/span&gt;
&lt;span class="nv"&gt;0204&lt;/span&gt; &lt;span class="mi"&gt;0226&lt;/span&gt;&lt;span class="s"&gt;    APTR    KickTagPtr&lt;/span&gt;
&lt;span class="nv"&gt;0208&lt;/span&gt; &lt;span class="mi"&gt;022a&lt;/span&gt;&lt;span class="s"&gt;    APTR    KickCheckSum&lt;/span&gt;

&lt;span class="nv"&gt;020c&lt;/span&gt; &lt;span class="mi"&gt;022e&lt;/span&gt;&lt;span class="s"&gt;    UBYTE   ExecBaseReserved&lt;/span&gt;&lt;span class="err"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="err"&gt;]&lt;/span&gt;&lt;span class="c"&gt;;&lt;/span&gt;
&lt;span class="mi"&gt;0216&lt;/span&gt;&lt;span class="s"&gt; 0238    UBYTE   ExecBaseNewReserved&lt;/span&gt;&lt;span class="err"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;20&lt;/span&gt;&lt;span class="err"&gt;]&lt;/span&gt;&lt;span class="c"&gt;;&lt;/span&gt;
&lt;span class="mi"&gt;022a&lt;/span&gt;&lt;span class="s"&gt; 024c    LABEL   SYSBASESIZE&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The include file that I found in the Amiga Developer CD has a slightly different version of this structure that contains fields from higher versions of Exec. This structure can be found in the Amiga System Programmer's Guide, page 308. You can easily find the definitions of values like &lt;code&gt;SH_SIZE&lt;/code&gt; in the include files contained in the &lt;code&gt;include_i/exec/&lt;/code&gt; directory.&lt;/p&gt;
&lt;p&gt;As you can see the final address is &lt;code&gt;0x24c&lt;/code&gt;, which is exactly where the free memory begins (remember that &lt;code&gt;LABEL&lt;/code&gt; is a macro and not a field, so it doesn't use space).&lt;/p&gt;
&lt;h1 id="the-magic-numbers-0x676-and-0x400"&gt;The "magic numbers" &lt;code&gt;0x676&lt;/code&gt; and &lt;code&gt;0x400&lt;/code&gt;&lt;a class="headerlink" href="#the-magic-numbers-0x676-and-0x400" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;The Motorola 68000 architecture forces to reserve the first 1024 bytes (&lt;code&gt;0x400&lt;/code&gt;) for the exception vectors. The table of these vectors can be found in the Programmer's Reference Manual, page B-2, and this is the source for the magic number used when adding the chip memory to the system lists in case an expansion memory is installed.&lt;/p&gt;
&lt;p&gt;The Exec base address, however, is not &lt;code&gt;0x400&lt;/code&gt; but &lt;code&gt;0x676&lt;/code&gt;. As we already know the library is preceded by the jump table, and since Exec exports 105 functions we use &lt;code&gt;105*6 = 630&lt;/code&gt; bytes for the jump vectors. Adding these 630 bytes to the first 1024 reserved for the exception vectors gives 1654 (&lt;code&gt;0x676&lt;/code&gt;) as the base address of the library.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;        &lt;span class="o"&gt;+---------------------------------------+&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;First&lt;/span&gt; &lt;span class="n"&gt;free&lt;/span&gt; &lt;span class="n"&gt;address&lt;/span&gt;                    &lt;span class="o"&gt;|&lt;/span&gt;
   &lt;span class="mi"&gt;2242&lt;/span&gt; &lt;span class="o"&gt;+---------------------------------------+&lt;/span&gt; &lt;span class="mh"&gt;0x8c2&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;-+&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;ExecBase&lt;/span&gt; &lt;span class="n"&gt;structure&lt;/span&gt;                    &lt;span class="o"&gt;|&lt;/span&gt;         &lt;span class="o"&gt;|&lt;/span&gt;
   &lt;span class="mi"&gt;1688&lt;/span&gt; &lt;span class="o"&gt;+---------------------------------------+&lt;/span&gt; &lt;span class="mh"&gt;0x698&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;LIB&lt;/span&gt; &lt;span class="n"&gt;structure&lt;/span&gt;                         &lt;span class="o"&gt;|&lt;/span&gt;         &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Exec&lt;/span&gt; &lt;span class="n"&gt;base&lt;/span&gt;
   &lt;span class="mi"&gt;1668&lt;/span&gt; &lt;span class="o"&gt;+---------------------------------------+&lt;/span&gt; &lt;span class="mh"&gt;0x684&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;structure&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;LN&lt;/span&gt; &lt;span class="n"&gt;structure&lt;/span&gt;                          &lt;span class="o"&gt;|&lt;/span&gt;         &lt;span class="o"&gt;|&lt;/span&gt;
   &lt;span class="mi"&gt;1654&lt;/span&gt; &lt;span class="o"&gt;+---------------------------------------+&lt;/span&gt; &lt;span class="mh"&gt;0x676&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;-+&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Jump&lt;/span&gt; &lt;span class="n"&gt;vector&lt;/span&gt; &lt;span class="err"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;105&lt;/span&gt;                      &lt;span class="o"&gt;|&lt;/span&gt;         &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;+---------------------------------------+&lt;/span&gt;         &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="p"&gt;[...]&lt;/span&gt;                                 &lt;span class="o"&gt;|&lt;/span&gt;         &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;+---------------------------------------+&lt;/span&gt;         &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Exec&lt;/span&gt; &lt;span class="n"&gt;jump&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Jump&lt;/span&gt; &lt;span class="n"&gt;vector&lt;/span&gt; &lt;span class="err"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;                        &lt;span class="o"&gt;|&lt;/span&gt;         &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;vector&lt;/span&gt; &lt;span class="n"&gt;table&lt;/span&gt;
   &lt;span class="mi"&gt;1030&lt;/span&gt; &lt;span class="o"&gt;+---------------------------------------+&lt;/span&gt; &lt;span class="mh"&gt;0x406&lt;/span&gt;   &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Jump&lt;/span&gt; &lt;span class="n"&gt;vector&lt;/span&gt; &lt;span class="err"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;                        &lt;span class="o"&gt;|&lt;/span&gt;         &lt;span class="o"&gt;|&lt;/span&gt;
   &lt;span class="mi"&gt;1024&lt;/span&gt; &lt;span class="o"&gt;+---------------------------------------+&lt;/span&gt; &lt;span class="mh"&gt;0x400&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;-+&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;End&lt;/span&gt; &lt;span class="n"&gt;of&lt;/span&gt; &lt;span class="n"&gt;reserved&lt;/span&gt; &lt;span class="n"&gt;space&lt;/span&gt;                 &lt;span class="o"&gt;|&lt;/span&gt;         &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;+---------------------------------------+&lt;/span&gt;         &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="p"&gt;[...]&lt;/span&gt;                                 &lt;span class="o"&gt;|&lt;/span&gt;         &lt;span class="o"&gt;|&lt;/span&gt;
     &lt;span class="mi"&gt;12&lt;/span&gt; &lt;span class="o"&gt;+---------------------------------------+&lt;/span&gt; &lt;span class="mh"&gt;0xc&lt;/span&gt;     &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="n"&gt;Kilobyte&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Vector&lt;/span&gt; &lt;span class="err"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;                             &lt;span class="o"&gt;|&lt;/span&gt;         &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;reserved&lt;/span&gt; &lt;span class="n"&gt;by&lt;/span&gt;
      &lt;span class="mi"&gt;8&lt;/span&gt; &lt;span class="o"&gt;+---------------------------------------+&lt;/span&gt; &lt;span class="mh"&gt;0x8&lt;/span&gt;     &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;the&lt;/span&gt; &lt;span class="n"&gt;M68k&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Reset&lt;/span&gt; &lt;span class="n"&gt;Initial&lt;/span&gt; &lt;span class="n"&gt;Program&lt;/span&gt; &lt;span class="n"&gt;Counter&lt;/span&gt;         &lt;span class="o"&gt;|&lt;/span&gt;         &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;architecture&lt;/span&gt;
      &lt;span class="mi"&gt;4&lt;/span&gt; &lt;span class="o"&gt;+---------------------------------------+&lt;/span&gt; &lt;span class="mh"&gt;0x4&lt;/span&gt;     &lt;span class="o"&gt;|&lt;/span&gt;
        &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="n"&gt;Reset&lt;/span&gt; &lt;span class="n"&gt;Initial&lt;/span&gt; &lt;span class="n"&gt;Interrupt&lt;/span&gt; &lt;span class="n"&gt;Stack&lt;/span&gt; &lt;span class="n"&gt;Pointer&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;         &lt;span class="o"&gt;|&lt;/span&gt;
      &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="o"&gt;+---------------------------------------+&lt;/span&gt; &lt;span class="mh"&gt;0x0&lt;/span&gt;   &lt;span class="o"&gt;&amp;lt;-+&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h1 id="whats-next"&gt;What's next&lt;a class="headerlink" href="#whats-next" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;It's time to show the complete Exec vector table, as we are going to use and analyse all the functions defined there. I will then discuss the structure of the memory list header and its relationship with linked lists. Last I will dissect the code of &lt;code&gt;AddMemList&lt;/code&gt; and thus show in detail how the chip and expansion memory areas are added to to free memory pool.&lt;/p&gt;
&lt;h1 id="resources"&gt;Resources&lt;a class="headerlink" href="#resources" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;Microprocessor-based system design by Ricardo Gutierrez-Osuna (&lt;a href="http://courses.cs.tamu.edu/rgutier/ceg411_f01/"&gt;slides&lt;/a&gt;), in particular &lt;a href="http://courses.cs.tamu.edu/rgutier/ceg411_f01/l9.pdf"&gt;Lesson 9 - Exception processing&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Motorola M68000 Family Programmer's Reference Manual &lt;a href="https://www.nxp.com/docs/en/reference-manual/M68000PRM.pdf"&gt;PDF here&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Amiga System Programmers Guide, Abacus (&lt;a href="https://archive.org/details/Amiga_System_Programmers_Guide_1988_Abacus"&gt;pdf here&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="feedback"&gt;Feedback&lt;a class="headerlink" href="#feedback" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Feel free to reach me on &lt;a href="https://twitter.com/thedigicat"&gt;Twitter&lt;/a&gt; if you have questions. The &lt;a href="https://github.com/TheDigitalCatOnline/thedigitalcatonline.github.com/issues"&gt;GitHub issues&lt;/a&gt; page is the best place to submit corrections.&lt;/p&gt;</content><category term="assembly"></category><category term="amiga"></category><category term="retroprogramming"></category></entry><entry><title>Exploring the Amiga - Part 5</title><link href="https://www.thedigitalcatonline.com/blog/2018/06/25/exploring-the-amiga-5/" rel="alternate"></link><published>2018-06-25T12:00:00+01:00</published><updated>2019-02-12T20:00:00+00:00</updated><author><name>Leonardo Giordani</name></author><id>tag:www.thedigitalcatonline.com,2018-06-25:/blog/2018/06/25/exploring-the-amiga-5/</id><summary type="html"></summary><content type="html">&lt;p&gt;Memory management is always one of the most rich and complex parts of an architecture, mainly because the available amount of memory is always less than what you would like to have. &lt;a href="https://users.ece.cmu.edu/~koopman/titan/rules.html"&gt;Always&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;It is also an interesting topic because memory is generally managed by both the hardware and the software. The microprocessor may provide a memory management unit (MMU) that enforces a specific schema and the software has to implement its own algorithms on top of that.&lt;/p&gt;
&lt;p&gt;The Amiga originally run on a Motorola 68k, which doesn't provide any memory management in hardware. This means that there is no way for the processor to block attempts to read memory by a process, a feature that wasn't present on the first Intel x86 processors as well. Intel "solved" the issue with the introduction of the protected mode in the 386 family (even though an initial version was already present on the 286 processors). Motorola provided external MMUs for the 68010 and 68020, while the 68030 and later processor feature an on-chip MMU. &lt;/p&gt;
&lt;p&gt;The Motorola 68k is a 32-bit processor, thus registers and the address bus have that size. The memory, however, is connected to only 24 of the 32 lines of the bus, which means that the total memory space addressable by the processor is a 24-bit space, that gives 16 Megabytes instead of the possible 4 Gigabytes. That amount of memory was however enough for the period when the Amiga was designed. Consider that the most successful model of Amiga, the Amiga 500, had 500 KBytes of memory, sometimes increased to 1 Megabyte through a memory expansion.&lt;/p&gt;
&lt;p&gt;The lack of a memory scheme enforced by the processor means that at boot time the memory is just a flat area that can be addressed directly. As we saw in the previous instalments Exec creates its own structure in memory, generating the library node and creating the library jump table. This happens in the bigger picture of the machine initialisation, and one of the tasks performed during this initialisation is the setup of the memory management structures.&lt;/p&gt;
&lt;h1 id="the-exec-base-address"&gt;The Exec base address&lt;a class="headerlink" href="#the-exec-base-address" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Every Amiga programmer knows that address &lt;code&gt;0x4&lt;/code&gt; contains the Exec base address, and I showed in past instalments how this is used in conjunction with the jump table to call the library functions.&lt;/p&gt;
&lt;p&gt;The reason why the Exec base address is stored there is however seldom mentioned. As a matter of fact that address is not just a random choice.&lt;/p&gt;
&lt;p&gt;The Motorola 68000 family reserves the first Kilobyte of memory for exception vectors, that is code that will be executed when something wrong happens. "Wrong" here means bad at hardware level, from a divide by zero to a bus error. This is enforced by the Motorola 68k architecture and thus is a feature shared by other computers and consoles based on it.&lt;/p&gt;
&lt;p&gt;The first two of these vectors are actually used when the processor is powering-up (or in general when it resets). And the vector number 1 (the second) at offset &lt;code&gt;0x4&lt;/code&gt; is the Reset Initial Program Counter.&lt;/p&gt;
&lt;p&gt;After a reset the processor initialises the Program Counter with the address stored at &lt;code&gt;0x4&lt;/code&gt; in the memory. When the CPU is switched on, however, the Kickstart ROM is copied in memory, thus the addresses 0 and 4 (first two exception vectors) are the addresses listed in the ROM itself.&lt;/p&gt;
&lt;p&gt;The very first 8 bytes of the Kickstart ROM are&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00000000: 1111&lt;/span&gt;
&lt;span class="m"&gt;00000002: 4ef9 00fc 00d2&lt;/span&gt;            &lt;span class="k"&gt;jmp&lt;/span&gt;     &lt;span class="mi"&gt;0xfc00d2&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nl"&gt;l&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and you can clearly see that the long word at address &lt;code&gt;0x4&lt;/code&gt; is &lt;code&gt;00fc 00d2&lt;/code&gt;. This actually corresponds to the address where the initial code of the ROM is&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000000d2: 4ff9 0004 0000&lt;/span&gt;            &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x40000&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nl"&gt;l&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;sp&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;which sets the stack pointer, but I'll keep this analysis for a future post.&lt;/p&gt;
&lt;p&gt;The address &lt;code&gt;0x4&lt;/code&gt; is then free to be used during the normal execution, since it is used only during a reset, but in that case whatever we wrote there (the Exec base address) is overwritten by the ROM code.&lt;/p&gt;
&lt;h1 id="list-headers"&gt;List headers&lt;a class="headerlink" href="#list-headers" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Exec manages memory and resources using &lt;a href="https://en.wikipedia.org/wiki/Linked_list"&gt;linked lists&lt;/a&gt;. As you know, to manage a linked list we need the address (pointer) of the head, of the tail, and also of the second-to-last element (the tail predecessor), to allow the tail to be detached and replaced. Actually it is evident that, given the convention that the last node is connected to the address 0, the only value we need is the address of the list head. The two additional addresses, however, can greatly simplify the code that manages the list and can greatly increase the performances, avoiding the need of a complete scan of the list to find the last element every time we want to add something to the end of the list.&lt;/p&gt;
&lt;p&gt;The Exec library provides a nice structure to manage lists, &lt;code&gt;LH&lt;/code&gt;. The structure is defined in &lt;code&gt;include_i/exec/lists.i&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;   &lt;span class="nv"&gt;STRUCTURE&lt;/span&gt;    &lt;span class="s"&gt;LH&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;
    &lt;span class="nv"&gt;APTR&lt;/span&gt;    &lt;span class="s"&gt;LH_HEAD&lt;/span&gt;
    &lt;span class="nv"&gt;APTR&lt;/span&gt;    &lt;span class="s"&gt;LH_TAIL&lt;/span&gt;
    &lt;span class="nv"&gt;APTR&lt;/span&gt;    &lt;span class="s"&gt;LH_TAILPRED&lt;/span&gt;
    &lt;span class="nv"&gt;UBYTE&lt;/span&gt;   &lt;span class="s"&gt;LH_TYPE&lt;/span&gt;
    &lt;span class="nv"&gt;UBYTE&lt;/span&gt;   &lt;span class="s"&gt;LH_pad&lt;/span&gt;
    &lt;span class="nv"&gt;LABEL&lt;/span&gt;   &lt;span class="s"&gt;LH_SIZE &lt;/span&gt;&lt;span class="c"&gt;;word aligned&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The only two fields that this structure adds compared to the previous description are &lt;code&gt;LH_TYPE&lt;/code&gt;, that unsurprisingly contains the type of the data contained in the list, and &lt;code&gt;LH_pad&lt;/code&gt; which is nothing but what the name suggests, a padding that allows the structure to be word aligned.&lt;/p&gt;
&lt;p&gt;We need now to discover where Exec keeps the header for the memory list. Analysing the &lt;code&gt;ExecBase&lt;/code&gt; structure contained in &lt;code&gt;include_i/exec/execbase.i&lt;/code&gt; we find the following definitions&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c"&gt;******* System List Headers (private!) ********************************&lt;/span&gt;

    &lt;span class="nv"&gt;STRUCT&lt;/span&gt;  &lt;span class="s"&gt;MemList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
    &lt;span class="nv"&gt;STRUCT&lt;/span&gt;  &lt;span class="s"&gt;ResourceList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
    &lt;span class="nv"&gt;STRUCT&lt;/span&gt;  &lt;span class="s"&gt;DeviceList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
    &lt;span class="nv"&gt;STRUCT&lt;/span&gt;  &lt;span class="s"&gt;IntrList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
    &lt;span class="nv"&gt;STRUCT&lt;/span&gt;  &lt;span class="s"&gt;LibList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
    &lt;span class="nv"&gt;STRUCT&lt;/span&gt;  &lt;span class="s"&gt;PortList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
    &lt;span class="nv"&gt;STRUCT&lt;/span&gt;  &lt;span class="s"&gt;TaskReady&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
    &lt;span class="nv"&gt;STRUCT&lt;/span&gt;  &lt;span class="s"&gt;TaskWait&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
    &lt;span class="nv"&gt;STRUCT&lt;/span&gt;  &lt;span class="s"&gt;SoftInts&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;SH_SIZE*5&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;which is exactly what we wanted. When Exec installs itself in the first part of the memory it will also initialise these headers to keep track of the corresponding resources.&lt;/p&gt;
&lt;p&gt;It is interesting to note, however, that the ExecBase structure described in the include files is not used directly, but is more a description of what the code is going to create. This is a bit different from what higher level languages like C use to do. In C you declare a structure, you reserve memory for it, and then access its fields. In Assembly, ultimately, there is no such a concept as a structure and a field. We have only a (flat) memory and addresses.&lt;/p&gt;
&lt;p&gt;Since ExecBase is a description of the structure of Exec once it will be installed in memory it is interesting to run through its fields and annotate the relative address of each of them.&lt;/p&gt;
&lt;p&gt;I took the code contained in &lt;code&gt;include_i/exec/execbase.i&lt;/code&gt; and I computed the address of each field. The first column contains the relative address inside the structure (thus starting from &lt;code&gt;0x0&lt;/code&gt;), while the second column contains the address relative to the Exec base address. As shown in the fourth post the &lt;code&gt;LN&lt;/code&gt; and &lt;code&gt;LIB&lt;/code&gt; structures fill the first 34 bytes, which is why the following starting address is &lt;code&gt;0x22&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;0000&lt;/span&gt; &lt;span class="mi"&gt;0022&lt;/span&gt;&lt;span class="s"&gt;    UWORD   SoftVer &lt;/span&gt;&lt;span class="c"&gt;; kickstart release number (obs.)&lt;/span&gt;
&lt;span class="nv"&gt;0002&lt;/span&gt; &lt;span class="mi"&gt;0024&lt;/span&gt;&lt;span class="s"&gt;    WORD    LowMemChkSum    &lt;/span&gt;&lt;span class="c"&gt;; checksum of 68000 trap vectors&lt;/span&gt;
&lt;span class="nv"&gt;0004&lt;/span&gt; &lt;span class="mi"&gt;0026&lt;/span&gt;&lt;span class="s"&gt;    ULONG   ChkBase &lt;/span&gt;&lt;span class="c"&gt;; system base pointer complement&lt;/span&gt;
&lt;span class="nv"&gt;0008&lt;/span&gt; &lt;span class="mi"&gt;002a&lt;/span&gt;&lt;span class="s"&gt;    APTR    ColdCapture &lt;/span&gt;&lt;span class="c"&gt;; coldstart soft capture vector&lt;/span&gt;
&lt;span class="nv"&gt;000c&lt;/span&gt; &lt;span class="mi"&gt;002e&lt;/span&gt;&lt;span class="s"&gt;    APTR    CoolCapture &lt;/span&gt;&lt;span class="c"&gt;; coolstart soft capture vector&lt;/span&gt;
&lt;span class="nv"&gt;0010&lt;/span&gt; &lt;span class="mi"&gt;0032&lt;/span&gt;&lt;span class="s"&gt;    APTR    WarmCapture &lt;/span&gt;&lt;span class="c"&gt;; warmstart soft capture vector&lt;/span&gt;
&lt;span class="nv"&gt;0014&lt;/span&gt; &lt;span class="mi"&gt;0036&lt;/span&gt;&lt;span class="s"&gt;    APTR    SysStkUpper &lt;/span&gt;&lt;span class="c"&gt;; system stack base   (upper bound)&lt;/span&gt;
&lt;span class="nv"&gt;0018&lt;/span&gt; &lt;span class="mi"&gt;003a&lt;/span&gt;&lt;span class="s"&gt;    APTR    SysStkLower &lt;/span&gt;&lt;span class="c"&gt;; top of system stack (lower bound)&lt;/span&gt;
&lt;span class="nv"&gt;001c&lt;/span&gt; &lt;span class="mi"&gt;003e&lt;/span&gt;&lt;span class="s"&gt;    ULONG   MaxLocMem   &lt;/span&gt;&lt;span class="c"&gt;; top of chip memory&lt;/span&gt;
&lt;span class="nv"&gt;0020&lt;/span&gt; &lt;span class="mi"&gt;0042&lt;/span&gt;&lt;span class="s"&gt;    APTR    DebugEntry  &lt;/span&gt;&lt;span class="c"&gt;; global debugger entry point&lt;/span&gt;
&lt;span class="nv"&gt;0024&lt;/span&gt; &lt;span class="mi"&gt;0046&lt;/span&gt;&lt;span class="s"&gt;    APTR    DebugData   &lt;/span&gt;&lt;span class="c"&gt;; global debugger data segment&lt;/span&gt;
&lt;span class="nv"&gt;0028&lt;/span&gt; &lt;span class="mi"&gt;004a&lt;/span&gt;&lt;span class="s"&gt;    APTR    AlertData   &lt;/span&gt;&lt;span class="c"&gt;; alert data segment&lt;/span&gt;
&lt;span class="nv"&gt;002c&lt;/span&gt; &lt;span class="mi"&gt;004e&lt;/span&gt;&lt;span class="s"&gt;    APTR    MaxExtMem   &lt;/span&gt;&lt;span class="c"&gt;; top of extended mem, or null if none&lt;/span&gt;

&lt;span class="nv"&gt;0030&lt;/span&gt; &lt;span class="mi"&gt;0052&lt;/span&gt;&lt;span class="s"&gt;    WORD    ChkSum      &lt;/span&gt;&lt;span class="c"&gt;; for all of the above (minus 2)&lt;/span&gt;


&lt;span class="c"&gt;******* Interrupt Related ********************************************&lt;/span&gt;

    &lt;span class="nv"&gt;LABEL&lt;/span&gt;   &lt;span class="s"&gt;IntVects&lt;/span&gt;
&lt;span class="nv"&gt;0032&lt;/span&gt; &lt;span class="mi"&gt;0054&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVTBE&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;003e&lt;/span&gt; &lt;span class="mi"&gt;0060&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVDSKBLK&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;004a&lt;/span&gt; &lt;span class="mi"&gt;006c&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVSOFTINT&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;0056&lt;/span&gt; &lt;span class="mi"&gt;0078&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVPORTS&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;0062&lt;/span&gt; &lt;span class="mi"&gt;0084&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVCOPER&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;006e&lt;/span&gt; &lt;span class="mi"&gt;0090&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVVERTB&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;007a&lt;/span&gt; &lt;span class="mi"&gt;009c&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVBLIT&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;0086&lt;/span&gt; &lt;span class="mi"&gt;00a8&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVAUD0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;0092&lt;/span&gt; &lt;span class="mi"&gt;00b4&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVAUD1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;009e&lt;/span&gt; &lt;span class="mi"&gt;00c0&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVAUD2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;00aa&lt;/span&gt; &lt;span class="mi"&gt;00cc&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVAUD3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;00b6&lt;/span&gt; &lt;span class="mi"&gt;00d8&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVRBF&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;00c2&lt;/span&gt; &lt;span class="mi"&gt;00e4&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVDSKSYNC&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;00ce&lt;/span&gt; &lt;span class="mi"&gt;00f0&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVEXTER&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;00da&lt;/span&gt; &lt;span class="mi"&gt;00fc&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVINTEN&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;00e6&lt;/span&gt; &lt;span class="mi"&gt;0108&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IVNMI&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;IV_SIZE&lt;/span&gt;


&lt;span class="c"&gt;******* Dynamic System Variables *************************************&lt;/span&gt;

&lt;span class="nv"&gt;00f2&lt;/span&gt; &lt;span class="mi"&gt;0114&lt;/span&gt;&lt;span class="s"&gt;    APTR    ThisTask    &lt;/span&gt;&lt;span class="c"&gt;; pointer to current task (readable)&lt;/span&gt;

&lt;span class="nv"&gt;00f6&lt;/span&gt; &lt;span class="mi"&gt;0118&lt;/span&gt;&lt;span class="s"&gt;    ULONG   IdleCount   &lt;/span&gt;&lt;span class="c"&gt;; idle counter&lt;/span&gt;
&lt;span class="nv"&gt;00fa&lt;/span&gt; &lt;span class="mi"&gt;011c&lt;/span&gt;&lt;span class="s"&gt;    ULONG   DispCount   &lt;/span&gt;&lt;span class="c"&gt;; dispatch counter&lt;/span&gt;
&lt;span class="nv"&gt;00fe&lt;/span&gt; &lt;span class="mi"&gt;0120&lt;/span&gt;&lt;span class="s"&gt;    UWORD   Quantum &lt;/span&gt;&lt;span class="c"&gt;; time slice quantum&lt;/span&gt;
&lt;span class="nv"&gt;0100&lt;/span&gt; &lt;span class="mi"&gt;0122&lt;/span&gt;&lt;span class="s"&gt;    UWORD   Elapsed &lt;/span&gt;&lt;span class="c"&gt;; current quantum ticks&lt;/span&gt;
&lt;span class="nv"&gt;0102&lt;/span&gt; &lt;span class="mi"&gt;0124&lt;/span&gt;&lt;span class="s"&gt;    UWORD   SysFlags    &lt;/span&gt;&lt;span class="c"&gt;; misc internal system flags&lt;/span&gt;
&lt;span class="nv"&gt;0104&lt;/span&gt; &lt;span class="mi"&gt;0126&lt;/span&gt;&lt;span class="s"&gt;    BYTE    IDNestCnt   &lt;/span&gt;&lt;span class="c"&gt;; interrupt disable nesting count&lt;/span&gt;
&lt;span class="nv"&gt;0105&lt;/span&gt; &lt;span class="mi"&gt;0127&lt;/span&gt;&lt;span class="s"&gt;    BYTE    TDNestCnt   &lt;/span&gt;&lt;span class="c"&gt;; task disable nesting count&lt;/span&gt;

&lt;span class="nv"&gt;0106&lt;/span&gt; &lt;span class="mi"&gt;0128&lt;/span&gt;&lt;span class="s"&gt;    UWORD   AttnFlags   &lt;/span&gt;&lt;span class="c"&gt;; special attention flags (readable)&lt;/span&gt;

&lt;span class="nv"&gt;0108&lt;/span&gt; &lt;span class="mi"&gt;012a&lt;/span&gt;&lt;span class="s"&gt;    UWORD   AttnResched &lt;/span&gt;&lt;span class="c"&gt;; rescheduling attention&lt;/span&gt;
&lt;span class="nv"&gt;010a&lt;/span&gt; &lt;span class="mi"&gt;012c&lt;/span&gt;&lt;span class="s"&gt;    APTR    ResModules  &lt;/span&gt;&lt;span class="c"&gt;; pointer to resident module array&lt;/span&gt;
&lt;span class="nv"&gt;010e&lt;/span&gt; &lt;span class="mi"&gt;0130&lt;/span&gt;&lt;span class="s"&gt;    APTR    TaskTrapCode    &lt;/span&gt;&lt;span class="c"&gt;; default task trap routine&lt;/span&gt;
&lt;span class="nv"&gt;0112&lt;/span&gt; &lt;span class="mi"&gt;0134&lt;/span&gt;&lt;span class="s"&gt;    APTR    TaskExceptCode  &lt;/span&gt;&lt;span class="c"&gt;; default task exception code&lt;/span&gt;
&lt;span class="nv"&gt;0116&lt;/span&gt; &lt;span class="mi"&gt;0138&lt;/span&gt;&lt;span class="s"&gt;    APTR    TaskExitCode    &lt;/span&gt;&lt;span class="c"&gt;; default task exit code&lt;/span&gt;
&lt;span class="nv"&gt;011a&lt;/span&gt; &lt;span class="mi"&gt;013c&lt;/span&gt;&lt;span class="s"&gt;    ULONG   TaskSigAlloc    &lt;/span&gt;&lt;span class="c"&gt;; preallocated signal mask&lt;/span&gt;
&lt;span class="nv"&gt;011e&lt;/span&gt; &lt;span class="mi"&gt;0140&lt;/span&gt;&lt;span class="s"&gt;    UWORD   TaskTrapAlloc   &lt;/span&gt;&lt;span class="c"&gt;; preallocated trap mask&lt;/span&gt;


&lt;span class="c"&gt;******* System List Headers (private!) ********************************&lt;/span&gt;

&lt;span class="nv"&gt;0120&lt;/span&gt; &lt;span class="mi"&gt;0142&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  MemList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;012e&lt;/span&gt; &lt;span class="mi"&gt;0150&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  ResourceList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;013c&lt;/span&gt; &lt;span class="mi"&gt;015e&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  DeviceList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;014a&lt;/span&gt; &lt;span class="mi"&gt;016c&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  IntrList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;0158&lt;/span&gt; &lt;span class="mi"&gt;017a&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  LibList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;0166&lt;/span&gt; &lt;span class="mi"&gt;0188&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  PortList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;0174&lt;/span&gt; &lt;span class="mi"&gt;0196&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  TaskReady&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;0182&lt;/span&gt; &lt;span class="mi"&gt;01a4&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  TaskWait&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;
&lt;span class="nv"&gt;0190&lt;/span&gt; &lt;span class="mi"&gt;01b2&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  SoftInts&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;SH_SIZE*5&lt;/span&gt;

&lt;span class="nv"&gt;01e0&lt;/span&gt; &lt;span class="mi"&gt;0202&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  LastAlert&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="s"&gt;*4&lt;/span&gt;

&lt;span class="nv"&gt;01f0&lt;/span&gt; &lt;span class="mi"&gt;0212&lt;/span&gt;&lt;span class="s"&gt;    UBYTE   VBlankFrequency     &lt;/span&gt;&lt;span class="c"&gt;;(readable)&lt;/span&gt;
&lt;span class="nv"&gt;01f1&lt;/span&gt; &lt;span class="mi"&gt;0213&lt;/span&gt;&lt;span class="s"&gt;    UBYTE   PowerSupplyFrequency    &lt;/span&gt;&lt;span class="c"&gt;;(readable)&lt;/span&gt;

&lt;span class="nv"&gt;01f2&lt;/span&gt; &lt;span class="mi"&gt;0214&lt;/span&gt;&lt;span class="s"&gt;    STRUCT  SemaphoreList&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LH_SIZE&lt;/span&gt;

&lt;span class="nv"&gt;0200&lt;/span&gt; &lt;span class="mi"&gt;0222&lt;/span&gt;&lt;span class="s"&gt;    APTR    KickMemPtr  &lt;/span&gt;&lt;span class="c"&gt;; ptr to queue of mem lists&lt;/span&gt;
&lt;span class="nv"&gt;0204&lt;/span&gt; &lt;span class="mi"&gt;0226&lt;/span&gt;&lt;span class="s"&gt;    APTR    KickTagPtr  &lt;/span&gt;&lt;span class="c"&gt;; ptr to rom tag queue&lt;/span&gt;
&lt;span class="nv"&gt;0208&lt;/span&gt; &lt;span class="mi"&gt;022a&lt;/span&gt;&lt;span class="s"&gt;    APTR    KickCheckSum    &lt;/span&gt;&lt;span class="c"&gt;; checksum for mem and tags&lt;/span&gt;

&lt;span class="nv"&gt;020c&lt;/span&gt; &lt;span class="mi"&gt;022e&lt;/span&gt;&lt;span class="s"&gt;    UBYTE ExecBaseReserved&lt;/span&gt;&lt;span class="err"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="err"&gt;]&lt;/span&gt;&lt;span class="c"&gt;;&lt;/span&gt;
&lt;span class="mi"&gt;0216&lt;/span&gt;&lt;span class="s"&gt; 0238    UBYTE ExecBaseNewReserved&lt;/span&gt;&lt;span class="err"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;20&lt;/span&gt;&lt;span class="err"&gt;]&lt;/span&gt;&lt;span class="c"&gt;;&lt;/span&gt;
&lt;span class="mi"&gt;022a&lt;/span&gt;&lt;span class="s"&gt; 024c    LABEL   SYSBASESIZE&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;According to this structure we expect to find the memory list header 322 bytes (&lt;code&gt;0x142&lt;/code&gt;) after the base address, which means that this number should be mentioned somewhere in the Kickstart code.&lt;/p&gt;
&lt;p&gt;It is not surprise indeed that the function &lt;code&gt;AllocMem&lt;/code&gt; mentions it. This function is part of the Exec API that we explored in the third and fourth instalments. Following the same method described there I found the function at the address &lt;code&gt;0x17d0&lt;/code&gt; in the Kickstart code&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c"&gt;; memoryBlock = AllocMem(byteSize, attributes)&lt;/span&gt;
&lt;span class="c"&gt;; d0                     d0        d1&lt;/span&gt;

&lt;span class="m"&gt;000017d0: 522e 0127&lt;/span&gt;                 &lt;span class="k"&gt;addq.b&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x127&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000017d4: 48e7 3020&lt;/span&gt;                 &lt;span class="k"&gt;movem.l&lt;/span&gt; &lt;span class="nv"&gt;d2&lt;/span&gt;&lt;span class="p"&gt;-&lt;/span&gt;&lt;span class="nv"&gt;d3&lt;/span&gt;&lt;span class="p"&gt;/&lt;/span&gt;&lt;span class="nv"&gt;a2&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;sp&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000017d8: 2600&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d3&lt;/span&gt;
&lt;span class="m"&gt;000017da: 2401&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;d1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d2&lt;/span&gt;
&lt;span class="m"&gt;000017dc: 45ee 0142&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x142&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a2&lt;/span&gt;
&lt;span class="m"&gt;000017e0: 2452&lt;/span&gt;                      &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a2&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a2&lt;/span&gt;&lt;span class="c"&gt;&lt;/span&gt;
&lt;span class="c"&gt;; ...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and in this initial part of the function we can clearly see the code that loads the effective address of &lt;code&gt;0x142(a6)&lt;/code&gt;. Remember that &lt;code&gt;a6&lt;/code&gt; is always supposed to contain the Exec base address.&lt;/p&gt;
&lt;p&gt;The displacement &lt;code&gt;0x142&lt;/code&gt; is also mentioned in a table towards the beginning of the code, and this is the part we are really interested in at the moment&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c"&gt;; Initialise list headers&lt;/span&gt;

&lt;span class="m"&gt;000002b0: 43fa 0020&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x2d2&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;pc&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;
&lt;span class="m"&gt;000002b4: 3019&lt;/span&gt;                      &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)+,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000002b6: 6700 0086&lt;/span&gt;                 &lt;span class="k"&gt;beq.w&lt;/span&gt;   &lt;span class="mi"&gt;0x33e&lt;/span&gt;
&lt;span class="m"&gt;000002ba: 41f6 0000&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nl"&gt;w&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;000002be: 2088&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000002c0: 5890&lt;/span&gt;                      &lt;span class="k"&gt;addq.l&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000002c2: 42a8 0004&lt;/span&gt;                 &lt;span class="k"&gt;clr.l&lt;/span&gt;   &lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000002c6: 2148 0008&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x8&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000002ca: 3019&lt;/span&gt;                      &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)+,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000002cc: 1140 000c&lt;/span&gt;                 &lt;span class="k"&gt;move.b&lt;/span&gt;  &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0xc&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000002d0: 60e2&lt;/span&gt;                      &lt;span class="k"&gt;bra.b&lt;/span&gt;   &lt;span class="mi"&gt;0x2b4&lt;/span&gt;&lt;span class="c"&gt;&lt;/span&gt;

&lt;span class="c"&gt;; List headers&lt;/span&gt;

&lt;span class="m"&gt;000002d2: 0142 000a&lt;/span&gt;
&lt;span class="m"&gt;000002d6: 0150 0008&lt;/span&gt;
&lt;span class="m"&gt;000002da: 015e 0003&lt;/span&gt;
&lt;span class="m"&gt;000002de: 017a 0009&lt;/span&gt;
&lt;span class="m"&gt;000002e2: 0188 0004&lt;/span&gt;
&lt;span class="m"&gt;000002e6: 0196 0001&lt;/span&gt;
&lt;span class="m"&gt;000002ea: 01a4 0001&lt;/span&gt;
&lt;span class="m"&gt;000002ee: 016c 0002&lt;/span&gt;
&lt;span class="m"&gt;000002f2: 01b2 000b&lt;/span&gt;
&lt;span class="m"&gt;000002f6: 01c2 000b&lt;/span&gt;
&lt;span class="m"&gt;000002fa: 01d2 000b&lt;/span&gt;
&lt;span class="m"&gt;000002fe: 01e2 000b&lt;/span&gt;
&lt;span class="m"&gt;00000302: 01f2 000b&lt;/span&gt;
&lt;span class="m"&gt;00000306: 0214 000f&lt;/span&gt;
&lt;span class="m"&gt;0000030a: 0000&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;As you can see I formatted the code to show that the values after &lt;code&gt;02d2&lt;/code&gt; are data and not code. The disassembler will obviously show you some instructions but they are just misinterpretations of the binary data. AS it is usual in the Kickstart code, we have some procedure working on a set of data and the data is stored immediately after the code itself. The purpose of this procedure is that of creating the initial headers for the linked lists that Exec will use to manage the system resources.&lt;/p&gt;
&lt;p&gt;This table is immediately followed by the table we found in the &lt;a href="https://www.thedigitalcatonline.com/blog/2018/06/08/exploring-the-amiga-3/"&gt;third post&lt;/a&gt; of this series, when we were looking at the values of the &lt;code&gt;LIB&lt;/code&gt; structure.&lt;/p&gt;
&lt;p&gt;Let's comment line by line the code at &lt;code&gt;02b0&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c"&gt;; Initialise list headers&lt;/span&gt;

&lt;span class="m"&gt;000002b0: 43fa 0020&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x2d2&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;pc&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;
&lt;span class="m"&gt;000002b4: 3019&lt;/span&gt;                      &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)+,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000002b6: 6700 0086&lt;/span&gt;                 &lt;span class="k"&gt;beq.w&lt;/span&gt;   &lt;span class="mi"&gt;0x33e&lt;/span&gt;
&lt;span class="m"&gt;000002ba: 41f6 0000&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nl"&gt;w&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;span class="m"&gt;000002be: 2088&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000002c0: 5890&lt;/span&gt;                      &lt;span class="k"&gt;addq.l&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000002c2: 42a8 0004&lt;/span&gt;                 &lt;span class="k"&gt;clr.l&lt;/span&gt;   &lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000002c6: 2148 0008&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x8&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000002ca: 3019&lt;/span&gt;                      &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)+,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000002cc: 1140 000c&lt;/span&gt;                 &lt;span class="k"&gt;move.b&lt;/span&gt;  &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0xc&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000002d0: 60e2&lt;/span&gt;                      &lt;span class="k"&gt;bra.b&lt;/span&gt;   &lt;span class="mi"&gt;0x2b4&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000002b0: 43fa 0020&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="mi"&gt;0x2d2&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;pc&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;First of all the code loads the absolute address of &lt;code&gt;0x2d2(pc)&lt;/code&gt; in the &lt;code&gt;a1&lt;/code&gt; register. This is exactly the beginning of the table, as shown above.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000002b4: 3019&lt;/span&gt;                      &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)+,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000002b6: 6700 0086&lt;/span&gt;                 &lt;span class="k"&gt;beq.w&lt;/span&gt;   &lt;span class="mi"&gt;0x33e&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The code then loads the first value of the table (&lt;code&gt;0142&lt;/code&gt;) in &lt;code&gt;d0&lt;/code&gt; and increments &lt;code&gt;a1&lt;/code&gt;. This suggests that we are looking at a loop. The following instruction is indeed a comparison that jumps to &lt;code&gt;0x33e&lt;/code&gt; is the value is &lt;code&gt;0&lt;/code&gt;. You can easily see above that the table is terminated by a &lt;code&gt;0000&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000002ba: 41f6 0000&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nl"&gt;w&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The register &lt;code&gt;a0&lt;/code&gt; is then loaded with the effective address of Exec + &lt;code&gt;d0&lt;/code&gt;. This means that we use the value we just read from the table as a pointer. For the first value, then, we are looking at &lt;code&gt;0x142&lt;/code&gt; bytes after the beginning of the Exec library, exactly where we expected to find the Memory List header.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000002be: 2088&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000002c0: 5890&lt;/span&gt;                      &lt;span class="k"&gt;addq.l&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;,(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;An empty linked list has the head pointing to the tail and the tail pointing to zero. To do this we set the content of that address &lt;code&gt;(a0)&lt;/code&gt; to the address itself (&lt;code&gt;a0&lt;/code&gt;), then we increment it by 4 making it point to the tail.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000002c2: 42a8 0004&lt;/span&gt;                 &lt;span class="k"&gt;clr.l&lt;/span&gt;   &lt;span class="mi"&gt;0x4&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000002c6: 2148 0008&lt;/span&gt;                 &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x8&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The tail itself is then cleared and the tail predecessor is set to be the head.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000002ca: 3019&lt;/span&gt;                      &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)+,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000002cc: 1140 000c&lt;/span&gt;                 &lt;span class="k"&gt;move.b&lt;/span&gt;  &lt;span class="nv"&gt;d0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0xc&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The code then fetches the next word from the table (&lt;code&gt;000a&lt;/code&gt;) and puts it into a field 12 bytes (&lt;code&gt;0xc&lt;/code&gt;) from the beginning of the structure, that is &lt;code&gt;LH_TYPE&lt;/code&gt;. The possible values of this byte can be found in &lt;code&gt;include_i/exec/nodes.i&lt;/code&gt;, where we find that the value &lt;code&gt;0xa&lt;/code&gt; corresponds to &lt;code&gt;NT_MEMORY&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c"&gt;;------ Node Types for LN_TYPE&lt;/span&gt;

&lt;span class="nv"&gt;NT_UNKNOWN&lt;/span&gt;      &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
&lt;span class="nv"&gt;NT_TASK&lt;/span&gt;         &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="s"&gt;   &lt;/span&gt;&lt;span class="c"&gt;; Exec task&lt;/span&gt;
&lt;span class="nv"&gt;NT_INTERRUPT&lt;/span&gt;    &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;
&lt;span class="nv"&gt;NT_DEVICE&lt;/span&gt;       &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;3&lt;/span&gt;
&lt;span class="nv"&gt;NT_MSGPORT&lt;/span&gt;      &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;4&lt;/span&gt;
&lt;span class="nv"&gt;NT_MESSAGE&lt;/span&gt;      &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="s"&gt;   &lt;/span&gt;&lt;span class="c"&gt;; Indicates message currently pending&lt;/span&gt;
&lt;span class="nv"&gt;NT_FREEMSG&lt;/span&gt;      &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;6&lt;/span&gt;
&lt;span class="nv"&gt;NT_REPLYMSG&lt;/span&gt;     &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;7&lt;/span&gt;&lt;span class="s"&gt;   &lt;/span&gt;&lt;span class="c"&gt;; Message has been replied&lt;/span&gt;
&lt;span class="nv"&gt;NT_RESOURCE&lt;/span&gt;     &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;8&lt;/span&gt;
&lt;span class="nv"&gt;NT_LIBRARY&lt;/span&gt;      &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;9&lt;/span&gt;
&lt;span class="nv"&gt;NT_MEMORY&lt;/span&gt;       &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;10&lt;/span&gt;
&lt;span class="nv"&gt;NT_SOFTINT&lt;/span&gt;      &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;11&lt;/span&gt;&lt;span class="s"&gt;  &lt;/span&gt;&lt;span class="c"&gt;; Internal flag used by SoftInts&lt;/span&gt;
&lt;span class="nv"&gt;NT_FONT&lt;/span&gt;         &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;12&lt;/span&gt;
&lt;span class="nv"&gt;NT_PROCESS&lt;/span&gt;      &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;13&lt;/span&gt;&lt;span class="s"&gt;  &lt;/span&gt;&lt;span class="c"&gt;; AmigaDOS Process&lt;/span&gt;
&lt;span class="nv"&gt;NT_SEMAPHORE&lt;/span&gt;    &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;14&lt;/span&gt;
&lt;span class="nv"&gt;NT_SIGNALSEM&lt;/span&gt;    &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;15&lt;/span&gt;&lt;span class="s"&gt;  &lt;/span&gt;&lt;span class="c"&gt;; signal semaphores&lt;/span&gt;
&lt;span class="nv"&gt;NT_BOOTNODE&lt;/span&gt;     &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;16&lt;/span&gt;
&lt;span class="nv"&gt;NT_KICKMEM&lt;/span&gt;      &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;17&lt;/span&gt;
&lt;span class="nv"&gt;NT_GRAPHICS&lt;/span&gt;     &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;18&lt;/span&gt;
&lt;span class="nv"&gt;NT_DEATHMESSAGE&lt;/span&gt; &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;19&lt;/span&gt;

&lt;span class="nv"&gt;NT_USER&lt;/span&gt;         &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;254&lt;/span&gt;&lt;span class="s"&gt; &lt;/span&gt;&lt;span class="c"&gt;; User node types work down from here&lt;/span&gt;
&lt;span class="nv"&gt;NT_EXTENDED&lt;/span&gt;     &lt;span class="k"&gt;EQU&lt;/span&gt; &lt;span class="mi"&gt;255&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;There is only one instruction left&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000002d0: 60e2&lt;/span&gt;                      &lt;span class="k"&gt;bra.b&lt;/span&gt;   &lt;span class="mi"&gt;0x2b4&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;which jumps back to the beginning of this short piece of code. The procedure then keeps looping on the whole table until it reaches the list terminator &lt;code&gt;0000&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The final content of the memory at &lt;code&gt;0142&lt;/code&gt; will be&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00000142: 0000 0146&lt;/span&gt; &lt;span class="c"&gt;; LH_HEAD&lt;/span&gt;
&lt;span class="m"&gt;00000146: 0000 0000&lt;/span&gt; &lt;span class="c"&gt;; LH_TAIL&lt;/span&gt;
&lt;span class="m"&gt;0000014a: 0000 0146&lt;/span&gt; &lt;span class="c"&gt;; LH_TAILPRED&lt;/span&gt;
&lt;span class="m"&gt;0000014d: 0a&lt;/span&gt;        &lt;span class="c"&gt;; LH_TYPE&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And the same happens for the remaining 7 lists from &lt;code&gt;ResourceList&lt;/code&gt; to &lt;code&gt;TaskWait&lt;/code&gt;. After this the Exec lists are initialised.&lt;/p&gt;
&lt;p&gt;According to the values of &lt;code&gt;LN_TYPE&lt;/code&gt; the list headers table is the following&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000002d2: 0142 000a&lt;/span&gt; &lt;span class="c"&gt;; MemList (NT_MEMORY)&lt;/span&gt;
&lt;span class="m"&gt;000002d6: 0150 0008&lt;/span&gt; &lt;span class="c"&gt;; ResourceList (NT_RESOURCE)&lt;/span&gt;
&lt;span class="m"&gt;000002da: 015e 0003&lt;/span&gt; &lt;span class="c"&gt;; DeviceList (NT_DEVICE)&lt;/span&gt;
&lt;span class="m"&gt;000002de: 017a 0009&lt;/span&gt; &lt;span class="c"&gt;; LibList (NT_LIBRARY)&lt;/span&gt;
&lt;span class="m"&gt;000002e2: 0188 0004&lt;/span&gt; &lt;span class="c"&gt;; PortList (NT_MSGPORT)&lt;/span&gt;
&lt;span class="m"&gt;000002e6: 0196 0001&lt;/span&gt; &lt;span class="c"&gt;; TaskReady (NT_TASK)&lt;/span&gt;
&lt;span class="m"&gt;000002ea: 01a4 0001&lt;/span&gt; &lt;span class="c"&gt;; TaskWait (NT_TASK)&lt;/span&gt;
&lt;span class="m"&gt;000002ee: 016c 0002&lt;/span&gt; &lt;span class="c"&gt;; IntrList (NT_INTERRUPT)&lt;/span&gt;
&lt;span class="m"&gt;000002f2: 01b2 000b&lt;/span&gt; &lt;span class="c"&gt;; SoftInts[0] (NT_SOFTINT)&lt;/span&gt;
&lt;span class="m"&gt;000002f6: 01c2 000b&lt;/span&gt; &lt;span class="c"&gt;; SoftInts[1] (NT_SOFTINT)&lt;/span&gt;
&lt;span class="m"&gt;000002fa: 01d2 000b&lt;/span&gt; &lt;span class="c"&gt;; SoftInts[2] (NT_SOFTINT)&lt;/span&gt;
&lt;span class="m"&gt;000002fe: 01e2 000b&lt;/span&gt; &lt;span class="c"&gt;; SoftInts[3] (NT_SOFTINT)&lt;/span&gt;
&lt;span class="m"&gt;00000302: 01f2 000b&lt;/span&gt; &lt;span class="c"&gt;; SoftInts[4] (NT_SOFTINT)&lt;/span&gt;
&lt;span class="m"&gt;00000306: 0214 000f&lt;/span&gt; &lt;span class="c"&gt;; SemaphoreList (NT_SIGNALSEM)&lt;/span&gt;
&lt;span class="m"&gt;0000030a: 0000&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h1 id="whats-next"&gt;What's next&lt;a class="headerlink" href="#whats-next" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;The next instalment of the series will cover the initial part of the system memory initialisation, both the standard one and potential expansions, introducing &lt;code&gt;AddMemList&lt;/code&gt; for the first time. It will also discuss the origin of some important numbers used in the Kickstart code, &lt;code&gt;0x24c&lt;/code&gt;, &lt;code&gt;0x400&lt;/code&gt;, and &lt;code&gt;0x676&lt;/code&gt;.&lt;/p&gt;
&lt;h1 id="resources"&gt;Resources&lt;a class="headerlink" href="#resources" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;Microprocessor-based system design by Ricardo Gutierrez-Osuna (&lt;a href="http://courses.cs.tamu.edu/rgutier/ceg411_f01/"&gt;slides&lt;/a&gt;), in particular &lt;a href="http://courses.cs.tamu.edu/rgutier/ceg411_f01/l9.pdf"&gt;Lesson 9 - Exception processing&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Motorola M68000 Family Programmer's Reference Manual &lt;a href="https://www.nxp.com/docs/en/reference-manual/M68000PRM.pdf"&gt;PDF here&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="feedback"&gt;Feedback&lt;a class="headerlink" href="#feedback" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Feel free to reach me on &lt;a href="https://twitter.com/thedigicat"&gt;Twitter&lt;/a&gt; if you have questions. The &lt;a href="https://github.com/TheDigitalCatOnline/thedigitalcatonline.github.com/issues"&gt;GitHub issues&lt;/a&gt; page is the best place to submit corrections.&lt;/p&gt;</content><category term="assembly"></category><category term="amiga"></category><category term="retroprogramming"></category></entry><entry><title>Exploring the Amiga - Part 4</title><link href="https://www.thedigitalcatonline.com/blog/2018/06/14/exploring-the-amiga-4/" rel="alternate"></link><published>2018-06-14T14:30:00+01:00</published><updated>2019-02-12T20:00:00+00:00</updated><author><name>Leonardo Giordani</name></author><id>tag:www.thedigitalcatonline.com,2018-06-14:/blog/2018/06/14/exploring-the-amiga-4/</id><summary type="html"></summary><content type="html">&lt;h1 id="the-exec-base-functions"&gt;The Exec base functions&lt;a class="headerlink" href="#the-exec-base-functions" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;We found the Kickstart 1.3 (Exec 34.2) vector table at address &lt;code&gt;0x1a7c&lt;/code&gt;, and the first 4 entries read&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;00001a7c: 08a0&lt;/span&gt;
&lt;span class="m"&gt;00001a7e: 08a8&lt;/span&gt;
&lt;span class="m"&gt;00001a80: 08ac&lt;/span&gt;
&lt;span class="m"&gt;00001a82: 08ac&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;If we translate these relative values into absolute addresses, summing the address of the table itself, we discover the address of the 4 base functions that every Amiga library has to provide, namely &lt;code&gt;Open&lt;/code&gt;, &lt;code&gt;Close&lt;/code&gt;, &lt;code&gt;Expunge&lt;/code&gt;, and a reserved slot that should contain a function that returns 0.&lt;/p&gt;
&lt;h2 id="open"&gt;&lt;code&gt;Open&lt;/code&gt;&lt;a class="headerlink" href="#open" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The first value is &lt;code&gt;0x08a0&lt;/code&gt;, and if we sum this value to the address of the table itself we get &lt;code&gt;0x1a7c + 0x08a0 = 0x231c&lt;/code&gt;. At this address we will find the first function defined in the jump table, that is &lt;code&gt;Open&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The code is the following&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;0000231c: 200e&lt;/span&gt;          &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;0000231e: 526e 0020&lt;/span&gt;     &lt;span class="k"&gt;addq.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x20&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00002322: 4e75&lt;/span&gt;          &lt;span class="k"&gt;rts&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The &lt;code&gt;Open&lt;/code&gt; routine expects the address of the library to be in the &lt;code&gt;a6&lt;/code&gt; register, and returns the same value in &lt;code&gt;d0&lt;/code&gt;. It then adds 1 to the number contained 32 bytes (&lt;code&gt;0x20&lt;/code&gt;) after the address of the library itself and then returns. To find out what this number is we can go back again to the NDK and its include files.&lt;/p&gt;
&lt;p&gt;From a previous investigation we know that, once the library has been installed in memory, there are two structures defined one after the other. The first is the &lt;code&gt;LN&lt;/code&gt; structure that represents a linked list node, and the second is the &lt;code&gt;LIB&lt;/code&gt; structure that represents the library.&lt;/p&gt;
&lt;p&gt;We find the definition of &lt;code&gt;LN&lt;/code&gt; in &lt;code&gt;include_i/exec/nodes.i&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt; &lt;span class="nv"&gt;STRUCTURE&lt;/span&gt;    &lt;span class="s"&gt;LN&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="s"&gt;    &lt;/span&gt;&lt;span class="c"&gt;; List Node&lt;/span&gt;
    &lt;span class="nv"&gt;APTR&lt;/span&gt;    &lt;span class="s"&gt;LN_SUCC &lt;/span&gt;&lt;span class="c"&gt;; Pointer to next (successor)&lt;/span&gt;
    &lt;span class="nv"&gt;APTR&lt;/span&gt;    &lt;span class="s"&gt;LN_PRED &lt;/span&gt;&lt;span class="c"&gt;; Pointer to previous (predecessor)&lt;/span&gt;
    &lt;span class="nv"&gt;UBYTE&lt;/span&gt;   &lt;span class="s"&gt;LN_TYPE&lt;/span&gt;
    &lt;span class="nv"&gt;BYTE&lt;/span&gt;    &lt;span class="s"&gt;LN_PRI  &lt;/span&gt;&lt;span class="c"&gt;; Priority, for sorting&lt;/span&gt;
    &lt;span class="nv"&gt;APTR&lt;/span&gt;    &lt;span class="s"&gt;LN_NAME &lt;/span&gt;&lt;span class="c"&gt;; ID string, null terminated&lt;/span&gt;
    &lt;span class="nv"&gt;LABEL&lt;/span&gt;   &lt;span class="s"&gt;LN_SIZE &lt;/span&gt;&lt;span class="c"&gt;; Note: word aligned&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and the definition of &lt;code&gt;LIB&lt;/code&gt; in &lt;code&gt;include_i/exewc/libraries.i&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt; &lt;span class="nv"&gt;STRUCTURE&lt;/span&gt; &lt;span class="s"&gt;LIB&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="s"&gt;LN_SIZE&lt;/span&gt;
    &lt;span class="nv"&gt;UBYTE&lt;/span&gt;   &lt;span class="s"&gt;LIB_FLAGS       &lt;/span&gt;&lt;span class="c"&gt;; see below&lt;/span&gt;
    &lt;span class="nv"&gt;UBYTE&lt;/span&gt;   &lt;span class="s"&gt;LIB_pad         &lt;/span&gt;&lt;span class="c"&gt;; must be zero&lt;/span&gt;
    &lt;span class="nv"&gt;UWORD&lt;/span&gt;   &lt;span class="s"&gt;LIB_NEGSIZE     &lt;/span&gt;&lt;span class="c"&gt;; number of bytes before LIB&lt;/span&gt;
    &lt;span class="nv"&gt;UWORD&lt;/span&gt;   &lt;span class="s"&gt;LIB_POSSIZE     &lt;/span&gt;&lt;span class="c"&gt;; number of bytes after LIB&lt;/span&gt;
    &lt;span class="nv"&gt;UWORD&lt;/span&gt;   &lt;span class="s"&gt;LIB_VERSION     &lt;/span&gt;&lt;span class="c"&gt;; major&lt;/span&gt;
    &lt;span class="nv"&gt;UWORD&lt;/span&gt;   &lt;span class="s"&gt;LIB_REVISION    &lt;/span&gt;&lt;span class="c"&gt;; minor&lt;/span&gt;
    &lt;span class="nv"&gt;APTR&lt;/span&gt;    &lt;span class="s"&gt;LIB_IDSTRING    &lt;/span&gt;&lt;span class="c"&gt;; ASCII identification&lt;/span&gt;
    &lt;span class="nv"&gt;ULONG&lt;/span&gt;   &lt;span class="s"&gt;LIB_SUM         &lt;/span&gt;&lt;span class="c"&gt;; the system-calculated checksum&lt;/span&gt;
    &lt;span class="nv"&gt;UWORD&lt;/span&gt;   &lt;span class="s"&gt;LIB_OPENCNT     &lt;/span&gt;&lt;span class="c"&gt;; number of current opens&lt;/span&gt;
    &lt;span class="nv"&gt;LABEL&lt;/span&gt;   &lt;span class="s"&gt;LIB_SIZE        &lt;/span&gt;&lt;span class="c"&gt;; Warning: Size is not a longword multiple!&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;As you can see the latter mentions the former reserving space for it at the beginning (&lt;code&gt;LN_SIZE&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;&lt;code&gt;LABEL&lt;/code&gt; is a macro that creates an alias for the current size of the structure, and you can find its definition in &lt;code&gt;include_i/exec/types.i&lt;/code&gt;. It works in conjunction with the type macros, which increment the global variable &lt;code&gt;SOFFSET&lt;/code&gt;. The code &lt;code&gt;LABEL LN_SIZE&lt;/code&gt; in the &lt;code&gt;LN&lt;/code&gt; structure produces the definition &lt;code&gt;LN_SIZE EQU 14&lt;/code&gt;, which is thus a simple marker and does not contribute to the size of the structure itself.&lt;/p&gt;
&lt;p&gt;The comment after the &lt;code&gt;LABEL&lt;/code&gt; macro in the &lt;code&gt;LN&lt;/code&gt; structure says that the structure is word aligned, and indeed its size is a multiple of a word (2 bytes): 2 &lt;code&gt;APTR&lt;/code&gt; (8 bytes) + 1 &lt;code&gt;UBYTE&lt;/code&gt; (1 bytes) + 1 &lt;code&gt;BYTE&lt;/code&gt; (1 byte) + 1 &lt;code&gt;APTR&lt;/code&gt; (4 bytes) = 14 bytes.&lt;/p&gt;
&lt;p&gt;To find the field updated by &lt;code&gt;Open&lt;/code&gt; we need to skip 32 bytes. So, after we skip the whole &lt;code&gt;LN&lt;/code&gt; structure, we still have 18 bytes to skip into the &lt;code&gt;LIB&lt;/code&gt; structure. At that offset we find the &lt;code&gt;LIB_OPENCNT&lt;/code&gt; field (remember that &lt;code&gt;UBYTE&lt;/code&gt; is 1 byte, &lt;code&gt;UWORD&lt;/code&gt; 2 bytes, and &lt;code&gt;APTR&lt;/code&gt; and &lt;code&gt;ULONG&lt;/code&gt; 4 bytes). This field is, as the comment reads, the "number of current opens".&lt;/p&gt;
&lt;p&gt;The last instruction of the &lt;code&gt;Open&lt;/code&gt; function is &lt;code&gt;rts&lt;/code&gt; (ReTurn from Subroutine) that returns to the instruction after the &lt;code&gt;jsr&lt;/code&gt; that called the function.&lt;/p&gt;
&lt;h2 id="close-expunge-and-the-reserved-slot"&gt;&lt;code&gt;Close&lt;/code&gt;, &lt;code&gt;Expunge&lt;/code&gt;, and the reserved slot&lt;a class="headerlink" href="#close-expunge-and-the-reserved-slot" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Immediately after the definition of the &lt;code&gt;Open&lt;/code&gt; function, we find the definition of &lt;code&gt;Close&lt;/code&gt;, listed in the vector table as &lt;code&gt;0x08a8&lt;/code&gt;, which becomes &lt;code&gt;0x1a7c + 0x08a8 = 0x2324&lt;/code&gt;. The next two entries in the vector table contain the same value &lt;code&gt;0x08ac&lt;/code&gt;, which translates to the absolute address &lt;code&gt;0x1a7c + 0x08ac = 0x2328&lt;/code&gt;. This address is then the location of both the &lt;code&gt;Expunge&lt;/code&gt; function and the reserved function that must return 0.&lt;/p&gt;
&lt;p&gt;The code of the &lt;code&gt;Close&lt;/code&gt; function is very simple, it just decrements the open counter (&lt;code&gt;0x20&lt;/code&gt; in the library). There is no explicit &lt;code&gt;rts&lt;/code&gt; as &lt;code&gt;Close&lt;/code&gt; uses the adjacent &lt;code&gt;Expunge&lt;/code&gt; code for that. Since it's impossible to remove the Exec library in the Amiga system, the &lt;code&gt;Expunge&lt;/code&gt; function of the Exec library just returns 0, which is exactly what the reserved function has to do (thus the same address in the vector table), and what &lt;code&gt;Close&lt;/code&gt; does after having decremented the open counter.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c"&gt;; Close&lt;/span&gt;
&lt;span class="m"&gt;00002324: 536e 0020&lt;/span&gt;     &lt;span class="k"&gt;subq.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;0x20&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a6&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="c"&gt;&lt;/span&gt;

&lt;span class="c"&gt;; Expunge&lt;/span&gt;
&lt;span class="m"&gt;00002328: 7000&lt;/span&gt;          &lt;span class="k"&gt;moveq&lt;/span&gt;   &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;0000232a: 4e75&lt;/span&gt;          &lt;span class="k"&gt;rts&lt;/span&gt;     
&lt;/pre&gt;&lt;/div&gt;


&lt;h1 id="makefunctions"&gt;&lt;code&gt;MakeFunctions&lt;/code&gt;&lt;a class="headerlink" href="#makefunctions" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;The &lt;code&gt;MakeFunctions&lt;/code&gt; routine is used by Exec to create the vector table at the beginning of the library when it is loaded in memory. You might recall that the vector table is created backward from the beginning of the library, thus allowing to use a simpler addressing scheme.&lt;/p&gt;
&lt;p&gt;The prototype of the &lt;code&gt;MakeFunctions&lt;/code&gt; routine is&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;size = MakeFunctions(addess, vectors, offset)
d0                   a0      a1       a2
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;and the code that we found in one of the previous investigations is at offset &lt;code&gt;0x15b2&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000015b2: 2f0b&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a3&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;sp&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000015b4: 7000&lt;/span&gt;                      &lt;span class="k"&gt;moveq&lt;/span&gt;   &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000015b6: 220a&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;000015b8: 6716&lt;/span&gt;                      &lt;span class="k"&gt;beq.b&lt;/span&gt;   &lt;span class="mi"&gt;0x15d0&lt;/span&gt;
&lt;span class="m"&gt;000015ba: 3219&lt;/span&gt;                      &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)+,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;000015bc: 0c41 ffff&lt;/span&gt;                 &lt;span class="k"&gt;cmpi.w&lt;/span&gt;  &lt;span class="p"&gt;#-&lt;/span&gt;&lt;span class="mi"&gt;0x1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;000015c0: 6722&lt;/span&gt;                      &lt;span class="k"&gt;beq.b&lt;/span&gt;   &lt;span class="mi"&gt;0x15e4&lt;/span&gt;
&lt;span class="m"&gt;000015c2: 47f2 1000&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nl"&gt;w&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a3&lt;/span&gt;
&lt;span class="m"&gt;000015c6: 210b&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a3&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000015c8: 313c 4ef9&lt;/span&gt;                 &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x4ef9&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000015cc: 5c80&lt;/span&gt;                      &lt;span class="k"&gt;addq.l&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x6&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000015ce: 60ea&lt;/span&gt;                      &lt;span class="k"&gt;bra.b&lt;/span&gt;   &lt;span class="mi"&gt;0x15ba&lt;/span&gt;
&lt;span class="m"&gt;000015d0: 2219&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)+,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;000015d2: 0c81 ffff ffff&lt;/span&gt;            &lt;span class="k"&gt;cmpi.l&lt;/span&gt;  &lt;span class="p"&gt;#-&lt;/span&gt;&lt;span class="mi"&gt;0x1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;000015d8: 670a&lt;/span&gt;                      &lt;span class="k"&gt;beq.b&lt;/span&gt;   &lt;span class="mi"&gt;0x15e4&lt;/span&gt;
&lt;span class="m"&gt;000015da: 2101&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;d1&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000015dc: 313c 4ef9&lt;/span&gt;                 &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x4ef9&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000015e0: 5c80&lt;/span&gt;                      &lt;span class="k"&gt;addq.l&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x6&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000015e2: 60ec&lt;/span&gt;                      &lt;span class="k"&gt;bra.b&lt;/span&gt;   &lt;span class="mi"&gt;0x15d0&lt;/span&gt;
&lt;span class="m"&gt;000015e4: 265f&lt;/span&gt;                      &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;sp&lt;/span&gt;&lt;span class="p"&gt;)+,&lt;/span&gt;&lt;span class="nv"&gt;a3&lt;/span&gt;
&lt;span class="m"&gt;000015e6: 4e75&lt;/span&gt;                      &lt;span class="k"&gt;rts&lt;/span&gt;     
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The code is probably easier to read if we replace the addresses with some labels&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nl"&gt;Setup:&lt;/span&gt;
&lt;span class="m"&gt;000015b2: 2f0b&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a3&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;sp&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000015b4: 7000&lt;/span&gt;                      &lt;span class="k"&gt;moveq&lt;/span&gt;   &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000015b6: 220a&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;000015b8: 6716&lt;/span&gt;                      &lt;span class="k"&gt;beq.b&lt;/span&gt;   &lt;span class="nl"&gt;Absolute&lt;/span&gt;

&lt;span class="nl"&gt;Relative:&lt;/span&gt;
&lt;span class="m"&gt;000015ba: 3219&lt;/span&gt;                      &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)+,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;000015bc: 0c41 ffff&lt;/span&gt;                 &lt;span class="k"&gt;cmpi.w&lt;/span&gt;  &lt;span class="p"&gt;#-&lt;/span&gt;&lt;span class="mi"&gt;0x1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;000015c0: 6722&lt;/span&gt;                      &lt;span class="k"&gt;beq.b&lt;/span&gt;   &lt;span class="nl"&gt;Cleanup&lt;/span&gt;
&lt;span class="m"&gt;000015c2: 47f2 1000&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nl"&gt;w&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a3&lt;/span&gt;
&lt;span class="m"&gt;000015c6: 210b&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a3&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000015c8: 313c 4ef9&lt;/span&gt;                 &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x4ef9&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000015cc: 5c80&lt;/span&gt;                      &lt;span class="k"&gt;addq.l&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x6&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000015ce: 60ea&lt;/span&gt;                      &lt;span class="k"&gt;bra.b&lt;/span&gt;   &lt;span class="nl"&gt;Relative&lt;/span&gt;

&lt;span class="nl"&gt;Absolute:&lt;/span&gt;
&lt;span class="m"&gt;000015d0: 2219&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)+,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;000015d2: 0c81 ffff ffff&lt;/span&gt;            &lt;span class="k"&gt;cmpi.l&lt;/span&gt;  &lt;span class="p"&gt;#-&lt;/span&gt;&lt;span class="mi"&gt;0x1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;000015d8: 670a&lt;/span&gt;                      &lt;span class="k"&gt;beq.b&lt;/span&gt;   &lt;span class="nl"&gt;Cleanup&lt;/span&gt;
&lt;span class="m"&gt;000015da: 2101&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;d1&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000015dc: 313c 4ef9&lt;/span&gt;                 &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x4ef9&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000015e0: 5c80&lt;/span&gt;                      &lt;span class="k"&gt;addq.l&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x6&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000015e2: 60ec&lt;/span&gt;                      &lt;span class="k"&gt;bra.b&lt;/span&gt;   &lt;span class="nl"&gt;Absolute&lt;/span&gt;

&lt;span class="nl"&gt;Cleanup:&lt;/span&gt;
&lt;span class="m"&gt;000015e4: 265f&lt;/span&gt;                      &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;sp&lt;/span&gt;&lt;span class="p"&gt;)+,&lt;/span&gt;&lt;span class="nv"&gt;a3&lt;/span&gt;
&lt;span class="m"&gt;000015e6: 4e75&lt;/span&gt;                      &lt;span class="k"&gt;rts&lt;/span&gt;     
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="setup"&gt;Setup&lt;a class="headerlink" href="#setup" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The first part of the code is&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nl"&gt;Setup:&lt;/span&gt;
&lt;span class="m"&gt;000015b2: 2f0b&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a3&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;sp&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000015b4: 7000&lt;/span&gt;                      &lt;span class="k"&gt;moveq&lt;/span&gt;   &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000015b6: 220a&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;000015b8: 6716&lt;/span&gt;                      &lt;span class="k"&gt;beq.b&lt;/span&gt;   &lt;span class="nl"&gt;Absolute&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The first thing this code does is to save the &lt;code&gt;a3&lt;/code&gt; register in the stack because it will be changed during the routine.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nl"&gt;Setup:&lt;/span&gt;
&lt;span class="m"&gt;000015b2: 2f0b&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a3&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;sp&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;In Assembly, variables are provided by registers and thus are not namespaced, as the registers are the same through the whole program. This is why you should save and restore them and document which one you will change, for instance to return values.&lt;/p&gt;
&lt;p&gt;Secondly, the code sets the &lt;code&gt;d0&lt;/code&gt; register to 0.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000015b4: 7000&lt;/span&gt;                      &lt;span class="k"&gt;moveq&lt;/span&gt;   &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This register, according to the function prototype, will contain the final size of the jump table, and 0 is a sensible starting value.&lt;/p&gt;
&lt;p&gt;Lastly, the code moves the &lt;code&gt;a2&lt;/code&gt; register to &lt;code&gt;d1&lt;/code&gt; to be able to manipulate it. &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000015b6: 220a&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;000015b8: 6716&lt;/span&gt;                      &lt;span class="k"&gt;beq.b&lt;/span&gt;   &lt;span class="nl"&gt;Absolute&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This, however, also sets the processor flags according to the value of &lt;code&gt;a2&lt;/code&gt; itself, and those flags are used in the next &lt;code&gt;beq.b&lt;/code&gt; instruction. If &lt;code&gt;a2&lt;/code&gt; contains the value 0 the table is absolute (code at &lt;code&gt;0x15d0&lt;/code&gt;, labelled &lt;code&gt;Absolute&lt;/code&gt; here) otherwise it is relative (code at &lt;code&gt;0x15ba&lt;/code&gt;, labelled &lt;code&gt;Relative&lt;/code&gt; here).&lt;/p&gt;
&lt;h2 id="relative"&gt;Relative&lt;a class="headerlink" href="#relative" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The second section manages relative jump vectors&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nl"&gt;Relative:&lt;/span&gt;
&lt;span class="m"&gt;000015ba: 3219&lt;/span&gt;                      &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)+,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;000015bc: 0c41 ffff&lt;/span&gt;                 &lt;span class="k"&gt;cmpi.w&lt;/span&gt;  &lt;span class="p"&gt;#-&lt;/span&gt;&lt;span class="mi"&gt;0x1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;000015c0: 6722&lt;/span&gt;                      &lt;span class="k"&gt;beq.b&lt;/span&gt;   &lt;span class="nl"&gt;Cleanup&lt;/span&gt;
&lt;span class="m"&gt;000015c2: 47f2 1000&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nl"&gt;w&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a3&lt;/span&gt;
&lt;span class="m"&gt;000015c6: 210b&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a3&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000015c8: 313c 4ef9&lt;/span&gt;                 &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x4ef9&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000015cc: 5c80&lt;/span&gt;                      &lt;span class="k"&gt;addq.l&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x6&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000015ce: 60ea&lt;/span&gt;                      &lt;span class="k"&gt;bra.b&lt;/span&gt;   &lt;span class="nl"&gt;Relative&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This fetches one of the vectors from the address stored in &lt;code&gt;a1&lt;/code&gt; (the address of the vector table), immediately incrementing the register value to point at the next vector.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nl"&gt;Relative:&lt;/span&gt;
&lt;span class="m"&gt;000015ba: 3219&lt;/span&gt;                      &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)+,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;then compares it with &lt;code&gt;0xffff&lt;/code&gt; (or &lt;code&gt;#-0x1&lt;/code&gt;) to see if we reached the end of the table. In that case the code jumps to the fourth section (&lt;code&gt;0x15e4&lt;/code&gt;, labelled &lt;code&gt;Cleanup&lt;/code&gt;), otherwise the execution continues with the next instruction&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000015bc: 0c41 ffff&lt;/span&gt;                 &lt;span class="k"&gt;cmpi.w&lt;/span&gt;  &lt;span class="p"&gt;#-&lt;/span&gt;&lt;span class="mi"&gt;0x1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;000015c0: 6722&lt;/span&gt;                      &lt;span class="k"&gt;beq.b&lt;/span&gt;   &lt;span class="nl"&gt;Cleanup&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The routine then loads the effective address of the relative vector using &lt;code&gt;a2&lt;/code&gt; as the base addressing, and stores it in &lt;code&gt;a3&lt;/code&gt;. This register now contains the final entry that will be part of the jump table.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000015c2: 47f2 1000&lt;/span&gt;                 &lt;span class="k"&gt;lea&lt;/span&gt;     &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;a2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nl"&gt;w&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;&lt;span class="nv"&gt;a3&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Since the address of the jump table is contained in &lt;code&gt;a0&lt;/code&gt;, the resulting absolute vector is stored there, then the code stores the value &lt;code&gt;0x4ef9&lt;/code&gt; which is the code for the &lt;code&gt;jmp&lt;/code&gt; instruction (more on this later)&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000015c6: 210b&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;a3&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000015c8: 313c 4ef9&lt;/span&gt;                 &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x4ef9&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Note that since we are storing the jump table at negative addresses starting from the library's base pointer we have to copy the argument (the address) first and then the function (the code for &lt;code&gt;jmp&lt;/code&gt;). The last thing this part of the code does is to add 6 to the size of the jump table (1 word for the instruction, 2 words for the address) and then jumps back to the beginning of the loop.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000015cc: 5c80&lt;/span&gt;                      &lt;span class="k"&gt;addq.l&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x6&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000015ce: 60ea&lt;/span&gt;                      &lt;span class="k"&gt;bra.b&lt;/span&gt;   &lt;span class="nl"&gt;Relative&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2 id="absolute"&gt;Absolute&lt;a class="headerlink" href="#absolute" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The third section is very similar to the second one, because it performs the same actions, only with absolute addresses instead of relative ones.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000015d0: 2219&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;a1&lt;/span&gt;&lt;span class="p"&gt;)+,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;000015d2: 0c81 ffff ffff&lt;/span&gt;            &lt;span class="k"&gt;cmpi.l&lt;/span&gt;  &lt;span class="p"&gt;#-&lt;/span&gt;&lt;span class="mi"&gt;0x1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d1&lt;/span&gt;
&lt;span class="m"&gt;000015d8: 670a&lt;/span&gt;                      &lt;span class="k"&gt;beq.b&lt;/span&gt;   &lt;span class="nl"&gt;Cleanup&lt;/span&gt;
&lt;span class="m"&gt;000015da: 2101&lt;/span&gt;                      &lt;span class="k"&gt;move.l&lt;/span&gt;  &lt;span class="nv"&gt;d1&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000015dc: 313c 4ef9&lt;/span&gt;                 &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x4ef9&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;000015e0: 5c80&lt;/span&gt;                      &lt;span class="k"&gt;addq.l&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x6&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nv"&gt;d0&lt;/span&gt;
&lt;span class="m"&gt;000015e2: 60ec&lt;/span&gt;                      &lt;span class="k"&gt;bra.b&lt;/span&gt;   &lt;span class="nl"&gt;Absolute&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The only difference with the previous section is that there is no need to load the effective address, as the value contained in &lt;code&gt;d1&lt;/code&gt; is already absolute, so the latter can be stored directly.&lt;/p&gt;
&lt;h2 id="cleanup"&gt;Cleanup&lt;a class="headerlink" href="#cleanup" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The last section simply restores the stack pointer, popping the value of the &lt;code&gt;a3&lt;/code&gt; register where the pointer was previously saved, and returns to the caller.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000015e4: 265f&lt;/span&gt;                      &lt;span class="k"&gt;movea.l&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;sp&lt;/span&gt;&lt;span class="p"&gt;)+,&lt;/span&gt;&lt;span class="nv"&gt;a3&lt;/span&gt;
&lt;span class="m"&gt;000015e6: 4e75&lt;/span&gt;                      &lt;span class="k"&gt;rts&lt;/span&gt;     
&lt;/pre&gt;&lt;/div&gt;


&lt;h1 id="self-modifying-code"&gt;Self-modifying code&lt;a class="headerlink" href="#self-modifying-code" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;The creation of the jump table performed by the &lt;code&gt;MakeFunctions&lt;/code&gt; routine leverages a very powerful feature of any assembly language, that is being able to produce code that self-modifies. This feature comes from a property of machine languages called &lt;a href="https://en.wikipedia.org/wiki/Homoiconicity"&gt;homoiconicity&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The basic idea of homoiconicity is that the language doesn't consider data and code two different things, thus allowing to use the code as an input for routines and to change it programmatically. Pay attention that self-modifying code is just one of the implications of homoiconicity, and not its definition.&lt;/p&gt;
&lt;p&gt;Homoiconicity is a feature rarely provided by languages. It is very powerful, but it basically forces to keep the language at the level of its own AST (Abstract Syntax Tree), which in turn means that you cannot add a proper abstraction, or, if you prefer, a proper high level language, if we identify with this term a computer language that is similar to the human language.&lt;/p&gt;
&lt;p&gt;Famous examples of high level languages that are homoiconic are Lisp and Prolog. Lisp is a language that manages lists and its syntax is based on... lists. This means that you can pass Lisp code to a function and transform it like you would do with standard data.&lt;/p&gt;
&lt;p&gt;Back to the Motorola Assembly code, the line we are interested in is &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;000015c8: 313c 4ef9&lt;/span&gt;                 &lt;span class="k"&gt;move.w&lt;/span&gt;  &lt;span class="p"&gt;#&lt;/span&gt;&lt;span class="mi"&gt;0x4ef9&lt;/span&gt;&lt;span class="p"&gt;,-(&lt;/span&gt;&lt;span class="nv"&gt;a0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This decrements the address contained in &lt;code&gt;a0&lt;/code&gt; by 2 bytes, then stores at the resulting address the hexadecimal number &lt;code&gt;0x4ef9&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The interesting part is that the number &lt;code&gt;0x4ef9&lt;/code&gt; has a specific meaning for the Motorola 68000 processor, and namely that of the &lt;code&gt;jmp&lt;/code&gt; instruction. This is clearly shown by the tables in the Programmer's Reference Manual (Section 8, Instruction Format Summary, 8-15).&lt;/p&gt;
&lt;p&gt;First we have to convert the number in binary, and we get&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;0x4ef9 -&amp;gt; 0100 1110 1111 1001
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The first 10 bits (&lt;code&gt;0100 1110 11&lt;/code&gt;) already identify a &lt;code&gt;jmp&lt;/code&gt; instruction. The following 6 bits (&lt;code&gt;111 001&lt;/code&gt;) identify the addressing mode, which in this case is &lt;code&gt;Absolute Long&lt;/code&gt; or &lt;code&gt;(xxx).L&lt;/code&gt; (Programmer's Reference Manual, 4-108). This instruction shall then be followed by a 4 bytes absolute address.&lt;/p&gt;
&lt;p&gt;With that &lt;code&gt;move.w&lt;/code&gt;, then, the code writes in memory some Assembly code. Techniques like this have been and are used by games and viruses to obfuscate the code, as a static analysis of the binary will not reveal what will be there only at runtime!&lt;/p&gt;
&lt;h1 id="whats-next"&gt;What's next&lt;a class="headerlink" href="#whats-next" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;The next article will discuss the reason behind the address &lt;code&gt;0x4&lt;/code&gt; used for the Exec base address, and then will move on discussing linked lists and how Exec manages system resources using them.&lt;/p&gt;
&lt;h1 id="resources"&gt;Resources&lt;a class="headerlink" href="#resources" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;ul&gt;
&lt;li&gt;Motorola M68000 Family Programmer's Reference Manual &lt;a href="https://www.nxp.com/docs/en/reference-manual/M68000PRM.pdf"&gt;PDF here&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://amigadev.elowar.com"&gt;AmigaOS Developer Docs&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id="feedback"&gt;Feedback&lt;a class="headerlink" href="#feedback" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;Feel free to reach me on &lt;a href="https://twitter.com/thedigicat"&gt;Twitter&lt;/a&gt; if you have questions. The &lt;a href="https://github.com/TheDigitalCatOnline/thedigitalcatonline.github.com/issues"&gt;GitHub issues&lt;/a&gt; page is the best place to submit corrections.&lt;/p&gt;</content><category term="assembly"></category><category term="amiga"></category><category term="retroprogramming"></category></entry></feed>